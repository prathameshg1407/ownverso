I'll analyze the module-wise architecture document and update it to align with the optimized Prisma schema we created. Let me provide a comprehensive, updated version.

# Ownverso Platform - Complete Module-Wise Architecture v2.0

## Aligned with Optimized Prisma Schema v3.0

---

# Table of Contents

1. [Authentication & Authorization](#1-authentication--authorization)
2. [User Management](#2-user-management)
3. [Site Management](#3-site-management)
4. [Content Management (Series)](#4-content-management-series)
5. [Content Management (Chapters)](#5-content-management-chapters)
6. [Media & File Management](#6-media--file-management)
7. [Subscription & Tiers](#7-subscription--tiers)
8. [Payment Processing](#8-payment-processing)
9. [Analytics & Reporting](#9-analytics--reporting)
10. [AI & Translation](#10-ai--translation)
11. [Social & Engagement](#11-social--engagement)
12. [Communication](#12-communication)
13. [Discovery & Forum](#13-discovery--forum)
14. [Search](#14-search)
15. [Moderation & Reports](#15-moderation--reports)
16. [Support & Helpdesk](#16-support--helpdesk)
17. [Admin & System](#17-admin--system)
18. [Billing & Invoicing](#18-billing--invoicing)
19. [Referrals](#19-referrals)
20. [API Keys & Webhooks](#20-api-keys--webhooks)
21. [GDPR & Data Export](#21-gdpr--data-export)

---

# 1. Authentication & Authorization

## 1.1 Database Schema

```prisma
// ============================================================================
// AUTHENTICATION MODULE - SCHEMA (Optimized)
// ============================================================================

enum UserRole {
  READER
  AUTHOR
  COLLABORATOR
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  PENDING_VERIFICATION
  ACTIVE
  SUSPENDED
  BANNED
  DELETED
}

enum AuthProvider {
  EMAIL
  GOOGLE
  APPLE
  TWITTER
}

enum VerificationTokenType {
  EMAIL_VERIFICATION
  EMAIL_CHANGE
  PASSWORD_RESET
  MFA_SETUP
}

/// Core user account (auth-related fields only shown here)
model User {
  // Primary Keys - BIGINT for internal, CUID for external
  id                    BigInt      @id @default(autoincrement())
  publicId              String      @unique @default(cuid())
  
  // Authentication
  email                 String      @unique
  emailVerified         Boolean     @default(false)
  emailVerifiedAt       DateTime?
  passwordHash          String?     // Null if OAuth-only
  
  // Role & Status
  role                  UserRole    @default(READER)
  status                UserStatus  @default(PENDING_VERIFICATION)
  statusHistory         Json        @default("[]") // [{status, timestamp, reason}]
  
  // Security
  mfaEnabled            Boolean     @default(false)
  mfaSecret             String?     // Encrypted TOTP secret
  mfaBackupCodes        String[]    @default([])
  lastLoginAt           DateTime?
  lastLoginIp           String?     @db.VarChar(45)
  lastLoginUserAgent    String?
  failedLoginCount      Int         @default(0) @db.SmallInt
  lockedUntil           DateTime?
  
  // Timestamps
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  deletedAt             DateTime?   // GDPR soft delete

  // Auth Relations
  authAccounts          AuthAccount[]
  sessions              Session[]
  verificationTokens    VerificationToken[]

  @@index([email])
  @@index([publicId])
  @@index([status, role])
  @@map("users")
}

/// OAuth and external authentication providers
model AuthAccount {
  id                BigInt       @id @default(autoincrement())
  userId            BigInt
  
  provider          AuthProvider
  providerAccountId String
  
  // OAuth tokens (encrypted at rest)
  accessToken       String?      @db.Text
  refreshToken      String?      @db.Text
  tokenExpiresAt    DateTime?
  
  // Provider profile data
  providerEmail     String?
  providerName      String?
  providerAvatar    String?
  scopes            String[]     @default([])
  
  // Sync status
  lastSyncedAt      DateTime?
  isRevoked         Boolean      @default(false)
  revokedAt         DateTime?
  
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  // Relations
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId, provider])
  @@map("auth_accounts")
}

/// Active user sessions with device tracking
model Session {
  id                BigInt       @id @default(autoincrement())
  userId            BigInt
  
  // Token hashes (never store raw tokens)
  tokenHash         String       @unique
  refreshTokenHash  String       @unique
  
  // Revocation
  isRevoked         Boolean      @default(false)
  revokedAt         DateTime?
  revokedReason     String?
  
  // Device & location info
  userAgent         String?      @db.Text
  ipAddress         String?      @db.VarChar(45)
  deviceType        String?      // desktop, mobile, tablet
  deviceOs          String?
  browser           String?
  country           String?      @db.Char(2)
  city              String?
  
  // Auth context
  authProvider      AuthProvider?
  
  // Lifecycle
  expiresAt         DateTime
  lastActiveAt      DateTime     @default(now())
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  // Relations
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRevoked])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("sessions")
}

/// Verification tokens for email, password reset, MFA setup
model VerificationToken {
  id            BigInt                @id @default(autoincrement())
  userId        BigInt
  
  tokenHash     String                @unique
  type          VerificationTokenType
  newEmail      String?               // For EMAIL_CHANGE type
  
  // Usage tracking
  isUsed        Boolean               @default(false)
  usedAt        DateTime?
  requestedIp   String?               @db.VarChar(45)
  usedIp        String?               @db.VarChar(45)
  
  expiresAt     DateTime
  createdAt     DateTime              @default(now())

  // Relations
  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
  @@index([expiresAt])
  @@map("verification_tokens")
}
```

## 1.2 API Endpoints

```yaml
# ============================================================================
# AUTHENTICATION MODULE - API ENDPOINTS
# ============================================================================

Authentication:
  Public:
    - POST   /api/v1/auth/register                    # Register new user
    - POST   /api/v1/auth/login                       # Login with email/password
    - POST   /api/v1/auth/login/google                # Google OAuth login
    - POST   /api/v1/auth/login/apple                 # Apple OAuth login
    - POST   /api/v1/auth/login/twitter               # Twitter OAuth login
    - POST   /api/v1/auth/refresh                     # Refresh access token
    - POST   /api/v1/auth/forgot-password             # Request password reset
    - POST   /api/v1/auth/reset-password              # Reset password with token
    - POST   /api/v1/auth/verify-email                # Verify email with token
    - POST   /api/v1/auth/resend-verification         # Resend verification email
    - GET    /api/v1/auth/oauth/:provider/callback    # OAuth callback handler

  Authenticated:
    - POST   /api/v1/auth/logout                      # Logout current session
    - POST   /api/v1/auth/logout-all                  # Logout all sessions
    - POST   /api/v1/auth/change-password             # Change password
    - POST   /api/v1/auth/change-email                # Request email change
    - POST   /api/v1/auth/verify-email-change         # Verify new email
    - GET    /api/v1/auth/sessions                    # List active sessions
    - DELETE /api/v1/auth/sessions/:sessionId         # Revoke specific session
    - GET    /api/v1/auth/me                          # Get current user (minimal)

  MFA:
    - POST   /api/v1/auth/mfa/enable                  # Enable MFA (returns QR)
    - POST   /api/v1/auth/mfa/verify                  # Verify MFA setup with code
    - POST   /api/v1/auth/mfa/disable                 # Disable MFA
    - POST   /api/v1/auth/mfa/challenge               # Verify MFA during login
    - GET    /api/v1/auth/mfa/backup-codes            # Get backup codes
    - POST   /api/v1/auth/mfa/regenerate-backup       # Regenerate backup codes
```

## 1.3 Backend Folder Structure

```
backend/
├── src/
│   ├── modules/
│   │   └── auth/
│   │       ├── index.ts                      # Module exports
│   │       ├── auth.module.ts                # NestJS module definition
│   │       ├── auth.routes.ts                # Route definitions
│   │       ├── auth.controller.ts            # HTTP handlers
│   │       ├── auth.service.ts               # Business logic
│   │       ├── auth.repository.ts            # Database operations
│   │       │
│   │       ├── dto/
│   │       │   ├── index.ts
│   │       │   ├── register.dto.ts
│   │       │   ├── login.dto.ts
│   │       │   ├── login-response.dto.ts
│   │       │   ├── reset-password.dto.ts
│   │       │   ├── change-password.dto.ts
│   │       │   ├── change-email.dto.ts
│   │       │   ├── verify-email.dto.ts
│   │       │   ├── mfa-setup.dto.ts
│   │       │   ├── mfa-verify.dto.ts
│   │       │   └── session.dto.ts
│   │       │
│   │       ├── schemas/
│   │       │   ├── index.ts
│   │       │   ├── register.schema.ts        # Zod validation
│   │       │   ├── login.schema.ts
│   │       │   └── password.schema.ts
│   │       │
│   │       ├── strategies/
│   │       │   ├── index.ts
│   │       │   ├── jwt.strategy.ts           # JWT validation
│   │       │   ├── jwt-refresh.strategy.ts   # Refresh token strategy
│   │       │   ├── google.strategy.ts        # Google OAuth
│   │       │   ├── apple.strategy.ts         # Apple Sign-In
│   │       │   └── twitter.strategy.ts       # Twitter OAuth
│   │       │
│   │       ├── guards/
│   │       │   ├── index.ts
│   │       │   ├── jwt-auth.guard.ts         # JWT authentication
│   │       │   ├── roles.guard.ts            # Role-based access
│   │       │   ├── mfa-required.guard.ts     # MFA verification
│   │       │   ├── email-verified.guard.ts   # Email verification check
│   │       │   └── rate-limit.guard.ts       # Rate limiting
│   │       │
│   │       ├── services/
│   │       │   ├── index.ts
│   │       │   ├── token.service.ts          # JWT generation/validation
│   │       │   ├── session.service.ts        # Session management
│   │       │   ├── mfa.service.ts            # TOTP generation/verification
│   │       │   ├── password.service.ts       # Hashing, validation
│   │       │   ├── oauth.service.ts          # OAuth flow handling
│   │       │   └── verification.service.ts   # Email verification tokens
│   │       │
│   │       ├── decorators/
│   │       │   ├── index.ts
│   │       │   ├── current-user.decorator.ts
│   │       │   ├── roles.decorator.ts
│   │       │   ├── public.decorator.ts
│   │       │   └── require-mfa.decorator.ts
│   │       │
│   │       └── interfaces/
│   │           ├── index.ts
│   │           ├── jwt-payload.interface.ts
│   │           ├── auth-user.interface.ts
│   │           └── oauth-profile.interface.ts
│   │
│   ├── core/
│   │   └── security/
│   │       ├── index.ts
│   │       ├── encryption.service.ts         # AES encryption for secrets
│   │       ├── hashing.service.ts            # Argon2 password hashing
│   │       ├── jwt.service.ts                # JWT utilities
│   │       └── otp.service.ts                # TOTP generation
│   │
│   └── common/
│       ├── middleware/
│       │   └── auth.middleware.ts            # Request authentication
│       └── filters/
│           └── auth-exception.filter.ts      # Auth error handling
```

## 1.4 Frontend Folder Structure

```
frontend/
├── src/
│   ├── app/
│   │   └── (auth)/
│   │       ├── layout.tsx                    # Auth pages layout
│   │       ├── login/
│   │       │   └── page.tsx
│   │       ├── register/
│   │       │   └── page.tsx
│   │       ├── forgot-password/
│   │       │   └── page.tsx
│   │       ├── reset-password/
│   │       │   └── [token]/
│   │       │       └── page.tsx
│   │       ├── verify-email/
│   │       │   └── [token]/
│   │       │       └── page.tsx
│   │       ├── mfa/
│   │       │   ├── setup/
│   │       │   │   └── page.tsx
│   │       │   └── challenge/
│   │       │       └── page.tsx
│   │       └── oauth/
│   │           └── [provider]/
│   │               └── callback/
│   │                   └── page.tsx
│   │
│   ├── features/
│   │   └── auth/
│   │       ├── index.ts                      # Feature exports
│   │       │
│   │       ├── components/
│   │       │   ├── index.ts
│   │       │   ├── login-form/
│   │       │   │   ├── login-form.tsx
│   │       │   │   ├── login-form.test.tsx
│   │       │   │   ├── login-form.stories.tsx
│   │       │   │   └── index.ts
│   │       │   ├── register-form/
│   │       │   │   ├── register-form.tsx
│   │       │   │   ├── register-form.test.tsx
│   │       │   │   └── index.ts
│   │       │   ├── social-login-buttons/
│   │       │   │   ├── social-login-buttons.tsx
│   │       │   │   ├── google-button.tsx
│   │       │   │   ├── apple-button.tsx
│   │       │   │   └── index.ts
│   │       │   ├── password-input/
│   │       │   │   ├── password-input.tsx
│   │       │   │   ├── password-strength-meter.tsx
│   │       │   │   └── index.ts
│   │       │   ├── mfa-setup/
│   │       │   │   ├── mfa-setup.tsx
│   │       │   │   ├── qr-code-display.tsx
│   │       │   │   ├── backup-codes-display.tsx
│   │       │   │   └── index.ts
│   │       │   ├── mfa-input/
│   │       │   │   ├── mfa-input.tsx
│   │       │   │   ├── otp-input.tsx
│   │       │   │   └── index.ts
│   │       │   ├── session-manager/
│   │       │   │   ├── session-manager.tsx
│   │       │   │   ├── session-list.tsx
│   │       │   │   ├── session-item.tsx
│   │       │   │   └── index.ts
│   │       │   └── auth-guard/
│   │       │       ├── auth-guard.tsx
│   │       │       ├── role-guard.tsx
│   │       │       └── index.ts
│   │       │
│   │       ├── hooks/
│   │       │   ├── index.ts
│   │       │   ├── use-auth.ts               # Auth state & actions
│   │       │   ├── use-login.ts              # Login mutation
│   │       │   ├── use-register.ts           # Register mutation
│   │       │   ├── use-logout.ts             # Logout mutation
│   │       │   ├── use-session.ts            # Session management
│   │       │   ├── use-mfa.ts                # MFA operations
│   │       │   └── use-password-reset.ts     # Password reset flow
│   │       │
│   │       ├── api/
│   │       │   ├── index.ts
│   │       │   ├── auth.api.ts               # API calls
│   │       │   └── auth.types.ts             # API types
│   │       │
│   │       ├── store/
│   │       │   ├── index.ts
│   │       │   ├── auth.store.ts             # Zustand store
│   │       │   └── auth.selectors.ts         # Store selectors
│   │       │
│   │       ├── utils/
│   │       │   ├── index.ts
│   │       │   ├── token.utils.ts            # Token storage
│   │       │   └── validation.utils.ts       # Form validation
│   │       │
│   │       └── types/
│   │           ├── index.ts
│   │           └── auth.types.ts             # Type definitions
│   │
│   └── lib/
│       └── auth/
│           ├── auth-provider.tsx             # Auth context provider
│           └── protected-route.tsx           # Route protection HOC
```

## 1.5 Complete File List

```
# ============================================================================
# AUTHENTICATION MODULE - COMPLETE FILE LIST
# ============================================================================

# Backend (45 files)
backend/src/modules/auth/index.ts
backend/src/modules/auth/auth.module.ts
backend/src/modules/auth/auth.routes.ts
backend/src/modules/auth/auth.controller.ts
backend/src/modules/auth/auth.service.ts
backend/src/modules/auth/auth.repository.ts
backend/src/modules/auth/dto/index.ts
backend/src/modules/auth/dto/register.dto.ts
backend/src/modules/auth/dto/login.dto.ts
backend/src/modules/auth/dto/login-response.dto.ts
backend/src/modules/auth/dto/reset-password.dto.ts
backend/src/modules/auth/dto/change-password.dto.ts
backend/src/modules/auth/dto/change-email.dto.ts
backend/src/modules/auth/dto/verify-email.dto.ts
backend/src/modules/auth/dto/mfa-setup.dto.ts
backend/src/modules/auth/dto/mfa-verify.dto.ts
backend/src/modules/auth/dto/session.dto.ts
backend/src/modules/auth/schemas/index.ts
backend/src/modules/auth/schemas/register.schema.ts
backend/src/modules/auth/schemas/login.schema.ts
backend/src/modules/auth/schemas/password.schema.ts
backend/src/modules/auth/strategies/index.ts
backend/src/modules/auth/strategies/jwt.strategy.ts
backend/src/modules/auth/strategies/jwt-refresh.strategy.ts
backend/src/modules/auth/strategies/google.strategy.ts
backend/src/modules/auth/strategies/apple.strategy.ts
backend/src/modules/auth/strategies/twitter.strategy.ts
backend/src/modules/auth/guards/index.ts
backend/src/modules/auth/guards/jwt-auth.guard.ts
backend/src/modules/auth/guards/roles.guard.ts
backend/src/modules/auth/guards/mfa-required.guard.ts
backend/src/modules/auth/guards/email-verified.guard.ts
backend/src/modules/auth/guards/rate-limit.guard.ts
backend/src/modules/auth/services/index.ts
backend/src/modules/auth/services/token.service.ts
backend/src/modules/auth/services/session.service.ts
backend/src/modules/auth/services/mfa.service.ts
backend/src/modules/auth/services/password.service.ts
backend/src/modules/auth/services/oauth.service.ts
backend/src/modules/auth/services/verification.service.ts
backend/src/modules/auth/decorators/index.ts
backend/src/modules/auth/decorators/current-user.decorator.ts
backend/src/modules/auth/decorators/roles.decorator.ts
backend/src/modules/auth/decorators/public.decorator.ts
backend/src/modules/auth/decorators/require-mfa.decorator.ts
backend/src/modules/auth/interfaces/index.ts
backend/src/modules/auth/interfaces/jwt-payload.interface.ts
backend/src/modules/auth/interfaces/auth-user.interface.ts
backend/src/modules/auth/interfaces/oauth-profile.interface.ts
backend/src/core/security/index.ts
backend/src/core/security/encryption.service.ts
backend/src/core/security/hashing.service.ts
backend/src/core/security/jwt.service.ts
backend/src/core/security/otp.service.ts
backend/src/common/middleware/auth.middleware.ts
backend/src/common/filters/auth-exception.filter.ts

# Frontend (42 files)
frontend/src/app/(auth)/layout.tsx
frontend/src/app/(auth)/login/page.tsx
frontend/src/app/(auth)/register/page.tsx
frontend/src/app/(auth)/forgot-password/page.tsx
frontend/src/app/(auth)/reset-password/[token]/page.tsx
frontend/src/app/(auth)/verify-email/[token]/page.tsx
frontend/src/app/(auth)/mfa/setup/page.tsx
frontend/src/app/(auth)/mfa/challenge/page.tsx
frontend/src/app/(auth)/oauth/[provider]/callback/page.tsx
frontend/src/features/auth/index.ts
frontend/src/features/auth/components/index.ts
frontend/src/features/auth/components/login-form/login-form.tsx
frontend/src/features/auth/components/login-form/login-form.test.tsx
frontend/src/features/auth/components/login-form/login-form.stories.tsx
frontend/src/features/auth/components/login-form/index.ts
frontend/src/features/auth/components/register-form/register-form.tsx
frontend/src/features/auth/components/register-form/register-form.test.tsx
frontend/src/features/auth/components/register-form/index.ts
frontend/src/features/auth/components/social-login-buttons/social-login-buttons.tsx
frontend/src/features/auth/components/social-login-buttons/google-button.tsx
frontend/src/features/auth/components/social-login-buttons/apple-button.tsx
frontend/src/features/auth/components/social-login-buttons/index.ts
frontend/src/features/auth/components/password-input/password-input.tsx
frontend/src/features/auth/components/password-input/password-strength-meter.tsx
frontend/src/features/auth/components/password-input/index.ts
frontend/src/features/auth/components/mfa-setup/mfa-setup.tsx
frontend/src/features/auth/components/mfa-setup/qr-code-display.tsx
frontend/src/features/auth/components/mfa-setup/backup-codes-display.tsx
frontend/src/features/auth/components/mfa-setup/index.ts
frontend/src/features/auth/components/mfa-input/mfa-input.tsx
frontend/src/features/auth/components/mfa-input/otp-input.tsx
frontend/src/features/auth/components/mfa-input/index.ts
frontend/src/features/auth/components/session-manager/session-manager.tsx
frontend/src/features/auth/components/session-manager/session-list.tsx
frontend/src/features/auth/components/session-manager/session-item.tsx
frontend/src/features/auth/components/session-manager/index.ts
frontend/src/features/auth/components/auth-guard/auth-guard.tsx
frontend/src/features/auth/components/auth-guard/role-guard.tsx
frontend/src/features/auth/components/auth-guard/index.ts
frontend/src/features/auth/hooks/index.ts
frontend/src/features/auth/hooks/use-auth.ts
frontend/src/features/auth/hooks/use-login.ts
frontend/src/features/auth/hooks/use-register.ts
frontend/src/features/auth/hooks/use-logout.ts
frontend/src/features/auth/hooks/use-session.ts
frontend/src/features/auth/hooks/use-mfa.ts
frontend/src/features/auth/hooks/use-password-reset.ts
frontend/src/features/auth/api/index.ts
frontend/src/features/auth/api/auth.api.ts
frontend/src/features/auth/api/auth.types.ts
frontend/src/features/auth/store/index.ts
frontend/src/features/auth/store/auth.store.ts
frontend/src/features/auth/store/auth.selectors.ts
frontend/src/features/auth/utils/index.ts
frontend/src/features/auth/utils/token.utils.ts
frontend/src/features/auth/utils/validation.utils.ts
frontend/src/features/auth/types/index.ts
frontend/src/features/auth/types/auth.types.ts
frontend/src/lib/auth/auth-provider.tsx
frontend/src/lib/auth/protected-route.tsx
```

---

# 2. User Management

## 2.1 Database Schema

```prisma
// ============================================================================
// USER MANAGEMENT MODULE - SCHEMA (Optimized)
// ============================================================================

enum DataRegion {
  INDIA
  SOUTHEAST_ASIA
  EUROPE
  NORTH_AMERICA
}

enum PlatformTier {
  FREE
  STARTER
  GROWTH
  PROFESSIONAL
  ENTERPRISE
}

enum PlatformSubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  SUSPENDED
  TRIAL
}

enum BillingCycle {
  MONTHLY
  ANNUAL
  LIFETIME
}

enum CollaboratorRole {
  EDITOR
  TRANSLATOR
  ANALYST
  MANAGER
}

/// Core user profile (extends auth fields)
model User {
  // ... auth fields from Module 1 ...
  
  // Profile
  username              String      @unique
  displayName           String
  avatarUrl             String?     @db.VarChar(2048)
  bio                   String?     @db.Text
  
  // Preferences
  locale                String      @default("en") @db.Char(2)
  timezone              String      @default("Asia/Kolkata")
  preferences           Json        @default("{}")
  dataRegion            DataRegion  @default(INDIA)
  
  // Platform Subscription (for Authors)
  platformTier                 PlatformTier               @default(FREE)
  platformTierStatus           PlatformSubscriptionStatus @default(ACTIVE)
  platformTierStartedAt        DateTime?
  platformTierExpiresAt        DateTime?
  platformBillingCycle         BillingCycle?
  platformStripeCustomerId     String?
  platformStripeSubscriptionId String?
  
  // Usage Tracking (Free tier billing)
  currentMonthRevenue    BigInt    @default(0)
  currentMonthUsageFee   BigInt    @default(0)
  lastUsageFeeInvoiceAt  DateTime?
  
  // Tier Limits (cached for performance)
  seriesCount              Int       @default(0) @db.SmallInt
  totalChapterCount        Int       @default(0)
  activeSubscriberCount    Int       @default(0)
  storageUsedBytes         BigInt    @default(0)
  bandwidthUsedBytes       BigInt    @default(0)
  emailBroadcastsThisMonth Int       @default(0) @db.SmallInt
  
  // AI Usage (monthly quotas)
  aiTranslationWordsUsed Int       @default(0)
  aiWritingTokensUsed    Int       @default(0)
  aiCoverGenerationsUsed Int       @default(0)
  aiUsageResetAt         DateTime?
  
  // Referral Program
  referralCode         String?     @unique
  referredById         BigInt?
  referralRewardMonths Int         @default(0) @db.SmallInt

  // Self-referential
  referredBy           User?       @relation("UserReferrals", fields: [referredById], references: [id], onDelete: SetNull)
  referrals            User[]      @relation("UserReferrals")
  
  // Profile Relations
  authorProfile        AuthorProfile?
  collaborations       Collaborator[]

  @@index([username])
  @@index([referredById])
  @@index([platformTier, platformTierStatus])
  @@map("users")
}

/// Extended author profile information
model AuthorProfile {
  id                BigInt    @id @default(autoincrement())
  userId            BigInt    @unique
  
  // Identity
  penName           String?
  tagline           String?   @db.VarChar(200)
  fullBio           String?   @db.Text
  
  // Social links
  websiteUrl        String?   @db.VarChar(2048)
  twitterHandle     String?   @db.VarChar(50)
  instagramHandle   String?   @db.VarChar(50)
  tiktokHandle      String?   @db.VarChar(50)
  youtubeChannel    String?   @db.VarChar(2048)
  discordServer     String?   @db.VarChar(2048)
  patreonPage       String?   @db.VarChar(2048)
  kofiPage          String?   @db.VarChar(2048)
  
  // Writing profile
  genres            String[]  @default([])
  primaryGenre      String?
  writingSince      DateTime?
  
  // Verification
  isVerified        Boolean   @default(false)
  verifiedAt        DateTime?
  verificationNote  String?
  
  // Commissions
  acceptingCommissions Boolean @default(false)
  commissionInfo       String? @db.Text
  commissionMinPrice   Int?
  commissionMaxPrice   Int?
  commissionCurrency   String  @default("INR") @db.Char(3)
  
  // Privacy settings
  allowDirectMessages Boolean @default(true)
  showEmail           Boolean @default(false)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isVerified])
  @@index([primaryGenre])
  @@map("author_profiles")
}

/// Team collaborators on a site
model Collaborator {
  id                BigInt           @id @default(autoincrement())
  siteId            String
  userId            BigInt
  
  role              CollaboratorRole
  permissions       Json             @default("{}")
  
  // Invitation flow
  invitedByEmail    String?
  inviteToken       String?          @unique
  invitedAt         DateTime         @default(now())
  acceptedAt        DateTime?
  expiresAt         DateTime?
  
  // Status
  isActive          Boolean          @default(true)
  deactivatedAt     DateTime?
  deactivatedReason String?
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Relations
  site              Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([siteId, userId])
  @@index([siteId, isActive])
  @@map("collaborators")
}
```

## 2.2 API Endpoints

```yaml
# ============================================================================
# USER MANAGEMENT MODULE - API ENDPOINTS
# ============================================================================

Users:
  Public:
    - GET    /api/v1/users/:username                   # Get public profile
    - GET    /api/v1/users/:username/series            # Get user's public series
    - GET    /api/v1/users/:username/stats             # Get public stats

  Authenticated (Own Profile):
    - GET    /api/v1/users/me                          # Get current user full profile
    - PATCH  /api/v1/users/me                          # Update profile
    - POST   /api/v1/users/me/avatar                   # Upload avatar
    - DELETE /api/v1/users/me/avatar                   # Remove avatar
    - GET    /api/v1/users/me/preferences              # Get preferences
    - PATCH  /api/v1/users/me/preferences              # Update preferences
    - GET    /api/v1/users/me/connected-accounts       # List OAuth accounts
    - POST   /api/v1/users/me/connected-accounts/:provider   # Connect OAuth
    - DELETE /api/v1/users/me/connected-accounts/:provider   # Disconnect OAuth
    - GET    /api/v1/users/me/usage                    # Get usage stats (tier limits)
    - GET    /api/v1/users/me/tier                     # Get current tier details

Author Profile:
    - GET    /api/v1/author-profile                    # Get own author profile
    - POST   /api/v1/author-profile                    # Create author profile (become author)
    - PATCH  /api/v1/author-profile                    # Update author profile
    - GET    /api/v1/authors/:userId                   # Get author profile (public)
    - GET    /api/v1/authors/:userId/sites             # Get author's sites (public)

Collaborators:
    - GET    /api/v1/sites/:siteId/collaborators                       # List collaborators
    - POST   /api/v1/sites/:siteId/collaborators                       # Invite collaborator
    - GET    /api/v1/sites/:siteId/collaborators/:collaboratorId       # Get collaborator
    - PATCH  /api/v1/sites/:siteId/collaborators/:collaboratorId       # Update role/permissions
    - DELETE /api/v1/sites/:siteId/collaborators/:collaboratorId       # Remove collaborator
    - POST   /api/v1/sites/:siteId/collaborators/:collaboratorId/resend-invite  # Resend invite

Invitations:
    - GET    /api/v1/collaborator-invites              # List my pending invites
    - GET    /api/v1/collaborator-invites/:token       # Get invite details
    - POST   /api/v1/collaborator-invites/:token/accept   # Accept invite
    - POST   /api/v1/collaborator-invites/:token/decline  # Decline invite
```

## 2.3 Backend Folder Structure

```
backend/
├── src/
│   └── modules/
│       ├── users/
│       │   ├── index.ts
│       │   ├── users.module.ts
│       │   ├── users.routes.ts
│       │   ├── users.controller.ts
│       │   ├── users.service.ts
│       │   ├── users.repository.ts
│       │   │
│       │   ├── dto/
│       │   │   ├── index.ts
│       │   │   ├── update-user.dto.ts
│       │   │   ├── update-preferences.dto.ts
│       │   │   ├── user-response.dto.ts
│       │   │   ├── user-public.dto.ts
│       │   │   └── usage-stats.dto.ts
│       │   │
│       │   ├── schemas/
│       │   │   ├── index.ts
│       │   │   ├── update-user.schema.ts
│       │   │   └── preferences.schema.ts
│       │   │
│       │   └── services/
│       │       ├── index.ts
│       │       ├── avatar.service.ts
│       │       ├── preferences.service.ts
│       │       └── usage-tracking.service.ts
│       │
│       ├── author-profiles/
│       │   ├── index.ts
│       │   ├── author-profiles.module.ts
│       │   ├── author-profiles.routes.ts
│       │   ├── author-profiles.controller.ts
│       │   ├── author-profiles.service.ts
│       │   ├── author-profiles.repository.ts
│       │   │
│       │   ├── dto/
│       │   │   ├── index.ts
│       │   │   ├── create-author-profile.dto.ts
│       │   │   ├── update-author-profile.dto.ts
│       │   │   └── author-profile-response.dto.ts
│       │   │
│       │   └── schemas/
│       │       ├── index.ts
│       │       └── author-profile.schema.ts
│       │
│       └── collaborators/
│           ├── index.ts
│           ├── collaborators.module.ts
│           ├── collaborators.routes.ts
│           ├── collaborators.controller.ts
│           ├── collaborators.service.ts
│           ├── collaborators.repository.ts
│           │
│           ├── dto/
│           │   ├── index.ts
│           │   ├── invite-collaborator.dto.ts
│           │   ├── update-collaborator.dto.ts
│           │   └── collaborator-response.dto.ts
│           │
│           ├── schemas/
│           │   ├── index.ts
│           │   └── invite.schema.ts
│           │
│           └── services/
│               ├── index.ts
│               └── invitation.service.ts
```

## 2.4 Frontend Folder Structure

```
frontend/
├── src/
│   ├── app/
│   │   ├── (dashboard)/
│   │   │   └── dashboard/
│   │   │       ├── account/
│   │   │       │   ├── page.tsx                      # Account overview
│   │   │       │   ├── profile/
│   │   │       │   │   └── page.tsx                  # Edit profile
│   │   │       │   ├── author-profile/
│   │   │       │   │   └── page.tsx                  # Author profile settings
│   │   │       │   ├── security/
│   │   │       │   │   └── page.tsx                  # Security settings
│   │   │       │   ├── sessions/
│   │   │       │   │   └── page.tsx                  # Active sessions
│   │   │       │   ├── connected/
│   │   │       │   │   └── page.tsx                  # Connected accounts
│   │   │       │   ├── preferences/
│   │   │       │   │   └── page.tsx                  # Preferences
│   │   │       │   └── usage/
│   │   │       │       └── page.tsx                  # Usage & limits
│   │   │       │
│   │   │       └── team/
│   │   │           ├── page.tsx                      # Team members list
│   │   │           ├── invite/
│   │   │           │   └── page.tsx                  # Invite collaborator
│   │   │           └── [collaboratorId]/
│   │   │               └── page.tsx                  # Edit collaborator
│   │   │
│   │   └── (reader)/
│   │       └── account/
│   │           └── settings/
│   │               ├── page.tsx                      # Reader settings
│   │               ├── profile/
│   │               │   └── page.tsx
│   │               └── privacy/
│   │                   └── page.tsx
│   │
│   └── features/
│       └── users/
│           ├── index.ts
│           │
│           ├── components/
│           │   ├── index.ts
│           │   ├── user-avatar/
│           │   │   ├── user-avatar.tsx
│           │   │   ├── avatar-upload.tsx
│           │   │   ├── avatar-cropper.tsx
│           │   │   └── index.ts
│           │   ├── user-profile-card/
│           │   │   ├── user-profile-card.tsx
│           │   │   ├── user-profile-card-skeleton.tsx
│           │   │   └── index.ts
│           │   ├── user-profile-form/
│           │   │   ├── user-profile-form.tsx
│           │   │   └── index.ts
│           │   ├── author-profile-form/
│           │   │   ├── author-profile-form.tsx
│           │   │   ├── social-links-input.tsx
│           │   │   ├── genres-selector.tsx
│           │   │   └── index.ts
│           │   ├── preferences-form/
│           │   │   ├── preferences-form.tsx
│           │   │   ├── locale-selector.tsx
│           │   │   ├── timezone-selector.tsx
│           │   │   ├── notification-settings.tsx
│           │   │   └── index.ts
│           │   ├── team-member-list/
│           │   │   ├── team-member-list.tsx
│           │   │   ├── team-member-card.tsx
│           │   │   ├── role-badge.tsx
│           │   │   └── index.ts
│           │   ├── invite-collaborator-dialog/
│           │   │   ├── invite-collaborator-dialog.tsx
│           │   │   ├── role-selector.tsx
│           │   │   ├── permissions-matrix.tsx
│           │   │   └── index.ts
│           │   ├── connected-accounts/
│           │   │   ├── connected-accounts.tsx
│           │   │   ├── account-card.tsx
│           │   │   └── index.ts
│           │   └── usage-display/
│           │       ├── usage-display.tsx
│           │       ├── usage-meter.tsx
│           │       ├── tier-limits-card.tsx
│           │       └── index.ts
│           │
│           ├── hooks/
│           │   ├── index.ts
│           │   ├── use-user.ts
│           │   ├── use-user-profile.ts
│           │   ├── use-author-profile.ts
│           │   ├── use-collaborators.ts
│           │   ├── use-preferences.ts
│           │   ├── use-usage.ts
│           │   └── use-connected-accounts.ts
│           │
│           ├── api/
│           │   ├── index.ts
│           │   ├── users.api.ts
│           │   ├── author-profiles.api.ts
│           │   └── collaborators.api.ts
│           │
│           ├── store/
│           │   ├── index.ts
│           │   └── user.store.ts
│           │
│           └── types/
│               ├── index.ts
│               ├── user.types.ts
│               ├── author-profile.types.ts
│               └── collaborator.types.ts
```

---

# 3. Site Management

## 3.1 Database Schema

```prisma
// ============================================================================
// SITE MANAGEMENT MODULE - SCHEMA (Optimized)
// ============================================================================

enum SiteStatus {
  ACTIVE
  MAINTENANCE
  SUSPENDED
  DELETED
}

enum ContentRating {
  EVERYONE
  TEEN
  MATURE
}

/// Author's website/storefront
model Site {
  id                    String       @id @default(cuid())
  authorId              BigInt
  
  // Identity
  slug                  String       @unique
  name                  String       @db.VarChar(100)
  tagline               String?      @db.VarChar(200)
  description           String?      @db.Text
  
  // Branding
  logoUrl               String?      @db.VarChar(2048)
  faviconUrl            String?      @db.VarChar(2048)
  coverImageUrl         String?      @db.VarChar(2048)
  
  // Theme
  themeId               String?
  primaryColor          String?      @db.Char(7)
  secondaryColor        String?      @db.Char(7)
  accentColor           String?      @db.Char(7)
  customFonts           Json?
  customCss             String?      @db.Text
  customCssEnabled      Boolean      @default(false)
  
  // Custom domain
  customDomain          String?      @unique @db.VarChar(253)
  customDomainVerified  Boolean      @default(false)
  customDomainVerifiedAt DateTime?
  customDomainDnsRecords Json?
  sslEnabled            Boolean      @default(true)
  sslExpiresAt          DateTime?
  
  // Status
  status                SiteStatus   @default(ACTIVE)
  isPublic              Boolean      @default(true)
  maintenanceMode       Boolean      @default(false)
  maintenanceMessage    String?      @db.Text
  suspensionReason      String?
  
  // SEO
  metaTitle             String?      @db.VarChar(60)
  metaDescription       String?      @db.VarChar(160)
  ogImageUrl            String?      @db.VarChar(2048)
  canonicalUrl          String?      @db.VarChar(2048)
  
  // Social links
  socialLinks           Json?
  
  // Analytics integration
  googleAnalyticsId     String?
  facebookPixelId       String?
  customTrackingCode    String?      @db.Text
  analyticsEnabled      Boolean      @default(true)
  
  // Content settings
  defaultContentRating  ContentRating @default(EVERYONE)
  commentsEnabled       Boolean      @default(true)
  commentsModerationMode String      @default("post")
  
  // Activity tracking
  lastPublishedAt       DateTime?
  
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  // Relations
  author                User         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  theme                 Theme?       @relation(fields: [themeId], references: [id], onDelete: SetNull)
  series                Series[]
  pages                 Page[]
  announcements         Announcement[]
  collaborators         Collaborator[]
  subscriptionTiers     AuthorSubscriptionTier[]
  discountCodes         DiscountCode[]
  products              Product[]
  outgoingWebhooks      OutgoingWebhook[]
  socialConnections     SocialConnection[]
  apiKeys               APIKey[]
  mediaFiles            MediaFile[]
  calendarEntries       ContentCalendarEntry[]
  importJobs            ImportJob[]
  exportJobs            ExportJob[]
  abTests               ABTest[]

  @@unique([authorId, slug])
  @@index([authorId])
  @@index([slug])
  @@index([customDomain])
  @@index([status, isPublic])
  @@map("sites")
}

/// Custom static pages on author site
model Page {
  id                String    @id @default(cuid())
  siteId            String
  
  slug              String    @db.VarChar(100)
  title             String    @db.VarChar(100)
  content           String    @db.Text
  contentHtml       String?   @db.Text
  
  isPublished       Boolean   @default(false)
  publishedAt       DateTime?
  
  // Navigation
  showInNav         Boolean   @default(false)
  navOrder          Int       @default(0) @db.SmallInt
  navLabel          String?   @db.VarChar(30)
  
  // SEO
  metaTitle         String?   @db.VarChar(60)
  metaDescription   String?   @db.VarChar(160)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  site              Site      @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([siteId, slug])
  @@index([siteId, isPublished, navOrder])
  @@map("pages")
}

/// Site theme templates
model Theme {
  id                String        @id @default(cuid())
  name              String
  slug              String        @unique
  description       String?       @db.Text
  
  thumbnailUrl      String?       @db.VarChar(2048)
  previewUrl        String?       @db.VarChar(2048)
  
  // Configuration
  styles            Json
  colorSchemes      Json?
  fontOptions       Json?
  layoutOptions     Json?
  
  // Availability
  isPublic          Boolean       @default(true)
  isPremium         Boolean       @default(false)
  requiredTier      PlatformTier?
  
  usageCount        Int           @default(0)
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  sites             Site[]

  @@index([slug])
  @@index([isPublic, isPremium])
  @@map("themes")
}
```

## 3.2 API Endpoints

```yaml
# ============================================================================
# SITE MANAGEMENT MODULE - API ENDPOINTS
# ============================================================================

Sites:
  Management:
    - GET    /api/v1/sites                             # List own sites
    - POST   /api/v1/sites                             # Create new site
    - GET    /api/v1/sites/:siteId                     # Get site details
    - PATCH  /api/v1/sites/:siteId                     # Update site
    - DELETE /api/v1/sites/:siteId                     # Delete site (soft)
    - POST   /api/v1/sites/:siteId/restore             # Restore deleted site

  Settings:
    - GET    /api/v1/sites/:siteId/settings            # Get all settings
    - PATCH  /api/v1/sites/:siteId/settings            # Update settings
    - PATCH  /api/v1/sites/:siteId/settings/comments   # Comment settings
    - PATCH  /api/v1/sites/:siteId/settings/content    # Content settings

  Branding:
    - GET    /api/v1/sites/:siteId/branding            # Get branding
    - PATCH  /api/v1/sites/:siteId/branding            # Update branding
    - POST   /api/v1/sites/:siteId/branding/logo       # Upload logo
    - DELETE /api/v1/sites/:siteId/branding/logo       # Remove logo
    - POST   /api/v1/sites/:siteId/branding/favicon    # Upload favicon
    - DELETE /api/v1/sites/:siteId/branding/favicon    # Remove favicon
    - POST   /api/v1/sites/:siteId/branding/cover      # Upload cover
    - DELETE /api/v1/sites/:siteId/branding/cover      # Remove cover
    - POST   /api/v1/sites/:siteId/branding/og-image   # Upload OG image

  Theme:
    - GET    /api/v1/sites/:siteId/theme               # Get current theme
    - PATCH  /api/v1/sites/:siteId/theme               # Update theme
    - GET    /api/v1/sites/:siteId/theme/preview       # Preview theme changes

  Domain:
    - GET    /api/v1/sites/:siteId/domain              # Get domain settings
    - POST   /api/v1/sites/:siteId/domain              # Set custom domain
    - DELETE /api/v1/sites/:siteId/domain              # Remove custom domain
    - POST   /api/v1/sites/:siteId/domain/verify       # Verify DNS
    - GET    /api/v1/sites/:siteId/domain/dns-records  # Get required DNS records
    - GET    /api/v1/sites/:siteId/domain/ssl-status   # Check SSL status

  Analytics Integration:
    - GET    /api/v1/sites/:siteId/integrations        # Get all integrations
    - PATCH  /api/v1/sites/:siteId/integrations        # Update integrations
    - POST   /api/v1/sites/:siteId/integrations/verify # Verify integration

  Public:
    - GET    /api/v1/sites/by-slug/:slug               # Get by slug (public)
    - GET    /api/v1/sites/by-domain/:domain           # Get by domain (public)
    - GET    /api/v1/sites/:siteId/public              # Get public site info

Themes:
    - GET    /api/v1/themes                            # List available themes
    - GET    /api/v1/themes/:themeId                   # Get theme details
    - GET    /api/v1/themes/:themeId/preview           # Get preview URL
    - GET    /api/v1/themes/categories                 # Get theme categories

Pages:
    - GET    /api/v1/sites/:siteId/pages               # List pages
    - POST   /api/v1/sites/:siteId/pages               # Create page
    - GET    /api/v1/sites/:siteId/pages/:pageId       # Get page
    - PATCH  /api/v1/sites/:siteId/pages/:pageId       # Update page
    - DELETE /api/v1/sites/:siteId/pages/:pageId       # Delete page
    - POST   /api/v1/sites/:siteId/pages/:pageId/publish     # Publish
    - POST   /api/v1/sites/:siteId/pages/:pageId/unpublish   # Unpublish
    - POST   /api/v1/sites/:siteId/pages/:pageId/duplicate   # Duplicate page
    - PATCH  /api/v1/sites/:siteId/pages/reorder       # Reorder pages
    - GET    /api/v1/sites/:siteId/pages/by-slug/:slug # Get by slug (public)
```

## 3.3 Backend Folder Structure

```
backend/
├── src/
│   └── modules/
│       ├── sites/
│       │   ├── index.ts
│       │   ├── sites.module.ts
│       │   ├── sites.routes.ts
│       │   ├── sites.controller.ts
│       │   ├── sites.service.ts
│       │   ├── sites.repository.ts
│       │   │
│       │   ├── dto/
│       │   │   ├── index.ts
│       │   │   ├── create-site.dto.ts
│       │   │   ├── update-site.dto.ts
│       │   │   ├── update-branding.dto.ts
│       │   │   ├── update-domain.dto.ts
│       │   │   ├── update-theme.dto.ts
│       │   │   ├── update-integrations.dto.ts
│       │   │   └── site-response.dto.ts
│       │   │
│       │   ├── schemas/
│       │   │   ├── index.ts
│       │   │   ├── create-site.schema.ts
│       │   │   ├── update-site.schema.ts
│       │   │   └── domain.schema.ts
│       │   │
│       │   └── services/
│       │       ├── index.ts
│       │       ├── domain.service.ts
│       │       ├── dns-verification.service.ts
│       │       ├── ssl-certificate.service.ts
│       │       ├── branding.service.ts
│       │       └── site-resolution.service.ts
│       │
│       ├── pages/
│       │   ├── index.ts
│       │   ├── pages.module.ts
│       │   ├── pages.routes.ts
│       │   ├── pages.controller.ts
│       │   ├── pages.service.ts
│       │   ├── pages.repository.ts
│       │   │
│       │   ├── dto/
│       │   │   ├── index.ts
│       │   │   ├── create-page.dto.ts
│       │   │   ├── update-page.dto.ts
│       │   │   └── page-response.dto.ts
│       │   │
│       │   └── schemas/
│       │       ├── index.ts
│       │       └── page.schema.ts
│       │
│       └── themes/
│           ├── index.ts
│           ├── themes.module.ts
│           ├── themes.routes.ts
│           ├── themes.controller.ts
│           ├── themes.service.ts
│           ├── themes.repository.ts
│           │
│           ├── dto/
│           │   ├── index.ts
│           │   └── theme-response.dto.ts
│           │
│           └── schemas/
│               └── index.ts
```

## 3.4 Frontend Folder Structure

```
frontend/
├── src/
│   ├── app/
│   │   ├── (dashboard)/
│   │   │   └── dashboard/
│   │   │       └── sites/
│   │   │           ├── page.tsx                       # Sites list
│   │   │           ├── new/
│   │   │           │   └── page.tsx                   # Create site wizard
│   │   │           └── [siteId]/
│   │   │               ├── page.tsx                   # Site overview
│   │   │               ├── settings/
│   │   │               │   └── page.tsx               # General settings
│   │   │               ├── branding/
│   │   │               │   └── page.tsx               # Logo, colors, fonts
│   │   │               ├── theme/
│   │   │               │   └── page.tsx               # Theme selection
│   │   │               ├── domain/
│   │   │               │   └── page.tsx               # Custom domain
│   │   │               ├── seo/
│   │   │               │   └── page.tsx               # SEO settings
│   │   │               ├── integrations/
│   │   │               │   └── page.tsx               # Analytics, tracking
│   │   │               ├── pages/
│   │   │               │   ├── page.tsx               # Pages list
│   │   │               │   ├── new/
│   │   │               │   │   └── page.tsx           # Create page
│   │   │               │   └── [pageId]/
│   │   │               │       └── edit/
│   │   │               │           └── page.tsx       # Edit page
│   │   │               └── navigation/
│   │   │                   └── page.tsx               # Nav ordering
│   │   │
│   │   └── (sites)/
│   │       └── [site]/
│   │           ├── layout.tsx                         # Site layout
│   │           ├── page.tsx                           # Site homepage
│   │           ├── about/
│   │           │   └── page.tsx
│   │           └── [pageSlug]/
│   │               └── page.tsx                       # Dynamic page
│   │
│   └── features/
│       └── sites/
│           ├── index.ts
│           │
│           ├── components/
│           │   ├── index.ts
│           │   ├── site-card/
│           │   │   ├── site-card.tsx
│           │   │   ├── site-card-skeleton.tsx
│           │   │   └── index.ts
│           │   ├── site-list/
│           │   │   ├── site-list.tsx
│           │   │   └── index.ts
│           │   ├── create-site-wizard/
│           │   │   ├── create-site-wizard.tsx
│           │   │   ├── step-identity.tsx
│           │   │   ├── step-theme.tsx
│           │   │   ├── step-domain.tsx
│           │   │   └── index.ts
│           │   ├── site-settings-form/
│           │   │   ├── site-settings-form.tsx
│           │   │   └── index.ts
│           │   ├── branding-editor/
│           │   │   ├── branding-editor.tsx
│           │   │   ├── logo-uploader.tsx
│           │   │   ├── favicon-uploader.tsx
│           │   │   ├── color-picker.tsx
│           │   │   ├── font-selector.tsx
│           │   │   ├── css-editor.tsx
│           │   │   └── index.ts
│           │   ├── theme-selector/
│           │   │   ├── theme-selector.tsx
│           │   │   ├── theme-card.tsx
│           │   │   ├── theme-preview.tsx
│           │   │   ├── theme-customizer.tsx
│           │   │   └── index.ts
│           │   ├── domain-settings/
│           │   │   ├── domain-settings.tsx
│           │   │   ├── dns-records-display.tsx
│           │   │   ├── verification-status.tsx
│           │   │   ├── ssl-status.tsx
│           │   │   └── index.ts
│           │   ├── page-editor/
│           │   │   ├── page-editor.tsx
│           │   │   ├── page-preview.tsx
│           │   │   └── index.ts
│           │   ├── page-list/
│           │   │   ├── page-list.tsx
│           │   │   ├── page-card.tsx
│           │   │   ├── page-reorder.tsx
│           │   │   └── index.ts
│           │   ├── seo-settings/
│           │   │   ├── seo-settings.tsx
│           │   │   ├── og-image-preview.tsx
│           │   │   ├── meta-preview.tsx
│           │   │   └── index.ts
│           │   └── integrations-panel/
│           │       ├── integrations-panel.tsx
│           │       ├── google-analytics-setup.tsx
│           │       ├── facebook-pixel-setup.tsx
│           │       └── index.ts
│           │
│           ├── hooks/
│           │   ├── index.ts
│           │   ├── use-site.ts
│           │   ├── use-sites.ts
│           │   ├── use-create-site.ts
│           │   ├── use-theme.ts
│           │   ├── use-themes.ts
│           │   ├── use-pages.ts
│           │   ├── use-domain.ts
│           │   └── use-site-settings.ts
│           │
│           ├── api/
│           │   ├── index.ts
│           │   ├── sites.api.ts
│           │   ├── themes.api.ts
│           │   └── pages.api.ts
│           │
│           ├── store/
│           │   ├── index.ts
│           │   └── site.store.ts
│           │
│           └── types/
│               ├── index.ts
│               ├── site.types.ts
│               ├── theme.types.ts
│               └── page.types.ts
```

---

# 4. Content Management (Series)

## 4.1 Database Schema

```prisma
// ============================================================================
// SERIES MODULE - SCHEMA (Optimized)
// ============================================================================

enum ContentType {
  WEB_NOVEL
  WEBTOON
  MANGA
  MANHWA
  WESTERN_COMIC
}

enum SeriesStatus {
  DRAFT
  ONGOING
  HIATUS
  COMPLETED
  CANCELLED
}

enum ReadingDirection {
  LTR       // Left to right (Western)
  RTL       // Right to left (Manga)
  VERTICAL  // Top to bottom (Webtoon)
}

enum ChapterAccessLevel {
  FREE            // Accessible to everyone
  SUBSCRIBERS     // Any paid subscriber
  SPECIFIC_TIER   // Specific tier or higher
  SCHEDULED_FREE  // Will become free on scheduled date
}

/// A story/comic series
model Series {
  id                    String           @id @default(cuid())
  authorId              BigInt
  siteId                String
  
  // Identity
  slug                  String           @unique
  title                 String           @db.VarChar(200)
  synopsis              String           @db.Text
  
  // Images
  coverImageUrl         String?          @db.VarChar(2048)
  coverImageId          String?
  bannerImageUrl        String?          @db.VarChar(2048)
  thumbnailUrl          String?          @db.VarChar(2048)
  
  // Classification
  contentType           ContentType      @default(WEB_NOVEL)
  contentRating         ContentRating    @default(EVERYONE)
  status                SeriesStatus     @default(DRAFT)
  language              String           @default("en") @db.Char(2)
  originalLanguage      String           @default("en") @db.Char(2)
  readingDirection      ReadingDirection @default(LTR)
  
  // Stats (kept for sorting/filtering performance)
  viewCount             BigInt           @default(0)
  subscriberCount       Int              @default(0)
  averageRating         Float            @default(0)
  
  // Schedule
  updateSchedule        String?
  updateDays            Int[]            @default([])
  lastPublishedAt       DateTime?
  nextScheduledAt       DateTime?
  
  // Monetization
  defaultAccessLevel    ChapterAccessLevel @default(FREE)
  earlyAccessDays       Int              @default(0) @db.SmallInt
  previewParagraphs     Int              @default(3) @db.SmallInt
  paywallMessage        String?          @db.Text
  
  // Discovery
  isListed              Boolean          @default(false)
  listingScore          Float            @default(0)
  trendingScore         Float            @default(0)
  featuredAt            DateTime?
  featuredUntil         DateTime?
  featuredType          String?
  
  // SEO
  metaTitle             String?          @db.VarChar(60)
  metaDescription       String?          @db.VarChar(160)
  canonicalUrl          String?          @db.VarChar(2048)
  
  // Completion
  isComplete            Boolean          @default(false)
  completedAt           DateTime?
  totalPlannedChapters  Int?
  
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  deletedAt             DateTime?        // Soft delete

  // Relations
  author                User             @relation(fields: [authorId], references: [id], onDelete: Cascade)
  site                  Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)
  chapters              Chapter[]
  genres                SeriesGenre[]
  tags                  SeriesTag[]
  reviews               Review[]
  readingProgress       ReadingProgress[]
  bookmarks             Bookmark[]
  contentWarnings       SeriesContentWarning[]
  translations          SeriesTranslation[]
  translationGlossary   TranslationGlossary[]
  aiWritingSessions     AIWritingSession[]
  readingListItems      ReadingListItem[]
  readerEngagementScores ReaderEngagementScore[]
  writingGoals          WritingGoal[]
  calendarEntries       ContentCalendarEntry[]
  importJobs            ImportJob[]
  exportJobs            ExportJob[]

  @@unique([siteId, slug])
  @@index([authorId])
  @@index([siteId, status])
  @@index([contentType, language, isListed])
  @@index([isListed, status, trendingScore(sort: Desc)])
  @@index([viewCount(sort: Desc)])
  @@index([subscriberCount(sort: Desc)])
  @@index([deletedAt])
  @@map("series")
}

/// Genre categories for content discovery
model Genre {
  id                String        @id @default(cuid())
  name              String        @unique
  slug              String        @unique
  description       String?       @db.Text
  iconUrl           String?       @db.VarChar(2048)
  color             String?       @db.Char(7)
  
  // Hierarchy
  parentId          String?
  
  displayOrder      Int           @default(0) @db.SmallInt
  isActive          Boolean       @default(true)
  isFeatured        Boolean       @default(false)
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  parent            Genre?        @relation("GenreHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children          Genre[]       @relation("GenreHierarchy")
  series            SeriesGenre[]

  @@index([slug])
  @@index([isActive, displayOrder])
  @@map("genres")
}

/// Many-to-many: Series <-> Genre (Composite PK)
model SeriesGenre {
  seriesId          String
  genreId           String
  isPrimary         Boolean       @default(false)
  createdAt         DateTime      @default(now())

  // Relations
  series            Series        @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  genre             Genre         @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@id([seriesId, genreId])
  @@index([genreId])
  @@map("series_genres")
}

/// Tags for fine-grained content discovery
model Tag {
  id                String        @id @default(cuid())
  name              String        @unique
  slug              String        @unique
  
  usageCount        Int           @default(0)
  isApproved        Boolean       @default(true)
  isBlocked         Boolean       @default(false)
  
  createdAt         DateTime      @default(now())

  // Relations
  series            SeriesTag[]

  @@index([slug])
  @@index([usageCount(sort: Desc)])
  @@map("tags")
}

/// Many-to-many: Series <-> Tag (Composite PK)
model SeriesTag {
  seriesId          String
  tagId             String
  createdAt         DateTime      @default(now())

  // Relations
  series            Series        @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  tag               Tag           @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([seriesId, tagId])
  @@index([tagId])
  @@map("series_tags")
}
```

## 4.2 API Endpoints

```yaml
# ============================================================================
# SERIES MODULE - API ENDPOINTS
# ============================================================================

Series:
  Management:
    - GET    /api/v1/sites/:siteId/series              # List series in site
    - POST   /api/v1/sites/:siteId/series              # Create series
    - GET    /api/v1/series/:seriesId                  # Get series details
    - PATCH  /api/v1/series/:seriesId                  # Update series
    - DELETE /api/v1/series/:seriesId                  # Soft delete series
    - POST   /api/v1/series/:seriesId/restore          # Restore deleted series
    - POST   /api/v1/series/:seriesId/duplicate        # Duplicate series

  Media:
    - POST   /api/v1/series/:seriesId/cover            # Upload cover image
    - DELETE /api/v1/series/:seriesId/cover            # Remove cover
    - POST   /api/v1/series/:seriesId/banner           # Upload banner
    - DELETE /api/v1/series/:seriesId/banner           # Remove banner
    - POST   /api/v1/series/:seriesId/thumbnail        # Upload thumbnail
    - DELETE /api/v1/series/:seriesId/thumbnail        # Remove thumbnail

  Settings:
    - GET    /api/v1/series/:seriesId/settings         # Get all settings
    - PATCH  /api/v1/series/:seriesId/settings         # Update settings
    - GET    /api/v1/series/:seriesId/paywall          # Get paywall settings
    - PATCH  /api/v1/series/:seriesId/paywall          # Update paywall
    - GET    /api/v1/series/:seriesId/schedule         # Get schedule settings
    - PATCH  /api/v1/series/:seriesId/schedule         # Update schedule

  Status:
    - POST   /api/v1/series/:seriesId/publish          # Publish series
    - POST   /api/v1/series/:seriesId/unpublish        # Unpublish series
    - POST   /api/v1/series/:seriesId/complete         # Mark as complete
    - POST   /api/v1/series/:seriesId/hiatus           # Set to hiatus
    - POST   /api/v1/series/:seriesId/resume           # Resume from hiatus

  Discovery:
    - POST   /api/v1/series/:seriesId/list             # List on discovery forum
    - POST   /api/v1/series/:seriesId/unlist           # Remove from forum
    - GET    /api/v1/series/:seriesId/listing-score    # Get listing score
    - GET    /api/v1/series/:seriesId/ranking          # Get ranking info

  Stats:
    - GET    /api/v1/series/:seriesId/stats            # Get series stats
    - GET    /api/v1/series/:seriesId/stats/detailed   # Detailed analytics

  Public:
    - GET    /api/v1/sites/:siteId/series/public       # List public series
    - GET    /api/v1/sites/:siteId/series/by-slug/:slug  # Get by slug
    - GET    /api/v1/series/:seriesId/public           # Get public info

Genres:
    - GET    /api/v1/genres                            # List all genres
    - GET    /api/v1/genres/featured                   # Get featured genres
    - GET    /api/v1/genres/:genreId                   # Get genre details
    - GET    /api/v1/genres/:genreId/series            # Get series in genre
    - GET    /api/v1/genres/:genreId/children          # Get sub-genres

Tags:
    - GET    /api/v1/tags                              # List popular tags
    - GET    /api/v1/tags/search                       # Search tags
    - GET    /api/v1/tags/:tagSlug                     # Get tag details
    - GET    /api/v1/tags/:tagSlug/series              # Get series with tag
    - POST   /api/v1/tags                              # Create tag (if allowed)

Series Genres/Tags:
    - GET    /api/v1/series/:seriesId/genres           # Get series genres
    - PUT    /api/v1/series/:seriesId/genres           # Set genres (replace)
    # 4. Content Management (Series) - Continued

## 4.2 API Endpoints (Continued)

```yaml
Series Genres/Tags (continued):
    - POST   /api/v1/series/:seriesId/genres           # Add genre
    - DELETE /api/v1/series/:seriesId/genres/:genreId  # Remove genre
    - GET    /api/v1/series/:seriesId/tags             # Get series tags
    - PUT    /api/v1/series/:seriesId/tags             # Set tags (replace)
    - POST   /api/v1/series/:seriesId/tags             # Add tag
    - DELETE /api/v1/series/:seriesId/tags/:tagId      # Remove tag

Content Warnings:
    - GET    /api/v1/series/:seriesId/warnings         # Get content warnings
    - PUT    /api/v1/series/:seriesId/warnings         # Set warnings
    - POST   /api/v1/series/:seriesId/warnings         # Add warning
    - DELETE /api/v1/series/:seriesId/warnings/:warningId  # Remove warning
    - GET    /api/v1/content-warnings                  # List all warning types
```

## 4.3 Backend Folder Structure

```
backend/
├── src/
│   └── modules/
│       ├── series/
│       │   ├── index.ts
│       │   ├── series.module.ts
│       │   ├── series.routes.ts
│       │   ├── series.controller.ts
│       │   ├── series.service.ts
│       │   ├── series.repository.ts
│       │   │
│       │   ├── dto/
│       │   │   ├── index.ts
│       │   │   ├── create-series.dto.ts
│       │   │   ├── update-series.dto.ts
│       │   │   ├── update-paywall.dto.ts
│       │   │   ├── update-schedule.dto.ts
│       │   │   ├── series-response.dto.ts
│       │   │   ├── series-public.dto.ts
│       │   │   └── series-stats.dto.ts
│       │   │
│       │   ├── schemas/
│       │   │   ├── index.ts
│       │   │   ├── create-series.schema.ts
│       │   │   ├── update-series.schema.ts
│       │   │   └── paywall.schema.ts
│       │   │
│       │   └── services/
│       │       ├── index.ts
│       │       ├── series-stats.service.ts
│       │       ├── series-ranking.service.ts
│       │       ├── series-discovery.service.ts
│       │       ├── paywall.service.ts
│       │       └── schedule.service.ts
│       │
│       ├── genres/
│       │   ├── index.ts
│       │   ├── genres.module.ts
│       │   ├── genres.routes.ts
│       │   ├── genres.controller.ts
│       │   ├── genres.service.ts
│       │   ├── genres.repository.ts
│       │   │
│       │   ├── dto/
│       │   │   ├── index.ts
│       │   │   └── genre-response.dto.ts
│       │   │
│       │   └── schemas/
│       │       └── index.ts
│       │
│       ├── tags/
│       │   ├── index.ts
│       │   ├── tags.module.ts
│       │   ├── tags.routes.ts
│       │   ├── tags.controller.ts
│       │   ├── tags.service.ts
│       │   ├── tags.repository.ts
│       │   │
│       │   ├── dto/
│       │   │   ├── index.ts
│       │   │   ├── create-tag.dto.ts
│       │   │   └── tag-response.dto.ts
│       │   │
│       │   └── schemas/
│       │       └── index.ts
│       │
│       └── content-warnings/
│           ├── index.ts
│           ├── content-warnings.module.ts
│           ├── content-warnings.routes.ts
│           ├── content-warnings.controller.ts
│           ├── content-warnings.service.ts
│           │
│           └── dto/
│               ├── index.ts
│               └── content-warning.dto.ts
```

## 4.4 Frontend Folder Structure

```
frontend/
├── src/
│   ├── app/
│   │   ├── (dashboard)/
│   │   │   └── dashboard/
│   │   │       ├── sites/
│   │   │       │   └── [siteId]/
│   │   │       │       └── series/
│   │   │       │           ├── page.tsx                # Series list
│   │   │       │           └── new/
│   │   │       │               └── page.tsx            # Create series
│   │   │       │
│   │   │       └── series/
│   │   │           └── [seriesId]/
│   │   │               ├── page.tsx                    # Series overview
│   │   │               ├── edit/
│   │   │               │   └── page.tsx                # Edit series
│   │   │               ├── settings/
│   │   │               │   └── page.tsx                # Series settings
│   │   │               ├── paywall/
│   │   │               │   └── page.tsx                # Paywall settings
│   │   │               ├── schedule/
│   │   │               │   └── page.tsx                # Update schedule
│   │   │               ├── analytics/
│   │   │               │   └── page.tsx                # Series analytics
│   │   │               ├── discovery/
│   │   │               │   └── page.tsx                # Discovery settings
│   │   │               ├── warnings/
│   │   │               │   └── page.tsx                # Content warnings
│   │   │               └── import/
│   │   │                   └── page.tsx                # Import chapters
│   │   │
│   │   ├── (forum)/
│   │   │   └── discover/
│   │   │       ├── page.tsx                            # Discovery home
│   │   │       ├── genre/
│   │   │       │   └── [genreSlug]/
│   │   │       │       └── page.tsx                    # Genre page
│   │   │       ├── tags/
│   │   │       │   ├── page.tsx                        # All tags
│   │   │       │   └── [tagSlug]/
│   │   │       │       └── page.tsx                    # Tag page
│   │   │       └── series/
│   │   │           └── [seriesId]/
│   │   │               └── page.tsx                    # Series detail
│   │   │
│   │   └── (sites)/
│   │       └── [site]/
│   │           └── series/
│   │               ├── page.tsx                        # Series list
│   │               └── [seriesSlug]/
│   │                   └── page.tsx                    # Series page
│   │
│   └── features/
│       └── series/
│           ├── index.ts
│           │
│           ├── components/
│           │   ├── index.ts
│           │   ├── series-card/
│           │   │   ├── series-card.tsx
│           │   │   ├── series-card-skeleton.tsx
│           │   │   ├── series-card-compact.tsx
│           │   │   └── index.ts
│           │   ├── series-grid/
│           │   │   ├── series-grid.tsx
│           │   │   └── index.ts
│           │   ├── series-list/
│           │   │   ├── series-list.tsx
│           │   │   ├── series-list-item.tsx
│           │   │   └── index.ts
│           │   ├── series-header/
│           │   │   ├── series-header.tsx
│           │   │   ├── series-cover.tsx
│           │   │   ├── series-stats-bar.tsx
│           │   │   └── index.ts
│           │   ├── series-metadata/
│           │   │   ├── series-metadata.tsx
│           │   │   ├── rating-display.tsx
│           │   │   ├── update-schedule-display.tsx
│           │   │   └── index.ts
│           │   ├── create-series-form/
│           │   │   ├── create-series-form.tsx
│           │   │   ├── content-type-selector.tsx
│           │   │   └── index.ts
│           │   ├── edit-series-form/
│           │   │   ├── edit-series-form.tsx
│           │   │   └── index.ts
│           │   ├── series-cover-upload/
│           │   │   ├── series-cover-upload.tsx
│           │   │   ├── cover-cropper.tsx
│           │   │   └── index.ts
│           │   ├── genre-selector/
│           │   │   ├── genre-selector.tsx
│           │   │   ├── genre-badge.tsx
│           │   │   ├── genre-tree.tsx
│           │   │   └── index.ts
│           │   ├── tag-input/
│           │   │   ├── tag-input.tsx
│           │   │   ├── tag-badge.tsx
│           │   │   ├── tag-suggestions.tsx
│           │   │   └── index.ts
│           │   ├── paywall-settings/
│           │   │   ├── paywall-settings.tsx
│           │   │   ├── access-level-selector.tsx
│           │   │   ├── early-access-config.tsx
│           │   │   └── index.ts
│           │   ├── schedule-settings/
│           │   │   ├── schedule-settings.tsx
│           │   │   ├── day-selector.tsx
│           │   │   └── index.ts
│           │   ├── content-warnings-editor/
│           │   │   ├── content-warnings-editor.tsx
│           │   │   ├── warning-selector.tsx
│           │   │   └── index.ts
│           │   ├── series-status-badge/
│           │   │   ├── series-status-badge.tsx
│           │   │   └── index.ts
│           │   ├── content-type-badge/
│           │   │   ├── content-type-badge.tsx
│           │   │   └── index.ts
│           │   ├── content-rating-badge/
│           │   │   ├── content-rating-badge.tsx
│           │   │   └── index.ts
│           │   └── discovery-settings/
│           │       ├── discovery-settings.tsx
│           │       ├── listing-score-display.tsx
│           │       └── index.ts
│           │
│           ├── hooks/
│           │   ├── index.ts
│           │   ├── use-series.ts
│           │   ├── use-series-list.ts
│           │   ├── use-create-series.ts
│           │   ├── use-update-series.ts
│           │   ├── use-series-stats.ts
│           │   ├── use-genres.ts
│           │   ├── use-tags.ts
│           │   └── use-content-warnings.ts
│           │
│           ├── api/
│           │   ├── index.ts
│           │   ├── series.api.ts
│           │   ├── genres.api.ts
│           │   ├── tags.api.ts
│           │   └── content-warnings.api.ts
│           │
│           ├── store/
│           │   ├── index.ts
│           │   └── series.store.ts
│           │
│           └── types/
│               ├── index.ts
│               ├── series.types.ts
│               ├── genre.types.ts
│               ├── tag.types.ts
│               └── content-warning.types.ts
```

---

# 5. Content Management (Chapters)

## 5.1 Database Schema

```prisma
// ============================================================================
// CHAPTERS MODULE - SCHEMA (Optimized)
// ============================================================================

enum ChapterStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  ARCHIVED
}

/// Individual chapter/episode
model Chapter {
  id                    String             @id @default(cuid())
  authorId              BigInt
  seriesId              String
  
  // Identity
  slug                  String
  chapterNumber         Float
  volumeNumber          Int?               @db.SmallInt
  title                 String?            @db.VarChar(200)
  
  // Content (web novel)
  content               String?            @db.Text
  contentHtml           String?            @db.Text
  wordCount             Int                @default(0)
  
  // Author note
  authorNote            String?            @db.Text
  authorNoteHtml        String?            @db.Text
  authorNotePosition    String             @default("end")
  
  // Status
  status                ChapterStatus      @default(DRAFT)
  scheduledAt           DateTime?
  publishedAt           DateTime?
  
  // Access control
  accessLevel           ChapterAccessLevel @default(FREE)
  minimumTierId         String?
  scheduledFreeAt       DateTime?
  previewParagraphs     Int?
  paywallMessage        String?            @db.Text
  
  // One-time purchase
  isPurchasable         Boolean            @default(false)
  price                 Int?
  currency              String             @default("INR") @db.Char(3)
  
  // Stats
  viewCount             BigInt             @default(0)
  
  // Ordering
  order                 Int                @default(0)
  
  // SEO
  metaTitle             String?            @db.VarChar(60)
  metaDescription       String?            @db.VarChar(160)
  
  // Versioning
  currentVersion        Int                @default(1) @db.SmallInt
  
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  deletedAt             DateTime?          // Soft delete

  // Relations
  author                User               @relation(fields: [authorId], references: [id], onDelete: Cascade)
  series                Series             @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  minimumTier           AuthorSubscriptionTier? @relation(fields: [minimumTierId], references: [id], onDelete: SetNull)
  versions              ChapterVersion[]
  images                ChapterImage[]
  readingProgress       ReadingProgress[]
  comments              Comment[]
  bookmarks             Bookmark[]
  contentWarnings       ChapterContentWarning[]
  reactions             Reaction[]
  purchases             Purchase[]
  translations          ChapterTranslation[]
  tiktokPreviews        TikTokPreview[]
  socialPosts           SocialPost[]
  aiWritingSessions     AIWritingSession[]
  scheduledPublication  ScheduledPublication?
  scheduledUnlock       ScheduledUnlock?

  @@unique([seriesId, slug])
  @@unique([seriesId, chapterNumber, volumeNumber])
  @@index([seriesId, status, order])
  @@index([status, scheduledAt])
  @@index([deletedAt])
  @@map("chapters")
}

/// Chapter version history
model ChapterVersion {
  id                BigInt    @id @default(autoincrement())
  chapterId         String
  
  versionNumber     Int       @db.SmallInt
  title             String?   @db.VarChar(200)
  content           String    @db.Text
  contentHtml       String?   @db.Text
  wordCount         Int
  authorNote        String?   @db.Text
  
  changeNote        String?   @db.VarChar(500)
  changedById       BigInt?
  changedByName     String?
  diffStats         Json?
  
  createdAt         DateTime  @default(now())

  // Relations
  chapter           Chapter   @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@unique([chapterId, versionNumber])
  @@index([chapterId, createdAt(sort: Desc)])
  @@map("chapter_versions")
}

/// Images for comic/webtoon chapters
model ChapterImage {
  id                BigInt    @id @default(autoincrement())
  chapterId         String
  
  imageUrl          String    @db.VarChar(2048)
  thumbnailUrl      String?   @db.VarChar(2048)
  placeholderUrl    String?   @db.VarChar(2048)
  
  width             Int       @db.SmallInt
  height            Int       @db.SmallInt
  fileSize          Int
  mimeType          String    @db.VarChar(50)
  
  order             Int       @db.SmallInt
  altText           String?   @db.VarChar(500)
  
  isProcessed       Boolean   @default(false)
  processedAt       DateTime?
  processingError   String?
  
  // OCR data
  extractedText     String?   @db.Text
  textBoundingBoxes Json?
  
  createdAt         DateTime  @default(now())

  // Relations
  chapter           Chapter   @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  ocrJobs           OCRJob[]
  textReplacements  ComicTextReplacement[]

  @@index([chapterId, order])
  @@map("chapter_images")
}

/// Scheduled chapter publications
model ScheduledPublication {
  id                BigInt    @id @default(autoincrement())
  chapterId         String    @unique
  
  scheduledFor      DateTime
  timezone          String    @default("Asia/Kolkata")
  
  status            ScheduledPublicationStatus @default(PENDING)
  publishedAt       DateTime?
  errorMessage      String?
  retryCount        Int       @default(0) @db.SmallInt
  
  notifySubscribers Boolean   @default(true)
  socialPost        Boolean   @default(true)
  emailBroadcast    Boolean   @default(false)
  subscriberNotified Boolean  @default(false)
  socialPosted      Boolean   @default(false)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  chapter           Chapter   @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@index([status, scheduledFor])
  @@map("scheduled_publications")
}

/// Scheduled paywall unlocks
model ScheduledUnlock {
  id                    BigInt    @id @default(autoincrement())
  chapterId             String    @unique
  
  unlockAt              DateTime
  timezone              String    @default("Asia/Kolkata")
  
  originalAccessLevel   String
  originalMinimumTierId String?
  
  status                ScheduledUnlockStatus @default(PENDING)
  unlockedAt            DateTime?
  errorMessage          String?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  chapter               Chapter   @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@index([status, unlockAt])
  @@map("scheduled_unlocks")
}

/// Chapter content warnings (Composite PK)
model ChapterContentWarning {
  chapterId         String
  warningId         String
  details           String?   @db.Text
  addedAt           DateTime  @default(now())
  addedById         BigInt?

  // Relations
  chapter           Chapter        @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  warning           ContentWarning @relation(fields: [warningId], references: [id], onDelete: Cascade)

  @@id([chapterId, warningId])
  @@index([warningId])
  @@map("chapter_content_warnings")
}
```

## 5.2 API Endpoints

```yaml
# ============================================================================
# CHAPTERS MODULE - API ENDPOINTS
# ============================================================================

Chapters:
  Management:
    - GET    /api/v1/series/:seriesId/chapters         # List chapters
    - POST   /api/v1/series/:seriesId/chapters         # Create chapter
    - GET    /api/v1/chapters/:chapterId               # Get chapter
    - PATCH  /api/v1/chapters/:chapterId               # Update chapter
    - DELETE /api/v1/chapters/:chapterId               # Soft delete
    - POST   /api/v1/chapters/:chapterId/restore       # Restore deleted
    - POST   /api/v1/chapters/:chapterId/duplicate     # Duplicate chapter

  Content:
    - GET    /api/v1/chapters/:chapterId/content       # Get content only
    - PUT    /api/v1/chapters/:chapterId/content       # Update content
    - POST   /api/v1/chapters/:chapterId/autosave      # Auto-save draft
    - GET    /api/v1/chapters/:chapterId/autosave      # Get auto-saved
    - DELETE /api/v1/chapters/:chapterId/autosave      # Clear auto-save

  Status:
    - POST   /api/v1/chapters/:chapterId/publish       # Publish immediately
    - POST   /api/v1/chapters/:chapterId/unpublish     # Unpublish
    - POST   /api/v1/chapters/:chapterId/schedule      # Schedule publication
    - PATCH  /api/v1/chapters/:chapterId/schedule      # Update schedule
    - DELETE /api/v1/chapters/:chapterId/schedule      # Cancel schedule
    - POST   /api/v1/chapters/:chapterId/archive       # Archive
    - POST   /api/v1/chapters/:chapterId/unarchive     # Unarchive

  Access Control:
    - GET    /api/v1/chapters/:chapterId/access        # Get access settings
    - PATCH  /api/v1/chapters/:chapterId/access        # Update access
    - POST   /api/v1/chapters/:chapterId/schedule-free # Schedule free unlock
    - PATCH  /api/v1/chapters/:chapterId/schedule-free # Update free schedule
    - DELETE /api/v1/chapters/:chapterId/schedule-free # Cancel free schedule

  Versions:
    - GET    /api/v1/chapters/:chapterId/versions      # List versions
    - GET    /api/v1/chapters/:chapterId/versions/:versionId    # Get version
    - POST   /api/v1/chapters/:chapterId/versions/:versionId/restore  # Restore
    - GET    /api/v1/chapters/:chapterId/versions/:versionId/diff     # Get diff
    - GET    /api/v1/chapters/:chapterId/versions/compare/:v1/:v2     # Compare

  Ordering:
    - PATCH  /api/v1/series/:seriesId/chapters/reorder # Reorder chapters
    - POST   /api/v1/chapters/:chapterId/move          # Move to another series

  Bulk Operations:
    - POST   /api/v1/series/:seriesId/chapters/bulk/update    # Bulk update
    - POST   /api/v1/series/:seriesId/chapters/bulk/delete    # Bulk delete
    - POST   /api/v1/series/:seriesId/chapters/bulk/publish   # Bulk publish
    - POST   /api/v1/series/:seriesId/chapters/bulk/access    # Bulk access change
    - POST   /api/v1/series/:seriesId/chapters/bulk/schedule  # Bulk schedule

  Import/Export:
    - POST   /api/v1/series/:seriesId/chapters/import         # Import chapters
    - POST   /api/v1/series/:seriesId/chapters/import/google-docs  # From Google Docs
    - POST   /api/v1/series/:seriesId/chapters/import/word    # From Word
    - POST   /api/v1/series/:seriesId/chapters/import/markdown # From Markdown
    - GET    /api/v1/series/:seriesId/chapters/export         # Export all
    - GET    /api/v1/chapters/:chapterId/export               # Export single
    - GET    /api/v1/chapters/:chapterId/export/:format       # Export in format

  Public/Reader:
    - GET    /api/v1/series/:seriesId/chapters/public  # List public chapters
    - GET    /api/v1/chapters/:chapterId/public        # Get public info
    - GET    /api/v1/chapters/:chapterId/read          # Read (authenticated)
    - POST   /api/v1/chapters/:chapterId/unlock        # Purchase/unlock

Chapter Images (Comics):
    - GET    /api/v1/chapters/:chapterId/images        # List images
    - POST   /api/v1/chapters/:chapterId/images        # Upload single
    - POST   /api/v1/chapters/:chapterId/images/bulk   # Bulk upload
    - GET    /api/v1/chapters/:chapterId/images/:imageId   # Get image
    - PATCH  /api/v1/chapters/:chapterId/images/:imageId   # Update alt/order
    - DELETE /api/v1/chapters/:chapterId/images/:imageId   # Delete image
    - PATCH  /api/v1/chapters/:chapterId/images/reorder    # Reorder images
    - POST   /api/v1/chapters/:chapterId/images/:imageId/process  # Reprocess

Content Warnings:
    - GET    /api/v1/chapters/:chapterId/warnings      # Get warnings
    - PUT    /api/v1/chapters/:chapterId/warnings      # Set warnings
    - POST   /api/v1/chapters/:chapterId/warnings      # Add warning
    - DELETE /api/v1/chapters/:chapterId/warnings/:warningId  # Remove
```

## 5.3 Backend Folder Structure

```
backend/
├── src/
│   └── modules/
│       └── chapters/
│           ├── index.ts
│           ├── chapters.module.ts
│           ├── chapters.routes.ts
│           ├── chapters.controller.ts
│           ├── chapters.service.ts
│           ├── chapters.repository.ts
│           │
│           ├── dto/
│           │   ├── index.ts
│           │   ├── create-chapter.dto.ts
│           │   ├── update-chapter.dto.ts
│           │   ├── update-content.dto.ts
│           │   ├── update-access.dto.ts
│           │   ├── schedule.dto.ts
│           │   ├── bulk-update.dto.ts
│           │   ├── import-chapters.dto.ts
│           │   ├── chapter-response.dto.ts
│           │   ├── chapter-public.dto.ts
│           │   └── chapter-read.dto.ts
│           │
│           ├── schemas/
│           │   ├── index.ts
│           │   ├── create-chapter.schema.ts
│           │   ├── update-chapter.schema.ts
│           │   ├── access.schema.ts
│           │   └── schedule.schema.ts
│           │
│           ├── services/
│           │   ├── index.ts
│           │   ├── chapter-access.service.ts
│           │   ├── chapter-version.service.ts
│           │   ├── chapter-scheduler.service.ts
│           │   ├── chapter-import.service.ts
│           │   ├── chapter-export.service.ts
│           │   ├── autosave.service.ts
│           │   ├── word-counter.service.ts
│           │   ├── content-renderer.service.ts
│           │   └── paywall-check.service.ts
│           │
│           ├── images/
│           │   ├── index.ts
│           │   ├── chapter-images.routes.ts
│           │   ├── chapter-images.controller.ts
│           │   ├── chapter-images.service.ts
│           │   │
│           │   ├── dto/
│           │   │   ├── index.ts
│           │   │   ├── upload-image.dto.ts
│           │   │   ├── update-image.dto.ts
│           │   │   └── image-response.dto.ts
│           │   │
│           │   └── services/
│           │       ├── index.ts
│           │       ├── image-processor.service.ts
│           │       ├── image-optimizer.service.ts
│           │       └── placeholder-generator.service.ts
│           │
│           └── importers/
│               ├── index.ts
│               ├── importer.interface.ts
│               ├── google-docs.importer.ts
│               ├── word.importer.ts
│               ├── markdown.importer.ts
│               ├── epub.importer.ts
│               └── html.importer.ts
│
├── workers/
│   ├── scheduled-publication.worker.ts
│   ├── scheduled-unlock.worker.ts
│   └── image-processing.worker.ts
```

## 5.4 Frontend Folder Structure

```
frontend/
├── src/
│   ├── app/
│   │   ├── (dashboard)/
│   │   │   └── dashboard/
│   │   │       ├── series/
│   │   │       │   └── [seriesId]/
│   │   │       │       └── chapters/
│   │   │       │           ├── page.tsx                # Chapter list
│   │   │       │           ├── new/
│   │   │       │           │   └── page.tsx            # Create chapter
│   │   │       │           ├── bulk-edit/
│   │   │       │           │   └── page.tsx            # Bulk operations
│   │   │       │           └── import/
│   │   │       │               └── page.tsx            # Import chapters
│   │   │       │
│   │   │       └── chapters/
│   │   │           └── [chapterId]/
│   │   │               ├── edit/
│   │   │               │   └── page.tsx                # Edit chapter
│   │   │               ├── preview/
│   │   │               │   └── page.tsx                # Preview
│   │   │               ├── settings/
│   │   │               │   └── page.tsx                # Chapter settings
│   │   │               ├── access/
│   │   │               │   └── page.tsx                # Access settings
│   │   │               ├── analytics/
│   │   │               │   └── page.tsx                # Chapter analytics
│   │   │               ├── versions/
│   │   │               │   ├── page.tsx                # Version history
│   │   │               │   └── [versionId]/
│   │   │               │       └── page.tsx            # View version
│   │   │               └── images/
│   │   │                   └── page.tsx                # Manage images
│   │   │
│   │   └── (sites)/
│   │       └── [site]/
│   │           └── series/
│   │               └── [seriesSlug]/
│   │                   ├── chapters/
│   │                   │   └── page.tsx                # Chapter list
│   │                   ├── [chapterSlug]/
│   │                   │   └── page.tsx                # Read chapter
│   │                   └── chapter/
│   │                       └── [number]/
│   │                           └── page.tsx            # Read by number
│   │
│   └── features/
│       └── chapters/
│           ├── index.ts
│           │
│           ├── components/
│           │   ├── index.ts
│           │   ├── chapter-list/
│           │   │   ├── chapter-list.tsx
│           │   │   ├── chapter-list-item.tsx
│           │   │   ├── chapter-list-skeleton.tsx
│           │   │   └── index.ts
│           │   ├── chapter-card/
│           │   │   ├── chapter-card.tsx
│           │   │   └── index.ts
│           │   ├── chapter-navigation/
│           │   │   ├── chapter-navigation.tsx
│           │   │   ├── prev-next-buttons.tsx
│           │   │   ├── chapter-dropdown.tsx
│           │   │   └── index.ts
│           │   ├── chapter-progress/
│           │   │   ├── chapter-progress.tsx
│           │   │   └── index.ts
│           │   ├── chapter-status-badge/
│           │   │   ├── chapter-status-badge.tsx
│           │   │   └── index.ts
│           │   ├── access-level-badge/
│           │   │   ├── access-level-badge.tsx
│           │   │   └── index.ts
│           │   ├── schedule-dialog/
│           │   │   ├── schedule-dialog.tsx
│           │   │   ├── date-time-picker.tsx
│           │   │   ├── timezone-selector.tsx
│           │   │   └── index.ts
│           │   ├── version-history/
│           │   │   ├── version-history.tsx
│           │   │   ├── version-list.tsx
│           │   │   ├── version-diff.tsx
│           │   │   ├── version-compare.tsx
│           │   │   └── index.ts
│           │   ├── bulk-actions/
│           │   │   ├── bulk-actions-toolbar.tsx
│           │   │   ├── bulk-select.tsx
│           │   │   ├── bulk-publish-dialog.tsx
│           │   │   ├── bulk-access-dialog.tsx
│           │   │   └── index.ts
│           │   ├── chapter-reorder/
│           │   │   ├── chapter-reorder.tsx
│           │   │   ├── drag-handle.tsx
│           │   │   └── index.ts
│           │   └── import-wizard/
│           │       ├── import-wizard.tsx
│           │       ├── source-selector.tsx
│           │       ├── file-upload.tsx
│           │       ├── google-docs-picker.tsx
│           │       ├── import-preview.tsx
│           │       └── index.ts
│           │
│           ├── editor/
│           │   ├── index.ts
│           │   ├── chapter-editor/
│           │   │   ├── chapter-editor.tsx
│           │   │   ├── editor-header.tsx
│           │   │   ├── editor-sidebar.tsx
│           │   │   └── index.ts
│           │   ├── rich-text-editor/
│           │   │   ├── rich-text-editor.tsx
│           │   │   ├── toolbar/
│           │   │   │   ├── toolbar.tsx
│           │   │   │   ├── format-buttons.tsx
│           │   │   │   ├── insert-menu.tsx
│           │   │   │   └── index.ts
│           │   │   ├── extensions/
│           │   │   │   ├── index.ts
│           │   │   │   ├── link.ts
│           │   │   │   ├── image.ts
│           │   │   │   ├── table.ts
│           │   │   │   ├── footnote.ts
│           │   │   │   └── spoiler.ts
│           │   │   └── index.ts
│           │   ├── markdown-editor/
│           │   │   ├── markdown-editor.tsx
│           │   │   ├── markdown-preview.tsx
│           │   │   └── index.ts
│           │   ├── word-counter/
│           │   │   ├── word-counter.tsx
│           │   │   └── index.ts
│           │   ├── auto-save-indicator/
│           │   │   ├── auto-save-indicator.tsx
│           │   │   └── index.ts
│           │   └── author-note-editor/
│           │       ├── author-note-editor.tsx
│           │       ├── position-selector.tsx
│           │       └── index.ts
│           │
│           ├── reader/
│           │   ├── index.ts
│           │   ├── reading-interface/
│           │   │   ├── reading-interface.tsx
│           │   │   ├── reading-container.tsx
│           │   │   └── index.ts
│           │   ├── novel-reader/
│           │   │   ├── novel-reader.tsx
│           │   │   ├── paragraph.tsx
│           │   │   ├── chapter-break.tsx
│           │   │   └── index.ts
│           │   ├── comic-reader/
│           │   │   ├── comic-reader.tsx
│           │   │   ├── vertical-scroll.tsx
│           │   │   ├── page-by-page.tsx
│           │   │   ├── image-loader.tsx
│           │   │   ├── zoom-controls.tsx
│           │   │   └── index.ts
│           │   ├── webtoon-reader/
│           │   │   ├── webtoon-reader.tsx
│           │   │   ├── long-strip.tsx
│           │   │   └── index.ts
│           │   ├── reading-toolbar/
│           │   │   ├── reading-toolbar.tsx
│           │   │   ├── chapter-info.tsx
│           │   │   ├── reading-actions.tsx
│           │   │   └── index.ts
│           │   ├── reading-settings/
│           │   │   ├── reading-settings.tsx
│           │   │   ├── font-settings.tsx
│           │   │   ├── theme-settings.tsx
│           │   │   ├── layout-settings.tsx
│           │   │   └── index.ts
│           │   ├── progress-bar/
│           │   │   ├── progress-bar.tsx
│           │   │   ├── scroll-progress.tsx
│           │   │   └── index.ts
│           │   ├── paywall-overlay/
│           │   │   ├── paywall-overlay.tsx
│           │   │   ├── subscription-prompt.tsx
│           │   │   ├── purchase-prompt.tsx
│           │   │   └── index.ts
│           │   └── chapter-end/
│           │       ├── chapter-end.tsx
│           │       ├── next-chapter-card.tsx
│           │       ├── reaction-buttons.tsx
│           │       └── index.ts
│           │
│           ├── comic-upload/
│           │   ├── index.ts
│           │   ├── image-uploader/
│           │   │   ├── image-uploader.tsx
│           │   │   ├── upload-zone.tsx
│           │   │   ├── upload-progress.tsx
│           │   │   └── index.ts
│           │   ├── bulk-image-uploader/
│           │   │   ├── bulk-image-uploader.tsx
│           │   │   ├── image-queue.tsx
│           │   │   └── index.ts
│           │   └── image-reorder/
│           │       ├── image-reorder.tsx
│           │       ├── image-thumbnail.tsx
│           │       └── index.ts
│           │
│           ├── hooks/
│           │   ├── index.ts
│           │   ├── use-chapter.ts
│           │   ├── use-chapters.ts
│           │   ├── use-create-chapter.ts
│           │   ├── use-update-chapter.ts
│           │   ├── use-chapter-content.ts
│           │   ├── use-chapter-versions.ts
│           │   ├── use-chapter-images.ts
│           │   ├── use-autosave.ts
│           │   ├── use-reading-progress.ts
│           │   ├── use-reading-settings.ts
│           │   └── use-chapter-access.ts
│           │
│           ├── api/
│           │   ├── index.ts
│           │   ├── chapters.api.ts
│           │   ├── chapter-versions.api.ts
│           │   ├── chapter-images.api.ts
│           │   └── chapter-import.api.ts
│           │
│           ├── store/
│           │   ├── index.ts
│           │   ├── chapter.store.ts
│           │   ├── editor.store.ts
│           │   └── reading.store.ts
│           │
│           └── types/
│               ├── index.ts
│               ├── chapter.types.ts
│               ├── version.types.ts
│               ├── image.types.ts
│               └── reader.types.ts
```

---

# 6. Media & File Management

## 6.1 Database Schema

```prisma
// ============================================================================
// MEDIA MODULE - SCHEMA (Optimized)
// ============================================================================

enum MediaScanStatus {
  PENDING
  SCANNING
  CLEAN
  FLAGGED
  INFECTED
  ERROR
}

/// Uploaded media files
model MediaFile {
  id                BigInt          @id @default(autoincrement())
  userId            BigInt
  siteId            String?
  
  filename          String
  originalFilename  String
  mimeType          String          @db.VarChar(100)
  fileSize          Int
  
  storageProvider   String          @default("s3")
  storagePath       String          @db.VarChar(500)
  storageRegion     String?
  
  publicUrl         String          @db.VarChar(2048)
  cdnUrl            String?         @db.VarChar(2048)
  
  width             Int?            @db.SmallInt
  height            Int?            @db.SmallInt
  aspectRatio       Float?
  colorProfile      String?
  dominantColor     String?         @db.Char(7)
  
  thumbnailUrl      String?         @db.VarChar(2048)
  placeholderUrl    String?         @db.VarChar(2048)
  
  isProcessed       Boolean         @default(false)
  processedAt       DateTime?
  processingError   String?
  
  isOptimized       Boolean         @default(false)
  originalSize      Int?
  optimizedSize     Int?
  compressionRatio  Float?
  
  altText           String?         @db.VarChar(500)
  caption           String?         @db.Text
  
  usageCount        Int             @default(0)
  lastUsedAt        DateTime?
  
  scanStatus        MediaScanStatus @default(PENDING)
  scannedAt         DateTime?
  scanResult        String?
  isQuarantined     Boolean         @default(false)
  
  folder            String?
  tags              String[]        @default([])
  
  createdAt         DateTime        @default(now())
  deletedAt         DateTime?

  // Relations
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  site              Site?           @relation(fields: [siteId], references: [id], onDelete: SetNull)

  @@index([userId, folder])
  @@index([siteId])
  @@index([scanStatus])
  @@map("media_files")
}

/// Storage usage tracking
model StorageUsage {
  id                  BigInt    @id @default(autoincrement())
  userId              BigInt    @unique
  
  totalBytes          BigInt    @default(0)
  imageBytes          BigInt    @default(0)
  documentBytes       BigInt    @default(0)
  videoBytes          BigInt    @default(0)
  otherBytes          BigInt    @default(0)
  
  totalFiles          Int       @default(0)
  imageFiles          Int       @default(0)
  documentFiles       Int       @default(0)
  videoFiles          Int       @default(0)
  
  bandwidthUsedBytes  BigInt    @default(0)
  bandwidthResetAt    DateTime
  
  storageLimitBytes   BigInt
  bandwidthLimitBytes BigInt
  
  storageWarningAt    DateTime?
  bandwidthWarningAt  DateTime?
  
  calculatedAt        DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("storage_usage")
}
```

## 6.2 API Endpoints

```yaml
# ============================================================================
# MEDIA MODULE - API ENDPOINTS
# ============================================================================

Media:
  Upload:
    - POST   /api/v1/media/upload                      # Direct upload
    - POST   /api/v1/media/upload/signed-url           # Get signed URL for client upload
    - POST   /api/v1/media/upload/complete             # Complete multipart upload
    - POST   /api/v1/media/upload/from-url             # Upload from URL

  Management:
    - GET    /api/v1/media                             # List files (with filters)
    - GET    /api/v1/media/:fileId                     # Get file details
    - PATCH  /api/v1/media/:fileId                     # Update metadata
    - DELETE /api/v1/media/:fileId                     # Delete file
    - POST   /api/v1/media/:fileId/copy                # Copy file
    - POST   /api/v1/media/:fileId/move                # Move to folder

  Folders:
    - GET    /api/v1/media/folders                     # List folders
    - POST   /api/v1/media/folders                     # Create folder
    - PATCH  /api/v1/media/folders/:folderId           # Rename folder
    - DELETE /api/v1/media/folders/:folderId           # Delete folder

  Processing:
    - POST   /api/v1/media/:fileId/process             # Reprocess file
    - POST   /api/v1/media/:fileId/optimize            # Optimize image
    - POST   /api/v1/media/:fileId/resize              # Resize image
    - GET    /api/v1/media/:fileId/variants            # Get image variants

  Download:
    - GET    /api/v1/media/:fileId/download            # Download file
    - GET    /api/v1/media/:fileId/stream              # Stream file

  Storage:
    - GET    /api/v1/media/storage                     # Get storage usage
    - GET    /api/v1/media/storage/breakdown           # Detailed breakdown
    - GET    /api/v1/media/bandwidth                   # Get bandwidth usage
    - GET    /api/v1/media/limits                      # Get limits for tier

  Bulk:
    - POST   /api/v1/media/bulk/delete                 # Bulk delete
    - POST   /api/v1/media/bulk/move                   # Bulk move
    - POST   /api/v1/media/bulk/tag                    # Bulk tag
```

## 6.3 Backend Folder Structure

```
backend/
├── src/
│   └── modules/
│       └── media/
│           ├── index.ts
│           ├── media.module.ts
│           ├── media.routes.ts
│           ├── media.controller.ts
│           ├── media.service.ts
│           ├── media.repository.ts
│           │
│           ├── dto/
│           │   ├── index.ts
│           │   ├── upload.dto.ts
│           │   ├── upload-signed-url.dto.ts
│           │   ├── update-media.dto.ts
│           │   ├── media-response.dto.ts
│           │   ├── storage-usage.dto.ts
│           │   └── bulk-operations.dto.ts
│           │
│           ├── schemas/
│           │   ├── index.ts
│           │   ├── upload.schema.ts
│           │   └── update-media.schema.ts
│           │
│           ├── storage/
│           │   ├── index.ts
│           │   ├── storage.interface.ts
│           │   ├── s3.storage.ts
│           │   ├── cloudflare-r2.storage.ts
│           │   ├── gcs.storage.ts
│           │   └── storage.factory.ts
│           │
│           ├── processors/
│           │   ├── index.ts
│           │   ├── processor.interface.ts
│           │   ├── image.processor.ts
│           │   ├── video.processor.ts
│           │   ├── document.processor.ts
│           │   ├── thumbnail.generator.ts
│           │   ├── placeholder.generator.ts
│           │   └── optimizer.ts
│           │
│           ├── services/
│           │   ├── index.ts
│           │   ├── upload.service.ts
│           │   ├── storage-tracking.service.ts
│           │   ├── virus-scanner.service.ts
│           │   ├── cdn.service.ts
│           │   └── cleanup.service.ts
│           │
│           └── folders/
│               ├── folders.routes.ts
│               ├── folders.controller.ts
│               └── folders.service.ts
│
├── workers/
│   ├── media-processor.worker.ts
│   ├── virus-scanner.worker.ts
│   └── storage-cleanup.worker.ts
```

## 6.4 Frontend Folder Structure

```
frontend/
├── src/
│   ├── app/
│   │   └── (dashboard)/
│   │       └── dashboard/
│   │           └── media/
│   │               ├── page.tsx                       # Media library
│   │               ├── upload/
│   │               │   └── page.tsx                   # Upload page
│           │       └── folders/
│           │           └── [folderId]/
│           │               └── page.tsx               # Folder view
│   │
│   └── features/
│       └── media/
│           ├── index.ts
│           │
│           ├── components/
│           │   ├── index.ts
│           │   ├── media-library/
│           │   │   ├── media-library.tsx
│           │   │   ├── media-grid.tsx
│           │   │   ├── media-list.tsx
│           │   │   ├── view-toggle.tsx
│           │   │   ├── filter-bar.tsx
│           │   │   ├── sort-dropdown.tsx
│           │   │   └── index.ts
│           │   ├── media-card/
│           │   │   ├── media-card.tsx
│           │   │   ├── media-thumbnail.tsx
│           │   │   ├── media-info.tsx
│           │   │   └── index.ts
│           │   ├── file-uploader/
│           │   │   ├── file-uploader.tsx
│           │   │   ├── dropzone.tsx
│           │   │   ├── upload-progress.tsx
│           │   │   ├── upload-queue.tsx
│           │   │   └── index.ts
│           │   ├── media-preview/
│           │   │   ├── media-preview.tsx
│           │   │   ├── image-preview.tsx
│           │   │   ├── video-preview.tsx
│           │   │   ├── document-preview.tsx
│           │   │   └── index.ts
│           │   ├── media-details/
│           │   │   ├── media-details.tsx
│           │   │   ├── metadata-form.tsx
│           │   │   ├── usage-info.tsx
│           │   │   └── index.ts
│           │   ├── folder-tree/
│           │   │   ├── folder-tree.tsx
│           │   │   ├── folder-item.tsx
│           │   │   ├── create-folder-dialog.tsx
│           │   │   └── index.ts
│           │   ├── storage-meter/
│           │   │   ├── storage-meter.tsx
│           │   │   ├── usage-breakdown.tsx
│           │   │   ├── bandwidth-meter.tsx
│           │   │   └── index.ts
│           │   ├── media-picker/
│           │   │   ├── media-picker.tsx
│           │   │   ├── picker-dialog.tsx
│           │   │   └── index.ts
│           │   └── bulk-actions/
│           │       ├── bulk-actions.tsx
│           │       ├── selection-toolbar.tsx
│           │       └── index.ts
│           │
│           ├── hooks/
│           │   ├── index.ts
│           │   ├── use-media.ts
│           │   ├── use-media-list.ts
│           │   ├── use-upload.ts
│           │   ├── use-folders.ts
│           │   ├── use-storage.ts
│           │   └── use-media-picker.ts
│           │
│           ├── api/
│           │   ├── index.ts
│           │   ├── media.api.ts
│           │   ├── folders.api.ts
│           │   └── storage.api.ts
│           │
│           ├── store/
│           │   ├── index.ts
│           │   ├── media.store.ts
│           │   └── upload.store.ts
│           │
│           └── types/
│               ├── index.ts
│               ├── media.types.ts
│               ├── folder.types.ts
│               └── upload.types.ts
```

---

# 7. Subscription & Tiers

## 7.1 Database Schema

```prisma
// ============================================================================
// SUBSCRIPTION MODULE - SCHEMA (Optimized)
// ============================================================================

enum ReaderSubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
  PAUSED
}

/// Author-created subscription tiers
model AuthorSubscriptionTier {
  id                String         @id @default(cuid())
  authorId          BigInt
  siteId            String
  
  // Identity
  name              String         @db.VarChar(50)
  slug              String
  description       String?        @db.Text
  
  // Pricing (in smallest currency unit)
  monthlyPrice      Int
  annualPrice       Int?
  currency          String         @default("INR") @db.Char(3)
  billingCycles     BillingCycle[] @default([MONTHLY])
  
  // Benefits
  benefits          String[]       @default([])
  benefitsJson      Json?
  earlyAccessDays   Int            @default(0) @db.SmallInt
  
  // Display
  badgeText         String?        @db.VarChar(20)
  badgeColor        String?        @db.Char(7)
  iconUrl           String?        @db.VarChar(2048)
  displayOrder      Int            @default(0) @db.SmallInt
  isHighlighted     Boolean        @default(false)
  highlightText     String?        @db.VarChar(30)
  
  // Status
  isActive          Boolean        @default(true)
  isPublic          Boolean        @default(true)
  isFree            Boolean        @default(false)
  isDefault         Boolean        @default(false)
  
  // Capacity
  maxSubscribers    Int?           // null = unlimited
  currentSubscribers Int           @default(0)
  
  // Gateway references
  razorpayPlanId    String?
  stripePriceId     String?
  xenditPlanId      String?
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  author            User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  site              Site           @relation(fields: [siteId], references: [id], onDelete: Cascade)
  subscriptions     ReaderSubscription[]
  chapters          Chapter[]
  discountCodeTiers DiscountCodeTier[]
  giftSubscriptions GiftSubscription[]

  @@unique([siteId, slug])
  @@index([authorId])
  @@index([siteId, isActive, displayOrder])
  @@map("author_subscription_tiers")
}

/// Reader subscription to an author tier
model ReaderSubscription {
  id                    String                   @id @default(cuid())
  readerId              BigInt
  tierId                String
  
  status                ReaderSubscriptionStatus @default(ACTIVE)
  billingCycle          BillingCycle             @default(MONTHLY)
  
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  priceAtPurchase       Int
  currency              String                   @db.Char(3)
  
  // Gateway
  gateway               PaymentGateway
  gatewaySubscriptionId String?
  gatewayCustomerId     String?
  
  // Discounts
  discountCodeId        String?
  discountMonthsRemaining Int                    @default(0) @db.SmallInt
  originalPrice         Int?
  
  // Trial
  isTrialing            Boolean                  @default(false)
  trialEndsAt           DateTime?
  
  // Cancellation
  autoRenew             Boolean                  @default(true)
  cancelledAt           DateTime?
  cancelReason          String?                  @db.VarChar(100)
  cancelFeedback        String?                  @db.Text
  expiresAt             DateTime?
  
  // Reminders
  renewalReminderSentAt DateTime?
  expiryReminderSentAt  DateTime?
  
  // Pause
  pausedAt              DateTime?
  pauseEndsAt           DateTime?
  pauseCount            Int                      @default(0) @db.SmallInt
  
  // Optimistic locking
  version               Int                      @default(1)
  
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt

  // Relations
  reader                User                     @relation("ReaderSubscriptions", fields: [readerId], references: [id], onDelete: Cascade)
  tier                  AuthorSubscriptionTier   @relation(fields: [tierId], references: [id], onDelete: Restrict)
  discountCode          DiscountCode?            @relation(fields: [discountCodeId], references: [id], onDelete: SetNull)
  payments              Payment[]
  churnPrediction       ChurnPrediction?

  @@unique([readerId, tierId])
  @@index([readerId, status])
  @@index([tierId, status])
  @@index([status, currentPeriodEnd])
  @@map("reader_subscriptions")
}

/// Gift subscription purchases
model GiftSubscription {
  id                String                 @id @default(cuid())
  
  giverId           BigInt
  giverEmail        String
  giverName         String?
  
  recipientEmail    String
  recipientName     String?
  recipientId       BigInt?
  
  tierId            String
  
  months            Int                    @default(1) @db.SmallInt
  amount            Int
  currency          String                 @default("INR") @db.Char(3)
  giftMessage       String?                @db.Text
  
  deliveryDate      DateTime               @default(now())
  isScheduled       Boolean                @default(false)
  
  status            GiftSubscriptionStatus @default(PENDING)
  deliveredAt       DateTime?
  claimedAt         DateTime?
  expiresAt         DateTime?
  
  claimCode         String                 @unique
  claimUrl          String?                @db.VarChar(2048)
  
  paymentId         BigInt?
  gatewayPaymentId  String?
  
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  // Relations
  giver             User                   @relation("GiftGiver", fields: [giverId], references: [id], onDelete: Cascade)
  recipient         User?                  @relation("GiftRecipient", fields: [recipientId], references: [id], onDelete: SetNull)
  tier              AuthorSubscriptionTier @relation(fields: [tierId], references: [id], onDelete: Restrict)

  @@index([giverId])
  @@index([recipientEmail])
  @@index([status])
  @@index([claimCode])
  @@map("gift_subscriptions")
}
```

## 7.2 API Endpoints

```yaml
# ============================================================================
# SUBSCRIPTION MODULE - API ENDPOINTS
# ============================================================================

Subscription Tiers (Author):
  - GET    /api/v1/sites/:siteId/tiers                 # List tiers
  - POST   /api/v1/sites/:siteId/tiers                 # Create tier
  - GET    /api/v1/tiers/:tierId                       # Get tier
  - PATCH  /api/v1/tiers/:tierId                       # Update tier
  - DELETE /api/v1/tiers/:tierId                       # Delete tier
  - POST   /api/v1/tiers/:tierId/activate              # Activate
  - POST   /api/v1/tiers/:tierId/deactivate            # Deactivate
  - PATCH  /api/v1/sites/:siteId/tiers/reorder         # Reorder tiers
  - POST   /api/v1/tiers/:tierId/duplicate             # Duplicate tier
  - GET    /api/v1/sites/:siteId/tiers/public          # Public pricing page

  Gateway Sync:
    - POST   /api/v1/tiers/:tierId/sync/razorpay       # Sync to Razorpay
    - POST   /api/v1/tiers/:tierId/sync/stripe         # Sync to Stripe
    - POST   /api/v1/tiers/:tierId/sync/xendit         # Sync to Xendit

Reader Subscriptions:
  - GET    /api/v1/my-subscriptions                    # List my subscriptions
  - GET    /api/v1/my-subscriptions/:subscriptionId    # Get subscription
  - POST   /api/v1/sites/:siteId/subscribe             # Subscribe to tier
  - PATCH  /api/v1/my-subscriptions/:subscriptionId    # Change tier
  - POST   /api/v1/my-subscriptions/:subscriptionId/cancel     # Cancel
  - POST   /api/v1/my-subscriptions/:subscriptionId/resume     # Resume
  - POST   /api/v1/my-subscriptions/:subscriptionId/pause      # Pause
  - POST   /api/v1/my-subscriptions/:subscriptionId/unpause    # Unpause
  - GET    /api/v1/my-subscriptions/:subscriptionId/invoices   # Get invoices

Author Subscriber Management:
  - GET    /api/v1/sites/:siteId/subscribers           # List subscribers
  - GET    /api/v1/sites/:siteId/subscribers/:subId    # Get subscriber
  - GET    /api/v1/sites/:siteId/subscribers/stats     # Subscriber stats
  - GET    /api/v1/sites/:siteId/subscribers/export    # Export subscribers
  - GET    /api/v1/sites/:siteId/subscribers/churn     # Churn analysis

Gift Subscriptions:
  - POST   /api/v1/sites/:siteId/gift                  # Purchase gift
  - GET    /api/v1/my-gifts/given                      # Gifts I've given
  - GET    /api/v1/my-gifts/received                   # Gifts I've received
  - GET    /api/v1/gifts/claim/:claimCode              # Get gift info
  - POST   /api/v1/gifts/claim/:claimCode              # Claim gift
```

## 7.3 Backend Folder Structure

```
backend/
├── src/
│   └── modules/
│       └── subscriptions/
│           ├── index.ts
│           ├── subscriptions.module.ts
│           │
│           ├── tiers/
│           │   ├── index.ts
│           │   ├── tiers.routes.ts
│           │   ├── tiers.controller.ts
│           │   ├── tiers.service.ts
│           │   ├── tiers.repository.ts
│           │   │
│           │   ├── dto/
│           │   │   ├── index.ts
│           │   │   ├── create-tier.dto.ts
│           │   │   ├── update-tier.dto.ts
│           │   │   └── tier-response.dto.ts
│           │   │
│           │   ├── schemas/
│           │   │   ├── index.ts
│           │   │   └── tier.schema.ts
│           │   │
│           │   └── services/
│           │       ├── index.ts
│           │       └── tier-sync.service.ts
│           │
│           ├── reader-subscriptions/
│           │   ├── index.ts
│           │   ├── reader-subscriptions.routes.ts
│           │   ├── reader-subscriptions.controller.ts
│           │   ├── reader-subscriptions.service.ts
│           │   ├── reader-subscriptions.repository.ts
│           │   │
│           │   ├── dto/
│           │   │   ├── index.ts
│           │   │   ├── subscribe.dto.ts
│           │   │   ├── update-subscription.dto.ts
│           │   │   ├── cancel.dto.ts
│           │   │   └── subscription-response.dto.ts
│           │   │
│           │   └── services/
│           │       ├── index.ts
│           │       ├── subscription-access.service.ts
│           │       ├── subscription-renewal.service.ts
│           │       └── subscription-reminder.service.ts
│           │
│           ├── subscribers/
│           │   ├── index.ts
│           │   ├── subscribers.routes.ts
│           │   ├── subscribers.controller.ts
│           │   ├── subscribers.service.ts
│           │   │
│           │   ├── dto/
│           │   │   ├── index.ts
│           │   │   ├── subscriber-response.dto.ts
│           │   │   └── subscriber-stats.dto.ts
│           │   │
│           │   └── services/
│           │       ├── index.ts
│           │       └── subscriber-export.service.ts
│           │
│           └── gifts/
│               ├── index.ts
│               ├── gifts.routes.ts
│               ├── gifts.controller.ts
│               ├── gifts.service.ts
│               │
│               ├── dto/
│               │   ├── index.ts
│               │   ├── create-gift.dto.ts
│               │   ├── claim-gift.dto.ts
│               │   └── gift-response.dto.ts
│               │
│               └── services/
│                   ├── index.ts
│                   └── gift-delivery.service.ts
│
├── workers/
│   ├── subscription-renewal.worker.ts
│   ├── subscription-reminder.worker.ts
│   ├── subscription-expiry.worker.ts
│   └── gift-delivery.worker.ts
```

## 7.4 Frontend Folder Structure

```
frontend/
├── src/
│   ├── app/
│   │   ├── (dashboard)/
│   │   │   └── dashboard/
│   │   │       ├── sites/
│   │   │       │   └── [siteId]/
│   │   │       │       └── tiers/
│   │   │       │           ├── page.tsx               # Manage tiers
│   │   │       │           ├── new/
│   │   │       │           │   └── page.tsx           # Create tier
│   │   │       │           └── [tierId]/
│   │   │       │               └── edit/
│   │   │       │                   └── page.tsx       # Edit tier
│   │   │       │
│   │   │       └── subscribers/
│   │   │           ├── page.tsx                       # Subscriber list
│   │   │           ├── [subscriptionId]/
│   │   │           │   └── page.tsx                   # Subscriber detail
│   │   │           ├── stats/
│   │   │           │   └── page.tsx                   # Subscriber stats
│   │   │           └── export/
│   │   │               └── page.tsx                   # Export
│   │   │
│   │   ├── (reader)/
│   │   │   └── account/
│   │   │       ├── subscriptions/
│   │   │       │   ├── page.tsx                       # My subscriptions
│   │   │       │   └── [subscriptionId]/
│   │   │       │       └── page.tsx                   # Manage subscription
│   │   │       └── gifts/
│   │   │           ├── page.tsx                       # My gifts
│   │   │           └── claim/
│   │   │               └── [claimCode]/
│   │   │                   └── page.tsx               # Claim gift
│   │   │
│   │   └── (sites)/
│   │       └── [site]/
│   │           ├── subscribe/
│   │           │   └── page.tsx                       # Subscription page
│   │           └── gift/
│   │               └── page.tsx                       # Gift subscription
│   │
│   └── features/
│       └── subscriptions/
│           ├── index.ts
│           │
│           ├── components/
│           │   ├── index.ts
│           │   ├── tier-card/
│           │   │   ├── tier-card.tsx
│           │   │   ├── tier-benefits.tsx
│           │   │   ├── tier-pricing.tsx
│           │   │   └── index.ts
│           │   ├── tier-grid/
│           │   │   ├── tier-grid.tsx
│           │   │   └── index.ts
│           │   ├── tier-form/
│           │   │   ├── tier-form.tsx
│           │   │   ├── benefits-editor.tsx
│           │   │   ├── pricing-input.tsx
│           │   │   └── index.ts
│           │   ├── subscribe-button/
│           │   │   ├── subscribe-button.tsx
│           │   │   └── index.ts
│           │   ├── subscription-card/
│           │   │   ├── subscription-card.tsx
│           │   │   ├── subscription-status.tsx
│           │   │   ├── renewal-info.tsx
│           │   │   └── index.ts
│           │   ├── subscription-manager/
│           │   │   ├── subscription-manager.tsx
│           │   │   ├── cancel-dialog.tsx
│           │   │   ├── pause-dialog.tsx
│           │   │   ├── change-tier-dialog.tsx
│           │   │   └── index.ts
│           │   ├── subscriber-table/
│           │   │   ├── subscriber-table.tsx
│           │   │   ├── subscriber-row.tsx
│           │   │   ├── subscriber-filters.tsx
│           │   │   └── index.ts
│           │   ├── subscriber-stats/
│           │   │   ├── subscriber-stats.tsx
│           │   │   ├── mrr-chart.tsx
│           │   │   ├── churn-chart.tsx
│           │   │   └── index.ts
│           │   ├── gift-form/
│           │   │   ├── gift-form.tsx
│           │   │   ├── recipient-input.tsx
│           │   │   ├── message-input.tsx
│           │   │   └── index.ts
│           │   └── gift-claim/
│           │       ├── gift-claim.tsx
│           │       ├── gift-preview.tsx
│           │       └── index.ts
│           │
│           ├── hooks/
│           │   ├── index.ts
│           │   ├── use-tiers.ts
│           │   ├── use-tier.ts
│           │   ├── use-subscriptions.ts
│           │   ├── use-subscription.ts
│           │   ├── use-subscribe.ts
│           │   ├── use-subscribers.ts
│           │   ├── use-subscriber-stats.ts
│           │   └── use-gifts.ts
│           │
│           ├── api/
│           │   ├── index.ts
│           │   ├── tiers.api.ts
│           │   ├── subscriptions.api.ts
│           │   ├── subscribers.api.ts
│           │   └── gifts.api.ts
│           │
│           ├── store/
│           │   ├── index.ts
│           │   └── subscription.store.ts
│           │
│           └── types/
│               ├── index.ts
│               ├── tier.types.ts
│               ├── subscription.types.ts
│               └── gift.types.ts
```

---

# 8. Payment Processing

## 8.1 Database Schema

```prisma
// ============================================================================
// PAYMENT MODULE - SCHEMA (Optimized)
// ============================================================================

enum PaymentGateway {
  RAZORPAY
  STRIPE
  XENDIT
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
  DISPUTED
  CANCELLED
}

enum PaymentType {
  SUBSCRIPTION
  ONE_TIME_PURCHASE
  TIP
  PLATFORM_FEE
}

/// Payment gateway configuration for authors
model PaymentGatewayConfig {
  id                      BigInt    @id @default(autoincrement())
  authorId                BigInt    @unique
  
  // Razorpay (India)
  razorpayKeyId           String?
  razorpayKeySecret       String?   @db.Text
  razorpayAccountId       String?
  razorpayWebhookSecret   String?   @db.Text
  razorpayConnected       Boolean   @default(false)
  razorpayConnectedAt     DateTime?
  razorpayVerified        Boolean   @default(false)
  razorpayVerifiedAt      DateTime?
  
  // Stripe (Global)
  stripeAccountId         String?
  stripeAccountType       String?
  stripeWebhookSecret     String?   @db.Text
  stripeConnected         Boolean   @default(false)
  stripeConnectedAt       DateTime?
  stripeChargesEnabled    Boolean   @default(false)
  stripePayoutsEnabled    Boolean   @default(false)
  stripeDetailsSubmitted  Boolean   @default(false)
  
  // Xendit (Southeast Asia)
  xenditBusinessId        String?
  xenditApiKey            String?   @db.Text
  xenditWebhookToken      String?   @db.Text
  xenditConnected         Boolean   @default(false)
  xenditConnectedAt       DateTime?
  xenditVerified          Boolean   @default(false)
  
  defaultGateway          PaymentGateway?
  
  // OAuth tokens
  razorpayAccessToken     String?   @db.Text
  razorpayRefreshToken    String?   @db.Text
  razorpayTokenExpiresAt  DateTime?
  stripeAccessToken       String?   @db.Text
  stripeRefreshToken      String?   @db.Text
  stripeTokenExpiresAt    DateTime?
  
  // Health
  lastWebhookReceivedAt   DateTime?
  webhookFailureCount     Int       @default(0) @db.SmallInt
  webhookHealthStatus     String?
  lastReconciliationAt    DateTime?
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // Relations
  ```prisma
  // Relations
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@map("payment_gateway_configs")
}

/// Individual payment transaction
model Payment {
  id BigInt @id @default(autoincrement())

  readerId BigInt
  authorId BigInt

  subscriptionId String?
  purchaseId     BigInt?

  type   PaymentType
  status PaymentStatus @default(PENDING)

  // Amounts in smallest currency unit (paise/cents)
  grossAmount Int
  gatewayFee  Int?
  netAmount   Int?
  currency    String @db.Char(3)

  // Gateway details
  gateway           PaymentGateway
  gatewayPaymentId  String?   // Gateway payment ID
  gatewayOrderId    String?   // Gateway order ID
  gatewayInvoiceId  String?
  gatewayResponse   Json?
  gatewayReceiptUrl String?   @db.VarChar(2048)

  // Payment method (non-sensitive)
  cardBrand      String? @db.VarChar(20)
  cardLast4      String? @db.VarChar(4)
  paymentCountry String? @db.Char(2)
  paymentMethod  String? // card, upi, netbanking, wallet

  // Failure handling
  failureCode    String?
  failureMessage String?
  failureAt      DateTime?
  retryCount     Int       @default(0) @db.SmallInt
  nextRetryAt    DateTime?

  // Refund
  refundedAmount Int?
  refundedAt     DateTime?
  refundReason   String?
  refundGatewayId String?

  // Dispute
  disputedAt        DateTime?
  disputeReason     String?
  disputeStatus     String?
  disputeEvidence   Json?
  disputeResolvedAt DateTime?
  disputeOutcome    String?   // won, lost, withdrawn

  // Metadata
  metadata  String? @db.Text
  notes     String? @db.Text
  ipAddress String? @db.VarChar(45)

  initiatedAt DateTime @default(now())
  processedAt DateTime?
  settledAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  reader       User                @relation("ReaderPayments", fields: [readerId], references: [id], onDelete: Restrict)
  author       User                @relation("AuthorPayments", fields: [authorId], references: [id], onDelete: Restrict)
  subscription ReaderSubscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  purchase     Purchase?           @relation(fields: [purchaseId], references: [id], onDelete: SetNull)
  events       PaymentEvent[]

  @@unique([gateway, gatewayPaymentId])
  @@index([readerId])
  @@index([authorId])
  @@index([subscriptionId])
  @@index([purchaseId])
  @@index([status])
  @@index([gateway])
  @@index([type])
  @@index([authorId, status, createdAt])
  @@index([readerId, status])
  @@index([gateway, status])
  @@map("payments")
}

/// Payment state transitions (event log)
model PaymentEvent {
  id        BigInt @id @default(autoincrement())
  paymentId BigInt

  eventType      String       @db.VarChar(50) // e.g. 'created', 'succeeded', 'refunded'
  previousStatus PaymentStatus?
  newStatus      PaymentStatus
  metadata       Json?

  createdAt DateTime @default(now())

  // Relations
  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId, createdAt(sort: Desc)])
  @@map("payment_events")
}

/// Platform invoices (usage fee on author revenue)
model PlatformInvoice {
  id       BigInt @id @default(autoincrement())
  authorId BigInt

  invoiceNumber   String   @unique
  periodStart     DateTime
  periodEnd       DateTime
  grossRevenue    BigInt   // Total reader revenue in period
  usageFeePercent Float    @default(10)
  usageFeeAmount  BigInt
  gstPercent      Float    @default(18)
  gstAmount       BigInt
  totalAmount     BigInt
  currency        String   @default("INR") @db.Char(3)

  status          PlatformInvoiceStatus @default(PENDING)

  dueDate          DateTime
  paidAt           DateTime?
  paymentMethod    String?
  paymentReference String?

  disputedAt        DateTime?
  disputeReason     String?   @db.Text
  disputeResolvedAt DateTime?
  disputeOutcome    String?

  remindersSent  Int       @default(0) @db.SmallInt
  lastReminderAt DateTime?

  invoiceUrl String? @db.VarChar(2048)
  notes      String? @db.Text

  transactionCount Int   @default(0)
  breakdown        Json? // Detailed transaction breakdown

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([status])
  @@index([periodStart])
  @@index([dueDate])
  @@index([authorId, status])
  @@index([status, dueDate])
  @@map("platform_invoices")
}

/// Author payout records (summary, actual payout via gateway)
model AuthorPayout {
  id       BigInt @id @default(autoincrement())
  authorId BigInt

  // Period
  periodStart DateTime
  periodEnd   DateTime

  // Amounts
  grossRevenue BigInt
  gatewayFees  BigInt
  platformFees BigInt
  netPayout    BigInt
  currency     String @default("INR") @db.Char(3)

  // Gateway Details
  gateway          PaymentGateway
  gatewayPayoutId  String?
  gatewayReference String?

  // Status
  status       PayoutStatus @default(PENDING)
  processedAt  DateTime?
  completedAt  DateTime?
  failedAt     DateTime?
  errorMessage String?

  // Bank Details snapshot
  bankDetails Json?

  // Invoice
  invoiceNumber String?
  invoiceUrl    String? @db.VarChar(2048)

  // Breakdown
  transactionCount Int   @default(0)
  breakdown        Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([status])
  @@index([periodStart])
  @@index([gateway])
  @@index([authorId, status])
  @@map("author_payouts")
}
```

---

## 8.2 Payment API Endpoints

```yaml
# ============================================================================
# PAYMENT MODULE - API ENDPOINTS
# ============================================================================

Payments (Author View):
  - GET    /api/v1/payments                           # List all received payments (filter by site, series, type)
  - GET    /api/v1/payments/:paymentId                # Get payment details
  - GET    /api/v1/payments/stats                     # Aggregated revenue stats (MRR, LTV, etc.)
  - GET    /api/v1/payments/export                    # Export payments CSV
  - GET    /api/v1/payments/timeline                  # Time-series revenue (for charts)

Payments (Reader View):
  - GET    /api/v1/my/payments                        # My payments
  - GET    /api/v1/my/payments/:paymentId             # My payment details
  - GET    /api/v1/my/payments/:paymentId/receipt     # Download receipt

Checkout:
  - POST   /api/v1/checkout/subscription              # Create subscription checkout (tier + billing)
  - POST   /api/v1/checkout/purchase                  # Create one-time purchase checkout
  - POST   /api/v1/checkout/tip                       # Tip an author
  - GET    /api/v1/checkout/session/:sessionId        # Get checkout status (for client polling)

Refunds:
  - POST   /api/v1/payments/:paymentId/refund         # Request/admin-issue refund
  - GET    /api/v1/payments/:paymentId/refund-status  # Check refund status

Disputes:
  - GET    /api/v1/payments/:paymentId/dispute        # View dispute status
  - POST   /api/v1/payments/:paymentId/dispute/evidence  # Upload evidence (author/admin)
  - POST   /api/v1/payments/:paymentId/dispute/mark   # Mark as won/lost (admin)

Author Gateway Configuration:
  - GET    /api/v1/payment-gateway                    # Get current author gateway config
  - POST   /api/v1/payment-gateway/default            # Set default gateway (RAZORPAY/STRIPE/XENDIT)

  Razorpay:
    - POST /api/v1/payment-gateway/razorpay/connect   # Save keys/account ID
    - POST /api/v1/payment-gateway/razorpay/disconnect
    - POST /api/v1/payment-gateway/razorpay/webhook-secret
    - GET  /api/v1/payment-gateway/razorpay/status

  Stripe:
    - POST /api/v1/payment-gateway/stripe/connect     # Connected account OAuth
    - POST /api/v1/payment-gateway/stripe/disconnect
    - POST /api/v1/payment-gateway/stripe/webhook-secret
    - GET  /api/v1/payment-gateway/stripe/status

  Xendit:
    - POST /api/v1/payment-gateway/xendit/connect
    - POST /api/v1/payment-gateway/xendit/disconnect
    - POST /api/v1/payment-gateway/xendit/webhook-token
    - GET  /api/v1/payment-gateway/xendit/status

Incoming Webhooks:
  - POST   /api/v1/webhooks/razorpay/:authorPublicId
  - POST   /api/v1/webhooks/stripe/:authorPublicId
  - POST   /api/v1/webhooks/xendit/:authorPublicId

Author Payouts:
  - GET    /api/v1/payouts                            # List author payouts
  - GET    /api/v1/payouts/:payoutId                  # Get payout details
  - GET    /api/v1/payouts/stats                      # Payout stats
  - GET    /api/v1/payouts/export                     # Export payouts CSV

Platform Invoices (Ownverso → Author):
  - GET    /api/v1/billing/platform-invoices          # List platform invoices
  - GET    /api/v1/billing/platform-invoices/:id      # Get invoice
  - GET    /api/v1/billing/platform-invoices/:id/pdf  # Download invoice PDF
  - POST   /api/v1/billing/platform-invoices/:id/mark-paid  # Admin-only
```

---

## 8.3 Backend Folder Structure

```
backend/
├── src/
│   └── modules/
│       └── payments/
│           ├── index.ts
│           ├── payments.module.ts
│           │
│           ├── payment-transactions/
│           │   ├── index.ts
│           │   ├── payment-transactions.routes.ts
│           │   ├── payment-transactions.controller.ts
│           │   ├── payment-transactions.service.ts
│           │   ├── payment-transactions.repository.ts
│           │   │
│           │   ├── dto/
│           │   │   ├── index.ts
│           │   │   ├── payment-response.dto.ts
│           │   │   ├── refund-request.dto.ts
│           │   │   ├── dispute-evidence.dto.ts
│           │   │   └── payment-stats.dto.ts
│           │   │
│           │   └── schemas/
│           │       ├── index.ts
│           │       ├── refund.schema.ts
│           │       └── dispute.schema.ts
│           │
│           ├── checkout/
│           │   ├── index.ts
│           │   ├── checkout.routes.ts
│           │   ├── checkout.controller.ts
│           │   ├── checkout.service.ts
│           │   │
│           │   ├── dto/
│           │   │   ├── index.ts
│           │   │   ├── create-subscription-checkout.dto.ts
│           │   │   ├── create-purchase-checkout.dto.ts
│           │   │   └── checkout-session-response.dto.ts
│           │   │
│           │   └── schemas/
│           │       ├── index.ts
│           │       └── checkout.schema.ts
│           │
│           ├── gateway-config/
│           │   ├── index.ts
│           │   ├── gateway-config.routes.ts
│           │   ├── gateway-config.controller.ts
│           │   ├── gateway-config.service.ts
│           │   ├── gateway-config.repository.ts
│           │   │
│           │   ├── providers/
│           │   │   ├── index.ts
│           │   │   ├── gateway.interface.ts
│           │   │   ├── razorpay.provider.ts
│           │   │   ├── stripe.provider.ts
│           │   │   └── xendit.provider.ts
│           │   │
│           │   └── dto/
│           │       ├── index.ts
│           │       ├── connect-razorpay.dto.ts
│           │       ├── connect-stripe.dto.ts
│           │       ├── connect-xendit.dto.ts
│           │       └── gateway-status.dto.ts
│           │
│           ├── webhooks/
│           │   ├── index.ts
│           │   ├── payment-webhooks.routes.ts
│           │   ├── payment-webhooks.controller.ts
│           │   ├── payment-webhooks.service.ts
│           │   │
│           │   └── parsers/
│           │       ├── index.ts
│           │       ├── razorpay.parser.ts
│           │       ├── stripe.parser.ts
│           │       └── xendit.parser.ts
│           │
│           ├── payouts/
│           │   ├── index.ts
│           │   ├── payouts.routes.ts
│           │   ├── payouts.controller.ts
│           │   ├── payouts.service.ts
│           │   ├── payouts.repository.ts
│           │   │
│           │   └── dto/
│           │       ├── index.ts
│           │       ├── payout-response.dto.ts
│           │       └── payout-stats.dto.ts
│           │
│           └── platform-invoices/
│               ├── index.ts
│               ├── platform-invoices.routes.ts
│               ├── platform-invoices.controller.ts
│               ├── platform-invoices.service.ts
│               ├── platform-invoices.repository.ts
│               │
│               └── dto/
│                   ├── index.ts
│                   ├── platform-invoice-response.dto.ts
│                   └── platform-invoice-stats.dto.ts
│
├── workers/
│   ├── payment-reconciliation.worker.ts
│   ├── payment-retry.worker.ts
│   ├── payout-calculation.worker.ts
│   └── platform-invoice-generation.worker.ts
```

---

## 8.4 Frontend Folder Structure

```
frontend/
├── src/
│   ├── app/
│   │   ├── (dashboard)/
│   │   │   └── dashboard/
│   │   │       ├── payments/
│   │   │       │   ├── page.tsx                      # Author payments list
│   │   │       │   └── [paymentId]/
│   │   │       │       └── page.tsx                  # Payment detail
│   │   │       ├── revenue/
│   │   │       │   └── page.tsx                      # Revenue dashboard
│   │   │       ├── payouts/
│   │   │       │   ├── page.tsx                      # Payouts list
│   │   │       │   └── [payoutId]/
│   │   │       │       └── page.tsx                  # Payout detail
│   │   │       └── billing/
│   │   │           └── platform-invoices/
│   │   │               ├── page.tsx                  # Platform invoices
│   │   │               └── [invoiceId]/
│   │   │                   └── page.tsx              # Invoice detail
│   │   │
│   │   ├── (reader)/
│   │   │   └── account/
│   │   │       └── payments/
│   │   │           ├── page.tsx                      # Reader payments
│   │   │           └── [paymentId]/
│   │   │               └── page.tsx                  # Reader payment detail
│   │   │
│   │   └── (sites)/
│   │       └── [site]/
│   │           └── checkout/
│   │               └── [sessionId]/
│   │                   └── page.tsx                  # Checkout status page
│   │
│   └── features/
│       └── payments/
│           ├── index.ts
│           │
│           ├── components/
│           │   ├── index.ts
│           │   ├── payment-table/
│           │   │   ├── payment-table.tsx
│           │   │   ├── payment-row.tsx
│           │   │   ├── payment-filters.tsx
│           │   │   └── index.ts
│           │   ├── payment-detail/
│           │   │   ├── payment-detail.tsx
│           │   │   ├── gateway-info.tsx
│           │   │   ├── refund-info.tsx
│           │   │   ├── dispute-info.tsx
│           │   │   └── index.ts
│           │   ├── checkout-summary/
│           │   │   ├── checkout-summary.tsx
│           │   │   └── index.ts
│           │   ├── revenue-dashboard/
│           │   │   ├── revenue-dashboard.tsx
│           │   │   ├── mrr-card.tsx
│           │   │   ├── arr-card.tsx
│           │   │   ├── ltv-card.tsx
│           │   │   ├── revenue-chart.tsx
│           │   │   └── index.ts
│           │   ├── payouts-table/
│           │   │   ├── payouts-table.tsx
│           │   │   ├── payout-row.tsx
│           │   │   └── index.ts
│           │   ├── platform-invoice-table/
│           │   │   ├── platform-invoice-table.tsx
│           │   │   ├── platform-invoice-row.tsx
│           │   │   └── index.ts
│           │   └── payment-method-badge/
│           │       ├── payment-method-badge.tsx
│           │       └── index.ts
│           │
│           ├── hooks/
│           │   ├── index.ts
│           │   ├── use-payments.ts
│           │   ├── use-payment.ts
│           │   ├── use-revenue-stats.ts
│           │   ├── use-payouts.ts
│           │   └── use-platform-invoices.ts
│           │
│           ├── api/
│           │   ├── index.ts
│           │   ├── payments.api.ts
│           │   ├── payouts.api.ts
│           │   └── platform-invoices.api.ts
│           │
│           ├── store/
│           │   ├── index.ts
│           │   └── payments.store.ts
│           │
│           └── types/
│               ├── index.ts
│               ├── payment.types.ts
│               ├── payout.types.ts
│               └── platform-invoice.types.ts
```

-Analytics & Reporting
9.1 Database Schema
prisma

// ============================================================================
// ANALYTICS MODULE - SCHEMA (Optimized)
// ============================================================================

enum AnalyticsEventType {
  PAGE_VIEW
  CHAPTER_START
  CHAPTER_PROGRESS
  CHAPTER_COMPLETE
  SERIES_VIEW
  SUBSCRIPTION_VIEW
  SUBSCRIPTION_START
  SUBSCRIPTION_CANCEL
  PAYMENT
  SIGNUP
  LOGIN
  SEARCH
  SHARE
}

/// Raw analytics events (high-volume, partitionable)
model AnalyticsEvent {
  id          BigInt             @id @default(autoincrement())
  userId      BigInt?
  sessionId   String?
  anonymousId String?

  eventType   AnalyticsEventType

  siteId      String?
  seriesId    String?
  chapterId   String?

  properties  Json?

  deviceType     String?
  browser        String?
  browserVersion String?
  os             String?
  osVersion      String?
  screenSize     String?

  country    String? @db.Char(2)
  region     String?
  city       String?

  referrer    String? @db.VarChar(2048)
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?

  forumRef    String?

  timestamp   DateTime @default(now())

  @@index([userId])
  @@index([sessionId])
  @@index([siteId, eventType, timestamp])
  @@index([seriesId, eventType, timestamp])
  @@index([timestamp(sort: Desc)])
  @@map("analytics_events")
}

/// Consolidated daily aggregates (site/series/author/other)
model AnalyticsAggregate {
  id         BigInt   @id @default(autoincrement())
  entityType String   @db.VarChar(20)  // 'site', 'series', 'author', 'chapter'
  entityId   String
  date       DateTime @db.Date

  // Common metrics
  pageViews      Int @default(0)
  uniqueVisitors Int @default(0)
  sessions       Int @default(0)

  // Flexible metrics in JSON
  metrics Json   @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([entityType, entityId, date])
  @@index([entityType, entityId])
  @@index([date])
  @@map("analytics_aggregates")
}

/// Daily revenue snapshot for authors (optional advanced dashboards)
model AuthorRevenueSnapshot {
  id       BigInt @id @default(autoincrement())
  authorId BigInt
  siteId   String?

  date DateTime @db.Date

  subscriptionRevenue BigInt @default(0)
  purchaseRevenue     BigInt @default(0)
  tipRevenue          BigInt @default(0)
  totalRevenue        BigInt @default(0)

  gatewayFees  BigInt @default(0)
  platformFees BigInt @default(0)
  netRevenue   BigInt @default(0)

  activeSubscribers  Int @default(0)
  newSubscribers     Int @default(0)
  churnedSubscribers Int @default(0)
  upgradedSubscribers Int @default(0)
  downgradedSubscribers Int @default(0)

  tierBreakdown Json?   // [{tierId, name, count, revenue}]
  currency      String  @default("INR")

  revenueChange    Float? // % vs previous day
  subscriberChange Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)
  site   Site? @relation(fields: [siteId], references: [id], onDelete: SetNull)

  @@unique([authorId, siteId, date])
  @@index([authorId])
  @@index([siteId])
  @@index([date])
  @@map("author_revenue_snapshots")
}

/// Monthly revenue summary for authors
model AuthorRevenueSummary {
  id       BigInt @id @default(autoincrement())
  authorId BigInt
  siteId   String?

  year  Int
  month Int

  totalRevenue        BigInt @default(0)
  subscriptionRevenue BigInt @default(0)
  purchaseRevenue     BigInt @default(0)
  tipRevenue          BigInt @default(0)

  totalFees    BigInt @default(0)
  gatewayFees  BigInt @default(0)
  platformFees BigInt @default(0)
  netRevenue   BigInt @default(0)

  avgActiveSubscribers Float @default(0)
  peakSubscribers      Int   @default(0)
  totalNewSubscribers  Int   @default(0)
  totalChurned         Int   @default(0)
  churnRate            Float @default(0)

  mrr           BigInt @default(0)
  mrrGrowth     Float  @default(0)
  revenueGrowth Float  @default(0)

  payoutAmount    BigInt?
  payoutDate      DateTime?
  payoutReference String?

  currency String @default("INR")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([authorId, siteId, year, month])
  @@index([authorId])
  @@index([siteId])
  @@index([year, month])
  @@map("author_revenue_summaries")
}

/// A/B Tests
model ABTest {
  id          String       @id @default(cuid())
  siteId      String
  name        String       @db.VarChar(100)
  description String?      @db.Text

  testElement    String    // e.g. 'pricing_page', 'cta_text'
  variants       Json      // [{id, name, value, trafficPercent}]
  trafficPercent Int       @default(100) @db.SmallInt
  successMetric  String    // 'click_rate', 'conversion_rate'

  minSampleSize       Int   @default(1000)
  confidenceThreshold Float @default(0.95)

  status ABTestStatus @default(DRAFT)

  startedAt DateTime?
  pausedAt  DateTime?
  endedAt   DateTime?

  winningVariant    String?
  results           Json?
  currentSampleSize Int     @default(0)
  isSignificant     Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  site        Site               @relation(fields: [siteId], references: [id], onDelete: Cascade)
  assignments ABTestAssignment[]

  @@index([siteId, status])
  @@map("ab_tests")
}

/// A/B test assignment (Composite PK)
model ABTestAssignment {
  testId    String
  visitorId String // userId or sessionId

  variantId String

  converted       Boolean   @default(false)
  convertedAt     DateTime?
  conversionValue Float?

  exposedAt DateTime @default(now())
  exposures Int      @default(1) @db.SmallInt

  assignedAt DateTime @default(now())

  // Relations
  test ABTest @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@id([testId, visitorId])
  @@index([variantId])
  @@index([converted])
  @@map("ab_test_assignments")
}
9.2 API Endpoints
YAML

# ============================================================================
# ANALYTICS MODULE - API ENDPOINTS
# ============================================================================

Site Analytics:
  - GET /api/v1/sites/:siteId/analytics/overview          # high-level KPIs
  - GET /api/v1/sites/:siteId/analytics/traffic           # page views, visitors
  - GET /api/v1/sites/:siteId/analytics/engagement        # comments, reactions
  - GET /api/v1/sites/:siteId/analytics/revenue           # revenue charts
  - GET /api/v1/sites/:siteId/analytics/subscribers       # subscriber metrics
  - GET /api/v1/sites/:siteId/analytics/content           # top series/chapters
  - GET /api/v1/sites/:siteId/analytics/funnel            # visitor → reader → sub
  - GET /api/v1/sites/:siteId/analytics/realtime          # current active users
  - POST /api/v1/sites/:siteId/analytics/export           # export CSV/JSON

Series Analytics:
  - GET /api/v1/series/:seriesId/analytics                # series overview
  - GET /api/v1/series/:seriesId/analytics/chapters       # per-chapter stats
  - GET /api/v1/series/:seriesId/analytics/retention      # reader retention
  - GET /api/v1/series/:seriesId/analytics/conversion     # view→sub conversion

Chapter Analytics:
  - GET /api/v1/chapters/:chapterId/analytics             # chapter stats

Author Revenue Analytics:
  - GET /api/v1/analytics/revenue/author                  # author-wide rev
  - GET /api/v1/analytics/revenue/author/daily            # daily snapshots
  - GET /api/v1/analytics/revenue/author/monthly          # monthly summaries
  - GET /api/v1/analytics/revenue/author/export           # export revenue

Event Ingestion (internal / collector):
  - POST /api/v1/analytics/events                         # bulk event ingest

A/B Testing:
  - GET    /api/v1/sites/:siteId/ab-tests                 # list tests
  - POST   /api/v1/sites/:siteId/ab-tests                 # create test
  - GET    /api/v1/ab-tests/:testId                       # get test
  - PATCH  /api/v1/ab-tests/:testId                       # update test
  - DELETE /api/v1/ab-tests/:testId                       # delete test

  - POST   /api/v1/ab-tests/:testId/start                 # start experiment
  - POST   /api/v1/ab-tests/:testId/pause                 # pause experiment
  - POST   /api/v1/ab-tests/:testId/stop                  # stop experiment
  - GET    /api/v1/ab-tests/:testId/results               # get results
  - POST   /api/v1/ab-tests/:testId/apply-winner          # apply winning variant
9.3 Backend Folder Structure
text

backend/
├── src/
│   └── modules/
│       └── analytics/
│           ├── index.ts
│           ├── analytics.module.ts
│           │
│           ├── site-analytics/
│           │   ├── site-analytics.routes.ts
│           │   ├── site-analytics.controller.ts
│           │   ├── site-analytics.service.ts
│           │   ├── site-analytics.repository.ts
│           │   └── dto/
│           │       ├── site-analytics-response.dto.ts
│           │       └── site-funnel-response.dto.ts
│           │
│           ├── series-analytics/
│           │   ├── series-analytics.routes.ts
│           │   ├── series-analytics.controller.ts
│           │   ├── series-analytics.service.ts
│           │   ├── series-analytics.repository.ts
│           │   └── dto/
│           │       └── series-analytics-response.dto.ts
│           │
│           ├── author-analytics/
│           │   ├── author-analytics.routes.ts
│           │   ├── author-analytics.controller.ts
│           │   ├── author-analytics.service.ts
│           │   ├── author-analytics.repository.ts
│           │   └── dto/
│           │       └── author-revenue-response.dto.ts
│           │
│           ├── events/
│           │   ├── analytics-events.routes.ts
│           │   ├── analytics-events.controller.ts
│           │   ├── analytics-events.service.ts
│           │   └── analytics-events.repository.ts
│           │
│           └── ab-tests/
│               ├── ab-tests.routes.ts
│               ├── ab-tests.controller.ts
│               ├── ab-tests.service.ts
│               ├── ab-tests.repository.ts
│               └── dto/
│                   ├── ab-test.dto.ts
│                   └── ab-test-results.dto.ts
│
├── workers/
│   ├── analytics-aggregation.worker.ts      # roll-up events to aggregates
│   ├── analytics-retention.worker.ts        # retention & cohorts
│   └── ab-test-evaluation.worker.ts         # significance checks
9.4 Frontend Folder Structure
text

frontend/
├── src/
│   ├── app/
│   │   └── (dashboard)/
│   │       └── dashboard/
│   │           ├── analytics/
│   │           │   ├── page.tsx              # site analytics overview
│   │           │   ├── traffic/page.tsx
│   │           │   ├── content/page.tsx
│   │           │   ├── engagement/page.tsx
│   │           │   ├── revenue/page.tsx
│   │           │   └── subscribers/page.tsx
│   │           └── series/
│   │               └── [seriesId]/
│   │                   └── analytics/page.tsx
│   │
│   └── features/
│       └── analytics/
│           ├── index.ts
│           ├── components/
│           │   ├── kpi-cards.tsx
│           │   ├── time-series-chart.tsx
│           │   ├── funnel-chart.tsx
│           │   ├── retention-cohort-chart.tsx
│           │   ├── geo-chart.tsx
│           │   └── index.ts
│           ├── hooks/
│           │   ├── use-site-analytics.ts
│           │   ├── use-series-analytics.ts
│           │   └── use-author-revenue.ts
│           ├── api/
│           │   ├── analytics.api.ts
│           │   └── ab-tests.api.ts
│           ├── store/
│           │   └── analytics.store.ts
│           └── types/
│               └── analytics.types.ts
10. AI & Translation
10.1 Database Schema
prisma

// ============================================================================
// AI & TRANSLATION MODULE - SCHEMA (Optimized)
// ============================================================================

/// AI writing assistant sessions
model AIWritingSession {
  id              BigInt  @id @default(autoincrement())
  userId          BigInt
  seriesId        String?
  chapterId       String?

  sessionType     String  // brainstorming, outline, dialogue, summary, etc.
  prompt          String  @db.Text
  systemPrompt    String? @db.Text
  response        String  @db.Text

  model           String
  tokensUsed      Int
  promptTokens    Int?
  completionTokens Int?
  estimatedCost   Float?

  wasHelpful      Boolean?
  helpfulRating   Int?   @db.SmallInt
  feedback        String? @db.Text

  responseTimeMs  Int?

  createdAt       DateTime @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  series  Series? @relation(fields: [seriesId], references: [id], onDelete: SetNull)
  chapter Chapter? @relation(fields: [chapterId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([seriesId])
  @@index([chapterId])
  @@index([sessionType])
  @@map("ai_writing_sessions")
}

/// AI usage tracking (monthly quotas)
model AIUsageRecord {
  id     BigInt @id @default(autoincrement())
  userId BigInt

  periodStart DateTime
  periodEnd   DateTime

  // Usage
  translationWordsUsed Int      @default(0)
  translationRequests  Int      @default(0)
  translationLanguages String[] @default([])

  writingTokensUsed    Int @default(0)
  writingRequests      Int @default(0)

  coverGenerationsUsed  Int @default(0) @db.SmallInt
  tiktokVideosGenerated Int @default(0) @db.SmallInt

  // Limits (snapshot)
  translationWordsLimit Int?
  writingTokensLimit    Int?
  coverGenerationsLimit Int? @db.SmallInt
  tiktokVideosLimit     Int? @db.SmallInt

  // Overage
  translationOverage Int    @default(0)
  writingOverage     Int    @default(0)
  overageCharged     BigInt @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, periodStart])
  @@index([userId, periodStart])
  @@map("ai_usage_records")
}

/// Series translation metadata
model SeriesTranslation {
  id       BigInt @id @default(autoincrement())
  seriesId String

  language     String @db.Char(2)
  languageName String

  title    String @db.VarChar(200)
  synopsis String @db.Text

  isPublished Boolean  @default(false)
  publishedAt DateTime?

  isAIGenerated Boolean @default(true)
  aiModel       String?
  aiConfidence  Float?

  isReviewed     Boolean   @default(false)
  reviewedById   BigInt?
  reviewedByName String?
  reviewedAt     DateTime?
  reviewNotes    String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  series Series @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  @@unique([seriesId, language])
  @@index([seriesId])
  @@index([language, isPublished])
  @@map("series_translations")
}

/// Chapter translation content
model ChapterTranslation {
  id       BigInt @id @default(autoincrement())
  chapterId String

  language     String @db.Char(2)
  languageName String

  title       String? @db.VarChar(200)
  content     String  @db.Text
  contentHtml String? @db.Text
  authorNote  String? @db.Text
  wordCount   Int     @default(0)

  isPublished Boolean  @default(false)
  publishedAt DateTime?

  isAIGenerated Boolean @default(true)
  aiModel       String?
  aiConfidence  Float?

  isReviewed     Boolean   @default(false)
  reviewedById   BigInt?
  reviewedByName String?
  reviewedAt     DateTime?
  reviewNotes    String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@unique([chapterId, language])
  @@index([chapterId])
  @@index([language, isPublished])
  @@map("chapter_translations")
}

/// Translation glossary entries
model TranslationGlossary {
  id       BigInt @id @default(autoincrement())
  seriesId String

  sourceText     String @db.VarChar(500)
  sourceLanguage String @default("en") @db.Char(2)
  targetText     String @db.VarChar(500)
  targetLanguage String @db.Char(2)

  termType   String  // character_name, place_name, term, phrase
  context    String? @db.Text
  notes      String? @db.Text

  isApproved Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  series Series @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  @@unique([seriesId, sourceText, targetLanguage])
  @@index([seriesId, targetLanguage])
  @@map("translation_glossary")
}

/// TikTok-style preview videos for chapters
model TikTokPreview {
  id        String @id @default(cuid())
  chapterId String

  videoUrl     String  @db.VarChar(2048)
  thumbnailUrl String? @db.VarChar(2048)
  duration     Int     @db.SmallInt

  width        Int @default(1080) @db.SmallInt
  height       Int @default(1920) @db.SmallInt

  fileSize     Int
  mimeType     String @default("video/mp4")

  status       TikTokPreviewStatus @default(PENDING)
  generationTime Int?

  templateId   String?
  style        Json?

  textContent  String? @db.Text
  textStyle    Json?

  audioTrackId  String?
  audioTrackUrl String? @db.VarChar(2048)
  hasVoiceover  Boolean @default(false)
  voiceId       String?

  errorMessage String?
  retryCount   Int     @default(0) @db.SmallInt

  isPublished Boolean   @default(false)
  publishedAt DateTime?

  tiktokPostId    String?
  tiktokPostUrl   String? @db.VarChar(2048)
  instagramPostId String?
  youtubeShortsId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@index([chapterId])
  @@index([status])
  @@map("tiktok_previews")
}

/// TikTok preview templates
model TikTokTemplate {
  id          String  @id @default(cuid())
  name        String  @db.VarChar(100)
  slug        String  @unique
  description String? @db.Text

  thumbnailUrl String? @db.VarChar(2048)
  previewUrl   String? @db.VarChar(2048)

  config       Json
  contentTypes ContentType[] @default([])

  isPublic     Boolean       @default(true)
  isPremium    Boolean       @default(false)
  requiredTier PlatformTier?

  usageCount   Int @default(0)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([slug])
  @@index([isPublic, isPremium])
  @@map("tiktok_templates")
}
10.2 API Endpoints
YAML

# ============================================================================
# AI & TRANSLATION MODULE - API ENDPOINTS
# ============================================================================

AI Writing Assistant:
  - POST /api/v1/ai/writing/brainstorm                 # general brainstorming
  - POST /api/v1/ai/writing/outline                    # create outline
  - POST /api/v1/ai/writing/dialogue                   # help with dialogue
  - POST /api/v1/ai/writing/description                # descriptive passages
  - POST /api/v1/ai/writing/summary                    # chapter/series summary
  - POST /api/v1/ai/writing/style-transfer             # adjust writing style
  - GET  /api/v1/ai/writing/sessions                   # list past sessions
  - GET  /api/v1/ai/writing/sessions/:sessionId        # session detail
  - GET  /api/v1/ai/writing/usage                      # usage by user

Translation (Series & Chapters):
  - POST /api/v1/series/:seriesId/translations/ai      # AI translate series metadata
  - POST /api/v1/chapters/:chapterId/translations/ai   # AI translate chapter
  - GET  /api/v1/series/:seriesId/translations         # list series translations
  - GET  /api/v1/series/:seriesId/translations/:lang   # get series translation
  - PATCH /api/v1/series/:seriesId/translations/:lang  # update translation
  - DELETE /api/v1/series/:seriesId/translations/:lang # delete translation

  - GET  /api/v1/chapters/:chapterId/translations      # list chapter translations
  - GET  /api/v1/chapters/:chapterId/translations/:lang
  - PATCH/DELETE /api/v1/chapters/:chapterId/translations/:lang

Glossary:
  - GET    /api/v1/series/:seriesId/glossary           # list glossary terms
  - POST   /api/v1/series/:seriesId/glossary           # create term
  - PATCH  /api/v1/series/:seriesId/glossary/:id       # edit term
  - DELETE /api/v1/series/:seriesId/glossary/:id       # delete term
  - POST   /api/v1/series/:seriesId/glossary/import    # bulk import terms
  - GET    /api/v1/series/:seriesId/glossary/export    # export glossary

AI Usage:
  - GET /api/v1/ai/usage                               # current period usage
  - GET /api/v1/ai/usage/history                       # historical usage
  - GET /api/v1/ai/limits                              # limits for current tier

TikTok Previews:
  - POST /api/v1/chapters/:chapterId/tiktok-previews   # request preview generation
  - GET  /api/v1/chapters/:chapterId/tiktok-previews   # list previews
  - GET  /api/v1/tiktok-previews/:previewId            # preview detail
  - POST /api/v1/tiktok-previews/:previewId/publish    # mark as published
  - POST /api/v1/tiktok-previews/:previewId/retry      # retry generation
  - GET  /api/v1/tiktok-templates                      # list templates
  - GET  /api/v1/tiktok-templates/:slug                # template detail
10.3 Backend Folder Structure
text

backend/
├── src/
│   └── modules/
│       └── ai/
│           ├── index.ts
│           ├── ai.module.ts
│           │
│           ├── writing-assistant/
│           │   ├── writing.routes.ts
│           │   ├── writing.controller.ts
│           │   ├── writing.service.ts
│           │   ├── writing.repository.ts
│           │   └── providers/
│           │       ├── openai.provider.ts
│           │       └── model-selector.service.ts
│           │
│           ├── translation/
│           │   ├── translation.routes.ts
│           │   ├── translation.controller.ts
│           │   ├── translation.service.ts
│           │   ├── translation.repository.ts
│           │   └── providers/
│           │       ├── translation.provider.ts       # e.g. DeepL, custom
│           │       └── glossary-applier.ts
│           │
│           ├── glossary/
│           │   ├── glossary.routes.ts
│           │   ├── glossary.controller.ts
│           │   ├── glossary.service.ts
│           │   └── glossary.repository.ts
│           │
│           ├── usage/
│           │   ├── usage.routes.ts
│           │   ├── usage.controller.ts
│           │   ├── usage.service.ts
│           │   └── usage.repository.ts
│           │
│           └── tiktok/
│               ├── tiktok.routes.ts
│               ├── tiktok.controller.ts
│               ├── tiktok.service.ts
│               ├── tiktok.repository.ts
│               └── providers/
│                   ├── video-generator.ts
│                   ├── audio-generator.ts
│                   └── tiktok-uploader.ts
│
├── workers/
│   ├── ai-usage-aggregation.worker.ts
│   ├── tiktok-generation.worker.ts
│   └── translation-batch.worker.ts
10.4 Frontend Folder Structure
text

frontend/
├── src/
│   ├── app/
│   │   └── (dashboard)/
│   │       └── dashboard/
│   │           ├── ai/
│   │           │   ├── page.tsx                 # AI overview
│   │           │   ├── writing/page.tsx         # Writing assistant console
│   │           │   ├── translation/page.tsx     # Translation dashboard
│   │           │   └── usage/page.tsx           # AI usage & limits
│   │           └── series/[seriesId]/ai/page.tsx # Series-specific AI tools
│   │
│   └── features/
│       └── ai/
│           ├── index.ts
│           ├── components/
│           │   ├── writing-assistant-panel.tsx
│           │   ├── ai-suggestion-card.tsx
│           │   ├── translation-panel.tsx
│           │   ├── translation-diff-view.tsx
│           │   ├── glossary-editor.tsx
│           │   ├── ai-usage-meter.tsx
│           │   └── index.ts
│           ├── hooks/
│           │   ├── use-ai-writing.ts
│           │   ├── use-translation.ts
│           │   ├── use-glossary.ts
│           │   └── use-ai-usage.ts
│           ├── api/
│           │   ├── ai-writing.api.ts
│           │   ├── translation.api.ts
│           │   └── ai-usage.api.ts
│           └── types/
│               └── ai.types.ts


11. Social & Engagement
11.1 Database Schema (Models Used)
These models are already defined in the optimized Prisma schema:

prisma

// Follow relationships
model AuthorFollow {
  followerId BigInt
  authorId   BigInt
  notifyNewSeries     Boolean @default(true)
  notifyNewChapters   Boolean @default(true)
  notifyAnnouncements Boolean @default(true)
  createdAt DateTime @default(now())
  // relations: follower User, author User
}

// Comments & reactions
model Comment {
  id        BigInt @id @default(autoincrement())
  userId    BigInt
  chapterId String
  parentId  BigInt?
  depth     Int    @default(0) @db.SmallInt
  content   String @db.Text
  hasSpoiler Boolean @default(false)
  isHidden  Boolean @default(false)
  isPinned  Boolean @default(false)
  isEdited  Boolean @default(false)
  // relations: user, chapter, parent, replies, reactions
}

model Reaction {
  id        BigInt @id @default(autoincrement())
  userId    BigInt
  chapterId String?
  commentId BigInt?
  type      String
  createdAt DateTime @default(now())
  // unique: [userId, chapterId, type], [userId, commentId, type]
}

// Reviews & votes
model Review {
  id        String @id @default(cuid())
  userId    BigInt
  seriesId  String
  rating    Float
  content   String @db.Text
  isHidden  Boolean @default(false)
  isEdited  Boolean @default(false)
  // stats: helpfulCount, unhelpfulCount
  // relations: user, series, votes
}

model ReviewVote {
  reviewId  String
  userId    BigInt
  isHelpful Boolean
  createdAt DateTime @default(now())
  // relations: review, user
}

// Reading progress & lists
model ReadingProgress { /* defined earlier */ }
model ReadingList      { /* defined earlier */ }
model ReadingListItem  { /* defined earlier */ }
model ReadingListFollow { /* defined earlier */ }
model Bookmark         { /* defined earlier */ }

// Reader settings & engagement
model ReaderSettings        { /* defined earlier */ }
model ReaderEngagementScore { /* defined earlier */ }
11.2 API Endpoints
YAML

# ============================================================================
# SOCIAL & ENGAGEMENT MODULE - API ENDPOINTS
# ============================================================================

Author Follow:
  - POST   /api/v1/authors/:authorId/follow          # Follow author
  - POST   /api/v1/authors/:authorId/unfollow        # Unfollow author
  - GET    /api/v1/authors/:authorId/followers       # List followers (author)
  - GET    /api/v1/me/following                      # Authors I follow
  - PATCH  /api/v1/authors/:authorId/follow-settings # Update follow notification prefs

Comments:
  - GET    /api/v1/chapters/:chapterId/comments      # List comments
  - POST   /api/v1/chapters/:chapterId/comments      # Add comment
  - GET    /api/v1/comments/:commentId               # Get single comment
  - PATCH  /api/v1/comments/:commentId               # Edit own comment
  - DELETE /api/v1/comments/:commentId               # Delete own comment
  - POST   /api/v1/comments/:commentId/reply         # Reply to comment
  - GET    /api/v1/comments/:commentId/replies       # Replies for a comment

  Author / Moderator actions:
    - POST   /api/v1/comments/:commentId/hide        # Hide comment
    - POST   /api/v1/comments/:commentId/unhide
    - POST   /api/v1/comments/:commentId/pin         # Pin comment
    - POST   /api/v1/comments/:commentId/unpin

Reactions:
  - POST   /api/v1/chapters/:chapterId/reactions     # React to chapter
  - DELETE /api/v1/chapters/:chapterId/reactions     # Remove chapter reaction
  - POST   /api/v1/comments/:commentId/reactions     # React to comment
  - DELETE /api/v1/comments/:commentId/reactions     # Remove comment reaction
  - GET    /api/v1/chapters/:chapterId/reactions     # List reactions summary
  - GET    /api/v1/comments/:commentId/reactions     # List reactions summary

Reviews:
  - GET    /api/v1/series/:seriesId/reviews          # List reviews
  - POST   /api/v1/series/:seriesId/reviews          # Create review
  - GET    /api/v1/reviews/:reviewId                 # Get review
  - PATCH  /api/v1/reviews/:reviewId                 # Edit own review
  - DELETE /api/v1/reviews/:reviewId                 # Delete own review

  Author actions:
    - POST   /api/v1/reviews/:reviewId/respond       # Author response
    - POST   /api/v1/reviews/:reviewId/hide          # Hide review
    - POST   /api/v1/reviews/:reviewId/unhide

  Helpful votes:
    - POST   /api/v1/reviews/:reviewId/vote          # Mark helpful/unhelpful
    - DELETE /api/v1/reviews/:reviewId/vote

Reading Progress & Lists:
  - GET    /api/v1/reading-progress/:seriesId        # Get progress
  - POST   /api/v1/reading-progress/:seriesId        # Update progress
  - DELETE /api/v1/reading-progress/:seriesId        # Clear progress

  Reading Lists:
    - GET    /api/v1/reading-lists                   # My lists
    - POST   /api/v1/reading-lists                   # Create list
    - GET    /api/v1/reading-lists/:listId           # Get list
    - PATCH  /api/v1/reading-lists/:listId           # Update list
    - DELETE /api/v1/reading-lists/:listId           # Delete list
    - GET    /api/v1/reading-lists/:listId/items     # List items
    - POST   /api/v1/reading-lists/:listId/items     # Add series
    - PATCH  /api/v1/reading-lists/:listId/items     # Reorder/update notes
    - DELETE /api/v1/reading-lists/:listId/items/:seriesId

  List Following:
    - POST   /api/v1/reading-lists/:listId/follow
    - DELETE /api/v1/reading-lists/:listId/follow
    - GET    /api/v1/reading-lists/:listId/followers

Bookmarks:
  - GET    /api/v1/bookmarks                         # My bookmarks
  - POST   /api/v1/bookmarks                         # Create bookmark
  - DELETE /api/v1/bookmarks/:bookmarkId

Reader Settings:
  - GET    /api/v1/reader/settings                   # Get reading settings
  - PATCH  /api/v1/reader/settings                   # Update settings
11.3 Backend Folder Structure
text

backend/
├── src/modules/social/
│   ├── index.ts
│   ├── social.module.ts
│   │
│   ├── follows/
│   │   ├── follows.routes.ts
│   │   ├── follows.controller.ts
│   │   ├── follows.service.ts
│   │   └── follows.repository.ts
│   │
│   ├── comments/
│   │   ├── comments.routes.ts
│   │   ├── comments.controller.ts
│   │   ├── comments.service.ts
│   │   └── comments.repository.ts
│   │
│   ├── reactions/
│   │   ├── reactions.routes.ts
│   │   ├── reactions.controller.ts
│   │   ├── reactions.service.ts
│   │   └── reactions.repository.ts
│   │
│   ├── reviews/
│   │   ├── reviews.routes.ts
│   │   ├── reviews.controller.ts
│   │   ├── reviews.service.ts
│   │   └── reviews.repository.ts
│   │
│   ├── reading-lists/
│   │   ├── reading-lists.routes.ts
│   │   ├── reading-lists.controller.ts
│   │   ├── reading-lists.service.ts
│   │   └── reading-lists.repository.ts
│   │
│   ├── bookmarks/
│   │   ├── bookmarks.routes.ts
│   │   ├── bookmarks.controller.ts
│   │   ├── bookmarks.service.ts
│   │   └── bookmarks.repository.ts
│   │
│   └── reader-settings/
│       ├── reader-settings.routes.ts
│       ├── reader-settings.controller.ts
│       ├── reader-settings.service.ts
│       └── reader-settings.repository.ts
11.4 Frontend Folder Structure
text

frontend/
├── src/app/(reader)/
│   ├── library/page.tsx                 # Reading lists & progress
│   ├── bookmarks/page.tsx
│   └── settings/reading/page.tsx       # ReaderSettings UI
│
├── src/app/(sites)/[site]/series/[seriesSlug]/[chapterSlug]/
│   └── page.tsx                        # Reader page (comments, reactions, etc.)
│
├── src/features/social/
│   ├── comments/
│   ├── reactions/
│   ├── reviews/
│   ├── follows/
│   ├── reading-lists/
│   ├── bookmarks/
│   └── reader-settings/


Understood. Here is **everything for Module 12 (Communication)** from **12.1 onward**, in the same structured style as your earlier sections (schema + API + backend + frontend), with **full Prisma models** and no “already defined” shortcuts.

---

# 12. Communication

## 12.1 Database Schema (Full Prisma Models)

```prisma
// ============================================================================
// COMMUNICATION MODULE - SCHEMA (Optimized)
// ============================================================================
//
// Models:
//   - Notification       (in-app notifications)
//   - EmailLog           (email delivery logs)
//   - Announcement       (site announcements / blog posts)
//   - PushSubscription   (Web Push subscriptions)
// ============================================================================

enum NotificationType {
  NEW_CHAPTER
  NEW_SUBSCRIBER
  SUBSCRIBER_CANCELLED
  COMMENT
  COMMENT_REPLY
  MENTION
  REVIEW
  SUBSCRIPTION_RENEWAL
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  MILESTONE
  ANNOUNCEMENT
  SYSTEM
}

enum EmailType {
  WELCOME
  EMAIL_VERIFICATION
  PASSWORD_RESET
  NEW_CHAPTER
  RENEWAL_REMINDER
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  PAYMENT_RETRY
  SUBSCRIPTION_CANCELLED
  SUBSCRIPTION_EXPIRED
  SECURITY_ALERT
  BROADCAST
  NEWSLETTER
  ANNOUNCEMENT
  WIN_BACK
  CHURN_PREVENTION
}

enum EmailStatus {
  QUEUED
  SENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
  SPAM_REPORTED
  UNSUBSCRIBED
}

/// In-app notifications delivered to users
model Notification {
  id     BigInt @id @default(autoincrement())
  userId BigInt

  type    NotificationType
  title   String  @db.VarChar(100)
  message String  @db.Text

  // Optional reference to related entity (for deep linking)
  referenceType String? // e.g. 'series', 'chapter', 'payment'
  referenceId   String?

  // URL to open when clicking the notification
  actionUrl String? @db.VarChar(2048)

  // Read state
  isRead Boolean   @default(false)
  readAt DateTime?

  // Delivery over email/push (for audit)
  emailSent   Boolean   @default(false)
  emailSentAt DateTime?
  pushSent    Boolean   @default(false)
  pushSentAt  DateTime?

  // For grouping/batching in UI
  groupKey String?

  createdAt DateTime @default(now())
  expiresAt DateTime? // Auto-cleanup if set

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt(sort: Desc)])
  @@index([userId, isRead])
  @@index([userId, type, isRead])

  @@map("notifications")
}

/// Email delivery log (transactional + broadcast)
model EmailLog {
  id     BigInt @id @default(autoincrement())
  userId BigInt?

  // Email meta
  type      EmailType
  toEmail   String
  fromEmail String
  fromName  String?
  replyTo   String?
  subject   String

  // Template info
  templateId   String?
  templateData Json?

  // Delivery lifecycle
  status EmailStatus @default(QUEUED)

  queuedAt    DateTime @default(now())
  sentAt      DateTime?
  deliveredAt DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  bouncedAt   DateTime?
  failedAt    DateTime?

  // Engagement
  openCount  Int @default(0) @db.SmallInt
  clickCount Int @default(0) @db.SmallInt

  // Errors / bounces
  errorMessage String?
  errorCode    String?
  bounceType   String? // 'hard', 'soft', etc.

  // Provider info
  provider   String? // 'sendgrid', 'ses', etc.
  externalId String? // Provider's message ID

  createdAt DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Indexes
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([toEmail])
  @@index([createdAt(sort: Desc)])
  @@index([type, status])

  @@map("email_logs")
}

/// Site announcements / blog posts
model Announcement {
  id     String @id @default(cuid())
  siteId String

  title       String  @db.VarChar(200)
  slug        String
  content     String  @db.Text
  contentHtml String? @db.Text
  excerpt     String? @db.VarChar(300)

  coverImageUrl String? @db.VarChar(2048)

  // Publishing
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  scheduledAt DateTime?

  // Display
  isPinned          Boolean @default(false)
  showOnHomepage    Boolean @default(true)
  notifySubscribers Boolean @default(false)

  viewCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  site        Site         @relation(fields: [siteId], references: [id], onDelete: Cascade)
  socialPosts SocialPost[] // Auto-posts to social networks

  // Indexes
  @@unique([siteId, slug])
  @@index([siteId])
  @@index([isPublished])
  @@index([publishedAt(sort: Desc)])
  @@index([siteId, isPublished, isPinned])

  @@map("announcements")
}

/// Web Push notification subscriptions
model PushSubscription {
  id     BigInt @id @default(autoincrement())
  userId BigInt

  // Web Push fields
  endpoint String @unique @db.Text
  p256dh   String @db.Text
  auth     String @db.Text

  // Device info (for debug / analytics)
  userAgent  String?
  deviceType String? // desktop, mobile, tablet
  deviceName String?

  isActive Boolean @default(true)

  // Stats
  lastUsedAt    DateTime?
  deliveryCount Int       @default(0)
  failureCount  Int       @default(0) @db.SmallInt
  lastFailureAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([userId])
  @@index([isActive])
  @@index([userId, isActive])

  @@map("push_subscriptions")
}
```

---

## 12.2 API Endpoints

```yaml
# ============================================================================
# COMMUNICATION MODULE - API ENDPOINTS
# ============================================================================

Notifications:
  - GET    /api/v1/notifications
      # Query params:
      #   status=unread|all
      #   type=NEW_CHAPTER, PAYMENT_FAILED, ...
      #   limit, cursor
  - PATCH  /api/v1/notifications/read-all
      # Mark all current user's notifications as read
  - PATCH  /api/v1/notifications/:notificationId/read
      # Mark a single notification as read
  - DELETE /api/v1/notifications/:notificationId
      # Dismiss a notification (soft delete)
  - GET    /api/v1/notifications/unread-count
      # Returns { count: number }
  - PATCH  /api/v1/notifications/settings
      # Optional per-type settings (if stored in User.preferences or separate model)

Email (Author Comms):
  - GET    /api/v1/sites/:siteId/email/settings
      # From name, from email, reply-to, provider config (masked)
  - PATCH  /api/v1/sites/:siteId/email/settings
      # Update branding and from-address settings
  - POST   /api/v1/sites/:siteId/email/broadcasts
      # Create a broadcast/newsletter to subscribers
  - GET    /api/v1/sites/:siteId/email/broadcasts
      # List broadcasts (with pagination)
  - GET    /api/v1/sites/:siteId/email/broadcasts/:broadcastId
      # Get broadcast details + stats
  - POST   /api/v1/sites/:siteId/email/broadcasts/:broadcastId/cancel
      # Cancel a scheduled broadcast
  - POST   /api/v1/sites/:siteId/email/test
      # Send a test email to the author

Email Logs (Admin/Debug):
  - GET    /api/v1/admin/email/logs
      # Filter by type, status, user, date range
  - GET    /api/v1/admin/email/logs/:id

Announcements:
  - GET    /api/v1/sites/:siteId/announcements
      # Author dashboard list
  - POST   /api/v1/sites/:siteId/announcements
      # Create new announcement
  - GET    /api/v1/announcements/:announcementId
      # Get one (author or admin)
  - PATCH  /api/v1/announcements/:announcementId
      # Update title/content/scheduling
  - DELETE /api/v1/announcements/:announcementId
      # Delete announcement
  - POST   /api/v1/announcements/:announcementId/publish
  - POST   /api/v1/announcements/:announcementId/unpublish

  Public:
    - GET /api/v1/sites/:siteId/announcements/public
        # Public list, filtered by isPublished
    - GET /api/v1/sites/:siteId/announcements/public/:slug
        # Get announcement by slug

Push Subscriptions:
  - POST   /api/v1/push/subscribe
      # body: { endpoint, keys: { p256dh, auth } }
  - DELETE /api/v1/push/unsubscribe
      # body: { endpoint }
  - GET    /api/v1/push/status
      # Check if push is active for current device

  Author-triggered push:
    - POST /api/v1/sites/:siteId/push/test
        # Send test notification to current user
    - POST /api/v1/sites/:siteId/push/broadcast
        # Send broadcast push to subscribers (rate limited)
```

---

## 12.3 Backend Folder Structure

```text
backend/
└── src/
    └── modules/
        └── communication/
            ├── index.ts
            ├── communication.module.ts
            │
            ├── notifications/
            │   ├── notifications.routes.ts
            │   ├── notifications.controller.ts
            │   ├── notifications.service.ts
            │   ├── notifications.repository.ts
            │   └── dto/
            │       ├── list-notifications.dto.ts
            │       ├── notification-response.dto.ts
            │       └── mark-read.dto.ts
            │
            ├── email/
            │   ├── email.routes.ts
            │   ├── email.controller.ts
            │   ├── email.service.ts
            │   ├── email.repository.ts
            │   ├── dto/
            │   │   ├── send-broadcast.dto.ts
            │   │   ├── email-settings.dto.ts
            │   │   └── email-log-response.dto.ts
            │   └── templates/
            │       ├── new-chapter.hbs
            │       ├── newsletter.hbs
            │       └── ...
            │
            ├── announcements/
            │   ├── announcements.routes.ts
            │   ├── announcements.controller.ts
            │   ├── announcements.service.ts
            │   ├── announcements.repository.ts
            │   └── dto/
            │       ├── create-announcement.dto.ts
            │       ├── update-announcement.dto.ts
            │       └── announcement-response.dto.ts
            │
            └── push/
                ├── push.routes.ts
                ├── push.controller.ts
                ├── push.service.ts
                ├── push.repository.ts
                └── providers/
                    ├── web-push.provider.ts   # node-web-push wrapper
                    └── push-payload.builder.ts
```

- **notifications.service.ts**  
  - createNotification(userId, type, payload)
  - listNotifications(userId, filters)
  - markAsRead(userId, notificationId)
  - markAllRead(userId)
- **email.service.ts**  
  - queueEmail(userId?, toEmail, type, templateId, data)
  - sendBroadcast(siteId, payload)
  - integrate with background worker for sending
- **announcements.service.ts**  
  - CRUD, schedule publish, increment viewCount
- **push.service.ts**  
  - subscribe/unsubscribe, sendToUser, sendToSiteSubscribers

Background workers (e.g. under `src/workers`) might include:

```text
workers/
  ├── email-sender.worker.ts        # drains EmailLog with status QUEUED
  ├── push-sender.worker.ts         # send push in batches
  └── announcement-scheduler.worker.ts # publishes scheduled announcements
```

---

## 12.4 Frontend Folder Structure

```text
frontend/
└── src/
    ├── app/
    │   ├── (dashboard)/
    │   │   └── dashboard/
    │   │       ├── announcements/
    │   │       │   ├── page.tsx              # List announcements (author)
    │   │       │   ├── new/page.tsx          # Create announcement
    │   │       │   └── [announcementId]/
    │   │       │       └── edit/page.tsx     # Edit announcement
    │   │       └── email/
    │   │           └── broadcasts/page.tsx   # Email broadcast list & stats
    │   │
    │   └── (sites)/
    │       └── [site]/
    │           ├── announcements/
    │           │   └── page.tsx              # Public announcements listing
    │           └── announcements/[slug]/page.tsx # Public announcement detail
    │
    ├── components/
    │   └── communication/
    │       ├── notification-center/
    │       │   ├── notification-center.tsx
    │       │   ├── notification-list.tsx
    │       │   ├── notification-item.tsx
    │       │   └── index.ts
    │       ├── notification-bell/
    │       │   ├── notification-bell.tsx
    │       │   └── index.ts
    │       ├── announcement-card/
    │       │   ├── announcement-card.tsx
    │       │   ├── announcement-skeleton.tsx
    │       │   └── index.ts
    │       ├── announcement-editor/
    │       │   ├── announcement-editor.tsx
    │       │   ├── announcement-form.tsx
    │       │   └── index.ts
    │       ├── email-broadcast-form/
    │       │   ├── email-broadcast-form.tsx
    │       │   └── index.ts
    │       └── push-permission/
    │           ├── push-permission-button.tsx
    │           └── index.ts
    │
    ├── features/communication/
    │   ├── hooks/
    │   │   ├── use-notifications.ts
    │   │   ├── use-announcements.ts
    │   │   ├── use-email-broadcasts.ts
    │   │   └── use-push-subscription.ts
    │   ├── api/
    │   │   ├── notifications.api.ts
    │   │   ├── announcements.api.ts
    │   │   ├── email.api.ts
    │   │   └── push.api.ts
    │   ├── store/
    │   │   ├── notification.store.ts
    │   │   └── announcement.store.ts
    │   └── types/
    │       ├── notification.types.ts
    │       ├── announcement.types.ts
    │       └── email.types.ts
    │
    └── lib/
        └── notifications/
            ├── notification-client.ts         # SSE/WebSocket client (if used)
            └── notification-adapter.ts
```

---

Continuing from Module 12, here is the **full architecture** for modules **13–21**, each with:

- Prisma **schema** (full models for that module)
- **API endpoints**
- **Backend** folder layout
- **Frontend** folder layout

I’ll avoid “already defined” shortcuts and restate models for clarity.

---

# 13. Discovery & Forum

## 13.1 Database Schema (Prisma)

```prisma
// ============================================================================
// DISCOVERY & FORUM MODULE - SCHEMA (Optimized)
// ============================================================================

/// Forum categories for discovery / community
model ForumCategory {
  id          String  @id @default(cuid())

  name        String  @db.VarChar(100)
  slug        String  @unique
  description String? @db.Text
  iconUrl     String? @db.VarChar(2048)
  color       String? @db.Char(7)

  // Hierarchy
  parentId String?
  parent   ForumCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children ForumCategory[] @relation("CategoryHierarchy")

  // Display
  displayOrder Int     @default(0) @db.SmallInt
  isActive     Boolean @default(true)
  isStaffOnly  Boolean @default(false)

  // Moderation
  requiresApproval Boolean   @default(false)
  moderatorIds     String[]  @default([]) // list of user public IDs or emails

  // Stats (denormalized for fast listing)
  postCount      Int       @default(0)
  threadCount    Int       @default(0)
  lastPostAt     DateTime?
  lastPostId     String?
  lastPostUserId BigInt?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  posts ForumPost[]

  @@index([slug])
  @@index([parentId])
  @@index([isActive])
  @@index([displayOrder])
  @@index([isActive, displayOrder])

  @@map("forum_categories")
}

/// Forum discussion posts (threads and replies)
model ForumPost {
  id         BigInt @id @default(autoincrement())
  authorId   BigInt
  categoryId String

  // Content
  title       String  @db.VarChar(200)
  slug        String
  content     String  @db.Text
  contentHtml String? @db.Text
  excerpt     String? @db.VarChar(300)

  // Threading
  parentId BigInt?
  parent   ForumPost?  @relation("ForumReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  ForumPost[] @relation("ForumReplies")
  depth    Int         @default(0) @db.SmallInt

  // Stats
  viewCount  Int @default(0)
  replyCount Int @default(0)
  likeCount  Int @default(0)

  // Status
  isPinned   Boolean @default(false)
  isLocked   Boolean @default(false)
  isHidden   Boolean @default(false)
  isApproved Boolean @default(true)

  // Moderation
  hiddenReason String?
  hiddenById   BigInt?
  hiddenAt     DateTime?

  // Last activity
  lastActivityAt  DateTime @default(now())
  lastReplyId     BigInt?
  lastReplyUserId BigInt?

  // Edit history
  isEdited  Boolean   @default(false)
  editedAt  DateTime?
  editCount Int       @default(0) @db.SmallInt

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  author User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
  category ForumCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  likes    ForumPostLike[]

  @@unique([categoryId, slug])
  @@index([authorId])
  @@index([categoryId])
  @@index([parentId])
  @@index([isPinned(sort: Desc), lastActivityAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([categoryId, isHidden, isApproved])

  @@map("forum_posts")
}

/// Forum post likes (composite primary key)
model ForumPostLike {
  postId BigInt
  userId BigInt

  createdAt DateTime @default(now())

  // Relations
  post ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([postId, userId])
  @@index([userId])

  @@map("forum_post_likes")
}
```

_Note_: Discovery also uses fields on `Series`:

```prisma
model Series {
  // ...
  isListed      Boolean @default(false)
  listingScore  Float   @default(0)
  trendingScore Float   @default(0)
  featuredAt    DateTime?
  featuredUntil DateTime?
  featuredType  String?
  // ...
}
```

## 13.2 API Endpoints

```yaml
# ============================================================================
# DISCOVERY & FORUM MODULE - API ENDPOINTS
# ============================================================================

Discovery:
  - GET /api/v1/discover
      # Query params:
      #   sort=trending|new|top
      #   genre=:slug
      #   tag=:slug
      #   format=WEB_NOVEL|WEBTOON|...
      #   language=en|hi|...
  - GET /api/v1/discover/trending
  - GET /api/v1/discover/featured
  - GET /api/v1/discover/new
  - GET /api/v1/discover/genre/:genreSlug
  - GET /api/v1/discover/tags/:tagSlug
  - GET /api/v1/discover/format/:contentType
  - GET /api/v1/discover/language/:lang
  - GET /api/v1/discover/recommendations
      # Personalized for current user (uses ReaderEngagementScore, etc.)

Forum Categories:
  - GET /api/v1/forum/categories
  - GET /api/v1/forum/categories/:slug
  - GET /api/v1/forum/categories/:slug/posts
      # Supports pagination & sorting

Forum Posts:
  - GET    /api/v1/forum/posts
      # Global listing with filters (category, tag, user, sort)
  - POST   /api/v1/forum/posts
      # Create new top-level thread
  - GET    /api/v1/forum/posts/:postId
  - PATCH  /api/v1/forum/posts/:postId
      # Edit own post
  - DELETE /api/v1/forum/posts/:postId
      # Soft delete own post

  Replies:
    - GET    /api/v1/forum/posts/:postId/replies
    - POST   /api/v1/forum/posts/:postId/replies
        # body: { content, hasSpoilers? }

  Likes:
    - POST   /api/v1/forum/posts/:postId/like
    - DELETE /api/v1/forum/posts/:postId/like

Moderation (Forum-level, for moderators/admins):
  - POST   /api/v1/forum/posts/:postId/hide
  - POST   /api/v1/forum/posts/:postId/unhide
  - POST   /api/v1/forum/posts/:postId/lock
  - POST   /api/v1/forum/posts/:postId/unlock
  - POST   /api/v1/forum/posts/:postId/pin
  - POST   /api/v1/forum/posts/:postId/unpin
```

## 13.3 Backend Folder Structure

```text
backend/
└── src/
    └── modules/
        └── forum/
            ├── index.ts
            ├── forum.module.ts
            │
            ├── categories/
            │   ├── forum-categories.routes.ts
            │   ├── forum-categories.controller.ts
            │   ├── forum-categories.service.ts
            │   └── forum-categories.repository.ts
            │
            ├── posts/
            │   ├── forum-posts.routes.ts
            │   ├── forum-posts.controller.ts
            │   ├── forum-posts.service.ts
            │   ├── forum-posts.repository.ts
            │   └── dto/
            │       ├── create-post.dto.ts
            │       ├── reply-post.dto.ts
            │       ├── update-post.dto.ts
            │       └── post-response.dto.ts
            │
            ├── likes/
            │   ├── forum-likes.routes.ts
            │   ├── forum-likes.controller.ts
            │   ├── forum-likes.service.ts
            │   └── forum-likes.repository.ts
            │
            └── discovery/
                ├── discovery.routes.ts
                ├── discovery.controller.ts
                ├── discovery.service.ts
                └── discovery.repository.ts
```

## 13.4 Frontend Folder Structure

```text
frontend/
└── src/
    ├── app/
    │   ├── (forum)/
    │   │   └── discover/
    │   │       ├── page.tsx                     # Discovery home
    │   │       ├── trending/page.tsx
    │   │       ├── featured/page.tsx
    │   │       ├── new/page.tsx
    │   │       ├── genre/[genreSlug]/page.tsx
    │   │       ├── tags/[tagSlug]/page.tsx
    │   │       └── format/[format]/page.tsx
    │   │
    │   └── (forum)/
    │       └── posts/
    │           ├── page.tsx                     # Forum index
    │           ├── new/page.tsx                 # New post
    │           └── [postId]/page.tsx            # Thread view (with replies)
    │
    ├── features/forum/
    │   ├── components/
    │   │   ├── forum-post-card.tsx
    │   │   ├── forum-reply.tsx
    │   │   ├── forum-editor.tsx
    │   │   ├── category-sidebar.tsx
    │   │   └── index.ts
    │   ├── hooks/
    │   │   ├── use-forum-posts.ts
    │   │   ├── use-forum-post.ts
    │   │   └── use-forum-categories.ts
    │   ├── api/
    │   │   ├── forum-posts.api.ts
    │   │   └── forum-categories.api.ts
    │   └── types/
    │       └── forum.types.ts
    │
    └── features/discovery/
        ├── components/
        │   ├── discovery-grid.tsx
        │   ├── discovery-filters.tsx
        │   └── index.ts
        ├── hooks/
        │   ├── use-discover.ts
        │   └── use-recommendations.ts
        └── api/discovery.api.ts
```

---

# 14. Search

## 14.1 Database Schema (Prisma)

```prisma
// ============================================================================
// SEARCH MODULE - SCHEMA (Optimized)
// ============================================================================

/// Denormalized search index for full-text and faceted search
model SearchIndex {
  id BigInt @id @default(autoincrement())

  // Entity reference
  entityType String // 'series', 'chapter', 'author', 'product'
  entityId   String

  // Searchable fields
  title      String
  content    String  @db.Text
  excerpt    String? @db.VarChar(500)

  // Facets
  authorId   BigInt?
  authorName String?
  siteId     String?
  siteName   String?
  seriesId   String?
  seriesName String?

  contentType ContentType?
  genres      String[]     @default([])
  tags        String[]     @default([])
  language    String?      @db.Char(2)

  // Ranking signals
  popularity  Float    @default(0)
  quality     Float    @default(0)
  recency     DateTime
  relevance   Float    @default(0)

  // Availability
  isPublic    Boolean  @default(true)
  isActive    Boolean  @default(true)

  // Extra metadata
  metadata    Json?

  updatedAt   DateTime @updatedAt

  @@unique([entityType, entityId])
  @@index([entityType])
  @@index([authorId])
  @@index([siteId])
  @@index([seriesId])
  @@index([language])
  @@index([isPublic, isActive])
  @@index([popularity(sort: Desc)])
  @@index([recency(sort: Desc)])
  @@index([contentType, language, isPublic])

  @@map("search_index")
}
```

Additional **views** used by search/discovery (read-only):

```prisma
view PopularSeries {
  id              String  @unique
  title           String
  slug            String
  coverImageUrl   String?
  contentType     ContentType
  language        String
  averageRating   Float
  subscriberCount Int
  viewCount       BigInt
  trendingScore   Float
  authorId        BigInt
  authorUsername  String
  authorName      String
  siteId          String
  siteSlug        String

  @@map("popular_series")
}
```

## 14.2 API Endpoints

```yaml
# ============================================================================
# SEARCH MODULE - API ENDPOINTS
# ============================================================================

Search:
  - GET /api/v1/search
      # Query:
      #   q: string
      #   type: series|chapter|author|product|all
      #   genre: slug
      #   tag: slug
      #   language: en|hi|...
      #   contentType: WEB_NOVEL|WEBTOON|...
      #   sort: relevance|popular|new
      #   page, pageSize

  - GET /api/v1/search/series
  - GET /api/v1/search/authors
  - GET /api/v1/search/forum

Autocomplete & Suggestions:
  - GET /api/v1/search/suggestions
      # Query:
      #   q: partial term
      # Returns:
      #   [{ type: 'series'|'author'|..., title, slug }]

  - GET /api/v1/search/popular-terms
      # Returns globally popular search terms
```

## 14.3 Backend & Frontend

Backend module: `src/modules/search`  
- `search.service` uses Postgres full-text (`to_tsvector`), `pg_trgm`, and `SearchIndex`.

Frontend:  
- `app/(forum)/discover/search/page.tsx` for global search UI.  
- `features/search/*` for components and hooks.

---

# 15. Moderation & Reports

## 15.1 Database Schema (Prisma)

```prisma
// ============================================================================
// MODERATION & REPORTS MODULE - SCHEMA (Optimized)
// ============================================================================

enum ReportReason {
  SPAM
  HARASSMENT
  HATE_SPEECH
  VIOLENCE_PROMOTION
  SEXUAL_CONTENT_UNTAGGED
  COPYRIGHT_INFRINGEMENT
  MISINFORMATION
  DOXXING
  CSAM
  OTHER
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED_ACTION_TAKEN
  RESOLVED_NO_ACTION
  DISMISSED
  ESCALATED
}

enum ModerationAction {
  NO_ACTION
  WARNING_ISSUED
  CONTENT_HIDDEN
  CONTENT_REMOVED
  USER_SUSPENDED_7_DAYS
  USER_SUSPENDED_30_DAYS
  USER_SUSPENDED_PERMANENT
  USER_BANNED
  ACCOUNT_DELETED
}

/// Content/user reports
model Report {
  id         BigInt       @id @default(autoincrement())
  reporterId BigInt

  // Target of report
  targetType   String      // 'user', 'series', 'chapter', 'comment', 'review', 'forum_post'
  targetId     String
  targetUserId BigInt?

  // Details
  reason      ReportReason
  description String?      @db.Text
  evidence    String[]     @default([]) // URLs, references

  // Status
  status   ReportStatus @default(PENDING)
  priority Int          @default(0) @db.SmallInt

  // Assignment
  assignedTo     String?  // moderator identifier
  assignedAt     DateTime?

  // Resolution
  resolvedAt     DateTime?
  resolvedById   BigInt?
  resolvedByName String?
  resolution     ModerationAction?
  resolutionNote String?   @db.Text

  // Appeal
  appealedAt       DateTime?
  appealReason     String? @db.Text
  appealResolvedAt DateTime?
  appealOutcome    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  reporter   User  @relation("ReportSubmitter", fields: [reporterId], references: [id], onDelete: Cascade)
  targetUser User? @relation("ReportTarget", fields: [targetUserId], references: [id], onDelete: SetNull)

  @@index([reporterId])
  @@index([targetType, targetId])
  @@index([targetUserId])
  @@index([status])
  @@index([reason])
  @@index([priority(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([status, priority])

  @@map("reports")
}

/// Moderation actions log
model ModerationLog {
  id          BigInt          @id @default(autoincrement())
  moderatorId BigInt

  targetType   String
  targetId     String
  targetUserId BigInt?

  action        ModerationAction
  reason        String?
  notes         String?          @db.Text
  internalNotes String?          @db.Text

  // Context
  reportId  BigInt?
  automated Boolean @default(false)

  // Snapshot of content at time of action
  contentSnapshot Json?

  // Reversal
  reversedAt     DateTime?
  reversedById   BigInt?
  reversedByName String?
  reversalReason String?

  createdAt DateTime @default(now())

  // Relations
  moderator  User  @relation("Moderator", fields: [moderatorId], references: [id], onDelete: Restrict)
  targetUser User? @relation("ModeratedUser", fields: [targetUserId], references: [id], onDelete: SetNull)

  @@index([moderatorId])
  @@index([targetType, targetId])
  @@index([targetUserId])
  @@index([action])
  @@index([createdAt(sort: Desc)])
  @@index([automated])

  @@map("moderation_logs")
}

/// Content warnings already defined in Communication of content safety:
model ContentWarning {
  id          String                  @id @default(cuid())
  name        String                  @unique
  slug        String                  @unique
  description String?                 @db.Text
  severity    ContentWarningSeverity  @default(MILD)
  category    ContentWarningCategory
  iconUrl     String?                 @db.VarChar(2048)
  color       String?                 @db.Char(7)
  isActive    Boolean                 @default(true)
  isDefault   Boolean                 @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  series   SeriesContentWarning[]
  chapters ChapterContentWarning[]

  @@index([slug])
  @@index([category])
  @@index([isActive])
  @@map("content_warnings")
}

/// Series-level content warnings (Composite PK)
model SeriesContentWarning {
  seriesId  String
  warningId String
  details   String?  @db.Text
  addedAt   DateTime @default(now())
  addedById BigInt?

  series  Series         @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  warning ContentWarning @relation(fields: [warningId], references: [id], onDelete: Cascade)

  @@id([seriesId, warningId])
  @@index([warningId])
  @@map("series_content_warnings")
}

/// Chapter-level content warnings (Composite PK)
model ChapterContentWarning {
  chapterId String
  warningId String
  details   String?  @db.Text
  addedAt   DateTime @default(now())
  addedById BigInt?

  chapter Chapter        @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  warning ContentWarning @relation(fields: [warningId], references: [id], onDelete: Cascade)

  @@id([chapterId, warningId])
  @@index([warningId])
  @@map("chapter_content_warnings")
}
```

## 15.2 API Endpoints

```yaml
# ============================================================================
# MODERATION & REPORTS MODULE - API ENDPOINTS
# ============================================================================

User Reports:
  - POST /api/v1/reports
      # body: { targetType, targetId, reason, description?, evidenceUrls?[] }
  - GET  /api/v1/my/reports
      # Reports submitted by current user

Site-level Moderation (Author / Site Moderators):
  - GET  /api/v1/sites/:siteId/reports
      # Filter reports related to this site's content
  - GET  /api/v1/sites/:siteId/moderation/queue
      # PENDING or UNDER_REVIEW reports
  - POST /api/v1/sites/:siteId/moderation/:reportId/action
      # body: { action: ModerationAction, notes?, resolutionNote? }
  - POST /api/v1/sites/:siteId/moderation/:reportId/escalate

Platform-level Moderation (Admin):
  - GET  /api/v1/admin/reports
  - GET  /api/v1/admin/reports/:reportId
  - POST /api/v1/admin/reports/:reportId/action
      # Apply ModerationAction platform-wide
  - GET  /api/v1/admin/moderation/log
      # Filter by targetType, targetId, moderator, action
```

Backend module: `src/modules/moderation`.

Frontend:  
- Admin moderation UIs under `app/(admin)/admin/moderation/*`  
- Author site moderation UIs under `app/(dashboard)/dashboard/sites/[siteId]/moderation/*`.

---

# 16. Support & Helpdesk

## 16.1 Database Schema

```prisma
// ============================================================================
// SUPPORT & HELPDESK MODULE - SCHEMA (Optimized)
// ============================================================================

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_ON_CUSTOMER
  WAITING_ON_THIRD_PARTY
  RESOLVED
  CLOSED
  REOPENED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TicketCategory {
  ACCOUNT_ACCESS
  BILLING
  PAYMENT_ISSUE
  TECHNICAL_BUG
  CONTENT_ISSUE
  FEATURE_REQUEST
  ABUSE_REPORT
  OTHER
}

/// Support tickets
model SupportTicket {
  id     BigInt @id @default(autoincrement())
  userId BigInt

  ticketNumber String @unique
  subject      String @db.VarChar(200)

  category TicketCategory
  priority TicketPriority @default(MEDIUM)
  status   TicketStatus   @default(OPEN)

  // Assignment
  assignedToId   String?   // internal user / group
  assignedToName String?
  assignedAt     DateTime?

  // Tags for filtering
  tags String[] @default([])

  // SLA tracking
  slaDeadline      DateTime?
  slaBreach        Boolean   @default(false)
  firstResponseAt  DateTime?
  firstResponseSla Boolean?  // met SLA?

  // Resolution
  resolvedAt        DateTime?
  resolutionTimeMin Int?
  closedAt          DateTime?

  // Feedback
  satisfactionRating   Int?    @db.SmallInt // 1-5
  satisfactionFeedback String? @db.Text

  // Metadata
  userPlatformTier  PlatformTier?
  relatedEntityType String?  // e.g. 'payment', 'series'
  relatedEntityId   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages TicketMessage[]

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([assignedToId])
  @@index([ticketNumber])
  @@index([createdAt(sort: Desc)])
  @@index([status, priority])
  @@index([status, assignedToId])

  @@map("support_tickets")
}

/// Messages within a support ticket
model TicketMessage {
  id       BigInt @id @default(autoincrement())
  ticketId BigInt
  userId   BigInt?

  isStaff   Boolean @default(false)
  isAI      Boolean @default(false)
  staffName String?

  content     String  @db.Text
  contentHtml String? @db.Text

  attachments Json?   // [{name, url, size, type}]

  isInternal Boolean  @default(false) // internal notes

  createdAt DateTime  @default(now())

  // Relations
  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([ticketId])
  @@index([userId])
  @@index([ticketId, createdAt])

  @@map("ticket_messages")
}
```

## 16.2 API Endpoints

```yaml
# ============================================================================
# SUPPORT & HELPDESK MODULE - API ENDPOINTS
# ============================================================================

User-facing:
  - GET    /api/v1/support/tickets
  - POST   /api/v1/support/tickets
      # body: { subject, category, description, attachments? }
  - GET    /api/v1/support/tickets/:ticketNumber
  - POST   /api/v1/support/tickets/:ticketNumber/messages
      # Add message
  - POST   /api/v1/support/tickets/:ticketNumber/close
  - POST   /api/v1/support/tickets/:ticketNumber/reopen
  - POST   /api/v1/support/tickets/:ticketNumber/rate
      # Satisfaction rating

Agent/Admin:
  - GET    /api/v1/admin/support/tickets
      # filters: status, priority, category, assignedTo
  - GET    /api/v1/admin/support/tickets/:ticketNumber
  - PATCH  /api/v1/admin/support/tickets/:ticketNumber
      # Change status, priority, assignment
  - POST   /api/v1/admin/support/tickets/:ticketNumber/messages
      # Staff response or internal note
  - GET    /api/v1/admin/support/stats
      # queue size, sla, response times
```

Backend: `modules/support`.  
Frontend:  
- `/reader/support` for user tickets  
- `/admin/support` for staff consoles.

---

# 17. Admin & System

## 17.1 Database Schema

```prisma
// ============================================================================
// ADMIN & SYSTEM MODULE - SCHEMA (Optimized)
// ============================================================================

model AuditLog {
  id BigInt @id @default(autoincrement())

  userId    BigInt?
  userEmail String?
  userRole  String?
  ipAddress String? @db.VarChar(45)
  userAgent String? @db.Text

  action       String
  actionType   String? // 'create', 'update', 'delete', 'access'
  resourceType String  // 'user', 'series', 'payment', ...
  resourceId   String?
  resourceName String?

  oldValue Json?
  newValue Json?
  changes  Json?
  metadata Json?

  success      Boolean @default(true)
  errorMessage String?
  errorCode    String?

  requestId  String?
  sessionId  String?
  durationMs Int?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([actionType])
  @@index([resourceType])
  @@index([resourceType, resourceId])
  @@index([createdAt(sort: Desc)])
  @@index([userId, createdAt])

  @@map("audit_logs")
}

model FeatureFlag {
  id   String @id @default(cuid())
  key  String @unique
  name String @db.VarChar(100)
  description String? @db.Text

  isEnabled Boolean @default(false)

  enabledForTiers  PlatformTier[] @default([])
  enabledForUsers  String[]       @default([])
  disabledForUsers String[]       @default([])

  enabledPercent Int @default(0) @db.SmallInt

  enableAt  DateTime?
  disableAt DateTime?

  category String?
  tags     String[] @default([])

  lastModifiedBy     String?
  lastModifiedByName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([isEnabled])
  @@index([category])
  @@map("feature_flags")
}

model JobQueue {
  id BigInt @id @default(autoincrement())

  queue   String
  jobType String
  jobId   String @unique

  payload Json

  status   JobStatus @default(PENDING)
  priority Int       @default(0) @db.SmallInt

  scheduledFor DateTime?
  startedAt    DateTime?
  completedAt  DateTime?

  attempts    Int       @default(0) @db.SmallInt
  maxAttempts Int       @default(3) @db.SmallInt
  lastError   String?   @db.Text
  nextRetryAt DateTime?
  retryDelay  Int       @default(60)

  progress        Int?    @db.SmallInt
  progressMessage String?
  progressData    Json?

  result Json?

  timeoutSeconds Int @default(300)

  createdBy BigInt?
  metadata  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([queue])
  @@index([jobType])
  @@index([status])
  @@index([priority(sort: Desc)])
  @@index([scheduledFor])
  @@index([createdAt(sort: Desc)])
  @@index([queue, status])
  @@index([status, scheduledFor])
  @@index([status, nextRetryAt])

  @@map("job_queue")
}

model RateLimit {
  id BigInt @id @default(autoincrement())

  key      String
  endpoint String?

  requestCount   Int      @default(0)
  windowStart    DateTime
  windowDuration Int      // seconds

  maxRequests Int

  blockedUntil  DateTime?
  blockReason   String?
  totalBlocked  Int       @default(0)
  lastBlockedAt DateTime?

  updatedAt DateTime @updatedAt

  @@unique([key, endpoint])
  @@index([key])
  @@index([windowStart])
  @@index([blockedUntil])

  @@map("rate_limits")
}

enum HealthStatus {
  HEALTHY
  DEGRADED
  UNHEALTHY
  MAINTENANCE
}

model HealthCheck {
  id BigInt @id @default(autoincrement())

  service  String  // 'database', 'redis', 's3', 'stripe', 'openai', etc.
  endpoint String?

  status         HealthStatus
  responseTimeMs Int?

  details      Json?
  errorMessage String?
  errorCode    String?

  expectedResponseMs Int?
  isWithinThreshold  Boolean?

  checkedAt DateTime @default(now())

  @@index([service])
  @@index([status])
  @@index([checkedAt(sort: Desc)])
  @@index([service, checkedAt])

  @@map("health_checks")
}

enum IncidentSeverity {
  P1_CRITICAL
  P2_HIGH
  P3_MEDIUM
  P4_LOW
}

enum IncidentStatus {
  INVESTIGATING
  IDENTIFIED
  MONITORING
  RESOLVED
}

model Incident {
  id String @id @default(cuid())

  title       String @db.VarChar(200)
  description String @db.Text
  severity    IncidentSeverity

  affectedServices String[] @default([])

  status IncidentStatus @default(INVESTIGATING)

  startedAt    DateTime
  detectedAt   DateTime @default(now())
  identifiedAt DateTime?
  mitigatedAt  DateTime?
  resolvedAt   DateTime?

  durationMinutes Int?
  downtimeMinutes Int?

  lastUpdateAt DateTime?
  updateCount  Int       @default(0) @db.SmallInt

  rootCause      String? @db.Text
  resolution     String? @db.Text
  lessonsLearned String? @db.Text
  actionItems    Json?
  postMortemUrl  String? @db.VarChar(2048)
  postMortemDueAt DateTime?

  commanderId   String?
  commanderName String?
  responders    String[] @default([])

  statusPageUpdated Boolean @default(false)
  customersNotified Boolean @default(false)

  externalTicketId  String?
  externalTicketUrl String? @db.VarChar(2048)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  updates IncidentUpdate[]

  @@index([status])
  @@index([severity])
  @@index([startedAt(sort: Desc)])
  @@index([status, severity])

  @@map("incidents")
}

model IncidentUpdate {
  id         BigInt @id @default(autoincrement())
  incidentId String

  status  IncidentStatus
  message String         @db.Text

  authorId   String?
  authorName String?

  isPublic Boolean @default(true)

  createdAt DateTime @default(now())

  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([incidentId])
  @@index([createdAt])
  @@index([incidentId, createdAt])

  @@map("incident_updates")
}

/// Platform-wide configuration key/values
model PlatformConfig {
  id String @id @default(cuid())

  key       String @unique
  value     String @db.Text
  valueType String  // 'string', 'number', 'boolean', 'json'

  category    String
  description String? @db.Text

  tierOverrides Json? // {FREE: "...", STARTER: "...", ...}

  validationRule String?
  allowedValues  String[] @default([])

  isSecret   Boolean @default(false)
  isEditable Boolean @default(true)

  lastModifiedBy     String?
  lastModifiedByName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([category])

  @@map("platform_config")
}

/// Tier limits definition
model TierLimits {
  id   String       @id @default(cuid())
  tier PlatformTier @unique

  // Content limits
  maxSeries            Int
  maxChaptersPerSeries Int
  maxTotalChapters     Int?

  // Subscriber limits
  maxSubscribers       Int
  maxSubscriptionTiers Int @db.SmallInt

  // Storage limits
  storageLimit   BigInt
  bandwidthLimit BigInt

  // Communication
  emailBroadcastsPerMonth Int
  newsletterSubscribers   Int?

  // AI limits
  translationLanguages     Int @db.SmallInt
  translationWordsPerMonth Int
  writingTokensPerMonth    Int
  coverGenerationsPerMonth Int @db.SmallInt
  tiktokVideosPerMonth     Int? @db.SmallInt

  // Features
  hasCustomDomain        Boolean
  customDomainCount      Int @db.SmallInt
  hasScheduledPublishing Boolean
  hasOneTimePurchases    Boolean
  hasAdvancedDiscounts   Boolean
  hasAdvancedAnalytics   Boolean
  hasCohortAnalysis      Boolean
  hasChurnPrediction     Boolean
  hasABTesting           Boolean
  hasAPIAccess           Boolean
  apiAccessLevel         String?
  hasFeaturedPlacement   Boolean
  featuredSlotsPerMonth  Int @db.SmallInt

  // Support
  supportResponseHours Int?
  hasPrioritySupport   Boolean
  hasDedicatedManager  Boolean
  hasOnboardingCall    Boolean
  onboardingMinutes    Int? @db.SmallInt

  // Version history
  versionHistoryDays Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tier_limits")
}

/// Cache invalidation tracking
model CacheInvalidation {
  id BigInt @id @default(autoincrement())

  cacheKey String
  pattern  String?

  reason       String
  triggeredBy  String?
  triggerEvent String?

  status CacheInvalidationStatus @default(PENDING)

  processedAt     DateTime?
  keysInvalidated Int?
  durationMs      Int?

  createdAt DateTime @default(now())

  @@index([cacheKey])
  @@index([status])
  @@index([createdAt(sort: Desc)])

  @@map("cache_invalidations")
}

enum CacheInvalidationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model APIRequestLog {
  id       BigInt @id @default(autoincrement())
  apiKeyId BigInt?

  method      String @db.VarChar(10)
  endpoint    String @db.VarChar(500)
  queryParams Json?
  requestBody Json?
  requestSize Int?

  statusCode     Int @db.SmallInt
  responseSize   Int?
  responseTimeMs Int

  ipAddress String? @db.VarChar(45)
  userAgent String? @db.Text

  errorMessage String?
  errorCode    String?

  rateLimitRemaining Int?
  rateLimitReset     DateTime?

  createdAt DateTime @default(now())

  apiKey APIKey? @relation(fields: [apiKeyId], references: [id], onDelete: SetNull)

  @@index([apiKeyId])
  @@index([endpoint])
  @@index([statusCode])
  @@index([createdAt(sort: Desc)])
  @@index([apiKeyId, createdAt])
  @@index([endpoint, statusCode, createdAt])

  @@map("api_request_logs")
}
```

## 17.2 API Endpoints

```yaml
# ============================================================================
# ADMIN & SYSTEM MODULE - API ENDPOINTS
# ============================================================================

Health & Status:
  - GET /api/v1/health
      # Basic service status
  - GET /api/v1/status
      # Aggregated status (DB, Redis, queue, 3rd parties)
  - GET /api/v1/admin/health/checks
      # Paginated HealthCheck logs
  - GET /api/v1/admin/incidents
  - POST /api/v1/admin/incidents
  - GET /api/v1/admin/incidents/:incidentId
  - PATCH /api/v1/admin/incidents/:incidentId
  - POST /api/v1/admin/incidents/:incidentId/updates

Feature Flags:
  - GET    /api/v1/admin/feature-flags
  - POST   /api/v1/admin/feature-flags
  - GET    /api/v1/admin/feature-flags/:key
  - PATCH  /api/v1/admin/feature-flags/:key
  - DELETE /api/v1/admin/feature-flags/:key

Platform Config:
  - GET    /api/v1/admin/config
  - GET    /api/v1/admin/config/:key
  - PATCH  /api/v1/admin/config/:key
  - POST   /api/v1/admin/config/cache-invalidate
      # body: { cacheKey?, pattern? }

Audit Logs:
  - GET /api/v1/admin/audit-logs
      # filters: userId, resourceType, action, date range

Jobs:
  - GET    /api/v1/admin/jobs
  - GET    /api/v1/admin/jobs/:jobId
  - POST   /api/v1/admin/jobs/:jobId/retry
  - POST   /api/v1/admin/jobs/:jobId/cancel
```

Backend: `src/modules/admin`, `src/modules/system`.  
Frontend: `/admin/system`, `/admin/flags`, `/admin/audit`, `/admin/jobs`.

---

# 18. Billing & Invoicing (Ownverso SaaS)

## 18.1 Schema

(We already defined `PlatformInvoice`, `AuthorPayout`, `AuthorRevenueSummary`, `AuthorRevenueSnapshot` above under Payments & Analytics. Here we group them logically under billing.)

Key models:

- `PlatformInvoice` – platform → author invoices (usage fee on Free tier or platform subscriptions)
- `AuthorPayout` – payouts summary
- `TierLimits` / `PlatformConfig` for pricing.

## 18.2 API Endpoints

```yaml
# ============================================================================
# OWNERSVO BILLING & INVOICING - API ENDPOINTS
# ============================================================================

Author Platform Subscription:
  - GET    /api/v1/billing/subscription              # get current platform tier & status
  - POST   /api/v1/billing/subscription/change       # upgrade/downgrade tier
  - POST   /api/v1/billing/subscription/cancel       # cancel renewal
  - GET    /api/v1/billing/subscription/history      # past platform subscription events

Platform Invoices (Ownverso → Author):
  - GET    /api/v1/billing/invoices
  - GET    /api/v1/billing/invoices/:invoiceId
  - GET    /api/v1/billing/invoices/:invoiceId/pdf
  - POST   /api/v1/billing/invoices/:invoiceId/pay   # if manual pay needed (rare)

Admin Billing:
  - GET    /api/v1/admin/billing/authors             # list authors & MRR
  - GET    /api/v1/admin/billing/invoices            # platform invoices (all)
  - POST   /api/v1/admin/billing/invoices/generate   # generate invoices for period
```

Backend: `modules/platform-billing`.  
Frontend: `/dashboard/billing`, `/admin/billing`.

---

# 19. Referrals

## 19.1 Schema

```prisma
// ============================================================================
// REFERRAL MODULE - SCHEMA (Optimized)
// ============================================================================

enum ReferralStatus {
  PENDING
  SIGNED_UP
  QUALIFIED
  REWARDED
  EXPIRED
}

/// Referral tracking between users
model Referral {
  id BigInt @id @default(autoincrement())

  // Referrer
  referrerId   BigInt
  referrerCode String

  // Referee
  refereeId BigInt @unique

  status ReferralStatus @default(PENDING)

  qualifiedAt         DateTime?
  qualificationEvent  String?
  qualificationReason String?

  // Rewards
  referrerReward          String?
  referrerRewardValue     Int?
  referrerRewardAppliedAt DateTime?

  refereeReward           String?
  refereeRewardValue      Int?
  refereeRewardAppliedAt  DateTime?

  // Attribution
  landingPage String? @db.VarChar(2048)
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  referrerUrl String? @db.VarChar(2048)

  // Timeline
  clickedAt   DateTime?
  signedUpAt  DateTime?
  convertedAt DateTime?

  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  referrer User @relation("ReferrerUser", fields: [referrerId], references: [id], onDelete: Cascade)
  referee  User @relation("RefereeUser", fields: [refereeId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([referrerCode])
  @@index([status])
  @@index([referrerId, status])
  @@index([createdAt(sort: Desc)])

  @@map("referrals")
}
```

## 19.2 API Endpoints

```yaml
# ============================================================================
# REFERRAL MODULE - API ENDPOINTS
# ============================================================================

Referrer:
  - GET  /api/v1/referrals/code                 # Get my referral code
  - POST /api/v1/referrals/code/regenerate      # Regenerate code
  - GET  /api/v1/referrals                      # List my referrals (as referrer)
  - GET  /api/v1/referrals/stats                # Summary: clicks, signups, rewards

Referee:
  - POST /api/v1/referrals/apply                # Apply referral code during signup
      # body: { code: string }

Admin:
  - GET /api/v1/admin/referrals                 # All referrals with filters
  - POST /api/v1/admin/referrals/:id/mark-rewarded
```

---

# 20. API Keys & Webhooks

## 20.1 Schema

```prisma
// ============================================================================
// API KEYS & WEBHOOKS MODULE - SCHEMA (Optimized)
// ============================================================================

model APIKey {
  id     BigInt @id @default(autoincrement())
  userId BigInt
  siteId String?

  keyHash   String @unique      // SHA-256 hash of API key
  keyPrefix String              // first 8 chars for display
  name      String @db.VarChar(100)
  description String? @db.VarChar(500)

  permissions String[] @default([]) // 'read', 'write', 'delete'
  scopes      String[] @default([]) // 'series', 'chapters', 'payments', etc.

  rateLimit       Int @default(1000)
  rateLimitWindow Int @default(3600)

  allowedIps     String[] @default([])
  allowedOrigins String[] @default([])

  isActive  Boolean @default(true)
  lastUsedAt DateTime?
  usageCount BigInt @default(0)

  expiresAt   DateTime?
  createdByIp String?  @db.VarChar(45)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  site        Site?           @relation(fields: [siteId], references: [id], onDelete: Cascade)
  requestLogs APIRequestLog[]

  @@index([userId])
  @@index([siteId])
  @@index([keyHash])
  @@index([keyPrefix])
  @@index([isActive])
  @@index([userId, isActive])

  @@map("api_keys")
}

enum WebhookEventStatus {
  PENDING
  PROCESSING
  PROCESSED
  FAILED
  RETRYING
  DEAD_LETTER
}

/// Incoming webhook events from payment gateways (and others)
model WebhookEvent {
  id BigInt @id @default(autoincrement())

  gateway  PaymentGateway
  authorId BigInt?

  eventType String
  eventId   String

  payload Json
  headers Json?

  signatureValid Boolean?
  signatureError String?

  status       WebhookEventStatus @default(PENDING)
  processedAt  DateTime?
  errorMessage String?
  retryCount   Int                @default(0) @db.SmallInt
  nextRetryAt  DateTime?

  idempotencyKey String? @unique

  receivedAt       DateTime @default(now())
  processingTimeMs Int?

  createdAt DateTime @default(now())

  @@index([gateway])
  @@index([authorId])
  @@index([eventType])
  @@index([eventId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([gateway, status])
  @@index([status, nextRetryAt])

  @@map("webhook_events")
}

/// Outgoing webhooks (author-defined)
model OutgoingWebhook {
  id     String @id @default(cuid())
  siteId String

  name        String  @db.VarChar(100)
  description String? @db.Text
  url         String  @db.VarChar(2048)
  secret      String  @db.Text // HMAC secret

  events String[] @default([]) // list of event types to send

  isActive     Boolean @default(true)
  retryEnabled Boolean @default(true)
  maxRetries   Int     @default(3) @db.SmallInt
  timeoutMs    Int     @default(30000)

  successCount    Int       @default(0)
  failureCount    Int       @default(0)
  lastTriggeredAt DateTime?
  lastSuccessAt   DateTime?
  lastFailureAt   DateTime?

  isHealthy        Boolean @default(true)
  consecutiveFails Int     @default(0) @db.SmallInt

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  site       Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([siteId])
  @@index([isActive])
  @@index([siteId, isActive])

  @@map("outgoing_webhooks")
}

/// Outgoing webhook delivery log
model WebhookDelivery {
  id        BigInt @id @default(autoincrement())
  webhookId String

  eventType String
  payload   Json

  // Response
  statusCode     Int?    @db.SmallInt
  responseBody   String? @db.Text
  responseTimeMs Int?

  success      Boolean @default(false)
  errorMessage String?

  attempt     Int       @default(1) @db.SmallInt
  nextRetryAt DateTime?

  createdAt DateTime @default(now())

  webhook OutgoingWebhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([eventType])
  @@index([success])
  @@index([createdAt(sort: Desc)])
  @@index([webhookId, success])

  @@map("webhook_deliveries")
}
```

## 20.2 API Endpoints

```yaml
# ============================================================================
# API KEYS & WEBHOOKS MODULE - API ENDPOINTS
# ============================================================================

API Keys:
  - GET    /api/v1/api-keys
  - POST   /api/v1/api-keys
      # body: { name, description?, permissions[], scopes[], rateLimit?, allowedIps?, allowedOrigins? }
  - GET    /api/v1/api-keys/:apiKeyId
  - PATCH  /api/v1/api-keys/:apiKeyId
  - DELETE /api/v1/api-keys/:apiKeyId
  - POST   /api/v1/api-keys/:apiKeyId/regenerate
  - GET    /api/v1/api-keys/:apiKeyId/usage
      # aggregates from APIRequestLog

Outgoing Webhooks:
  - GET    /api/v1/sites/:siteId/webhooks
  - POST   /api/v1/sites/:siteId/webhooks
      # body: { name, url, events[], secret? }
  - GET    /api/v1/webhooks/:webhookId
  - PATCH  /api/v1/webhooks/:webhookId
  - DELETE /api/v1/webhooks/:webhookId
  - POST   /api/v1/webhooks/:webhookId/test
  - GET    /api/v1/webhooks/:webhookId/deliveries
  - POST   /api/v1/webhooks/:webhookId/deliveries/:deliveryId/retry

Incoming Webhooks:
  - POST /api/v1/webhooks/razorpay/:authorPublicId
  - POST /api/v1/webhooks/stripe/:authorPublicId
  - POST /api/v1/webhooks/xendit/:authorPublicId
```

---

# 21. GDPR & Data Export

## 21.1 Database Schema

```prisma
// ============================================================================
// GDPR & DATA EXPORT MODULE - SCHEMA (Optimized)
// ============================================================================

enum DataExportType {
  FULL_ACCOUNT
  CONTENT_ONLY
  SUBSCRIBERS
  ANALYTICS
  TRANSACTIONS
}

enum DataExportFormat {
  JSON
  CSV
  EPUB
  PDF
  MARKDOWN
  ZIP
}

enum DataExportStatus {
  PENDING
  PROCESSING
  READY
  DOWNLOADED
  EXPIRED
  FAILED
}

enum AccountDeletionStatus {
  PENDING
  COOLING_OFF
  VERIFIED
  PROCESSING
  COMPLETED
  CANCELLED
}

/// Data export requests (Right of access / portability)
model DataExportRequest {
  id     BigInt @id @default(autoincrement())
  userId BigInt

  exportType DataExportType
  format     DataExportFormat @default(JSON)

  includeContent      Boolean @default(true)
  includeSubscribers  Boolean @default(true)
  includeAnalytics    Boolean @default(true)
  includeTransactions Boolean @default(true)
  includeComments     Boolean @default(true)
  dateRangeStart      DateTime?
  dateRangeEnd        DateTime?

  status DataExportStatus @default(PENDING)

  // Progress
  progress    Int     @default(0) @db.SmallInt
  currentStep String?

  // Result
  downloadUrl   String?  @db.VarChar(2048)
  fileSizeBytes BigInt?
  fileCount     Int?

  // Timing
  startedAt    DateTime?
  completedAt  DateTime?
  expiresAt    DateTime?
  downloadedAt DateTime?

  // Error
  errorMessage String?

  // Security
  downloadToken String? @unique
  downloadCount Int     @default(0) @db.SmallInt
  maxDownloads  Int     @default(5) @db.SmallInt

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@index([downloadToken])

  @@map("data_export_requests")
}

/// Account deletion requests (Right to erasure)
model AccountDeletionRequest {
  id     BigInt @id @default(autoincrement())
  userId BigInt @unique

  verificationToken String    @unique
  verifiedAt        DateTime?
  verificationIp    String?   @db.VarChar(45)

  reason   String?
  feedback String? @db.Text

  status AccountDeletionStatus @default(PENDING)

  coolingOffEndsAt    DateTime
  scheduledDeletionAt DateTime

  startedAt       DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?
  cancelledReason String?

  backupCreated   Boolean   @default(false)
  backupUrl       String?   @db.VarChar(2048)
  backupExpiresAt DateTime?

  deletionLog Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([scheduledDeletionAt])
  @@index([verificationToken])
  @@index([status, scheduledDeletionAt])

  @@map("account_deletion_requests")
}
```

## 21.2 API Endpoints

```yaml
# ============================================================================
# GDPR & DATA EXPORT MODULE - API ENDPOINTS
# ============================================================================

Data Export:
  - POST /api/v1/account/export
      # body: { exportType, format, includeContent?, includeSubscribers?, ... }
  - GET  /api/v1/account/export/status
      # returns latest request status for current user
  - GET  /api/v1/account/export/download
      # uses downloadToken (in query or temp cookie) to download

Account Deletion:
  - POST /api/v1/account/delete
      # initiate deletion (sets cooling off period)
  - GET  /api/v1/account/delete/status
  - POST /api/v1/account/delete/confirm
      # confirm with verificationToken
  - POST /api/v1/account/delete/cancel
      # cancel request during cooling_off or pending
```

Backend module: `src/modules/gdpr`.  
Frontend pages: `/reader/account/settings/export`, `/reader/account/settings/delete`.

---
