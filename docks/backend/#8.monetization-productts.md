Below is the **Monetization – Products** documentation (Category: ~20 endpoints), in the same style as previous sections.

Treat this as: `docs/backend/monetization-products.md`.

---

# Monetization – Products – Technical Documentation

## 1. Purpose & Scope

The **Monetization – Products** module covers:

- **Digital product catalog** per author site:
  - Types: bonus content, art packs, wallpapers, bundles, etc.
  - Pricing & currency
  - Inventory-like constraints (limited quantity, download limits)

- **One-time purchases**:
  - Purchasing digital products (and optionally chapters)
  - Discount code integration
  - Delivery & download tracking (download count, last download time)
  - Refund metadata

- **Author product management**:
  - CRUD for products
  - Sales stats per product

This module is tightly integrated with:

- **Payments** – actual charging + `Payment` records
- **Discount Codes** – shared with subscriptions
- **Media & Files** – storing downloadable assets

---

## 2. Prisma Schema (Models & Enums)

### 2.1 Relevant Enums

From the global schema; repeated for clarity.

```prisma
enum PaymentStatus {
  PENDING
  PROCESSING
  REQUIRES_ACTION
  SUCCEEDED
  FAILED
  EXPIRED
  REFUNDED
  PARTIALLY_REFUNDED
  DISPUTED
  CHARGEBACK_LOST
  CHARGEBACK_WON
  ON_HOLD
  CANCELLED
}

enum ProductType {
  DIGITAL_DOWNLOAD
  BONUS_CONTENT
  ART_PACK
  WALLPAPER_PACK
  AUDIO_CONTENT
  EBOOK
  BUNDLE
  MERCHANDISE
  COMMISSION_SLOT
  CUSTOM
}
```

(We also reuse `DiscountType` & `DiscountCode` from the Subscriptions doc.)

### 2.2 Models

#### 2.2.1 `Product`

```prisma
model Product {
  id       String @id @default(cuid())
  authorId BigInt
  siteId   String

  name        String      @db.VarChar(100)
  slug        String
  description String?     @db.Text
  shortDesc   String?     @db.VarChar(200)
  productType ProductType @default(DIGITAL_DOWNLOAD)

  coverImageUrl String?  @db.VarChar(2048)
  previewImages String[] @default([])

  price        Int
  comparePrice Int?
  currencyCode String @default("INR") @db.Char(3)

  // Download (actual file stored by storage subsystem)
  downloadFileRef  String? // reference to storage object
  downloadFileName String?
  downloadFileSize Int?
  downloadMimeType String?
  maxDownloads     Int?

  // Inventory-like
  isLimited     Boolean @default(false)
  totalQuantity Int?
  soldCount     Int     @default(0)

  // Availability
  isActive       Boolean   @default(true)
  availableFrom  DateTime?
  availableUntil DateTime?

  displayOrder Int     @default(0) @db.SmallInt
  isFeatured   Boolean @default(false)

  version Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author    AuthorAccount @relation(fields: [authorId], references: [userId], onDelete: Cascade)
  site      Site          @relation(fields: [siteId], references: [id], onDelete: Cascade)
  currency  Currency      @relation(fields: [currencyCode], references: [code])
  purchases Purchase[]

  @@unique([siteId, slug])
  @@index([authorId])
  @@index([siteId, isActive, displayOrder])
  @@index([productType, isActive])

  @@map("products")
}
```

#### 2.2.2 `Purchase`

```prisma
model Purchase {
  id       BigInt @id @default(autoincrement())
  readerId BigInt

  itemType  String // "chapter" or "product"
  chapterId String?
  productId String?

  amount         Int
  discountAmount Int    @default(0)
  finalAmount    Int
  currencyCode   String @db.Char(3)

  discountCodeId String?

  status PaymentStatus @default(PENDING)

  deliveredAt    DateTime?
  downloadCount  Int       @default(0) @db.SmallInt
  lastDownloadAt DateTime?

  refundedAt   DateTime?
  refundReason String?
  refundedBy   BigInt?

  paymentId BigInt?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reader  User     @relation(fields: [readerId], references: [id], onDelete: Cascade)
  chapter Chapter? @relation(fields: [chapterId], references: [id], onDelete: SetNull)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([readerId, status])
  @@index([chapterId])
  @@index([productId])
  @@index([status, createdAt])

  @@map("purchases")
}
```

These models, plus the `DiscountCode` models previously documented, fully cover the Products & Purchases domain.

---

## 3. Backend Implementation

### 3.1 Route & Handler Structure

**Base module:** `src/api/v1/products/` and `src/api/v1/purchases/`

#### 3.1.1 Product Routes – `src/api/v1/products/`

```text
src/api/v1/products/
  index.ts
  products.controller.ts
  products.service.ts
  products.schema.ts
  products.test.ts

  handlers/
    list-products.handler.ts          # GET /sites/{siteId}/products
    create-product.handler.ts         # POST /sites/{siteId}/products
    get-product.handler.ts            # GET /sites/{siteId}/products/{productId}
    update-product.handler.ts         # PUT /sites/{siteId}/products/{productId}
    delete-product.handler.ts         # DELETE /sites/{siteId}/products/{productId}
    upload-cover.handler.ts           # POST /sites/{siteId}/products/{productId}/cover

    public/
      list-site-products.handler.ts   # GET /s/{siteSlug}/shop
      get-public-product.handler.ts   # GET /s/{siteSlug}/shop/{productSlug}

    author/
      get-product-sales.handler.ts    # GET /sites/{siteId}/products/{productId}/sales
      get-products-stats.handler.ts   # GET /sites/{siteId}/products/stats
```

#### 3.1.2 Purchase Routes – `src/api/v1/purchases/`

```text
src/api/v1/purchases/
  index.ts
  purchases.controller.ts
  purchases.service.ts
  purchases.schema.ts
  purchases.test.ts

  handlers/
    list-my-purchases.handler.ts      # GET /purchases
    get-purchase.handler.ts           # GET /purchases/{id}
    make-purchase.handler.ts          # POST /purchases
    download-product.handler.ts       # GET /purchases/{id}/download
    request-refund.handler.ts         # POST /purchases/{id}/refund-request

    chapter-purchase.handler.ts       # POST /chapters/{chapterId}/purchase
    chapter-access-check.handler.ts   # GET /chapters/{chapterId}/access-check
```

**Note:** Payment creation for purchases is done via the Payments module – `purchases.service` orchestrates with `payments.service`.

### 3.2 Domain Layer

**Module:** `src/domain/products/`

```text
src/domain/products/
  entities/
    product.entity.ts
    purchase.entity.ts

  repositories/
    product.repository.ts
    purchase.repository.ts

  services/
    product.service.ts                # Product CRUD, inventory, stats
    purchase.service.ts               # Purchase lifecycle, download checks
    product-sales.service.ts          # Sales analytics per product
```

Highlights:

- `product.service.ts`:
  - Ensures `slug` uniqueness per site.
  - Enforces `totalQuantity` and `soldCount` constraints.
  - Handles feature flipping (`isActive`, `isFeatured`).

- `purchase.service.ts`:
  - Validates item (chapter or product) availability.
  - Integrates with `DiscountCode` and `Payment`:
    - Creates `Payment` with `type = ONE_TIME_PURCHASE`.
    - On payment success, marks `Purchase.status = SUCCEEDED`, sets `deliveredAt`.
  - Enforces `maxDownloads` logic and increments `downloadCount`.

### 3.3 Payments Integration

Purchases and chapter one-time purchases call:

- `payments.service.createPayment({type: ONE_TIME_PURCHASE, ...})`
- After gateway success callback, Payment module calls `purchase.service.markPaid(paymentId)`, which:
  - Sets `Purchase.status = SUCCEEDED`
  - Delivers download links (where applicable)
  - Updates `Product.soldCount`.

Refunds:

- Reader can request refund: `POST /purchases/{id}/refund-request`
- Admin / support uses Payments admin APIs to process actual refund; `Purchase.refundedAt` and `refundReason` are updated and Purchase.status may be aligned to REFUNDED.

---

## 4. Frontend Implementation (Next.js)

### 4.1 Public Shop Pages

Under `src/app/(site)/s/[siteSlug]/shop/`:

```text
src/app/(site)/s/[siteSlug]/shop/
  page.tsx                           # /s/{siteSlug}/shop – list site products
  [productSlug]/
    page.tsx                         # /s/{siteSlug}/shop/{productSlug} – product details

  _components/
    product-grid.tsx
    product-card.tsx
    product-detail.tsx
    add-to-cart-button.tsx           # Optional if implementing cart later
    buy-now-button.tsx               # For immediate checkout
    product-gallery.tsx
    price-display.tsx
    limited-stock-badge.tsx
```

### 4.2 Reader – Purchases & Downloads

Under `src/app/(reader-dashboard)/purchases/`:

```text
src/app/(reader-dashboard)/purchases/
  page.tsx                           # /purchases – list my purchases
  [purchaseId]/
    page.tsx                         # /purchases/{id} – purchase detail

  _components/
    purchase-list.tsx
    purchase-item.tsx
    purchase-status-badge.tsx
    download-button.tsx
    refund-request-form.tsx
```

### 4.3 Author – Product Management

Under `src/app/(author)/products/`:

```text
src/app/(author)/products/
  page.tsx                           # /products – list author products (for default site or site selector)
  create/
    page.tsx                         # /products/create
  [productId]/
    edit/
      page.tsx                       # /products/{productId}/edit
    stats/
      page.tsx                       # /products/{productId}/stats

  _components/
    product-table.tsx
    product-row.tsx
    product-form.tsx
    product-type-selector.tsx
    product-pricing-fields.tsx
    product-download-settings.tsx
    product-availability-fields.tsx
    product-cover-upload.tsx
    product-stats-tiles.tsx
    product-sales-chart.tsx
```

### 4.4 Components

```text
src/components/products/
  product-card.tsx
  product-grid.tsx
  product-detail.tsx
  product-type-badge.tsx
  limited-stock-badge.tsx
  sale-badge.tsx
  price-display.tsx
  purchase-cta.tsx
```

### 4.5 Hooks

```text
src/hooks/
  // Products
  use-products.ts                    # list site products
  use-product-detail.ts              # get single product
  use-create-product.ts              # create
  use-update-product.ts              # update
  use-delete-product.ts              # delete
  use-product-stats.ts               # sales stats
  use-upload-product-cover.ts        # cover upload

  // Purchases
  use-my-purchases.ts                # GET /purchases
  use-purchase-detail.ts             # GET /purchases/{id}
  use-download-product.ts            # GET /purchases/{id}/download
  use-request-purchase-refund.ts     # POST /purchases/{id}/refund-request

  // Chapter purchase
  use-purchase-chapter.ts            # POST /chapters/{chapterId}/purchase
  use-chapter-access-check.ts        # GET /chapters/{chapterId}/access-check
```

### 4.6 Frontend API Client Endpoints

```text
src/lib/api/endpoints/products.ts

export const productsApi = {
  // Author-side
  list: (siteId: string, params?: ProductQueryParams) =>
    api.get<ProductSummaryDto[]>(`/sites/${siteId}/products`, params),

  create: (siteId: string, data: CreateProductDto) =>
    api.post<ProductDetailDto>(`/sites/${siteId}/products`, data),

  get: (siteId: string, productId: string) =>
    api.get<ProductDetailDto>(`/sites/${siteId}/products/${productId}`),

  update: (siteId: string, productId: string, data: UpdateProductDto) =>
    api.put<ProductDetailDto>(`/sites/${siteId}/products/${productId}`, data),

  remove: (siteId: string, productId: string) =>
    api.delete<void>(`/sites/${siteId}/products/${productId}`),

  uploadCover: (siteId: string, productId: string, formData: FormData) =>
    api.upload<ProductDetailDto>(`/sites/${siteId}/products/${productId}/cover`, formData),

  getSales: (siteId: string, productId: string) =>
    api.get<ProductSalesStatsDto>(`/sites/${siteId}/products/${productId}/sales`),

  getStats: (siteId: string) =>
    api.get<ProductsStatsDto>(`/sites/${siteId}/products/stats`),

  // Public shop
  listPublic: (siteSlug: string, params?: PublicProductQueryParams) =>
    api.get<PublicProductSummaryDto[]>(`/s/${siteSlug}/shop`, params),

  getPublic: (siteSlug: string, productSlug: string) =>
    api.get<PublicProductDetailDto>(`/s/${siteSlug}/shop/${productSlug}`),
};
```

```text
src/lib/api/endpoints/purchases.ts

export const purchasesApi = {
  listMyPurchases: (params?: PurchaseQueryParams) =>
    api.get<Paginated<PurchaseDto>>('/purchases', params),

  getPurchase: (id: number | string) =>
    api.get<PurchaseDetailDto>(`/purchases/${id}`),

  makePurchase: (data: CreatePurchaseDto) =>
    api.post<CheckoutSessionDto | PurchaseDetailDto>('/purchases', data),

  downloadProduct: (id: number | string) =>
    api.get<Blob>(`/purchases/${id}/download`),

  requestRefund: (id: number | string, data: RefundRequestDto) =>
    api.post<void>(`/purchases/${id}/refund-request`, data),

  // For chapters
  purchaseChapter: (chapterId: string, data?: PurchaseChapterDto) =>
    api.post<CheckoutSessionDto | PurchaseDetailDto>(`/chapters/${chapterId}/purchase`, data || {}),

  checkChapterAccess: (chapterId: string) =>
    api.get<ChapterAccessCheckDto>(`/chapters/${chapterId}/access-check`),
};
```

---

## 5. API Reference – Products (~20 Endpoints)

Base URL: `https://api.ownverso.com/v1`

### 5.1 Author Product Management (8 endpoints)

1. **GET `/sites/{siteId}/products`**  
   List products for a site.  
   - Auth: Author / Collaborator (MANAGER/EDITOR with proper perms)  
   - Query: `q?`, `productType?`, `isActive?`, pagination.

2. **POST `/sites/{siteId}/products`**  
   Create a new product.  
   - Body:
     - `name`, `slug`, `productType`, `price`, `currencyCode`
     - `description?`, `shortDesc?`
     - `comparePrice?`
     - `isLimited?`, `totalQuantity?`
     - `maxDownloads?`
     - `availableFrom?`, `availableUntil?`

3. **GET `/sites/{siteId}/products/{productId}`**  
   Get full product detail (including download file metadata for author).

4. **PUT `/sites/{siteId}/products/{productId}`**  
   Update product fields.

5. **DELETE `/sites/{siteId}/products/{productId}`**  
   Soft-delete or deactivate product (`isActive = false`).

6. **POST `/sites/{siteId}/products/{productId}/cover`**  
   Upload or change cover image.  
   - Body: multipart/form-data with `file`.

7. **GET `/sites/{siteId}/products/{productId}/sales`**  
   Get sales stats for product (units sold, revenue, refunds).

8. **GET `/sites/{siteId}/products/stats`**  
   Aggregate stats across all products: total revenue, total orders, etc.

### 5.2 Public Shop & Product Detail (2 endpoints)

9. **GET `/s/{siteSlug}/shop`**  
   List active, available products for public shop.  
   - Auth: Public  
   - Query: `productType?`, `sort?`, `page?`, `perPage?`.

10. **GET `/s/{siteSlug}/shop/{productSlug}`**  
    Get public product detail (no download URLs).  
    - Includes: name, description, type, price, comparePrice, availability badges.

### 5.3 Reader Purchases (6 endpoints)

11. **GET `/purchases`**  
    List purchases for current reader.  
    - Auth: User  
    - Query: `status?`, `productType?`, `page?`, `perPage?`.

12. **POST `/purchases`**  
    Make a purchase (generic endpoint for products; chapters use dedicated endpoint).  
    - Auth: User  
    - Body:
      - `itemType`: `"product"`
      - `productId`
      - `discountCode?`
      - `paymentMethodId?`
    - Response:
      - `CheckoutSessionDto` (for gateway redirect) or direct `PurchaseDetailDto` if synchronous.

13. **GET `/purchases/{id}`**  
    Get purchase detail.  
    - Auth: User; must own purchase.

14. **GET `/purchases/{id}/download`**  
    Download product file (if allowed).  
    - Behavior:
      - Checks `status == SUCCEEDED`
      - Checks `maxDownloads` vs `downloadCount`
      - Increments `downloadCount`, updates `lastDownloadAt`
      - Streams file or presigned URL.

15. **POST `/purchases/{id}/refund-request`**  
    Reader-initiated refund request (does not execute refund automatically).  
    - Body: `reason: string`  
    - Creates support ticket or flags purchase for admin.

16. **GET `/chapters/{chapterId}/access-check`**  
    Check if chapter is accessible or requires purchase.  
    - Response:
      - `hasAccess: boolean`
      - `needsPurchase: boolean`
      - `price?`, `currencyCode?`, `hasSubscriptionAccess?`

### 5.4 Chapter One-time Purchase (2 endpoints)

17. **POST `/chapters/{chapterId}/purchase`**  
    Purchase chapter as a one-time item.  
    - Auth: User  
    - Body: `discountCode?`, `paymentMethodId?`  
    - Similar flow to `/purchases`, `itemType = "chapter"`.

18. **(Optional) GET `/chapters/{chapterId}/purchases`**  
    Author/admin-level endpoint to see purchases for a specific chapter (often counted under analytics; optional for the 20 total).

### 5.5 Admin – Product Oversight (2 endpoints)

19. **GET `/admin/products`**  
    Admin list of all products across platform.  
    - Filters: `siteId?`, `authorId?`, `productType?`, `isActive?`.

20. **PUT `/admin/products/{productId}/status`**  
    Force deactivate/activate a product (policy violations, etc.).  
    - Body: `isActive: boolean`, `reason?: string`.

> The exact set of admin endpoints can be tuned, but roughly 2–4 endpoints live in admin land for products, fitting the count.

---

## 6. Integration With Other Modules

- **Payments:**
  - Every successful purchase generates a `Payment` with `type = ONE_TIME_PURCHASE`.
  - Payment refunds change `Purchase.status` and `refundedAt`.

- **Discount Codes:**
  - `discountCodeId` on `Purchase` and discount logic reuse same `DiscountCode` models as subscriptions.

- **Media & Files:**
  - `downloadFileRef` is a key into Media/Storage (S3, R2, etc.); download endpoint uses `MediaFile` and storage provider to deliver the file.

- **Content Management:**
  - `Purchase.itemType = "chapter"` allows selling individual chapters; content gating uses `Purchase` + `ReaderSubscription` + `ChapterAccessLevel`.

- **Analytics:**
  - Purchases contribute to revenue analytics (per product, per site, per series).

- **Support:**
  - `refund-request` endpoints often create Support tickets, linking `Purchase.id` to a `SupportTicket.relatedEntityId`.

---

If this matches what you want, the next category is:

**Reader Engagement (42 endpoints)** – covering:

- Reading progress tracking
- Bookmarks
- Reading lists
- Reader settings
- Reader engagement scores and related analytics hooks.