

# User Management – Technical Documentation

## 1. Purpose & Scope

The **User Management** module covers:

- Viewing and updating own account (profile, preferences, security)
- Avatar upload/removal
- User deletion (initiation; actual deletion via GDPR module)
- Public user profiles (for author/reader discovery)
- Admin-level user search and management (status, role, impersonation)
- Reading localized security info (login history, devices)

This module **assumes** authentication is already handled by the Authentication & Authorization module, and focuses on **who the user is** on the platform, not how they log in.

---

## 2. Prisma Schema (Models & Enums)

We reuse several models from the full schema, but list here all models/enums directly relevant to user management.

### 2.1 Enums

```prisma
enum UserRole {
  READER
  AUTHOR
  COLLABORATOR
  MODERATOR
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  PENDING_VERIFICATION
  ACTIVE
  SUSPENDED
  BANNED
  DELETED
  DEACTIVATED
}

enum PlatformTier {
  FREE
  STARTER
  GROWTH
  PROFESSIONAL
  ENTERPRISE
}

enum EmailDigestFrequency {
  INSTANT
  HOURLY
  DAILY
  WEEKLY
  NEVER
}

enum ContentRating {
  EVERYONE
  TEEN
  MATURE
  ADULT_ONLY
}

enum DataRegion {
  INDIA
  SOUTHEAST_ASIA
  EUROPE
  NORTH_AMERICA
  SOUTH_AMERICA
  AUSTRALIA
  JAPAN
}
```

Additional enums that impact preferences/reader settings:

```prisma
enum ReadingTheme {
  LIGHT
  DARK
  SEPIA
  AMOLED
  SYSTEM
  CUSTOM
}

enum PageWidth {
  NARROW
  MEDIUM
  WIDE
  FULL
}

enum TextAlignment {
  LEFT
  JUSTIFY
  CENTER
  RIGHT
}
```

### 2.2 Core Models

We list the full definitions needed by user management. Some were shown in the auth doc; they are repeated here for completeness.

#### 2.2.1 `User`

```prisma
model User {
  id       BigInt @id @default(autoincrement())
  publicId String @unique @default(cuid())

  email         String     @unique
  emailVerified Boolean    @default(false)
  passwordHash  String?
  username      String     @unique
  displayName   String
  role          UserRole   @default(READER)
  status        UserStatus @default(PENDING_VERIFICATION)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Extensions
  profile       UserProfile?
  security      UserSecurity?
  preferences   UserPreferences?
  authorAccount AuthorAccount?
  readerProfile ReaderProfile?

  // Relations used by management/admin views:
  sessions           Session[]
  authAccounts       AuthAccount[]
  verificationTokens VerificationToken[]

  // Many content/payment/social relations omitted for brevity

  @@index([email])
  @@index([username])
  @@index([publicId])
  @@index([status, role])
  @@index([createdAt])
  @@index([deletedAt])

  @@map("users")
}
```

#### 2.2.2 `UserProfile`

```prisma
model UserProfile {
  userId BigInt @id

  avatarUrl String? @db.VarChar(2048)
  bio       String? @db.Text

  locale     String     @default("en") @db.Char(2)
  timezone   String     @default("UTC") @db.VarChar(50)
  dataRegion DataRegion @default(INDIA)

  websiteUrl      String? @db.VarChar(2048)
  twitterHandle   String? @db.VarChar(50)
  instagramHandle String? @db.VarChar(50)
  tiktokHandle    String? @db.VarChar(50)
  discordHandle   String? @db.VarChar(50)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}
```

#### 2.2.3 `UserSecurity`

Important for “security” section of user settings and admin panels.

```prisma
model UserSecurity {
  userId BigInt @id

  emailVerifiedAt DateTime?

  mfaEnabled     Boolean  @default(false)
  mfaSecret      String?  @db.Text
  mfaBackupCodes String[] @default([])

  lastLoginAt        DateTime?
  lastLoginIp        String?   @db.VarChar(45)
  lastLoginUserAgent String?   @db.Text
  lastLoginDeviceId  String?

  failedLoginCount  Int       @default(0) @db.SmallInt
  lockedUntil       DateTime?
  passwordChangedAt DateTime?
  forceLogoutAt     DateTime?

  statusHistory Json @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_security")
}
```

#### 2.2.4 `UserPreferences`

```prisma
model UserPreferences {
  userId BigInt @id

  emailNotifications   Boolean              @default(true)
  pushNotifications    Boolean              @default(true)
  emailDigestFrequency EmailDigestFrequency @default(DAILY)

  contentLanguages String[]       @default(["en"])
  contentRatings   ContentRating[] @default([EVERYONE, TEEN])
  hiddenGenres     String[]       @default([])
  hiddenTags       String[]       @default([])

  showOnlineStatus    Boolean @default(true)
  showReadingActivity Boolean @default(true)
  allowDirectMessages Boolean @default(true)

  marketingEmails Boolean @default(false)
  newsletterOptIn Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}
```

#### 2.2.5 `ReaderProfile`

Used for reader stats in dashboards & admin.

```prisma
model ReaderProfile {
  userId BigInt @id

  preferredGenres       String[]      @default([])
  preferredContentTypes ContentType[] @default([])

  totalSeriesRead    Int    @default(0)
  totalChaptersRead  Int    @default(0)
  totalReadTimeHours Float  @default(0)
  totalWordsRead     BigInt @default(0)

  activeSubscriptions Int    @default(0) @db.SmallInt
  lifetimeSpent       BigInt @default(0)
  lifetimeCurrency    String @default("INR") @db.Char(3)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reader_profiles")
}
```

#### 2.2.6 `AuthorAccount` (partial, fields relevant to user mgmt)

```prisma
model AuthorAccount {
  userId BigInt @id

  penName String?
  tagline String? @db.VarChar(200)
  fullBio String? @db.Text

  isVerified       Boolean   @default(false)
  verifiedAt       DateTime?
  verificationNote String?

  platformTier           PlatformTier               @default(FREE)
  platformTierStatus     PlatformSubscriptionStatus @default(ACTIVE)
  platformTierStartedAt  DateTime?
  platformTierExpiresAt  DateTime?
  platformBillingCycle   BillingCycle?
  platformTrialEndsAt    DateTime?

  stripeCustomerId   String?
  razorpayCustomerId String?
  xenditCustomerId   String?

  // ... usage and stats fields

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([platformTier, platformTierStatus])

  @@map("author_accounts")
}
```

#### 2.2.7 `Session` (for login history & session list)

```prisma
model Session {
  id     BigInt @id @default(autoincrement())
  userId BigInt

  tokenHash        String @unique
  refreshTokenHash String @unique

  isRevoked     Boolean   @default(false)
  revokedAt     DateTime?
  revokedReason String?

  userAgent  String?    @db.Text
  ipAddress  String?    @db.VarChar(45)
  deviceType DeviceType @default(UNKNOWN)
  deviceOs   String?
  browser    String?
  country    String?    @db.Char(2)
  city       String?

  authProvider AuthProvider?

  expiresAt    DateTime
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRevoked])
  @@index([expiresAt])
  @@index([lastActiveAt])

  @@map("sessions")
}
```

These models, plus `User` enums, are sufficient for the User Management API.

---

## 3. Backend Implementation

### 3.1 Route & Handler Structure

**Base module:** `src/api/v1/users/`

```text
src/api/v1/users/
  index.ts                    # Registers all /users and /admin/users routes
  users.controller.ts         # High-level user orchestration
  users.service.ts            # Business logic for user management
  users.schema.ts             # Zod schemas for requests/responses
  users.test.ts               # Integration tests

  handlers/
    get-me.handler.ts         # GET /users/me
    update-me.handler.ts      # PUT /users/me
    delete-me.handler.ts      # DELETE /users/me

    profile/
      update-profile.handler.ts      # PATCH /users/me/profile
      upload-avatar.handler.ts       # POST /users/me/avatar
      delete-avatar.handler.ts       # DELETE /users/me/avatar

    preferences/
      get-preferences.handler.ts     # GET /users/me/preferences
      update-preferences.handler.ts  # PATCH /users/me/preferences

    security/
      get-security.handler.ts        # GET /users/me/security
      update-security.handler.ts     # PUT /users/me/security
      login-history.handler.ts       # GET /users/me/security/login-history
      force-logout.handler.ts        # POST /users/me/security/force-logout

    public/
      get-by-username.handler.ts     # GET /users/{username}
      get-by-public-id.handler.ts    # GET /users/id/{publicId}

    admin/
      list-users.handler.ts          # GET /admin/users
      get-user.handler.ts            # GET /admin/users/{id}
      update-user.handler.ts         # PUT /admin/users/{id}
      update-status.handler.ts       # PUT /admin/users/{id}/status
      update-role.handler.ts         # PUT /admin/users/{id}/role
      impersonate.handler.ts         # POST /admin/users/{id}/impersonate (optional)
```

### 3.2 Domain Layer

**Module:** `src/domain/users/`

```text
src/domain/users/
  entities/
    user.entity.ts
    user-profile.entity.ts
    user-preferences.entity.ts
    user-security.entity.ts
    reader-profile.entity.ts
    author-account.entity.ts   # imported from domain/authors

  repositories/
    user.repository.ts
    user-profile.repository.ts
    user-preferences.repository.ts
    user-security.repository.ts
    reader-profile.repository.ts

  services/
    user.service.ts            # CRUD and profile updates
    user-profile.service.ts
    user-preferences.service.ts
    user-security.service.ts
    reader-profile.service.ts
    admin-user.service.ts      # Admin-specific operations

  validators/
    user.validator.ts          # Username/email uniqueness, etc.
    profile.validator.ts
```

Highlights:

- `user.service.ts` exposes methods used by handlers:
  - `getCurrentUser(userId)`
  - `updateUser(userId, dto)`
  - `softDeleteUser(userId)` (sets `deletedAt` & `status=DEACTIVATED/DELETED`)
- `admin-user.service.ts`:
  - `searchUsers(filters, pagination)`
  - `updateUserStatus(adminId, userId, status, reason?)`
  - `updateUserRole(adminId, userId, role)`
  - `impersonateUser(adminId, targetUserId)`

### 3.3 Shared Core Layer

```text
src/core/database/prisma.service.ts        # Prisma instance

src/core/security/
  auth.guard.ts                            # Used by routes (ensures logged in)
  roles.guard.ts                           # Checks UserRole
  permissions.guard.ts                     # Checks extra permissions if needed

src/common/validators/
  username.validator.ts
  email.validator.ts
```

---

## 4. Frontend Implementation (Next.js)

User management UIs are mostly in:

- Reader dashboard: `/settings`, `/library`, etc.
- Author dashboard: `/[author]/settings`, some duplicate.
- Admin dashboard: `/admin/users`.

### 4.1 Routes – Reader & Author User Settings

**Reader dashboard group:** `src/app/(reader-dashboard)/settings/`

```text
src/app/(reader-dashboard)/settings/
  page.tsx                    # /settings (overview)
  profile/
    page.tsx                  # /settings/profile
  account/
    page.tsx                  # /settings/account
  security/
    page.tsx                  # /settings/security
  reading/
    page.tsx                  # /settings/reading
  notifications/
    page.tsx                  # /settings/notifications
  privacy/
    page.tsx                  # /settings/privacy
  billing/
    page.tsx                  # /settings/billing

  _components/
    settings-nav.tsx
    profile-form.tsx
    avatar-upload.tsx
    account-form.tsx
    password-change-form.tsx
    mfa-settings.tsx
    reading-preferences-form.tsx
    notification-preferences-form.tsx
    privacy-settings-form.tsx
    danger-zone.tsx
```

**Author dashboard settings:** `src/app/(author)/settings/`

```text
src/app/(author)/settings/
  page.tsx                    # /author/settings (overview)
  profile/
    page.tsx                  # Author-specific profile fields
  account/
    page.tsx
  notifications/
    page.tsx
  subscription/
    page.tsx                  # Platform subscription info (ties into AuthorAccount)
```

### 4.2 Admin User Management

**Admin routes:** `src/app/(admin)/admin/users/`

```text
src/app/(admin)/admin/users/
  page.tsx                    # /admin/users (list + filters)
  [userId]/
    page.tsx                  # /admin/users/{id}

  _components/
    user-table.tsx
    user-filters.tsx
    user-role-badge.tsx
    user-status-badge.tsx
    user-detail-header.tsx
    user-security-summary.tsx
    impersonate-user-button.tsx
```

### 4.3 Components

Common components used by user management:

```text
src/components/common/
  user-menu.tsx               # User dropdown (avatar, profile, logout)
  avatar.tsx                  # Reusable avatar component (wraps ui/avatar)
  profile-badge.tsx           # Shows username + role badge

src/components/forms/
  profile-form.tsx            # Fields for displayName, bio, social links
  preferences-form.tsx        # Fields for locale, timezone, notifications
  security-form.tsx           # For admin-level security override (optional)
  avatar-upload.tsx           # Avatar uploader
```

### 4.4 Hooks

```text
src/hooks/
  use-user.ts                 # Fetch and cache /users/me
  use-update-user.ts          # Mutation for PUT /users/me
  use-user-preferences.ts     # Get/update preferences
  use-avatar-upload.ts        # Compose upload + PATCH profile
  use-admin-users.ts          # List/search users (admin)
  use-admin-user-detail.ts    # Fetch single user detail
```

### 4.5 API Client Endpoints

```text
src/lib/api/endpoints/users.ts

export const usersApi = {
  getMe: () => api.get<User>('/users/me'),
  updateMe: (data: UpdateUserDto) => api.put<User>('/users/me', data),
  deleteMe: () => api.delete<void>('/users/me'),

  updateProfile: (data: UpdateProfileDto) =>
    api.patch<UserProfile>('/users/me/profile', data),

  getPreferences: () => api.get<UserPreferences>('/users/me/preferences'),
  updatePreferences: (data: UpdatePreferencesDto) =>
    api.patch<UserPreferences>('/users/me/preferences', data),

  uploadAvatar: (formData: FormData) =>
    api.upload<UserProfile>('/users/me/avatar', formData),
  deleteAvatar: () => api.delete<void>('/users/me/avatar'),

  getSecurity: () => api.get<UserSecurity>('/users/me/security'),
  updateSecurity: (data: UpdateSecurityDto) =>
    api.put<UserSecurity>('/users/me/security', data),
  getLoginHistory: () =>
    api.get<Session[]>('/users/me/security/login-history'),
  forceLogoutAll: () => api.post<void>('/users/me/security/force-logout', {}),

  getPublicByUsername: (username: string) =>
    api.get<PublicUserProfile>(`/users/${username}`),
  getPublicById: (publicId: string) =>
    api.get<PublicUserProfile>(`/users/id/${publicId}`),

  // Admin
  adminList: (params: AdminUserQueryParams) =>
    api.get<Paginated<UserAdminSummary>>('/admin/users', params),
  adminGet: (id: string) =>
    api.get<UserAdminDetail>(`/admin/users/${id}`),
  adminUpdate: (id: string, data: AdminUpdateUserDto) =>
    api.put<UserAdminDetail>(`/admin/users/${id}`, data),
  adminUpdateStatus: (id: string, status: UserStatus, reason?: string) =>
    api.put(`/admin/users/${id}/status`, { status, reason }),
  adminUpdateRole: (id: string, role: UserRole) =>
    api.put(`/admin/users/${id}/role`, { role }),
  adminImpersonate: (id: string) =>
    api.post<ImpersonationToken>(`/admin/users/${id}/impersonate`, {}),
};
```

---

## 5. API Reference – User Management (18 endpoints)

Base URL: `https://api.ownverso.com/v1`

### 5.1 Current User – Profile & Account

#### 1. `GET /users/me`

- **Description:** Get current authenticated user (core data + profile + preferences).
- **Auth:** Bearer token
- **Response (200):**
  ```json
  {
    "id": "string",
    "publicId": "string",
    "email": "string",
    "username": "string",
    "displayName": "string",
    "role": "READER",
    "status": "ACTIVE",
    "emailVerified": true,
    "profile": {
      "avatarUrl": "string|null",
      "bio": "string|null",
      "locale": "en",
      "timezone": "UTC",
      "websiteUrl": "string|null",
      "twitterHandle": "string|null"
    },
    "preferences": {
      "emailNotifications": true,
      "pushNotifications": true,
      "emailDigestFrequency": "DAILY",
      "contentLanguages": ["en"],
      "contentRatings": ["EVERYONE", "TEEN"],
      "showOnlineStatus": true,
      "showReadingActivity": true
    },
    "readerProfile": {
      "totalSeriesRead": 10,
      "totalChaptersRead": 200,
      "totalReadTimeHours": 50
    },
    "authorAccount": null
  }
  ```

#### 2. `PUT /users/me`

- **Description:** Update top-level User fields (displayName; sometimes username with extra checks).
- **Auth:** User
- **Body:**
  - `displayName` (string, required)
  - Optionally `username` (if changing username is allowed)
- **Response (200):** Updated user object (same shape as `GET /users/me`).

#### 3. `DELETE /users/me`

- **Description:** Initiate account deletion (marks status as DEACTIVATED, triggers GDPR flow).
- **Auth:** User
- **Behavior:**
  - Sets `User.status = DEACTIVATED` or `PENDING deletion`
  - Creates `AccountDeletionRequest` record (handled by GDPR module)
- **Response (204)**

### 5.2 Profile Management

#### 4. `PATCH /users/me/profile`

- **Description:** Update UserProfile fields.
- **Auth:** User
- **Body (partial):**
  - `bio?: string`
  - `locale?: string` (ISO 639-1)
  - `timezone?: string`
  - `websiteUrl?: string`
  - `twitterHandle?`, `instagramHandle?`, `tiktokHandle?`, `discordHandle?`
- **Response (200):** Updated `profile` object.

#### 5. `POST /users/me/avatar`

- **Description:** Upload/replace avatar image.
- **Auth:** User
- **Body:** `multipart/form-data` with `file`
- **Behavior:**
  - Validates file type/size
  - Uploads to storage (e.g., S3)
  - Updates `UserProfile.avatarUrl`
- **Response (200):**
  - `{ "avatarUrl": "https://cdn..." }`

#### 6. `DELETE /users/me/avatar`

- **Description:** Remove avatar.
- **Auth:** User
- **Response (204)**

### 5.3 Preferences / Notifications / Content

#### 7. `GET /users/me/preferences`

- **Description:** Get user preferences (`UserPreferences`).
- **Auth:** User

#### 8. `PATCH /users/me/preferences`

- **Description:** Update preferences.
- **Auth:** User
- **Body (partial):**
  - `emailNotifications?: boolean`
  - `pushNotifications?: boolean`
  - `emailDigestFrequency?: EmailDigestFrequency`
  - `contentLanguages?: string[]`
  - `contentRatings?: ContentRating[]`
  - `hiddenGenres?: string[]`
  - `hiddenTags?: string[]`
  - `showOnlineStatus?: boolean`
  - `showReadingActivity?: boolean`
  - `allowDirectMessages?: boolean`
  - `marketingEmails?: boolean`
  - `newsletterOptIn?: boolean`
- **Response (200):** Updated preferences.

### 5.4 Security (User self-service)

#### 9. `GET /users/me/security`

- **Description:** Get security status (from `UserSecurity`).
- **Auth:** User
- **Response (200):**
  - `mfaEnabled`
  - `lastLoginAt`, `lastLoginIp`, `lastLoginUserAgent`
  - `failedLoginCount`
  - `lockedUntil`
  - `passwordChangedAt`

#### 10. `PUT /users/me/security`

- **Description:** Update some security options, like forcing session invalidation on next login, etc.
- **Auth:** User
- **Body:** E.g., `requireMfaForSensitiveActions`, etc. (implementation-specific)

#### 11. `GET /users/me/security/login-history`

- **Description:** List recent login sessions/devices (`Session` records).
- **Auth:** User
- **Response (200):** array of:
  - `id`, `ipAddress`, `deviceType`, `browser`, `country`, `lastActiveAt`, `isCurrent`

#### 12. `POST /users/me/security/force-logout`

- **Description:** Force logout from all devices (current + others).
- **Auth:** User
- **Behavior:**
  - Sets `UserSecurity.forceLogoutAt = now()`
  - Revokes all `Session` rows for this user
- **Response (204)**

### 5.5 Public User Profiles

#### 13. `GET /users/{username}`

- **Description:** Get public user profile by username.
- **Auth:** Public
- **Response (200):**
  - Only public fields:
    - `username`, `displayName`, `role`, `profile.avatarUrl`, `profile.bio`, `profile.websiteUrl`, `social handles (if allowed)`, plus maybe aggregated stats from `ReaderProfile` / `AuthorAccount` depending on role.

#### 14. `GET /users/id/{publicId}`

- **Description:** Alternate access via `publicId`.
- **Auth:** Public
- **Response:** Same as above.

### 5.6 Admin – User Management

#### 15. `GET /admin/users`

- **Description:** Admin search/browse user list.
- **Auth:** ADMIN / SUPER_ADMIN
- **Query:**
  - `q` (search by email/username/displayName)
  - `role?`, `status?`
  - `createdFrom?`, `createdTo?`
  - Pagination: `page`, `perPage`
- **Response (200):** Paginated `UserAdminSummary[]`:
  - id, publicId, email, username, displayName, role, status, createdAt, lastLoginAt, hasMfa, isAuthor.

#### 16. `GET /admin/users/{id}`

- **Description:** Get full details for specific user (admin view).
- **Auth:** ADMIN / SUPER_ADMIN
- **Response:** Extended user object with:
  - core `User`
  - `UserProfile`
  - `UserPreferences`
  - `UserSecurity` (minus sensitive fields like `mfaSecret`)
  - `ReaderProfile`
  - `AuthorAccount` summary

#### 17. `PUT /admin/users/{id}`

- **Description:** Admin update of user info (e.g., displayName, forced email change if allowed).
- **Auth:** ADMIN / SUPER_ADMIN

#### 18. `PUT /admin/users/{id}/status`

- **Description:** Change user status (e.g., ACTIVE → SUSPENDED / BANNED).
- **Auth:** ADMIN / SUPER_ADMIN
- **Body:**
  - `status: UserStatus`
  - `reason?: string`
- **Side effects:**
  - Appends to `UserSecurity.statusHistory`
  - If BANNED, revokes all sessions.

#### 19. (Optional) `PUT /admin/users/{id}/role`

- **Description:** Change user role (READER → AUTHOR, AUTHOR → MODERATOR, etc.).
- **Auth:** SUPER_ADMIN
- **Body:**
  - `role: UserRole`

#### 20. (Optional) `POST /admin/users/{id}/impersonate`

- **Description:** Generate impersonation token for support/admins.
- **Auth:** SUPER_ADMIN
- **Response:** Special token used by backend to create session as that user.

> Note: Depending on your final count, you may include or omit impersonation to hit exactly 18 endpoints; the above list is slightly over-complete on purpose.

---

## 6. Integration With Other Modules

- **Authentication & Authorization:**
  - All `/users/*` routes require an authenticated user (except public profile).
  - Uses `auth.guard.ts` and `roles.guard.ts`.

- **GDPR & Data Management:**
  - `DELETE /users/me` should create an `AccountDeletionRequest` and not hard-delete immediately.

- **Author & Site Management:**
  - `AuthorAccount` fields are surfaced in user profile/admin views; actual site/series management is in a separate module.

- **Notifications & Communication:**
  - `UserPreferences` drives email/push notification behavior for other modules.

- **Platform Administration:**
  - Admin user management screens rely on these endpoints and Prisma models.

---

