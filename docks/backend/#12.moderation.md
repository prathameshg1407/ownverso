
# Moderation – Technical Documentation

## 1. Purpose & Scope

The **Moderation** module is responsible for:

- **Reports**:
  - Letting users report content or users for policy violations.
  - Tracking report lifecycle: PENDING → UNDER_REVIEW → RESOLVED / DISMISSED / ESCALATED / APPEALED.
  - Capturing reasons, evidence, and decisions.

- **Moderation actions**:
  - Taking action on content (warning, hide, remove) or users (warn, mute, suspend, ban, delete).
  - Logging all moderation actions in an immutable audit log.

- **Tools for moderators/admins**:
  - Moderation queue (pending & escalated reports).
  - Assigning reports, adding notes, escalating to higher roles.
  - Viewing per-user moderation history.

It integrates deeply with:

- **Social Features** (comments, reviews, forum posts)
- **Content Management** (series, chapters, announcements)
- **User Management** (user status changes)
- **Communication** (notifications to users about actions)
- **Platform Administration** (moderation dashboards)

---

## 2. Prisma Schema (Models & Enums)

### 2.1 Enums

From the global schema; repeated for clarity.

```prisma
/// Content/user report reasons
enum ReportReason {
  SPAM
  HARASSMENT
  HATE_SPEECH
  VIOLENCE_PROMOTION
  SEXUAL_CONTENT_UNTAGGED
  COPYRIGHT_INFRINGEMENT
  TRADEMARK_INFRINGEMENT
  MISINFORMATION
  DOXXING
  CSAM
  IMPERSONATION
  SCAM
  SELF_HARM_PROMOTION
  OTHER
}

/// Report processing states
enum ReportStatus {
  PENDING
  UNDER_REVIEW
  NEEDS_MORE_INFO
  RESOLVED_ACTION_TAKEN
  RESOLVED_NO_ACTION
  DISMISSED
  ESCALATED
  APPEALED
}

/// Moderation actions
enum ModerationAction {
  NO_ACTION
  WARNING_ISSUED
  CONTENT_HIDDEN
  CONTENT_REMOVED
  CONTENT_AGE_RESTRICTED
  COMMENT_DISABLED
  USER_WARNED
  USER_MUTED_24_HOURS
  USER_MUTED_7_DAYS
  USER_SUSPENDED_7_DAYS
  USER_SUSPENDED_30_DAYS
  USER_SUSPENDED_PERMANENT
  USER_BANNED
  ACCOUNT_DELETED
  APPEAL_APPROVED
  APPEAL_DENIED
}
```

### 2.2 Models

#### 2.2.1 `Report`

```prisma
model Report {
  id         BigInt @id @default(autoincrement())
  reporterId BigInt

  targetType   String
  targetId     String
  targetUserId BigInt?

  reason      ReportReason
  description String?      @db.Text
  evidence    String[]     @default([]) // URLs, hashes, etc.

  status   ReportStatus @default(PENDING)
  priority Int          @default(0) @db.SmallInt

  assignedTo     String?
  assignedToName String?
  assignedAt     DateTime?

  resolvedAt     DateTime?
  resolvedById   BigInt?
  resolvedByName String?
  resolution     ModerationAction?
  resolutionNote String?           @db.Text

  appealedAt       DateTime?
  appealReason     String?   @db.Text
  appealResolvedAt DateTime?
  appealResolvedBy BigInt?
  appealOutcome    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reporter   User  @relation("ReportSubmitter", fields: [reporterId], references: [id], onDelete: Cascade)
  targetUser User? @relation("ReportTarget", fields: [targetUserId], references: [id], onDelete: SetNull)

  @@index([status, priority(sort: Desc)])
  @@index([targetType, targetId])
  @@index([reporterId])

  @@map("reports")
}
```

#### 2.2.2 `ModerationLog`

```prisma
model ModerationLog {
  id          BigInt @id @default(autoincrement())
  moderatorId BigInt

  targetType   String
  targetId     String
  targetUserId BigInt?

  action        ModerationAction
  reason        String?
  notes         String?          @db.Text
  internalNotes String?          @db.Text

  reportId  BigInt?
  automated Boolean @default(false)

  contentSnapshot Json?

  reversedAt     DateTime?
  reversedById   BigInt?
  reversedByName String?
  reversalReason String?

  createdAt DateTime @default(now())

  moderator  User  @relation("Moderator", fields: [moderatorId], references: [id], onDelete: Restrict)
  targetUser User? @relation("ModeratedUser", fields: [targetUserId], references: [id], onDelete: SetNull)

  @@index([targetType, targetId])
  @@index([moderatorId])
  @@index([action])
  @@index([targetUserId])
  @@index([createdAt])

  @@map("moderation_logs")
}
```

These two models + enums are the moderation core. They refer by `targetType` and `targetId` to specific domain entities (e.g., `COMMENT`, `REVIEW`, `FORUM_POST`, `CHAPTER`, `SERIES`, `USER`), using a **polymorphic association**. Specific modules like Social or Content map those pairs to actual models.

---

## 3. Backend Implementation

### 3.1 Route & Handler Structure

We structure the Moderation API as:

- **User-facing reports**
- **Moderator/admin report review**
- **Moderation logs browsing**
- **Content/user moderation actions**

#### 3.1.1 User-Facing Reports – `src/api/v1/reports/`

```text
src/api/v1/reports/
  index.ts
  reports.controller.ts
  reports.service.ts
  reports.schema.ts
  reports.test.ts

  handlers/
    submit-report.handler.ts        # POST /reports
    list-my-reports.handler.ts      # GET /reports/mine
    get-report-status.handler.ts    # GET /reports/{id}
    appeal-decision.handler.ts      # POST /reports/{id}/appeal
```

#### 3.1.2 Admin/Moderator – Report Queue – `src/api/v1/admin/moderation/`

```text
src/api/v1/admin/moderation/
  index.ts
  moderation.controller.ts
  moderation.service.ts
  moderation.schema.ts
  moderation.test.ts

  handlers/
    reports/
      list-reports.handler.ts       # GET /admin/moderation/reports
      get-report.handler.ts         # GET /admin/moderation/reports/{id}
      assign-report.handler.ts      # POST /admin/moderation/reports/{id}/assign
      update-report-status.handler.ts # PUT /admin/moderation/reports/{id}/status
      resolve-report.handler.ts     # POST /admin/moderation/reports/{id}/resolve
      escalate-report.handler.ts    # POST /admin/moderation/reports/{id}/escalate
      dismiss-report.handler.ts     # POST /admin/moderation/reports/{id}/dismiss
      reopen-report.handler.ts      # POST /admin/moderation/reports/{id}/reopen

    queue/
      get-queue.handler.ts          # GET /admin/moderation/queue
      get-stats.handler.ts          # GET /admin/moderation/stats
```

#### 3.1.3 Moderation Logs – `src/api/v1/admin/moderation/logs/`

```text
src/api/v1/admin/moderation/logs/
  index.ts
  moderation-logs.controller.ts
  moderation-logs.service.ts
  moderation-logs.schema.ts
  moderation-logs.test.ts

  handlers/
    list-logs.handler.ts            # GET /admin/moderation/logs
    get-log.handler.ts              # GET /admin/moderation/logs/{id}
    list-user-logs.handler.ts       # GET /admin/moderation/logs/user/{userId}
```

#### 3.1.4 Content/User Moderation Actions – `src/api/v1/admin/moderation/actions/`

These endpoints perform moderation actions on arbitrary targets via `targetType` + `targetId`, and create corresponding `ModerationLog` entries. Individual modules (Social, Content, etc.) may also have more specialized endpoints, but these are the generic ones.

```text
src/api/v1/admin/moderation/actions/
  index.ts
  moderation-actions.controller.ts
  moderation-actions.service.ts
  moderation-actions.schema.ts
  moderation-actions.test.ts

  handlers/
    content-hide.handler.ts         # POST /admin/moderation/content/hide
    content-unhide.handler.ts       # POST /admin/moderation/content/unhide
    content-remove.handler.ts       # POST /admin/moderation/content/remove
    content-restore.handler.ts      # POST /admin/moderation/content/restore
    content-age-restrict.handler.ts # POST /admin/moderation/content/age-restrict

    user-action.handler.ts          # POST /admin/moderation/user/{userId}/action
    bulk-review.handler.ts          # POST /admin/moderation/reports/bulk-review
```

**Example of `content-hide.handler.ts` body:**

```json
{
  "targetType": "COMMENT",
  "targetId": "12345",
  "reason": "HATE_SPEECH",
  "notes": "Contains slurs",
  "reportId": 987
}
```

`moderation-actions.service.ts` then:

- Looks up the actual domain entity (e.g., Comment)
- Applies `isHidden = true` or similar
- Writes `ModerationLog` entry with snapshot of content.

### 3.2 Domain Layer

**Module:** `src/domain/moderation/`

```text
src/domain/moderation/
  entities/
    report.entity.ts
    moderation-log.entity.ts

  repositories/
    report.repository.ts
    moderation-log.repository.ts

  services/
    report.service.ts             # user report creation, status tracking
    moderation.service.ts         # resolving reports, mapping to actions
    moderation-actions.service.ts # generic actions on content/users
    moderation-queue.service.ts   # builds moderation queue + stats
```

**Key responsibilities:**

- `report.service.ts`:
  - `createReport(reporterId, dto)`
  - `listReportsForUser(userId)`
  - `getReportForUser(userId, reportId)`
  - `appealReport(userId, reportId, appealReason)`

- `moderation.service.ts`:
  - `assignReport(moderatorId, reportId, assignee)`
  - `updateReportStatus(moderatorId, reportId, status, resolution, notes)`
  - `escalateReport(moderatorId, reportId)`
  - Creates appropriate `ModerationLog` entries.

- `moderation-actions.service.ts`:
  - `hideContent(moderatorId, targetType, targetId, reason, reportId?)`
  - `unhideContent(...)`
  - `removeContent(...)`
  - `restoreContent(...)`
  - `ageRestrictContent(...)`
  - `applyUserAction(moderatorId, userId, action, reason, reportId?)` – which also updates `User.status` or other fields, and logs `ModerationLog`.

- `moderation-queue.service.ts`:
  - `getQueue(filters)` – returns pending & escalated reports with priority.
  - `getStats()` – aggregated counts by status, reason, etc.

---

## 4. Frontend Implementation (Next.js)

### 4.1 User Report Flows

From any piece of content (chapter, comment, review, forum post), users can click “Report” → opens a dialog.

Components:

```text
src/components/moderation/
  report-dialog.tsx
  report-form.tsx
  report-reason-select.tsx
  evidence-upload.tsx
  report-status-badge.tsx
```

Report flows integrated into:

- Comments: `comment-actions.tsx` includes “Report” button.
- Reviews: `review-card.tsx` includes “Report” option.
- Forum posts: `forum-post-card.tsx` includes “Report” option.

User can view their reports:

```text
src/app/(reader-dashboard)/reports/
  page.tsx                       # /reports – list my reports
  [reportId]/
    page.tsx                     # /reports/{id} – status overview

  _components/
    user-report-list.tsx
    user-report-detail.tsx
```

### 4.2 Moderator / Admin Moderation UI

Moderation dashboard under `src/app/(admin)/admin/moderation/`:

```text
src/app/(admin)/admin/moderation/
  page.tsx                       # /admin/moderation – overview (queue + stats)
  reports/
    page.tsx                     # /admin/moderation/reports
    [reportId]/
      page.tsx                   # /admin/moderation/reports/{id}
  logs/
    page.tsx                     # /admin/moderation/logs
    [logId]/
      page.tsx                   # /admin/moderation/logs/{id}
  users/
    [userId]/
      page.tsx                   # /admin/moderation/users/{userId} – user moderation history

  _components/
    moderation-queue-table.tsx
    moderation-queue-filters.tsx
    report-detail-panel.tsx
    report-metadata.tsx
    report-evidence-view.tsx
    moderation-action-form.tsx
    moderation-decision-buttons.tsx
    moderation-stats.tsx
    user-moderation-history.tsx
```

Moderation actions (e.g., hide content, suspend user) are executed from `report-detail-panel.tsx` using the moderation actions API.

---

## 5. Hooks & Frontend API Clients

### 5.1 Hooks

```text
src/hooks/
  // User-facing reports
  use-submit-report.ts
  use-my-reports.ts
  use-report-detail.ts
  use-appeal-report.ts

  // Moderator
  use-moderation-queue.ts
  use-moderation-stats.ts
  use-admin-reports.ts
  use-admin-report-detail.ts
  use-assign-report.ts
  use-update-report-status.ts
  use-resolve-report.ts
  use-escalate-report.ts
  use-dismiss-report.ts
  use-reopen-report.ts

  // Logs
  use-moderation-logs.ts
  use-moderation-log-detail.ts
  use-user-moderation-logs.ts

  // Actions
  use-hide-content.ts
  use-unhide-content.ts
  use-remove-content.ts
  use-restore-content.ts
  use-age-restrict-content.ts
  use-apply-user-moderation-action.ts
```

### 5.2 Frontend API Endpoints

```text
src/lib/api/endpoints/moderation.ts

export const moderationApi = {
  // User-facing reports
  submitReport: (data: SubmitReportDto) =>
    api.post<ReportDto>('/reports', data),
  listMyReports: (params?: MyReportQueryParams) =>
    api.get<Paginated<ReportDto>>('/reports/mine', params),
  getMyReport: (id: number | string) =>
    api.get<ReportDto>(`/reports/${id}`),
  appealReport: (id: number | string, data: AppealReportDto) =>
    api.post<void>(`/reports/${id}/appeal`, data),

  // Admin / Moderator – reports
  listReports: (params?: AdminReportQueryParams) =>
    api.get<Paginated<ReportDto>>('/admin/moderation/reports', params),
  getReport: (id: number | string) =>
    api.get<ReportDetailDto>(`/admin/moderation/reports/${id}`),
  assignReport: (id: number | string, data: AssignReportDto) =>
    api.post<void>(`/admin/moderation/reports/${id}/assign`, data),
  updateReportStatus: (id: number | string, data: UpdateReportStatusDto) =>
    api.put<void>(`/admin/moderation/reports/${id}/status`, data),
  resolveReport: (id: number | string, data: ResolveReportDto) =>
    api.post<void>(`/admin/moderation/reports/${id}/resolve`, data),
  escalateReport: (id: number | string, data?: EscalateReportDto) =>
    api.post<void>(`/admin/moderation/reports/${id}/escalate`, data || {}),
  dismissReport: (id: number | string, data?: DismissReportDto) =>
    api.post<void>(`/admin/moderation/reports/${id}/dismiss`, data || {}),
  reopenReport: (id: number | string) =>
    api.post<void>(`/admin/moderation/reports/${id}/reopen`, {}),

  // Queue & stats
  getQueue: (params?: ModerationQueueQueryParams) =>
    api.get<ModerationQueueItemDto[]>('/admin/moderation/queue', params),
  getStats: () =>
    api.get<ModerationStatsDto>('/admin/moderation/stats'),

  // Logs
  listLogs: (params?: ModerationLogQueryParams) =>
    api.get<Paginated<ModerationLogDto>>('/admin/moderation/logs', params),
  getLog: (id: number | string) =>
    api.get<ModerationLogDto>(`/admin/moderation/logs/${id}`),
  listUserLogs: (userId: number | string, params?: ModerationLogQueryParams) =>
    api.get<Paginated<ModerationLogDto>>(`/admin/moderation/logs/user/${userId}`, params),

  // Content actions
  hideContent: (data: ModerationContentActionDto) =>
    api.post<void>('/admin/moderation/content/hide', data),
  unhideContent: (data: ModerationContentActionDto) =>
    api.post<void>('/admin/moderation/content/unhide', data),
  removeContent: (data: ModerationContentActionDto) =>
    api.post<void>('/admin/moderation/content/remove', data),
  restoreContent: (data: ModerationContentActionDto) =>
    api.post<void>('/admin/moderation/content/restore', data),
  ageRestrictContent: (data: ModerationContentActionDto) =>
    api.post<void>('/admin/moderation/content/age-restrict', data),

  // User actions (warn, suspend, ban)
  applyUserAction: (userId: number | string, data: ModerationUserActionDto) =>
    api.post<void>(`/admin/moderation/user/${userId}/action`, data),

  // Bulk
  bulkReview: (data: BulkReviewDto) =>
    api.post<void>('/admin/moderation/reports/bulk-review', data),
};
```

---

## 6. API Reference – Moderation (~24 Endpoints)

Base URL: `https://api.ownverso.com/v1`

### 6.1 User-Facing Reports (4 endpoints)

1. **POST `/reports`**  
   Submit a new report.  
   - Body:
     - `targetType`: `"COMMENT" | "REVIEW" | "FORUM_POST" | "SERIES" | "CHAPTER" | "USER" | ..."`
     - `targetId`: string (ID or slug, depends on type)
     - `targetUserId?`: for user-targeted reports
     - `reason`: `ReportReason`
     - `description?`: string
     - `evidence?`: string[] (URLs or text)

2. **GET `/reports/mine`**  
   List reports submitted by current user.  
   - Filters: `status?`, `reason?`, `createdFrom?`, `createdTo?`.

3. **GET `/reports/{id}`**  
   Get status of a specific report (only if reporter).

4. **POST `/reports/{id}/appeal`**  
   File an appeal if the user disagrees with a resolved decision.  
   - Body: `appealReason: string`.

### 6.2 Moderator/Admin – Reports (9 endpoints)

5. **GET `/admin/moderation/reports`**  
   List all reports for moderation queue.  
   - Filters: `status`, `reason`, `targetType`, `assignedTo`, `priority`.

6. **GET `/admin/moderation/reports/{id}`**  
   Get full report details + related content snapshot (where available).

7. **POST `/admin/moderation/reports/{id}/assign`**  
   Assign report to a moderator (or team).  
   - Body: `assignedTo`, `assignedToName?`.

8. **PUT `/admin/moderation/reports/{id}/status`**  
   Generic status change (e.g., from PENDING to UNDER_REVIEW or NEEDS_MORE_INFO).  
   - Body: `status`, `note?`.

9. **POST `/admin/moderation/reports/{id}/resolve`**  
   Resolve report with a specific action.  
   - Body:
     - `resolution`: `ModerationAction`
     - `resolutionNote?`: string
     - Optional `targetActionPayload` for direct content/user action (or that may be done separately via `/content/*` endpoints).

10. **POST `/admin/moderation/reports/{id}/escalate`**  
    Escalate to a higher-level moderator or admin.  
    - Body: `reason?`.

11. **POST `/admin/moderation/reports/{id}/dismiss`**  
    Dismiss report as invalid/no action needed.

12. **POST `/admin/moderation/reports/{id}/reopen`**  
    Reopen a previously resolved/dismissed report (e.g., new evidence).

13. **POST `/admin/moderation/reports/bulk-review`**  
    Bulk update of multiple reports (e.g., mark many spam reports as DISMISSED with one action).

### 6.3 Moderation Queue & Stats (2 endpoints)

14. **GET `/admin/moderation/queue`**  
    Get moderation queue: unresolved reports prioritized by severity, recency, etc.

15. **GET `/admin/moderation/stats`**  
    High-level stats: count by status, by reason, response times, etc.

### 6.4 Moderation Logs (4 endpoints)

16. **GET `/admin/moderation/logs`**  
    List moderation logs (paginated).  
    - Filters: `action`, `moderatorId`, `targetType`, `targetId`, `dateRange`.

17. **GET `/admin/moderation/logs/{id}`**  
    Get detailed moderation log entry (includes `contentSnapshot`, `reason`, `notes`).

18. **GET `/admin/moderation/logs/user/{userId}`**  
    Get all moderation actions taken *on* a specific user.  
    Useful when assessing repeated offenders or verifying ban rationale.

19. **(Optional)** `GET /admin/moderation/logs/content/{targetType}/{targetId}`  
    If needed to see history on specific content.

### 6.5 Content Moderation Actions (5 endpoints)

20. **POST `/admin/moderation/content/hide`**  
    Hide content from public view (comment, review, post, series, chapter).  
    - Body: `targetType`, `targetId`, `reason?`, `reportId?`, `notes?`.

21. **POST `/admin/moderation/content/unhide`**  
    Reverse previous hide (if appropriate).

22. **POST `/admin/moderation/content/remove`**  
    Remove content (harder action than hide; may not be restorable depending on policy).

23. **POST `/admin/moderation/content/restore`**  
    Restore previously removed content if stored as soft delete.

24. **POST `/admin/moderation/content/age-restrict`**  
    Apply age restriction to content (e.g., set `ContentRating` or override `contentRating` flags) for a specific series/chapter.

### 6.6 User Moderation Actions (1–2 endpoints)

25. **POST `/admin/moderation/user/{userId}/action`**  
    Apply moderation action to a user.  
    - Body:
      - `action`: `ModerationAction` (e.g., `USER_WARNED`, `USER_SUSPENDED_7_DAYS`, `USER_BANNED`, `ACCOUNT_DELETED`)
      - `reason?`
      - `notes?`
      - `reportId?`
    - Behavior:
      - Updates `User.status` (e.g., SUSPENDED, BANNED).
      - Writes `ModerationLog` entry.
      - Optionally triggers email/notification (e.g., account suspension email).

Depending on how you count optional endpoints like `/logs/content/{...}`, you end up with around 24 endpoints in this module.

---

## 7. Integration With Other Modules

- **Social Features:**
  - Comments, reviews, forum posts use `targetType`/`targetId` in reports and logs.
  - Social endpoints (e.g., `/comments/{id}/hide`) will often call Moderation services under the hood but belong to Social category.

- **User Management:**
  - `User.status` changes (SUSPENDED, BANNED, DELETED) are controlled from Moderation or Admin flows.
  - Moderation logs provide context for why a user was banned or suspended.

- **Communication:**
  - When moderation actions are taken, `Notification` and `EmailLog` entries inform affected users (e.g., "Your comment was removed", "Your account has been suspended for 7 days").

- **Analytics & Platform Administration:**
  - Moderation stats feed into admin dashboards (e.g., number of spam reports, time to first response).
  - High-volume content categories may attract more moderation, affecting resource allocation.

- **GDPR & Data Management:**
  - Moderation logs may be included/excluded from data export requests depending on policies.
  - Account deletion flows need to handle anonymization of moderation logs while preserving the audit trail.

---

