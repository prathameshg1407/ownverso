

# Translations – Technical Documentation

## 1. Purpose & Scope

The **Translations** module enables:

- **Series-level translations** (title + synopsis) into multiple languages.
- **Chapter-level translations** (full content, author note) into multiple languages.
- **AI-assisted translation** (e.g., via DeepL / OpenAI).
- **Human review** workflow for AI-generated translations.
- **Translation glossary** per series, to maintain terminology consistency.

It **does not** handle:

- General AI usage accounting (that lives in AI Features module; we only write the records).
- Reader language preferences (these come from `UserPreferences`).

---

## 2. Prisma Schema (Models & Enums)

### 2.1 Relevant Enums

From the main schema; repeated here for clarity.

```prisma
enum AIModel {
  GPT_4
  GPT_4_TURBO
  GPT_4O
  GPT_4O_MINI
  CLAUDE_3_OPUS
  CLAUDE_3_SONNET
  CLAUDE_3_HAIKU
  CLAUDE_3_5_SONNET
  GEMINI_PRO
  GEMINI_ULTRA
  LLAMA_3
  MISTRAL_LARGE
  CUSTOM
}

enum TranslationTermType {
  CHARACTER_NAME
  PLACE_NAME
  ORGANIZATION_NAME
  TITLE
  TERM
  PHRASE
  IDIOM
  HONORIFIC
}
```

Language codes themselves are stored in `Language` model (`code` = ISO 639-1), but translations store language codes as `String @db.Char(2)`.

### 2.2 Models

#### 2.2.1 `SeriesTranslation`

```prisma
model SeriesTranslation {
  id       BigInt @id @default(autoincrement())
  seriesId String

  language     String @db.Char(2)
  languageName String

  title    String @db.VarChar(200)
  synopsis String @db.Text

  isPublished Boolean   @default(false)
  publishedAt DateTime?

  // AI generation info
  isAIGenerated Boolean  @default(true)
  aiModel       AIModel?
  aiConfidence  Float?

  // Review status
  isReviewed     Boolean   @default(false)
  reviewedById   BigInt?
  reviewedByName String?
  reviewedAt     DateTime?
  reviewNotes    String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  series Series @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  @@unique([seriesId, language])
  @@index([seriesId])
  @@index([language, isPublished])

  @@map("series_translations")
}
```

#### 2.2.2 `ChapterTranslation`

```prisma
model ChapterTranslation {
  id        BigInt @id @default(autoincrement())
  chapterId String

  language     String @db.Char(2)
  languageName String

  title       String? @db.VarChar(200)
  content     String  @db.Text
  contentHtml String? @db.Text
  authorNote  String? @db.Text
  wordCount   Int     @default(0)

  isPublished Boolean   @default(false)
  publishedAt DateTime?

  // AI generation info
  isAIGenerated Boolean  @default(true)
  aiModel       AIModel?
  aiConfidence  Float?

  // Review status
  isReviewed     Boolean   @default(false)
  reviewedById   BigInt?
  reviewedByName String?
  reviewedAt     DateTime?
  reviewNotes    String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@unique([chapterId, language])
  @@index([chapterId])
  @@index([language, isPublished])

  @@map("chapter_translations")
}
```

#### 2.2.3 `TranslationGlossary`

```prisma
model TranslationGlossary {
  id       BigInt @id @default(autoincrement())
  seriesId String

  sourceText     String @db.VarChar(500)
  sourceLanguage String @default("en") @db.Char(2)
  targetText     String @db.VarChar(500)
  targetLanguage String @db.Char(2)

  termType   TranslationTermType @default(TERM)
  context    String?             @db.Text
  notes      String?             @db.Text
  isApproved Boolean             @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  series Series @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  @@unique([seriesId, sourceText, targetLanguage])
  @@index([seriesId, targetLanguage])

  @@map("translation_glossary")
}
```

These three models and enums are all that’s required for the Translations module. They relate back to existing `Series` and `Chapter`.

---

## 3. Backend Implementation

### 3.1 Route & Handler Structure

**Base module:** `src/api/v1/translations/`

```text
src/api/v1/translations/
  index.ts                         # Registers translation routes
  translations.controller.ts
  translations.service.ts
  translations.schema.ts
  translations.test.ts

  handlers/
    series/
      list-series-translations.handler.ts       # GET /series/{seriesId}/translations
      create-series-translation.handler.ts      # POST /series/{seriesId}/translations
      get-series-translation.handler.ts         # GET /series/{seriesId}/translations/{lang}
      update-series-translation.handler.ts      # PUT /series/{seriesId}/translations/{lang}
      delete-series-translation.handler.ts      # DELETE /series/{seriesId}/translations/{lang}
      publish-series-translation.handler.ts     # POST /series/{seriesId}/translations/{lang}/publish
      unpublish-series-translation.handler.ts   # POST /series/{seriesId}/translations/{lang}/unpublish
      ai-generate-series-translation.handler.ts # POST /series/{seriesId}/translations/{lang}/ai-generate
      review-series-translation.handler.ts      # POST /series/{seriesId}/translations/{lang}/review

    chapters/
      list-chapter-translations.handler.ts      # GET /chapters/{chapterId}/translations
      create-chapter-translation.handler.ts     # POST /chapters/{chapterId}/translations
      get-chapter-translation.handler.ts        # GET /chapters/{chapterId}/translations/{lang}
      update-chapter-translation.handler.ts     # PUT /chapters/{chapterId}/translations/{lang}
      delete-chapter-translation.handler.ts     # DELETE /chapters/{chapterId}/translations/{lang}
      publish-chapter-translation.handler.ts    # POST /chapters/{chapterId}/translations/{lang}/publish
      unpublish-chapter-translation.handler.ts  # POST /chapters/{chapterId}/translations/{lang}/unpublish
      ai-generate-chapter-translation.handler.ts# POST /chapters/{chapterId}/translations/{lang}/ai-generate
      review-chapter-translation.handler.ts     # POST /chapters/{chapterId}/translations/{lang}/review

    glossary/
      list-glossary.handler.ts                  # GET /series/{seriesId}/glossary
      create-glossary-term.handler.ts           # POST /series/{seriesId}/glossary
      update-glossary-term.handler.ts           # PUT /series/{seriesId}/glossary/{id}
      delete-glossary-term.handler.ts           # DELETE /series/{seriesId}/glossary/{id}
      import-glossary.handler.ts                # POST /series/{seriesId}/glossary/import
      export-glossary.handler.ts                # GET /series/{seriesId}/glossary/export
```

### 3.2 Domain Layer

**Module:** `src/domain/translations/`

```text
src/domain/translations/
  entities/
    series-translation.entity.ts
    chapter-translation.entity.ts
    translation-glossary.entity.ts

  repositories/
    series-translation.repository.ts
    chapter-translation.repository.ts
    translation-glossary.repository.ts

  services/
    series-translation.service.ts
    chapter-translation.service.ts
    glossary.service.ts
    ai-translation-orchestrator.service.ts  # orchestrates AI + glossary

  validators/
    translation.validator.ts                 # ensures language support, etc.
```

Highlights:

- `series-translation.service.ts`:
  - `listBySeries(seriesId)`
  - `create(seriesId, dto)`
  - `update(seriesId, language, dto)`
  - `delete(seriesId, language)`
  - `publish(seriesId, language)`
  - `unpublish(seriesId, language)`
  - `markReviewed(seriesId, language, reviewerInfo)`

- `chapter-translation.service.ts`:
  - Similar operations for chapters.

- `ai-translation-orchestrator.service.ts`:
  - Uses existing AI providers (DeepL/OpenAI) via `src/infrastructure/ai/`:
    - `deepl.provider.ts`, `openai.provider.ts`
  - Applies `TranslationGlossary` as inline hints.
  - Writes into `AIUsageRecord` (in AI Features module).

### 3.3 Infrastructure Integration

**AI providers:** `src/infrastructure/ai/`

```text
src/infrastructure/ai/
  index.ts
  ai.interface.ts
  providers/
    deepl.provider.ts      # primary translation
    openai.provider.ts     # fallback translation or summarization
```

**Language support:** can optionally query `Language` table; likely implemented in:

```text
src/domain/system/language.service.ts       # for UI or validation
```

---

## 4. Frontend Implementation (Next.js)

### 4.1 Author Series Translation UI

Routes under `src/app/(author)/series/[seriesId]/translations/`:

```text
src/app/(author)/series/[seriesId]/translations/
  page.tsx                         # /series/{seriesId}/translations – language overview
  [lang]/
    page.tsx                       # /series/{seriesId}/translations/{lang} – edit series translation
  _components/
    translation-language-list.tsx
    translation-language-badge.tsx
    add-language-modal.tsx
    series-translation-form.tsx
    translation-publish-toggle.tsx
    translation-review-panel.tsx
    ai-translation-button.tsx
```

### 4.2 Author Chapter Translation UI

Routes under `src/app/(author)/series/[seriesId]/chapters/[chapterId]/translations/`:

```text
src/app/(author)/series/[seriesId]/chapters/[chapterId]/translations/
  page.tsx                         # /series/{seriesId}/chapters/{chapterId}/translations
  [lang]/
    page.tsx                       # /series/{seriesId}/chapters/{chapterId}/translations/{lang}
  _components/
    chapter-translation-list.tsx
    chapter-translation-form.tsx
    ai-translation-button.tsx
    translation-status-badge.tsx
    translation-review-panel.tsx
```

### 4.3 Glossary UI

Routes under `src/app/(author)/series/[seriesId]/translations/glossary/`:

```text
src/app/(author)/series/[seriesId]/translations/glossary/
  page.tsx                         # /series/{seriesId}/translations/glossary
  _components/
    glossary-table.tsx
    glossary-term-form.tsx
    import-glossary-modal.tsx
    export-glossary-button.tsx
    term-type-badge.tsx
```

### 4.4 Frontend Components

```text
src/components/translations/
  language-selector.tsx
  translation-status-badge.tsx
  translation-badge.tsx
  ai-translation-indicator.tsx
  review-badge.tsx
```

### 4.5 Hooks

```text
src/hooks/
  use-series-translations.ts            # list/create/update/delete series translations
  use-chapter-translations.ts           # list/create/update/delete chapter translations
  use-glossary.ts                       # CRUD operations for glossary
  use-ai-translation.ts                 # AI translation action + loading state
```

### 4.6 Frontend API Client Endpoints

```text
src/lib/api/endpoints/translations.ts

export const translationsApi = {
  // SERIES TRANSLATIONS
  listSeriesTranslations: (seriesId: string) =>
    api.get<SeriesTranslationDto[]>(`/series/${seriesId}/translations`),

  createSeriesTranslation: (seriesId: string, data: CreateSeriesTranslationDto) =>
    api.post<SeriesTranslationDto>(`/series/${seriesId}/translations`, data),

  getSeriesTranslation: (seriesId: string, lang: string) =>
    api.get<SeriesTranslationDto>(`/series/${seriesId}/translations/${lang}`),

  updateSeriesTranslation: (seriesId: string, lang: string, data: UpdateSeriesTranslationDto) =>
    api.put<SeriesTranslationDto>(`/series/${seriesId}/translations/${lang}`, data),

  deleteSeriesTranslation: (seriesId: string, lang: string) =>
    api.delete<void>(`/series/${seriesId}/translations/${lang}`),

  publishSeriesTranslation: (seriesId: string, lang: string) =>
    api.post<void>(`/series/${seriesId}/translations/${lang}/publish`, {}),

  unpublishSeriesTranslation: (seriesId: string, lang: string) =>
    api.post<void>(`/series/${seriesId}/translations/${lang}/unpublish`, {}),

  aiGenerateSeriesTranslation: (seriesId: string, lang: string) =>
    api.post<SeriesTranslationDto>(`/series/${seriesId}/translations/${lang}/ai-generate`, {}),

  reviewSeriesTranslation: (seriesId: string, lang: string, data: ReviewTranslationDto) =>
    api.post<SeriesTranslationDto>(`/series/${seriesId}/translations/${lang}/review`, data),


  // CHAPTER TRANSLATIONS
  listChapterTranslations: (chapterId: string) =>
    api.get<ChapterTranslationDto[]>(`/chapters/${chapterId}/translations`),

  createChapterTranslation: (chapterId: string, data: CreateChapterTranslationDto) =>
    api.post<ChapterTranslationDto>(`/chapters/${chapterId}/translations`, data),

  getChapterTranslation: (chapterId: string, lang: string) =>
    api.get<ChapterTranslationDto>(`/chapters/${chapterId}/translations/${lang}`),

  updateChapterTranslation: (chapterId: string, lang: string, data: UpdateChapterTranslationDto) =>
    api.put<ChapterTranslationDto>(`/chapters/${chapterId}/translations/${lang}`, data),

  deleteChapterTranslation: (chapterId: string, lang: string) =>
    api.delete<void>(`/chapters/${chapterId}/translations/${lang}`),

  publishChapterTranslation: (chapterId: string, lang: string) =>
    api.post<void>(`/chapters/${chapterId}/translations/${lang}/publish`, {}),

  unpublishChapterTranslation: (chapterId: string, lang: string) =>
    api.post<void>(`/chapters/${chapterId}/translations/${lang}/unpublish`, {}),

  aiGenerateChapterTranslation: (chapterId: string, lang: string) =>
    api.post<ChapterTranslationDto>(`/chapters/${chapterId}/translations/${lang}/ai-generate`, {}),

  reviewChapterTranslation: (chapterId: string, lang: string, data: ReviewTranslationDto) =>
    api.post<ChapterTranslationDto>(`/chapters/${chapterId}/translations/${lang}/review`, data),


  // GLOSSARY
  listGlossary: (seriesId: string) =>
    api.get<GlossaryTermDto[]>(`/series/${seriesId}/glossary`),

  createGlossaryTerm: (seriesId: string, data: CreateGlossaryTermDto) =>
    api.post<GlossaryTermDto>(`/series/${seriesId}/glossary`, data),

  updateGlossaryTerm: (seriesId: string, id: number, data: UpdateGlossaryTermDto) =>
    api.put<GlossaryTermDto>(`/series/${seriesId}/glossary/${id}`, data),

  deleteGlossaryTerm: (seriesId: string, id: number) =>
    api.delete<void>(`/series/${seriesId}/glossary/${id}`),

  importGlossary: (seriesId: string, file: File) => {
    const formData = new FormData();
    formData.append('file', file);
    return api.upload<GlossaryImportResultDto>(`/series/${seriesId}/glossary/import`, formData);
  },

  exportGlossary: (seriesId: string, format: 'csv' | 'json' = 'csv') =>
    api.get<Blob>(`/series/${seriesId}/glossary/export`, { format }),
};
```

---

## 5. API Reference – Translations (24 Endpoints)

Base URL: `https://api.ownverso.com/v1`

### 5.1 Series Translations (9 endpoints)

#### 1. `GET /series/{seriesId}/translations`

- **Description:** List all translations for a series (one row per language).
- **Auth:** Author / TRANSLATOR / EDITOR / MANAGER with access to the site.
- **Response:**
  ```json
  [
    {
      "language": "es",
      "languageName": "Spanish",
      "title": "Título traducido",
      "isPublished": true,
      "isAIGenerated": true,
      "isReviewed": false,
      "aiModel": "DEEPL",   // if mapped, or "GPT_4O"
      "aiConfidence": 0.92
    }
  ]
  ```

#### 2. `POST /series/{seriesId}/translations`

- **Description:** Create a new translation for given series and target language (manual or AI-assisted).
- **Auth:** Author / TRANSLATOR / EDITOR.
- **Body:**
  - `language` (ISO 639-1, e.g. `"es"`)
  - `languageName` (e.g. `"Spanish"`)
  - `title`
  - `synopsis`
  - `isAIGenerated?` (boolean, default = false)
- **Response (201):** Created `SeriesTranslation`.

#### 3. `GET /series/{seriesId}/translations/{lang}`

- **Description:** Get specific translation for series in target language.
- **Auth:** Author / TRANSLATOR / EDITOR.
- **Response:** Full `SeriesTranslationDto`.

#### 4. `PUT /series/{seriesId}/translations/{lang}`

- **Description:** Update a series translation (title/synopsis).
- **Auth:** Author / TRANSLATOR / EDITOR.
- **Body:**
  - partial fields: `title?`, `synopsis?`

#### 5. `DELETE /series/{seriesId}/translations/{lang}`

- **Description:** Delete series translation (for given language).
- **Auth:** Author / TRANSLATOR / EDITOR.

#### 6. `POST /series/{seriesId}/translations/{lang}/publish`

- **Description:** Mark translation as published (visible to readers, depending on site rules).
- **Auth:** Author / MANAGER.
- **Behavior:** sets `isPublished = true`, `publishedAt = now()`.

#### 7. `POST /series/{seriesId}/translations/{lang}/unpublish`

- **Description:** Unpublish translation.
- **Auth:** Author / MANAGER.

#### 8. `POST /series/{seriesId}/translations/{lang}/ai-generate`

- **Description:** AI-generate or refresh the series translation.
- **Auth:** Author / TRANSLATOR.
- **Behavior:**
  - Fetches original series title & synopsis (from `Series`).
  - Uses glossary entries (`TranslationGlossary`) to preserve terms.
  - Calls AI provider (`deepl.provider` / `openai.provider`).
  - Stores translation with `isAIGenerated = true`, `aiModel`, `aiConfidence`, `isReviewed = false`.
  - Increments `AIUsageRecord.translationWordsUsed`.
- **Response (200):** New `SeriesTranslation`.

#### 9. `POST /series/{seriesId}/translations/{lang}/review`

- **Description:** Mark translation as reviewed (human QA).
- **Auth:** Author / TRANSLATOR / MANAGER.
- **Body:**
  - `isApproved` (boolean)
  - `reviewNotes?` (string)
- **Behavior:**
  - Sets `isReviewed`, `reviewedById`, `reviewedByName`, `reviewedAt`, `reviewNotes`.

### 5.2 Chapter Translations (9 endpoints)

#### 10. `GET /chapters/{chapterId}/translations`

- **Description:** List all translations for a chapter.
- **Auth:** Author / TRANSLATOR / EDITOR.

#### 11. `POST /chapters/{chapterId}/translations`

- **Description:** Create new chapter translation (manual input).
- **Auth:** Author / TRANSLATOR / EDITOR.
- **Body:**
  - `language`, `languageName`
  - `title?`
  - `content`
  - `authorNote?`
  - `isAIGenerated?` (optional, default false)

#### 12. `GET /chapters/{chapterId}/translations/{lang}`

- **Description:** Get translation for specific chapter + language.
- **Auth:** Author / TRANSLATOR / EDITOR.

#### 13. `PUT /chapters/{chapterId}/translations/{lang}`

- **Description:** Update chapter translation text.
- **Auth:** Author / TRANSLATOR / EDITOR.
- **Body:**
  - partial fields: `title?`, `content?`, `authorNote?`

#### 14. `DELETE /chapters/{chapterId}/translations/{lang}`

- **Description:** Delete chapter translation.

#### 15. `POST /chapters/{chapterId}/translations/{lang}/publish`

- **Description:** Mark translated chapter as published (reader-accessible when base chapter is accessible).
- **Auth:** Author / MANAGER.
- **Behavior:** sets `isPublished = true`, `publishedAt = now()`.

#### 16. `POST /chapters/{chapterId}/translations/{lang}/unpublish`

- **Description:** Unpublish translated chapter.

#### 17. `POST /chapters/{chapterId}/translations/{lang}/ai-generate`

- **Description:** AI-generate full chapter translation.
- **Auth:** Author / TRANSLATOR.
- **Behavior:**
  - Pulls original `Chapter.content` & `authorNote`.
  - Applies `TranslationGlossary` entries.
  - Calls translation AI provider.
  - Writes to `ChapterTranslation` with `isAIGenerated = true`, `aiModel`, etc.
  - Updates `wordCount`.
  - Updates `AIUsageRecord.translationWordsUsed` and `translationRequests`.
- **Response:** `ChapterTranslationDto`.

#### 18. `POST /chapters/{chapterId}/translations/{lang}/review`

- **Description:** Mark chapter translation as reviewed.
- **Auth:** Author / TRANSLATOR / MANAGER.
- **Body:** `isApproved`, `reviewNotes?`.

### 5.3 Translation Glossary (6 endpoints)

#### 19. `GET /series/{seriesId}/glossary`

- **Description:** List glossary entries for a series, optionally filtered by target language.
- **Auth:** Author / TRANSLATOR / EDITOR.
- **Query:** `targetLanguage?`
- **Response:** array of `GlossaryTermDto`.

#### 20. `POST /series/{seriesId}/glossary`

- **Description:** Create a new glossary term for series translation.
- **Auth:** Author / TRANSLATOR.
- **Body:**
  - `sourceText` (string)
  - `sourceLanguage` (string, default `"en"`)
  - `targetText` (string)
  - `targetLanguage` (string, required)
  - `termType?: TranslationTermType`
  - `context?: string`
  - `notes?: string`
- **Response:** Created term.

#### 21. `PUT /series/{seriesId}/glossary/{id}`

- **Description:** Update glossary term fields.
- **Auth:** Author / TRANSLATOR.

#### 22. `DELETE /series/{seriesId}/glossary/{id}`

- **Description:** Delete glossary entry.

#### 23. `POST /series/{seriesId}/glossary/import`

- **Description:** Bulk import glossary entries from file (CSV or JSON).
- **Auth:** Author / TRANSLATOR / MANAGER.
- **Body:** `multipart/form-data` with `file`.
- **Behavior:**
  - Parses file
  - Upserts `TranslationGlossary` entries
- **Response:** Import summary (count created/updated/failed).

#### 24. `GET /series/{seriesId}/glossary/export`

- **Description:** Export glossary for the series.
- **Auth:** Author / TRANSLATOR / MANAGER.
- **Query:** `format=csv|json`
- **Response:** file download (content-type determined by format).

---

## 6. Integration With Other Modules

- **Content Management:**
  - `SeriesTranslation` and `ChapterTranslation` depend on `Series` and `Chapter`.
  - Publishing behavior respects base chapter/series status and access rules.

- **AI Features:**
  - AI-generated translations record usage into `AIUsageRecord` (translationWordsUsed, translationRequests).
  - The translation orchestrator calls AI provider wrappers defined in AI module.

- **Reader Experience:**
  - Reader’s preferred language (from `UserPreferences.contentLanguages`) is used to select which translation to display.
  - Fallbacks: original language if no translation exists.

- **Search & Discovery:**
  - Search index (`SearchIndex` view/model) may incorporate translated titles/synopses for multilingual search (handled in Search module, not here directly).

- **Analytics:**
  - Analytics may track language-specific views; translation endpoints themselves do not handle analytics events.

---

