Below is the **Media & Files** documentation (Category: ~22 endpoints), following the same structure and style as previous sections.

Treat this as: `docs/backend/media-and-files.md`.

---

# Media & Files – Technical Documentation

## 1. Purpose & Scope

The **Media & Files** module is responsible for:

- **File storage & metadata**:
  - Uploading and tracking images, documents, videos, other media used by sites, series, chapters, products, etc.
  - Storing metadata: dimensions, file size, mime type, color information.

- **Optimization & processing**:
  - Marking media as processed/optimized.
  - Storing URLs for thumbnails/placeholders/CDN URLs.

- **Security scanning**:
  - Virus/malware scanning and quarantining suspicious files.

- **Storage & bandwidth accounting**:
  - Tracking per-user storage usage and bandwidth (`StorageUsage`).
  - Enforcing or monitoring tier-based storage limits.

It integrates with:

- **Author & Site Management** (logos, favicons, covers)
- **Content Management** (series covers, chapter images)
- **Monetization – Products** (downloadable assets)
- **AI Features** (AI-generated covers, TikTok previews)
- **Tier Limits** (max storage, bandwidth by platform tier)

---

## 2. Prisma Schema (Models & Enums)

### 2.1 Enums

From global schema; included here for context.

```prisma
enum MediaScanStatus {
  PENDING
  SCANNING
  CLEAN
  FLAGGED
  INFECTED
  BLOCKED
  ERROR
}

enum StorageProvider {
  S3
  GCS
  AZURE_BLOB
  CLOUDFLARE_R2
  BUNNY_CDN
  LOCAL
}
```

### 2.2 Models

#### 2.2.1 `MediaFile`

```prisma
model MediaFile {
  id     BigInt @id @default(autoincrement())
  userId BigInt
  siteId String?

  filename         String
  originalFilename String
  mimeType         String @db.VarChar(100)
  fileSize         Int

  storageProvider StorageProvider @default(S3)
  storagePath     String          @db.VarChar(500)
  storageRegion   String?

  publicUrl String  @db.VarChar(2048)
  cdnUrl    String? @db.VarChar(2048)

  // Image metadata
  width         Int?    @db.SmallInt
  height        Int?    @db.SmallInt
  aspectRatio   Float?
  colorProfile  String?
  dominantColor String? @db.Char(7)

  // Variants
  thumbnailUrl   String? @db.VarChar(2048)
  placeholderUrl String? @db.VarChar(2048)

  // Processing
  isProcessed     Boolean   @default(false)
  processedAt     DateTime?
  processingError String?

  // Optimization
  isOptimized      Boolean @default(false)
  originalSize     Int?
  optimizedSize    Int?
  compressionRatio Float?

  // Description
  altText String? @db.VarChar(500)
  caption String? @db.Text

  // Usage
  usageCount Int       @default(0)
  lastUsedAt DateTime?

  // Security
  scanStatus    MediaScanStatus @default(PENDING)
  scannedAt     DateTime?
  scanResult    String?
  isQuarantined Boolean         @default(false)

  // Organization
  folder String?
  tags   String[] @default([])

  createdAt DateTime  @default(now())
  deletedAt DateTime?

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  site Site? @relation(fields: [siteId], references: [id], onDelete: SetNull)

  @@index([userId, folder])
  @@index([siteId])
  @@index([scanStatus])
  @@index([deletedAt])

  @@map("media_files")
}
```

#### 2.2.2 `StorageUsage`

```prisma
model StorageUsage {
  id     BigInt @id @default(autoincrement())
  userId BigInt @unique

  totalBytes    BigInt @default(0)
  imageBytes    BigInt @default(0)
  documentBytes BigInt @default(0)
  videoBytes    BigInt @default(0)
  otherBytes    BigInt @default(0)

  totalFiles    Int @default(0)
  imageFiles    Int @default(0)
  documentFiles Int @default(0)
  videoFiles    Int @default(0)

  bandwidthUsedBytes BigInt   @default(0)
  bandwidthResetAt   DateTime

  // Limits from tier
  storageLimitBytes   BigInt
  bandwidthLimitBytes BigInt

  storageWarningAt   DateTime?
  bandwidthWarningAt DateTime?

  calculatedAt DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("storage_usage")
}
```

These models and enums provide the full schema for media and storage tracking.

---

## 3. Backend Implementation

### 3.1 Route & Handler Structure

**Base module:** `src/api/v1/media/`

We implement:

- Generic upload
- Media library access (list/get/update/delete)
- Folder-based organization
- Storage usage view

#### 3.1.1 Media Routes – `src/api/v1/media/`

```text
src/api/v1/media/
  index.ts
  media.controller.ts
  media.service.ts
  media.schema.ts
  media.test.ts

  handlers/
    upload-file.handler.ts            # POST /media/upload
    get-presigned-url.handler.ts      # POST /media/upload/presigned
    confirm-upload.handler.ts         # POST /media/upload/confirm
    initiate-multipart.handler.ts     # POST /media/upload/multipart/initiate
    upload-part.handler.ts            # POST /media/upload/multipart/part
    complete-multipart.handler.ts     # POST /media/upload/multipart/complete

    list-files.handler.ts             # GET /media
    get-file.handler.ts               # GET /media/{id}
    update-file.handler.ts            # PUT /media/{id}
    delete-file.handler.ts            # DELETE /media/{id}
    move-file.handler.ts              # POST /media/{id}/move

    list-folders.handler.ts           # GET /media/folders
    create-folder.handler.ts          # POST /media/folders
    delete-folder.handler.ts          # DELETE /media/folders/{folderName}
```

#### 3.1.2 Storage Usage – `src/api/v1/media/usage/`

```text
src/api/v1/media/usage/
  index.ts
  storage-usage.controller.ts
  storage-usage.service.ts
  storage-usage.schema.ts
  storage-usage.test.ts

  handlers/
    get-usage.handler.ts              # GET /media/usage
    get-breakdown.handler.ts          # GET /media/usage/breakdown
```

#### 3.1.3 Image Processing (optional but common) – `src/api/v1/media/processing/`

```text
src/api/v1/media/processing/
  index.ts
  processing.controller.ts
  processing.service.ts
  processing.schema.ts
  processing.test.ts

  handlers/
    optimize-image.handler.ts         # POST /media/{id}/optimize
    resize-image.handler.ts           # POST /media/{id}/resize
    crop-image.handler.ts             # POST /media/{id}/crop
    get-variants.handler.ts           # GET /media/{id}/variants
```

These routes often orchestrate with a background job queue rather than doing heavy work synchronously.

### 3.2 Domain Layer

**Module:** `src/domain/media/`

```text
src/domain/media/
  entities/
    media-file.entity.ts
    storage-usage.entity.ts

  repositories/
    media-file.repository.ts
    storage-usage.repository.ts

  services/
    media.service.ts                  # CRUD for MediaFile; linking to domains
    upload.service.ts                 # Handles upload flows, storage provider integration
    image-processing.service.ts       # Resizing, thumbnail, placeholder, optimization
    storage-usage.service.ts          # Calculate/update StorageUsage per user
```

**Storage Infrastructure:** `src/infrastructure/storage/`

```text
src/infrastructure/storage/
  storage.interface.ts
  storage.service.ts                  # chooses provider based on config
  providers/
    s3.provider.ts                    # AWS S3
    gcs.provider.ts                   # Google Cloud Storage
    azure.provider.ts                 # Azure Blob
    cloudflare-r2.provider.ts         # Cloudflare R2
    bunny.provider.ts                 # Bunny CDN storage
    local.provider.ts                 # local dev
```

**Security scanning** may be handled in a background job that updates `MediaFile.scanStatus` after scanning via some external tool.

---

## 4. Frontend Implementation (Next.js)

### 4.1 Author Media Library UI

Authors need a **media manager** to manage assets for sites, series, chapters, and products.

Route under `src/app/(author)/media/`:

```text
src/app/(author)/media/
  page.tsx                             # /media – global media library view
  _components/
    media-library-header.tsx
    media-grid.tsx
    media-list.tsx
    media-card.tsx
    media-table.tsx
    media-filters.tsx
    folder-sidebar.tsx
    folder-tree.tsx
    upload-button.tsx
    bulk-actions-bar.tsx
    media-detail-sidebar.tsx
    media-preview.tsx
    media-edit-form.tsx
```

Media modals are often used inside:

- Series editor (to pick cover)
- Product editor (to choose product images)
- Announcement editor, etc.

### 4.2 Upload Widgets

Reusable upload components:

```text
src/components/forms/
  file-upload.tsx
  image-upload.tsx
  multi-image-upload.tsx
```

These call the `media/upload` endpoints and then pass resulting `MediaFile` info to parent forms.

### 4.3 Storage Usage UI

Under `src/app/(author)/settings/storage/` or part of author dashboard:

```text
src/app/(author)/settings/storage/
  page.tsx                           # /settings/storage – storage stats
  _components/
    storage-usage-card.tsx
    storage-breakdown-chart.tsx
    bandwidth-usage-card.tsx
```

---

## 5. Hooks & Frontend API Clients

### 5.1 Hooks

```text
src/hooks/
  // Media library
  use-media-files.ts               # list media with filters (folder, tags, type)
  use-media-file-detail.ts         # get single file
  use-upload-media.ts              # single/batch upload with progress
  use-update-media.ts              # update metadata (altText, caption, tags)
  use-delete-media.ts              # delete file
  use-move-media.ts                # move file to folder

  // Folders
  use-media-folders.ts
  use-create-media-folder.ts
  use-delete-media-folder.ts

  // Storage usage
  use-storage-usage.ts             # GET /media/usage
  use-storage-breakdown.ts         # GET /media/usage/breakdown

  // Image processing (if exposed in UI)
  use-optimize-image.ts
  use-resize-image.ts
  use-crop-image.ts
  use-media-variants.ts
```

### 5.2 Frontend API Endpoints

```text
src/lib/api/endpoints/media.ts

export const mediaApi = {
  // Upload flows

  uploadFile: (formData: FormData) =>
    api.upload<MediaFileDto>('/media/upload', formData),

  getPresignedUrl: (data: PresignedUploadRequestDto) =>
    api.post<PresignedUploadResponseDto>('/media/upload/presigned', data),

  confirmUpload: (data: ConfirmUploadDto) =>
    api.post<MediaFileDto>('/media/upload/confirm', data),

  initiateMultipart: (data: InitiateMultipartDto) =>
    api.post<InitiateMultipartResponseDto>('/media/upload/multipart/initiate', data),

  uploadPart: (data: UploadPartDto) =>
    api.post<UploadPartResponseDto>('/media/upload/multipart/part', data),

  completeMultipart: (data: CompleteMultipartDto) =>
    api.post<MediaFileDto>('/media/upload/multipart/complete', data),

  // Media library CRUD

  listFiles: (params?: MediaQueryParams) =>
    api.get<Paginated<MediaFileDto>>('/media', params),

  getFile: (id: number | string) =>
    api.get<MediaFileDto>(`/media/${id}`),

  updateFile: (id: number | string, data: UpdateMediaFileDto) =>
    api.put<MediaFileDto>(`/media/${id}`, data),

  deleteFile: (id: number | string) =>
    api.delete<void>(`/media/${id}`),

  moveFile: (id: number | string, data: MoveMediaDto) =>
    api.post<void>(`/media/${id}/move`, data),

  // Folders

  listFolders: () =>
    api.get<MediaFolderDto[]>('/media/folders'),

  createFolder: (data: CreateFolderDto) =>
    api.post<void>('/media/folders', data),

  deleteFolder: (folderName: string) =>
    api.delete<void>(`/media/folders/${encodeURIComponent(folderName)}`),

  // Storage usage

  getUsage: () =>
    api.get<StorageUsageDto>('/media/usage'),

  getBreakdown: () =>
    api.get<StorageBreakdownDto>('/media/usage/breakdown'),

  // Image processing

  optimizeImage: (id: number | string) =>
    api.post<MediaFileDto>(`/media/${id}/optimize`, {}),

  resizeImage: (id: number | string, data: ResizeImageDto) =>
    api.post<MediaFileDto>(`/media/${id}/resize`, data),

  cropImage: (id: number | string, data: CropImageDto) =>
    api.post<MediaFileDto>(`/media/${id}/crop`, data),

  getVariants: (id: number | string) =>
    api.get<MediaVariantDto[]>(`/media/${id}/variants`),
};
```

---

## 6. API Reference – Media & Files (~22 Endpoints)

Base URL: `https://api.ownverso.com/v1`

### 6.1 Upload & Storage (6–8 endpoints)

1. **POST `/media/upload`**  
   Direct upload endpoint (small files).  
   - Auth: User (usually author/collaborator).  
   - Body: `multipart/form-data` with `file`.  
   - Response: `MediaFileDto`.

2. **POST `/media/upload/presigned`**  
   Request a presigned URL for client-side upload (S3/R2).  
   - Body: `filename`, `mimeType`, `size`, optional `folder`.  
   - Response: URL + fields for direct upload.

3. **POST `/media/upload/confirm`**  
   Confirm that file at presigned URL was uploaded; create `MediaFile` record.  
   - Body: metadata + `storagePath`, `publicUrl`.

4. **POST `/media/upload/multipart/initiate`**  
   Start a multipart upload for large files.

5. **POST `/media/upload/multipart/part`**  
   Upload a part (maybe just used by client’s direct-to-S3 instead).

6. **POST `/media/upload/multipart/complete`**  
   Complete multipart upload, then create `MediaFile`.

*(Multipart endpoints can be considered 1–3 endpoints depending on implementation; total still around target.)*

### 6.2 Media Library CRUD (7 endpoints)

7.  **GET `/media`**  
    List media files for current user (filtered by `siteId?`, `folder?`, `tags?`, `mimeType?`).

8.  **GET `/media/{id}`**  
    Get metadata for a single `MediaFile`.

9.  **PUT `/media/{id}`**  
    Update file metadata:
    - `altText?`, `caption?`, `folder?`, `tags?`.

10. **DELETE `/media/{id}`**  
    Soft-delete media file (set `deletedAt`).

11. **POST `/media/{id}/move`**  
    Move file to another folder.  
    - Body: `folder: string`.

12. **GET `/media/folders`**  
    List folders (virtual; derived from `MediaFile.folder`).

13. **POST `/media/folders`**  
    Create folder (might not persist separate model; ensures required prefix exists).

14. **DELETE `/media/folders/{folderName}`**  
    Delete folder (optional); may move or mark contained files.

### 6.3 Storage Usage (2 endpoints)

15. **GET `/media/usage`**  
    Get storage usage summary for current user (`StorageUsage`).

16. **GET `/media/usage/breakdown`**  
    Get detailed breakdown by type (images, documents, videos, other) and by site (if computed).

### 6.4 Image Processing (4–5 endpoints)

17. **POST `/media/{id}/optimize`**  
    Trigger optimization/compression (may schedule a job).

18. **POST `/media/{id}/resize`**  
    Generate resized variant (e.g., width/height).  
    - Body: target dimensions.

19. **POST `/media/{id}/crop`**  
    Crop image based on coordinates/aspect.  
    - Body: `x`, `y`, `width`, `height`, optional aspect.

20. **GET `/media/{id}/variants`**  
    List available image variants (thumbnails, different sizes, formats).

*(If you have a security scanning endpoint, e.g., `POST /media/{id}/scan`, that can be the 21st endpoint; plus an admin-level listing for quarantined files makes 22.)*

### 6.5 Security / Scan (Optional 1–2 endpoints)

21. **GET `/admin/media/quarantined`**  
    List infected/flagged media (admin view).  
    - Auth: Admin  
    - Filters: `scanStatus`, `userId`.

22. **POST `/admin/media/{id}/release`**  
    Release quarantined media after manual review.  
    - Sets `scanStatus = CLEAN`, `isQuarantined = false`.

---

## 7. Integration With Other Modules

- **Author & Site Management:**
  - `Site.logoUrl`, `Site.faviconUrl`, `Series.coverImageUrl`, `Announcement.coverImageUrl`, `Product.coverImageUrl` all reference `MediaFile.publicUrl` / `thumbnailUrl` etc.  
  - Media manager is site-aware, but usage is tracked per user.

- **Content Management:**
  - `ChapterImage` panels refer to image URLs or underlying `MediaFile` objects; editing flows may use Media module internally.

- **AI Features:**
  - AI-generated covers and TikTok previews provide raw files; Media module stores and tracks them.

- **Monetization – Products:**
  - Products’ downloadable files (epubs, zips, art packs) are stored as `MediaFile` with `downloadFileRef` in `Product`.

- **Tier Limits / Billing:**
  - `StorageUsage` vs. `TierLimits.storageLimitBytes` determines warnings and potential restrictions.
  - `bandwidthUsedBytes` can be computed from CDN access logs integrated via separate ingestion.

- **Security / Moderation:**
  - Media scanning supports blocking malicious uploads (INFECTED/BLOCKED) and hiding them from use.

---

If this matches what you want, the next category to document is:

**Social Connections (16 endpoints)** – i.e., external social media integrations:

- Connected social accounts (Twitter/Discord/Bluesky/etc.)
- Auto-posting configuration
- Social posts logs and stats.