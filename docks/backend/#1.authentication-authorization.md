

# Authentication & Authorization â€“ Technical Documentation

## 1. Purpose & Scope

This module is responsible for:

- User identity (registration, login, logout)
- Session management (web & API)
- OAuth / Social login
- Email verification and password reset
- Multi-factor authentication (MFA)
- Access token / refresh token lifecycle
- Basic authorization guards (role- and permission-based)

It underpins all other modules that require authenticated access (reader dashboard, author dashboard, admin, etc.).

---

## 2. Prisma Schema (Models & Enums)

### 2.1 Relevant Enums

```prisma
enum UserRole {
  READER
  AUTHOR
  COLLABORATOR
  MODERATOR
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  PENDING_VERIFICATION
  ACTIVE
  SUSPENDED
  BANNED
  DELETED
  DEACTIVATED
}

enum AuthProvider {
  EMAIL
  GOOGLE
  APPLE
  TWITTER
  DISCORD
  FACEBOOK
}

enum VerificationTokenType {
  EMAIL_VERIFICATION
  EMAIL_CHANGE
  PASSWORD_RESET
  MFA_SETUP
  ACCOUNT_RECOVERY
  API_KEY_CREATION
}
```

### 2.2 Core Models

#### `User` (core identity)

```prisma
model User {
  id       BigInt @id @default(autoincrement())
  publicId String @unique @default(cuid())

  // Authentication
  email         String     @unique
  emailVerified Boolean    @default(false)
  passwordHash  String?
  username      String     @unique
  displayName   String
  role          UserRole   @default(READER)
  status        UserStatus @default(PENDING_VERIFICATION)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Extensions
  profile       UserProfile?
  security      UserSecurity?
  preferences   UserPreferences?
  authorAccount AuthorAccount?
  readerProfile ReaderProfile?

  // Auth relations
  authAccounts       AuthAccount[]
  sessions           Session[]
  verificationTokens VerificationToken[]

  // ...many other relations (content, payments, etc.)
  
  @@index([email])
  @@index([username])
  @@index([publicId])
  @@index([status, role])
  @@index([createdAt])
  @@index([deletedAt])

  @@map("users")
}
```

#### `UserProfile` (non-sensitive profile)

```prisma
model UserProfile {
  userId BigInt @id

  avatarUrl String? @db.VarChar(2048)
  bio       String? @db.Text

  locale     String     @default("en") @db.Char(2)
  timezone   String     @default("UTC") @db.VarChar(50)
  dataRegion DataRegion @default(INDIA)

  websiteUrl      String? @db.VarChar(2048)
  twitterHandle   String? @db.VarChar(50)
  instagramHandle String? @db.VarChar(50)
  tiktokHandle    String? @db.VarChar(50)
  discordHandle   String? @db.VarChar(50)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}
```

#### `UserSecurity` (sensitive auth-related data)

```prisma
model UserSecurity {
  userId BigInt @id

  emailVerifiedAt DateTime?

  mfaEnabled     Boolean  @default(false)
  mfaSecret      String?  @db.Text
  mfaBackupCodes String[] @default([])

  lastLoginAt        DateTime?
  lastLoginIp        String?   @db.VarChar(45)
  lastLoginUserAgent String?   @db.Text
  lastLoginDeviceId  String?

  failedLoginCount  Int       @default(0) @db.SmallInt
  lockedUntil       DateTime?
  passwordChangedAt DateTime?
  forceLogoutAt     DateTime?

  statusHistory Json @default("[]") // [{status, timestamp, reason}]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_security")
}
```

#### `UserPreferences` (auth-adjacent, used in notifications/privacy)

```prisma
model UserPreferences {
  userId BigInt @id

  emailNotifications   Boolean              @default(true)
  pushNotifications    Boolean              @default(true)
  emailDigestFrequency EmailDigestFrequency @default(DAILY)

  contentLanguages String[]       @default(["en"])
  contentRatings   ContentRating[] @default([EVERYONE, TEEN])
  hiddenGenres     String[]       @default([])
  hiddenTags       String[]       @default([])

  showOnlineStatus    Boolean @default(true)
  showReadingActivity Boolean @default(true)
  allowDirectMessages Boolean @default(true)

  marketingEmails Boolean @default(false)
  newsletterOptIn Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}
```

#### `AuthAccount` (OAuth providers)

```prisma
model AuthAccount {
  id     BigInt @id @default(autoincrement())
  userId BigInt

  provider          AuthProvider
  providerAccountId String

  accessTokenRef  String?
  refreshTokenRef String?
  tokenExpiresAt  DateTime?
  tokenScopes     String[]  @default([])

  providerEmail  String?
  providerName   String?
  providerAvatar String? @db.VarChar(2048)

  lastSyncedAt  DateTime?
  isRevoked     Boolean   @default(false)
  revokedAt     DateTime?
  revokedReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId, provider])

  @@map("auth_accounts")
}
```

#### `Session`

```prisma
model Session {
  id     BigInt @id @default(autoincrement())
  userId BigInt

  tokenHash        String @unique
  refreshTokenHash String @unique

  isRevoked     Boolean   @default(false)
  revokedAt     DateTime?
  revokedReason String?

  userAgent  String?    @db.Text
  ipAddress  String?    @db.VarChar(45)
  deviceType DeviceType @default(UNKNOWN)
  deviceOs   String?
  browser    String?
  country    String?    @db.Char(2)
  city       String?

  authProvider AuthProvider?

  expiresAt    DateTime
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRevoked])
  @@index([tokenHash])
  @@index([expiresAt])
  @@index([lastActiveAt])

  @@map("sessions")
}
```

#### `VerificationToken`

```prisma
model VerificationToken {
  id     BigInt @id @default(autoincrement())
  userId BigInt

  tokenHash String                @unique
  type      VerificationTokenType
  newEmail  String?

  isUsed      Boolean   @default(false)
  usedAt      DateTime?
  requestedIp String?   @db.VarChar(45)
  usedIp      String?   @db.VarChar(45)

  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
  @@index([expiresAt])

  @@map("verification_tokens")
}
```

These models/enums are sufficient for the Authentication & Authorization feature set.

---

## 3. Backend Implementation

### 3.1 Route & Handler Structure

**Base module:** `src/api/v1/auth/`

```text
src/
  api/
    v1/
      auth/
        index.ts                 # Registers all auth routes with Fastify
        auth.controller.ts       # High-level orchestration; minimal logic
        auth.service.ts          # Business logic (delegates to domain)
        auth.schema.ts           # Request/response Zod schemas
        auth.test.ts             # Integration tests for auth endpoints

        strategies/
          local.strategy.ts      # Email/password auth
          google.strategy.ts     # Google OAuth
          apple.strategy.ts      # Apple OAuth
          twitter.strategy.ts    # Twitter OAuth
          discord.strategy.ts    # Discord OAuth

        guards/
          auth.guard.ts          # Ensures request is authenticated
          roles.guard.ts         # Role-based access check
          permissions.guard.ts   # Permission-based check
          rate-limit.guard.ts    # Per-endpoint rate limits

        handlers/
          register.handler.ts
          login.handler.ts
          logout.handler.ts
          logout-all.handler.ts
          refresh.handler.ts
          get-me.handler.ts

          password/
            forgot-password.handler.ts
            reset-password.handler.ts
            change-password.handler.ts

          email/
            verify-email.handler.ts
            resend-verification.handler.ts
            request-email-change.handler.ts
            confirm-email-change.handler.ts

          mfa/
            mfa-setup-init.handler.ts
            mfa-setup-verify.handler.ts
            mfa-disable.handler.ts
            mfa-verify-login.handler.ts
            mfa-recover.handler.ts

          oauth/
            oauth-init.handler.ts      # server-side helper if needed
            oauth-callback.handler.ts  # generic callback handler
```

### 3.2 Domain Layer

**Module:** `src/domain/auth/`

```text
src/domain/auth/
  entities/
    session.entity.ts
    auth-account.entity.ts
    verification-token.entity.ts

  repositories/
    session.repository.ts
    auth-account.repository.ts
    verification-token.repository.ts

  services/
    auth.service.ts            # login/register/logout/refresh
    session.service.ts         # session lifecycle
    token.service.ts           # verification tokens
    password.service.ts        # hashing & strength checks
    mfa.service.ts             # MFA secrets, TOTP, backup codes
    oauth.service.ts           # OAuth linking & login

  strategies/
    jwt.strategy.ts            # Token verification for API

  events/
    auth.events.ts             # e.g. UserLoggedIn, PasswordChanged, etc.
```

**Related user-domain files** (for security):

```text
src/domain/users/
  entities/
    user.entity.ts
    user-security.entity.ts
    user-profile.entity.ts

  repositories/
    user.repository.ts
    user-security.repository.ts

  services/
    user.service.ts
    user-security.service.ts
```

### 3.3 Core & Security Layer

```text
src/core/security/
  jwt.service.ts         # sign/verify access+refresh JWT
  hashing.service.ts     # argon2 password hashing
  api-key.service.ts     # for API keys (not primary auth)
  rate-limiter.service.ts# low-level rate-limiting
  vault.service.ts       # fetch secrets for OAuth providers

src/core/database/
  prisma.service.ts      # Prisma client with extensions

src/plugins/
  auth.plugin.ts         # Fastify JWT + hooks wiring
  prisma.plugin.ts
  rate-limit.plugin.ts
```

---

## 4. Frontend Implementation (Next.js)

### 4.1 App Router Routes

**Auth route group:** `src/app/(auth)/`

```text
src/app/(auth)/
  layout.tsx                    # Auth layout (logo, card, etc.)

  login/
    page.tsx                    # /login
    loading.tsx
    _components/
      login-form.tsx
      social-login-buttons.tsx
      remember-me-checkbox.tsx

  register/
    page.tsx                    # /register
    loading.tsx
    _components/
      register-form.tsx
      terms-checkbox.tsx
      password-strength-indicator.tsx

  forgot-password/
    page.tsx                    # /forgot-password
    _components/
      forgot-password-form.tsx

  reset-password/
    page.tsx                    # /reset-password?token=...
    _components/
      reset-password-form.tsx

  verify-email/
    page.tsx                    # /verify-email?token=...
    _components/
      verification-status.tsx

  mfa/
    setup/
      page.tsx                  # /mfa/setup
    verify/
      page.tsx                  # /mfa/verify (during login)

  oauth/
    callback/
      [provider]/
        page.tsx                # /oauth/callback/google, etc.
```

**API routes (NextAuth / server-side helpers):** `src/app/api/auth/`

```text
src/app/api/auth/
  [...nextauth]/
    route.ts                    # NextAuth handler
  csrf/
    route.ts                    # CSRF token if needed
```

### 4.2 Components

```text
src/components/common/
  user-menu.tsx                 # Profile menu in header
  auth-guard.tsx                # Client-side guard (optional)

src/components/forms/
  password-input.tsx
  otp-input.tsx
```

### 4.3 Hooks

```text
src/hooks/
  use-auth.ts                   # High-level auth hook (login, logout, register)
  use-session.ts                # Wrapper around next-auth useSession
  use-permissions.ts            # Role/permission checks
```

### 4.4 Libs & Config

```text
src/lib/auth/
  auth-options.ts               # NextAuth options
  providers.ts                  # OAuth providers config
  callbacks.ts                  # JWT & session callbacks
  session.ts                    # Helpers for server components

src/lib/api/
  client.ts                     # Axios client with interceptors
  endpoints/auth.ts             # Auth HTTP calls (login, register, etc.)

src/lib/constants/
  routes.ts                     # ROUTES.LOGIN, ROUTES.DASHBOARD, etc.
  api.ts                        # /auth/register, /auth/login, etc.
```

### 4.5 Types & Validation

```text
src/types/api/auth.types.ts
  // LoginCredentials, RegisterData, AuthResponse, SessionUser, etc.

src/lib/validation/schemas/auth.schema.ts
  // Zod schemas for frontend validation (login/register/MFA)
```

---

## 5. API Reference (Authentication & Authorization)

All endpoints are under `https://api.ownverso.com/v1`.

### 5.1 Registration & Login

#### 1. `POST /auth/register`

- **Description:** Create a new user account (email + password).
- **Auth:** Public
- **Body:**
  - `email` (string, required)
  - `password` (string, required)
  - `username` (string, required)
  - `displayName` (string, required)
- **Response (201):**
  - `user`: basic user object (id, email, username, role, status)
  - `requiresEmailVerification`: boolean
- **Errors:**
  - `409 USER_ALREADY_EXISTS`
  - `400 WEAK_PASSWORD`
  - `422 VALIDATION_ERROR`

#### 2. `POST /auth/login`

- **Description:** Login via email/password; returns access/refresh tokens (and/or sets HttpOnly cookies).
- **Auth:** Public
- **Body:**
  - `email`: string
  - `password`: string
  - `rememberMe`: boolean (optional)
- **Response (200):**
  - `accessToken`
  - `refreshToken`
  - `user`: user payload
  - `mfaRequired`: boolean
- **Errors:**
  - `401 INVALID_CREDENTIALS`
  - `423 ACCOUNT_LOCKED`
  - `403 ACCOUNT_BANNED`

#### 3. `POST /auth/logout`

- **Description:** Logout current session (invalidate access/refresh & Session row).
- **Auth:** Bearer token
- **Body:** none
- **Response (204)**

#### 4. `POST /auth/logout-all`

- **Description:** Logout from all devices (sets `forceLogoutAt` in `UserSecurity` and revokes all `Session` rows).
- **Auth:** Bearer token
- **Response (204)**

#### 5. `POST /auth/refresh`

- **Description:** Refresh access token using refresh token.
- **Auth:** Public (refresh token in body or cookie)
- **Body:**
  - `refreshToken`: string
- **Response (200):**
  - `accessToken`
  - `refreshToken` (maybe rotated)
- **Errors:**
  - `401 INVALID_REFRESH_TOKEN`
  - `401 REFRESH_TOKEN_EXPIRED`

#### 6. `GET /auth/me`

- **Description:** Get current authenticated user.
- **Auth:** Bearer token
- **Response (200):**
  - `user`: enriched user object (including profile & preferences)

### 5.2 OAuth / Social Login

#### 7. `GET /auth/oauth/{provider}`

- **Description:** (Optional) Server-side helper to build provider URL. In practice, usually handled by frontend with NextAuth.

#### 8. `GET /auth/oauth/{provider}/callback`

- **Description:** OAuth callback endpoint for provider.
- **Auth:** Public
- **Query:**
  - `code` / `state` etc., as per provider
- **Behavior:**
  - Validates OAuth code
  - Finds or creates `User`
  - Returns tokens or redirects HTML

### 5.3 Email Verification

#### 9. `POST /auth/email/verify`

- **Description:** Verify email using token.
- **Auth:** Public
- **Body:**
  - `token`: string
- **Behavior:**
  - Looks up `VerificationToken` with `type = EMAIL_VERIFICATION`
  - Marks `User.emailVerified = true`, `UserSecurity.emailVerifiedAt`
- **Response (200)**

#### 10. `POST /auth/email/resend-verification`

- **Description:** Resend email verification link to current user.
- **Auth:** User
- **Response (204)**

#### 11. `POST /auth/email/change`

- **Description:** Request email change (sends verification to new address).
- **Auth:** User
- **Body:**
  - `newEmail`
- **Response (204)**

#### 12. `POST /auth/email/confirm-change`

- **Description:** Confirm email change using token.
- **Auth:** Public
- **Body:** `token`
- **Response (200)**

### 5.4 Password Management

#### 13. `POST /auth/password/forgot`

- **Description:** Request password reset link.
- **Auth:** Public
- **Body:** `email`
- **Response (204)**

#### 14. `POST /auth/password/reset`

- **Description:** Reset password with token.
- **Auth:** Public
- **Body:**
  - `token`
  - `newPassword`
- **Response (200)**

#### 15. `PUT /auth/password/change`

- **Description:** Change password when logged in.
- **Auth:** User
- **Body:**
  - `currentPassword`
  - `newPassword`
- **Response (204)**

### 5.5 Multi-Factor Authentication (MFA)

#### 16. `POST /auth/mfa/setup`

- **Description:** Start MFA setup (returns TOTP secret & QR).
- **Auth:** User
- **Response (200):**
  - `otpAuthUrl`
  - `qrCodeSvg`
  - `recoveryCodes` (optional)

#### 17. `POST /auth/mfa/verify-setup`

- **Description:** Complete MFA setup by verifying TOTP code.
- **Auth:** User
- **Body:**
  - `code`
- **Behavior:**
  - Stores `mfaSecret`, `mfaEnabled = true`

#### 18. `POST /auth/mfa/disable`

- **Description:** Disable MFA after verifying password / TOTP.
- **Auth:** User

#### 19. `POST /auth/mfa/verify`

- **Description:** Verify MFA during login (when `mfaRequired = true`).
- **Auth:** Public
- **Body:**
  - `loginSessionId` or `pendingToken`
  - `code`
- **Response:**
  - Access & refresh tokens

#### 20. `POST /auth/mfa/recover`

- **Description:** Recover account using MFA backup code.
- **Auth:** Public
- **Body:**
  - `email`
  - `backupCode`

### 5.6 Sessions

#### 21. `GET /auth/sessions`

- **Description:** List active sessions for current user.
- **Auth:** User
- **Response:**
  - Array of sessions (device, location, lastActiveAt, etc.)

#### 22. `GET /auth/sessions/{id}`

- **Description:** Get details for a specific session.
- **Auth:** User

#### 23. `DELETE /auth/sessions/{id}`

- **Description:** Revoke a specific session (logout that device).
- **Auth:** User

#### 24. `DELETE /auth/sessions`

- **Description:** Revoke all *other* sessions (keep current).
- **Auth:** User

### 5.7 Security / Lock

#### 25. `GET /auth/security-status`

- **Description:** Get security status (MFA enabled, last login, etc.).
- **Auth:** User

#### 26. `POST /auth/security/lock-account`

- Optional, if you support explicit account lock by user.

### 5.8 Meta / Utility

#### 27. `GET /auth/password/strength`

- **Description:** Evaluate password strength.
- **Auth:** Public
- **Query:** `password`
- **Response:** `score`, `feedback`

#### 28. `GET /auth/providers`

- **Description:** List available auth providers (OAuth + email).
- **Auth:** Public

*(We initially counted 32 endpoints; above is a representative set. Additional small ones like `GET /auth/csrf`, `GET /auth/config`, etc., would bring the total to 32.)*

---
