

# Monetization – Payments – Technical Documentation

## 1. Purpose & Scope

The **Payments** module is responsible for:

- **Payment gateway configuration** for authors:
  - Connecting / disconnecting Razorpay, Stripe, Xendit, etc.
  - Storing account IDs and webhook secrets (via vault references)
  - Tracking webhook health

- **Payment transactions**:
  - All money movement records (subscriptions, one-time purchases, tips, platform fees, payouts)
  - Status transitions (PENDING → SUCCEEDED / FAILED / REFUNDED / DISPUTED)
  - Fees and net amounts
  - Gateway-specific identifiers

- **Payment events (event sourcing)**:
  - Detailed log of state changes for each Payment (useful for audits & reconciliation)

- **Platform invoices**:
  - Invoices Ownverso issues to authors (e.g., usage-based fees for Free tier)
  - Status (PENDING, PAID, OVERDUE, etc.)

- **Author payouts**:
  - Aggregated revenue for authors over a period
  - Payouts to author’s bank/UPI
  - Status (PENDING, PROCESSING, COMPLETED, FAILED)

It integrates closely with:

- **Monetization – Subscriptions** (recurrent charges)
- **Monetization – Products & Purchases** (one-time orders)
- **Webhooks & Integrations** (gateway events)
- **Platform Administration** (billing & finance dashboard)

---

## 2. Prisma Schema (Models & Enums)

### 2.1 Relevant Enums

```prisma
enum PaymentStatus {
  PENDING
  PROCESSING
  REQUIRES_ACTION
  SUCCEEDED
  FAILED
  EXPIRED
  REFUNDED
  PARTIALLY_REFUNDED
  DISPUTED
  CHARGEBACK_LOST
  CHARGEBACK_WON
  ON_HOLD
  CANCELLED
}

enum PaymentType {
  SUBSCRIPTION
  SUBSCRIPTION_RENEWAL
  ONE_TIME_PURCHASE
  TIP
  PLATFORM_FEE
  REFUND
  PAYOUT
}

enum PaymentGateway {
  RAZORPAY
  STRIPE
  XENDIT
  PAYPAL
  MANUAL
}

enum PlatformInvoiceStatus {
  DRAFT
  PENDING
  PAID
  OVERDUE
  CANCELLED
  DISPUTED
  WRITTEN_OFF
  REFUNDED
}

enum PayoutStatus {
  PENDING
  SCHEDULED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  ON_HOLD
}
```

### 2.2 Models

#### 2.2.1 `PaymentGatewayConfig` (Author gateway config)

```prisma
model PaymentGatewayConfig {
  id       BigInt @id @default(autoincrement())
  authorId BigInt @unique

  // Razorpay (India)
  razorpayAccountId        String?
  razorpayConnected        Boolean   @default(false)
  razorpayConnectedAt      DateTime?
  razorpayVerified         Boolean   @default(false)
  razorpayVerifiedAt       DateTime?
  razorpayWebhookSecretRef String?   // Secret reference (vault)

  // Stripe (Global)
  stripeAccountId        String?
  stripeAccountType      String?
  stripeConnected        Boolean   @default(false)
  stripeConnectedAt      DateTime?
  stripeChargesEnabled   Boolean   @default(false)
  stripePayoutsEnabled   Boolean   @default(false)
  stripeDetailsSubmitted Boolean   @default(false)
  stripeWebhookSecretRef String?   // Secret reference

  // Xendit (SEA)
  xenditBusinessId      String?
  xenditConnected       Boolean   @default(false)
  xenditConnectedAt     DateTime?
  xenditVerified        Boolean   @default(false)
  xenditWebhookTokenRef String?   // Secret reference

  defaultGateway PaymentGateway?

  // Health
  lastWebhookReceivedAt DateTime?
  webhookFailureCount   Int       @default(0) @db.SmallInt
  webhookHealthStatus   HealthStatus?
  lastReconciliationAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author AuthorAccount @relation(fields: [authorId], references: [userId], onDelete: Cascade)

  @@map("payment_gateway_configs")
}
```

#### 2.2.2 `Payment` (Core transaction record)

```prisma
model Payment {
  id BigInt @id @default(autoincrement())

  readerId BigInt?
  authorId BigInt?

  subscriptionId String?

  type   PaymentType
  status PaymentStatus @default(PENDING)

  // Amounts (smallest currency unit)
  grossAmount  Int
  gatewayFee   Int?
  platformFee  Int?
  netAmount    Int?
  currencyCode String @db.Char(3)

  // Gateway refs
  gateway           PaymentGateway
  gatewayPaymentId  String?
  gatewayOrderId    String?
  gatewayInvoiceId  String?
  gatewayResponse   Json?
  gatewayReceiptUrl String? @db.VarChar(2048)

  // Payment method (non-sensitive)
  cardBrand      String? @db.VarChar(20)
  cardLast4      String? @db.Char(4)
  paymentCountry String? @db.Char(2)
  paymentMethod  String? @db.VarChar(50)

  // Failure
  failureCode    String?
  failureMessage String?
  failedAt       DateTime?
  retryCount     Int       @default(0) @db.SmallInt
  maxRetries     Int       @default(3) @db.SmallInt
  nextRetryAt    DateTime?

  // Refund
  refundedAmount    Int?
  refundedAt        DateTime?
  refundReason      String?
  refundGatewayId   String?
  refundInitiatedBy BigInt?

  // Dispute
  disputedAt        DateTime?
  disputeReason     String?
  disputeStatus     String?
  disputeEvidence   Json?
  disputeResolvedAt DateTime?
  disputeOutcome    String?

  // Metadata
  metadata  Json?
  notes     String?   @db.Text
  ipAddress String?   @db.VarChar(45)
  userAgent String?   @db.Text

  // Idempotency
  idempotencyKey String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reader       User?               @relation("ReaderPayments", fields: [readerId], references: [id], onDelete: SetNull)
  author       User?               @relation("AuthorPayments", fields: [authorId], references: [id], onDelete: SetNull)
  subscription ReaderSubscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  currency     Currency            @relation(fields: [currencyCode], references: [code])
  events       PaymentEvent[]

  @@unique([gateway, gatewayPaymentId])
  @@index([readerId, status])
  @@index([authorId, status, createdAt(sort: Desc)])
  @@index([gateway, status])
  @@index([status, createdAt])
  @@index([status, nextRetryAt])
  @@index([subscriptionId])

  @@map("payments")
}
```

#### 2.2.3 `PaymentEvent` (Event sourcing)

```prisma
model PaymentEvent {
  id        BigInt @id @default(autoincrement())
  paymentId BigInt

  eventType      String         @db.VarChar(50)
  previousStatus PaymentStatus?
  newStatus      PaymentStatus
  metadata       Json?

  triggeredBy    String?
  triggeredById  BigInt?

  createdAt DateTime @default(now())

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId, createdAt(sort: Desc)])
  @@index([eventType, createdAt])

  @@map("payment_events")
}
```

#### 2.2.4 `PlatformInvoice` (Ownverso → Author)

```prisma
model PlatformInvoice {
  id       BigInt @id @default(autoincrement())
  authorId BigInt

  invoiceNumber   String   @unique
  periodStart     DateTime
  periodEnd       DateTime
  grossRevenue    BigInt
  usageFeePercent Float    @default(10)
  usageFeeAmount  BigInt
  gstPercent      Float    @default(18)
  gstAmount       BigInt
  totalAmount     BigInt
  currencyCode    String   @default("INR") @db.Char(3)

  status PlatformInvoiceStatus @default(PENDING)

  dueDate          DateTime
  paidAt           DateTime?
  paymentMethod    String?
  paymentReference String?

  disputedAt        DateTime?
  disputeReason     String?   @db.Text
  disputeResolvedAt DateTime?
  disputeOutcome    String?

  remindersSent  Int       @default(0) @db.SmallInt
  lastReminderAt DateTime?

  invoiceUrl String? @db.VarChar(2048)
  notes      String? @db.Text

  transactionCount Int   @default(0)
  breakdown        Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author AuthorAccount @relation(fields: [authorId], references: [userId], onDelete: Cascade)

  @@index([authorId, status])
  @@index([status, dueDate])
  @@index([periodStart, periodEnd])

  @@map("platform_invoices")
}
```

#### 2.2.5 `AuthorPayout`

```prisma
model AuthorPayout {
  id       BigInt @id @default(autoincrement())
  authorId BigInt

  periodStart DateTime
  periodEnd   DateTime

  grossRevenue BigInt
  gatewayFees  BigInt
  platformFees BigInt
  netPayout    BigInt
  currencyCode String @default("INR") @db.Char(3)

  gateway          PaymentGateway
  gatewayPayoutId  String?
  gatewayReference String?

  status       PayoutStatus @default(PENDING)
  scheduledFor DateTime?
  processedAt  DateTime?
  completedAt  DateTime?
  failedAt     DateTime?
  errorMessage String?
  retryCount   Int       @default(0) @db.SmallInt

  bankDetailsRef String?

  invoiceNumber String?
  invoiceUrl    String? @db.VarChar(2048)

  transactionCount Int   @default(0)
  breakdown        Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author AuthorAccount @relation(fields: [authorId], references: [userId], onDelete: Cascade)

  @@index([authorId, status])
  @@index([status, scheduledFor])
  @@index([periodStart])

  @@map("author_payouts")
}
```

These models + enums are the core of the Payments module.

---

## 3. Backend Implementation

### 3.1 Route & Handler Structure

We conceptually split into:

- **Author payment configuration**
- **Reader payments**
- **Author earnings & payouts**
- **Platform invoices**
- **Admin finance tools**

#### 3.1.1 Author Gateway Configuration – `src/api/v1/author/payment-config/`

```text
src/api/v1/author/payment-config/
  index.ts
  payment-config.controller.ts
  payment-config.service.ts
  payment-config.schema.ts
  payment-config.test.ts

  handlers/
    get-config.handler.ts                 # GET /author/payment-config
    set-default-gateway.handler.ts        # PUT /author/payment-config/default-gateway
    razorpay-connect.handler.ts           # POST /author/payment-config/razorpay/connect
    razorpay-disconnect.handler.ts        # POST /author/payment-config/razorpay/disconnect
    stripe-connect.handler.ts             # POST /author/payment-config/stripe/connect
    stripe-disconnect.handler.ts          # POST /author/payment-config/stripe/disconnect
    xendit-connect.handler.ts             # POST /author/payment-config/xendit/connect
    xendit-disconnect.handler.ts          # POST /author/payment-config/xendit/disconnect
    get-status.handler.ts                 # GET /author/payment-config/status
```

Connection flows may include OAuth for Stripe, or manual API key entry for Xendit, etc.

#### 3.1.2 Reader Payments – `src/api/v1/payments/`

```text
src/api/v1/payments/
  index.ts
  payments.controller.ts
  payments.service.ts
  payments.schema.ts
  payments.test.ts

  handlers/
    list-my-payments.handler.ts           # GET /payments
    get-my-payment.handler.ts             # GET /payments/{id}
    get-receipt.handler.ts                # GET /payments/{id}/receipt
    retry-payment.handler.ts              # POST /payments/{id}/retry
    request-refund.handler.ts             # POST /payments/{id}/refund-request

    methods/
      list-payment-methods.handler.ts     # GET /payment-methods
      add-payment-method.handler.ts       # POST /payment-methods
      delete-payment-method.handler.ts    # DELETE /payment-methods/{id}
      set-default-method.handler.ts       # PUT /payment-methods/{id}/default
```

> **Note:** Actual payment method data is often stored off-site (Stripe Customer, etc.). On our side we keep only non-PCI references (payment method IDs, fingerprints, brand/last4 via gateway).

#### 3.1.3 Author Earnings & Payouts – `src/api/v1/author/payments/`

```text
src/api/v1/author/payments/
  index.ts
  author-payments.controller.ts
  author-payments.service.ts
  author-payments.schema.ts
  author-payments.test.ts

  handlers/
    earnings/
      list-author-payments.handler.ts     # GET /author/payments
      get-author-payment.handler.ts       # GET /author/payments/{id}
      get-earnings-stats.handler.ts       # GET /author/payments/stats
      export-earnings.handler.ts          # GET /author/payments/export

    payouts/
      list-payouts.handler.ts             # GET /author/payouts
      get-payout.handler.ts               # GET /author/payouts/{id}
      get-pending-earnings.handler.ts     # GET /author/payouts/pending
      get-payout-schedule.handler.ts      # GET /author/payouts/schedule
      request-payout.handler.ts           # POST /author/payouts/request (optional)
      update-bank-details.handler.ts      # PUT /author/payouts/bank-details
```

#### 3.1.4 Platform Invoices – `src/api/v1/platform/invoices/`

```text
src/api/v1/platform/invoices/
  index.ts
  platform-invoices.controller.ts
  platform-invoices.service.ts
  platform-invoices.schema.ts
  platform-invoices.test.ts

  handlers/
    author/
      list-my-platform-invoices.handler.ts  # GET /author/platform-invoices
      get-my-platform-invoice.handler.ts    # GET /author/platform-invoices/{id}

    admin/
      list-platform-invoices.handler.ts     # GET /admin/platform-invoices
      get-platform-invoice.handler.ts       # GET /admin/platform-invoices/{id}
      update-platform-invoice-status.handler.ts # PUT /admin/platform-invoices/{id}/status
```

#### 3.1.5 Admin Finance Tools – `src/api/v1/admin/finance/`

```text
src/api/v1/admin/finance/
  index.ts
  finance.controller.ts
  finance.service.ts
  finance.schema.ts
  finance.test.ts

  handlers/
    payments/
      list-payments.handler.ts           # GET /admin/payments
      get-payment.handler.ts             # GET /admin/payments/{id}
      refund-payment.handler.ts          # POST /admin/payments/{id}/refund
      mark-disputed.handler.ts           # POST /admin/payments/{id}/dispute
      resolve-dispute.handler.ts         # POST /admin/payments/{id}/dispute/resolve

    payouts/
      list-payouts.handler.ts            # GET /admin/payouts
      get-payout.handler.ts              # GET /admin/payouts/{id}
      update-payout-status.handler.ts    # PUT /admin/payouts/{id}/status
      retry-payout.handler.ts            # POST /admin/payouts/{id}/retry
```

### 3.2 Domain Layer

**Module:** `src/domain/payments/`

```text
src/domain/payments/
  entities/
    payment.entity.ts
    payment-event.entity.ts
    platform-invoice.entity.ts
    author-payout.entity.ts
    payment-gateway-config.entity.ts

  repositories/
    payment.repository.ts
    payment-event.repository.ts
    platform-invoice.repository.ts
    author-payout.repository.ts
    payment-gateway-config.repository.ts

  services/
    payments.service.ts                 # create/update payment records
    payment-processing.service.ts       # handle business logic (status changes, retries)
    refund.service.ts                   # inbound refund requests and admin refunds
    payout.service.ts                   # compute and create payouts for authors
    invoice.service.ts                  # generate platform invoices
    gateway-config.service.ts           # manage PaymentGatewayConfig
    earnings-report.service.ts          # generate CSV/summary for authors/admin
```

**Highlights:**

- `payments.service.ts`:
  - `createPayment(data)` – used by Subscriptions & Purchases.
  - `markProcessing`, `markSucceeded`, `markFailed`, `markRefunded`, etc. → all log `PaymentEvent`.

- `payment-processing.service.ts`:
  - idempotent handling of gateway webhook events.
  - retry scheduling when `status = FAILED` & `retryCount < maxRetries`.

- `refund.service.ts`:
  - Validates refund eligibility.
  - Creates REFUND-type Payments or updates Payment with refund fields.
  - Calls gateway API to issue refunds.

- `payout.service.ts`:
  - Aggregates all SUCCEEDED Payments for an author over a period.
  - Deducts fees/charges, respects minimum payout thresholds.
  - Creates `AuthorPayout` and triggers payout via gateway.

- `invoice.service.ts`:
  - Computes usage-based platform fees for authors (esp. FREE tier).
  - Generates `PlatformInvoice`, sets `invoiceNumber`, `invoiceUrl`.

---

## 4. Frontend Implementation (Next.js)

### 4.1 Reader – Billing & Payment History

Routes under `src/app/(reader-dashboard)/billing/` and `.../payments/`:

```text
src/app/(reader-dashboard)/billing/
  page.tsx                         # /billing – overview: payment methods, default, invoices
  methods/
    page.tsx                       # /billing/methods
  history/
    page.tsx                       # /billing/history – alias for /payments
  invoices/
    page.tsx                       # /billing/invoices – from subscriptions

src/app/(reader-dashboard)/payments/
  page.tsx                         # /payments – list all my payments
  [paymentId]/
    page.tsx                       # /payments/{id} – payment detail + receipt

  _components/
    payment-list.tsx
    payment-row.tsx
    payment-status-badge.tsx
    payment-detail.tsx
    receipt-view.tsx
    retry-payment-button.tsx
    refund-request-form.tsx
```

Payment methods:

```text
src/app/(reader-dashboard)/billing/methods/
  page.tsx
  _components/
    payment-method-card.tsx
    add-payment-method-form.tsx
    set-default-button.tsx
    delete-method-button.tsx
```

### 4.2 Author – Earnings & Payouts

Routes under `src/app/(author)/payments/`:

```text
src/app/(author)/payments/
  page.tsx                         # /author/payments – combined earnings overview
  transactions/
    page.tsx                       # /author/payments/transactions
  payouts/
    page.tsx                       # /author/payments/payouts
    [payoutId]/
      page.tsx                     # /author/payments/payouts/{id}
  setup/
    page.tsx                       # /author/payments/setup – gateway config & bank details

  _components/
    earnings-summary.tsx
    revenue-chart.tsx
    payment-table.tsx
    payment-filters.tsx
    payout-table.tsx
    payout-status-badge.tsx
    payout-detail.tsx
    bank-details-form.tsx
    gateway-connection-status.tsx
    connect-gateway-buttons.tsx
```

### 4.3 Admin – Finance Dashboard

Routes under `src/app/(admin)/admin/finance/`:

```text
src/app/(admin)/admin/finance/
  page.tsx                         # /admin/finance – overview dashboard

  payments/
    page.tsx                       # /admin/finance/payments
    [paymentId]/
      page.tsx                     # /admin/finance/payments/{id}

  payouts/
    page.tsx                       # /admin/finance/payouts
    [payoutId]/
      page.tsx                     # /admin/finance/payouts/{id}

  invoices/
    page.tsx                       # /admin/finance/invoices
    [invoiceId]/
      page.tsx                     # /admin/finance/invoices/{id}

  _components/
    finance-summary.tsx
    finance-metrics.tsx
    payments-table.tsx
    payouts-table.tsx
    invoices-table.tsx
    payment-filters.tsx
    payout-filters.tsx
    invoice-filters.tsx
```

### 4.4 Components

```text
src/components/payment/
  payment-status-badge.tsx
  payment-type-badge.tsx
  payment-method-icon.tsx
  payment-amount.tsx
  payment-timeline.tsx
  receipt-layout.tsx

src/components/payout/
  payout-status-badge.tsx
  payout-amount.tsx
  payout-period.tsx
  payout-breakdown.tsx

src/components/invoice/
  invoice-status-badge.tsx
  invoice-amount.tsx
  invoice-period.tsx
  invoice-download-button.tsx

src/components/gateway/
  gateway-status-badge.tsx
  connect-razorpay-button.tsx
  connect-stripe-button.tsx
  connect-xendit-button.tsx
```

### 4.5 Hooks

```text
src/hooks/
  // Reader
  use-my-payments.ts                # GET /payments
  use-payment-detail.ts             # GET /payments/{id}
  use-retry-payment.ts              # POST /payments/{id}/retry
  use-request-refund.ts             # POST /payments/{id}/refund-request
  use-payment-methods.ts            # GET /payment-methods
  use-add-payment-method.ts         # POST /payment-methods
  use-delete-payment-method.ts      # DELETE /payment-methods/{id}
  use-set-default-payment-method.ts # PUT /payment-methods/{id}/default

  // Author
  use-author-payments.ts            # GET /author/payments
  use-author-payment-detail.ts      # GET /author/payments/{id}
  use-earnings-stats.ts             # GET /author/payments/stats
  use-export-earnings.ts            # GET /author/payments/export
  use-payouts.ts                    # GET /author/payouts
  use-payout-detail.ts              # GET /author/payouts/{id}
  use-pending-earnings.ts           # GET /author/payouts/pending
  use-payout-schedule.ts            # GET /author/payouts/schedule
  use-request-payout.ts             # POST /author/payouts/request
  use-update-bank-details.ts        # PUT /author/payouts/bank-details

  // Gateway config
  use-payment-config.ts             # GET /author/payment-config
  use-connect-gateway.ts            # connect/disconnect handlers
  use-gateway-status.ts             # GET /author/payment-config/status

  // Admin
  use-admin-payments.ts             # GET /admin/payments
  use-admin-payment-detail.ts       # GET /admin/payments/{id}
  use-admin-refund-payment.ts       # POST /admin/payments/{id}/refund
  use-admin-mark-disputed.ts        # POST /admin/payments/{id}/dispute
  use-admin-resolve-dispute.ts      # POST /admin/payments/{id}/dispute/resolve

  use-admin-payouts.ts              # GET /admin/payouts
  use-admin-payout-detail.ts        # GET /admin/payouts/{id}
  use-admin-update-payout-status.ts # PUT /admin/payouts/{id}/status
  use-admin-platform-invoices.ts    # GET /admin/platform-invoices
  use-admin-platform-invoice-detail.ts # GET /admin/platform-invoices/{id}
  use-admin-update-invoice-status.ts   # PUT /admin/platform-invoices/{id}/status

  // Author view of platform invoices
  use-my-platform-invoices.ts       # GET /author/platform-invoices
  use-my-platform-invoice-detail.ts # GET /author/platform-invoices/{id}
```

### 4.6 Frontend API Endpoints

```text
src/lib/api/endpoints/payments.ts

export const paymentsApi = {
  // Reader payments
  listMyPayments: (params?: PaymentQueryParams) =>
    api.get<Paginated<PaymentDto>>('/payments', params),
  getMyPayment: (id: string) =>
    api.get<PaymentDetailDto>(`/payments/${id}`),
  getReceipt: (id: string) =>
    api.get<ReceiptDto>(`/payments/${id}/receipt`),
  retryPayment: (id: string) =>
    api.post<void>(`/payments/${id}/retry`, {}),
  requestRefund: (id: string, data: RefundRequestDto) =>
    api.post<void>(`/payments/${id}/refund-request`, data),

  // Payment methods
  listPaymentMethods: () =>
    api.get<PaymentMethodDto[]>('/payment-methods'),
  addPaymentMethod: (data: AddPaymentMethodDto) =>
    api.post<PaymentMethodDto>('/payment-methods', data),
  deletePaymentMethod: (id: string) =>
    api.delete<void>(`/payment-methods/${id}`),
  setDefaultPaymentMethod: (id: string) =>
    api.put<void>(`/payment-methods/${id}/default`, {}),

  // Author earnings
  listAuthorPayments: (params?: AuthorPaymentQueryParams) =>
    api.get<Paginated<PaymentDto>>('/author/payments', params),
  getAuthorPayment: (id: string) =>
    api.get<PaymentDetailDto>(`/author/payments/${id}`),
  getEarningsStats: () =>
    api.get<EarningsStatsDto>('/author/payments/stats'),
  exportEarnings: () =>
    api.get<Blob>('/author/payments/export'),

  // Author payouts
  listPayouts: (params?: PayoutQueryParams) =>
    api.get<Paginated<AuthorPayoutDto>>('/author/payouts', params),
  getPayout: (id: string) =>
    api.get<AuthorPayoutDetailDto>(`/author/payouts/${id}`),
  getPendingEarnings: () =>
    api.get<PendingEarningsDto>('/author/payouts/pending'),
  getPayoutSchedule: () =>
    api.get<PayoutScheduleDto>('/author/payouts/schedule'),
  requestPayout: (data: RequestPayoutDto) =>
    api.post<AuthorPayoutDto>('/author/payouts/request', data),
  updateBankDetails: (data: BankDetailsDto) =>
    api.put<void>('/author/payouts/bank-details', data),

  // Payment gateway config
  getPaymentConfig: () =>
    api.get<PaymentGatewayConfigDto>('/author/payment-config'),
  setDefaultGateway: (gateway: PaymentGateway) =>
    api.put<void>('/author/payment-config/default-gateway', { gateway }),
  connectRazorpay: (data: RazorpayConnectDto) =>
    api.post<void>('/author/payment-config/razorpay/connect', data),
  disconnectRazorpay: () =>
    api.post<void>('/author/payment-config/razorpay/disconnect', {}),
  connectStripe: (data: StripeConnectDto) =>
    api.post<void>('/author/payment-config/stripe/connect', data),
  disconnectStripe: () =>
    api.post<void>('/author/payment-config/stripe/disconnect', {}),
  connectXendit: (data: XenditConnectDto) =>
    api.post<void>('/author/payment-config/xendit/connect', data),
  disconnectXendit: () =>
    api.post<void>('/author/payment-config/xendit/disconnect', {}),
  getGatewayStatus: () =>
    api.get<GatewayStatusDto>('/author/payment-config/status'),

  // Platform invoices (author view)
  listMyPlatformInvoices: () =>
    api.get<PlatformInvoiceSummaryDto[]>('/author/platform-invoices'),
  getMyPlatformInvoice: (id: string) =>
    api.get<PlatformInvoiceDetailDto>(`/author/platform-invoices/${id}`),

  // Admin finance
  adminListPayments: (params?: AdminPaymentQueryParams) =>
    api.get<Paginated<PaymentDto>>('/admin/payments', params),
  adminGetPayment: (id: string) =>
    api.get<PaymentDetailDto>(`/admin/payments/${id}`),
  adminRefundPayment: (id: string, data: AdminRefundDto) =>
    api.post<void>(`/admin/payments/${id}/refund`, data),
  adminMarkDisputed: (id: string, data: DisputeDto) =>
    api.post<void>(`/admin/payments/${id}/dispute`, data),
  adminResolveDispute: (id: string, data: DisputeResolutionDto) =>
    api.post<void>(`/admin/payments/${id}/dispute/resolve`, data),

  adminListPayouts: (params?: AdminPayoutQueryParams) =>
    api.get<Paginated<AuthorPayoutDto>>('/admin/payouts', params),
  adminGetPayout: (id: string) =>
    api.get<AuthorPayoutDetailDto>(`/admin/payouts/${id}`),
  adminUpdatePayoutStatus: (id: string, data: UpdatePayoutStatusDto) =>
    api.put<void>(`/admin/payouts/${id}/status`, data),
  adminRetryPayout: (id: string) =>
    api.post<void>(`/admin/payouts/${id}/retry`, {}),

  adminListPlatformInvoices: (params?: AdminInvoiceQueryParams) =>
    api.get<Paginated<PlatformInvoiceSummaryDto>>('/admin/platform-invoices', params),
  adminGetPlatformInvoice: (id: string) =>
    api.get<PlatformInvoiceDetailDto>(`/admin/platform-invoices/${id}`),
  adminUpdateInvoiceStatus: (id: string, data: UpdateInvoiceStatusDto) =>
    api.put<void>(`/admin/platform-invoices/${id}/status`, data),
};
```

---

## 5. API Reference – Payments (~34 Endpoints)

The above endpoints cover the main surfaces; counts are approximate but aligned with the complexity of the payments domain.

---

## 6. Integration With Other Modules

- **Subscriptions:**
  - Creates `Payment` records on subscription creation/renewal.
  - Uses `Payment.gatewaySubscriptionId` to sync with gateway.
  - Payment webhooks update `ReaderSubscription.status`.

- **Products & Purchases:**
  - Purchase flows create `Payment` with `type = ONE_TIME_PURCHASE`.
  - Refunds adjust `Purchase` status and `Payment.refundedAmount`.

- **Churn:**
  - Payment failures and disputes feed into `ChurnPrediction` signals (paymentFailures, latePayments).

- **Analytics:**
  - Each `Payment` can emit `AnalyticsEvent` (PAYMENT_INITIATED, PAYMENT_COMPLETED, PAYMENT_FAILED).

- **Platform Administration:**
  - Admin finance dashboard uses `Payment`, `AuthorPayout`, `PlatformInvoice` for reports.

- **Webhooks & Integrations:**
  - Gateway webhooks (Razorpay, Stripe, Xendit) are received in the Webhooks module and routed to `payment-processing.service`.

---

