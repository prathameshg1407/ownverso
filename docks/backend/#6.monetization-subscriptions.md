
# Monetization – Subscriptions – Technical Documentation

## 1. Purpose & Scope

The **Monetization – Subscriptions** module covers:

- **Author-created subscription tiers** for their readers:
  - Per-site tiers (monthly/annual/lifetime logic via `BillingCycle`)
  - Pricing & currencies
  - Benefits, early access, max subscribers, visibility

- **Reader subscriptions** to those tiers:
  - Creation (checkout triggers Payments module)
  - Status transitions (ACTIVE, TRIALING, CANCELLED, PAUSED, EXPIRED)
  - Billing cycle changes, tier changes, pause/resume/cancel/reactivate
  - Linking to payment gateway subscriptions (Stripe, Razorpay, Xendit, etc.)

- **Author subscriber management**:
  - Listing & exporting subscribers per site
  - Viewing subscriber details & history
  - Basic churn insights (full churn logic in Churn module)

- **Gift subscriptions**:
  - Purchasing gift subscriptions
  - Claiming gifts by recipients

- **Discount code support for subscriptions** (code model lives here; used also for purchases).

It integrates closely with:

- `Payments` (for actual money flow)
- `Churn` (for predictions & retention actions)
- `Analytics` (for subscription metrics)
- `Platform tier limits` (constrains number of tiers, subscribers, etc.)

---

## 2. Prisma Schema (Models & Enums)

### 2.1 Relevant Enums

From the global schema; repeated here for clarity.

```prisma
enum BillingCycle {
  MONTHLY
  QUARTERLY
  BIANNUAL
  ANNUAL
  LIFETIME
}

enum ReaderSubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELLED
  EXPIRED
  PAUSED
}

enum PaymentGateway {
  RAZORPAY
  STRIPE
  XENDIT
  PAYPAL
  MANUAL
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_TRIAL
  FREE_MONTHS
  BUNDLE
}

enum GiftSubscriptionStatus {
  PENDING
  SCHEDULED
  DELIVERED
  CLAIMED
  EXPIRED
  REFUNDED
  CANCELLED
}
```

### 2.2 Models

#### 2.2.1 `AuthorSubscriptionTier`

```prisma
model AuthorSubscriptionTier {
  id        String @id @default(cuid())
  authorId  BigInt
  siteId    String

  // Identity
  name        String  @db.VarChar(50)
  slug        String
  description String? @db.Text

  // Pricing
  monthlyPrice   Int
  annualPrice    Int?
  currencyCode   String        @default("INR") @db.Char(3)
  billingCycles  BillingCycle[] @default([MONTHLY])

  // Benefits
  benefits        String[] @default([])
  earlyAccessDays Int      @default(0) @db.SmallInt

  // Display
  badgeText     String? @db.VarChar(20)
  badgeColor    String? @db.Char(7)
  iconUrl       String? @db.VarChar(2048)
  displayOrder  Int     @default(0) @db.SmallInt
  isHighlighted Boolean @default(false)
  highlightText String? @db.VarChar(30)

  // Status
  isActive  Boolean @default(true)
  isPublic  Boolean @default(true)
  isFree    Boolean @default(false)
  isDefault Boolean @default(false)

  // Capacity
  maxSubscribers     Int?
  currentSubscribers Int  @default(0)

  // Gateway references (for recurring billing)
  razorpayPlanId String?
  stripePriceId  String?
  xenditPlanId   String?

  // Optimistic locking
  version Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author            AuthorAccount        @relation(fields: [authorId], references: [userId], onDelete: Cascade)
  site              Site                 @relation(fields: [siteId], references: [id], onDelete: Cascade)
  currency          Currency             @relation(fields: [currencyCode], references: [code])
  subscriptions     ReaderSubscription[]
  chapters          Chapter[]
  discountCodeTiers DiscountCodeTier[]
  giftSubscriptions GiftSubscription[]

  @@unique([siteId, slug])
  @@index([authorId])
  @@index([siteId, isActive, displayOrder])

  @@map("author_subscription_tiers")
}
```

#### 2.2.2 `ReaderSubscription`

```prisma
model ReaderSubscription {
  id       String @id @default(cuid())
  readerId BigInt
  tierId   String

  status       ReaderSubscriptionStatus @default(ACTIVE)
  billingCycle BillingCycle             @default(MONTHLY)

  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  priceAtPurchase    Int
  currencyCode       String   @db.Char(3)

  // Gateway linkage
  gateway               PaymentGateway
  gatewaySubscriptionId String?
  gatewayCustomerId     String?

  // Discounts
  discountCodeId          String?
  discountMonthsRemaining Int     @default(0) @db.SmallInt
  originalPrice           Int?

  // Trial
  isTrialing  Boolean   @default(false)
  trialEndsAt DateTime?

  // Cancellation
  autoRenew      Boolean   @default(true)
  cancelledAt    DateTime?
  cancelReason   String?   @db.VarChar(100)
  cancelFeedback String?   @db.Text
  expiresAt      DateTime?

  // Reminders
  renewalReminderSentAt DateTime?
  expiryReminderSentAt  DateTime?

  // Pause
  pausedAt    DateTime?
  pauseEndsAt DateTime?
  pauseCount  Int       @default(0) @db.SmallInt

  // Optimistic locking
  version Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reader          User                   @relation("ReaderSubscriptions", fields: [readerId], references: [id], onDelete: Cascade)
  tier            AuthorSubscriptionTier @relation(fields: [tierId], references: [id], onDelete: Restrict)
  discountCode    DiscountCode?          @relation(fields: [discountCodeId], references: [id], onDelete: SetNull)
  payments        Payment[]
  churnPrediction ChurnPrediction?

  @@unique([readerId, tierId])
  @@index([readerId, status])
  @@index([tierId, status])
  @@index([status, currentPeriodEnd])
  @@index([status, autoRenew, currentPeriodEnd])

  @@map("reader_subscriptions")
}
```

#### 2.2.3 `GiftSubscription`

```prisma
model GiftSubscription {
  id String @id @default(cuid())

  giverId    BigInt
  giverEmail String
  giverName  String?

  recipientEmail String
  recipientName  String?
  recipientId    BigInt?

  tierId String

  months       Int    @default(1) @db.SmallInt
  amount       Int
  currencyCode String @default("INR") @db.Char(3)
  giftMessage  String? @db.Text

  deliveryDate DateTime @default(now())
  isScheduled  Boolean  @default(false)

  status      GiftSubscriptionStatus @default(PENDING)
  deliveredAt DateTime?
  claimedAt   DateTime?
  expiresAt   DateTime?

  claimCode String  @unique
  claimUrl  String? @db.VarChar(2048)

  paymentId        BigInt?
  gatewayPaymentId String?

  reminderSentAt DateTime?
  thankYouSentAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  giver     User                   @relation("GiftGiver", fields: [giverId], references: [id], onDelete: Cascade)
  recipient User?                  @relation("GiftRecipient", fields: [recipientId], references: [id], onDelete: SetNull)
  tier      AuthorSubscriptionTier @relation(fields: [tierId], references: [id], onDelete: Restrict)

  @@index([giverId])
  @@index([recipientEmail])
  @@index([status])
  @@index([claimCode])
  @@index([status, deliveryDate])

  @@map("gift_subscriptions")
}
```

#### 2.2.4 Discount Code Models (shared with Products/Purchases)

```prisma
model DiscountCode {
  id       String @id @default(cuid())
  authorId BigInt
  siteId   String

  code           String       @db.VarChar(30)
  discountType   DiscountType
  discountValue  Int
  trialDays      Int?         @db.SmallInt
  freeMonths     Int?         @db.SmallInt
  durationMonths Int?         @db.SmallInt

  maxUses        Int?
  maxUsesPerUser Int  @default(1) @db.SmallInt
  currentUses    Int  @default(0)

  validFrom  DateTime @default(now())
  validUntil DateTime?
  isActive   Boolean  @default(true)

  firstPaymentOnly Boolean @default(true)
  minimumAmount    Int?
  minimumCurrency  String?  @db.Char(3)

  description   String? @db.VarChar(200)
  internalNotes String? @db.Text

  version Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author          AuthorAccount        @relation(fields: [authorId], references: [userId], onDelete: Cascade)
  site            Site                 @relation(fields: [siteId], references: [id], onDelete: Cascade)
  subscriptions   ReaderSubscription[]
  applicableTiers DiscountCodeTier[]
  usages          DiscountCodeUsage[]

  @@unique([siteId, code])
  @@index([code])
  @@index([siteId, isActive])
  @@index([validFrom, validUntil, isActive])

  @@map("discount_codes")
}

model DiscountCodeTier {
  discountCodeId String
  tierId         String

  discountCode DiscountCode           @relation(fields: [discountCodeId], references: [id], onDelete: Cascade)
  tier         AuthorSubscriptionTier @relation(fields: [tierId], references: [id], onDelete: Cascade)

  @@id([discountCodeId, tierId])

  @@map("discount_code_tiers")
}

model DiscountCodeUsage {
  id             BigInt @id @default(autoincrement())
  discountCodeId String
  userId         BigInt

  subscriptionId String?
  purchaseId     BigInt?

  amountSaved  Int?
  currencyCode String? @db.Char(3)

  usedAt DateTime @default(now())

  discountCode DiscountCode @relation(fields: [discountCodeId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([discountCodeId, userId, subscriptionId])
  @@index([discountCodeId])
  @@index([userId])

  @@map("discount_code_usages")
}
```

These are the core Prisma definitions for the Subscriptions module. The `Payment` model and `PaymentGatewayConfig` are defined in the Payments module, but they are referenced by `ReaderSubscription` and `GiftSubscription` through `gateway` and `paymentId`.

---

## 3. Backend Implementation

### 3.1 Route & Handler Structure

**Base module:** `src/api/v1/subscriptions/`

```text
src/api/v1/subscriptions/
  index.ts                         # Registers /subscriptions, /sites/*/tiers, etc.
  subscriptions.controller.ts
  subscriptions.service.ts
  subscriptions.schema.ts
  subscriptions.test.ts

  handlers/
    tiers/
      list-tiers.handler.ts        # GET /sites/{siteId}/tiers
      create-tier.handler.ts       # POST /sites/{siteId}/tiers
      get-tier.handler.ts          # GET /sites/{siteId}/tiers/{tierId}
      update-tier.handler.ts       # PUT /sites/{siteId}/tiers/{tierId}
      delete-tier.handler.ts       # DELETE /sites/{siteId}/tiers/{tierId}
      reorder-tiers.handler.ts     # PUT /sites/{siteId}/tiers/reorder
      highlight-tier.handler.ts    # POST /sites/{siteId}/tiers/{tierId}/highlight
      unhighlight-tier.handler.ts  # POST /sites/{siteId}/tiers/{tierId}/unhighlight
      activate-tier.handler.ts     # POST /sites/{siteId}/tiers/{tierId}/activate
      deactivate-tier.handler.ts   # POST /sites/{siteId}/tiers/{tierId}/deactivate

    reader/
      list-my-subscriptions.handler.ts    # GET /subscriptions
      subscribe.handler.ts                # POST /subscriptions
      get-subscription.handler.ts         # GET /subscriptions/{id}
      change-tier.handler.ts              # PUT /subscriptions/{id}/tier
      change-billing-cycle.handler.ts     # PUT /subscriptions/{id}/billing-cycle
      cancel.handler.ts                   # POST /subscriptions/{id}/cancel
      reactivate.handler.ts               # POST /subscriptions/{id}/reactivate
      pause.handler.ts                    # POST /subscriptions/{id}/pause
      resume.handler.ts                   # POST /subscriptions/{id}/resume
      list-subscription-invoices.handler.ts # GET /subscriptions/{id}/invoices
      preview-subscription.handler.ts     # GET /subscriptions/preview
      validate-access.handler.ts          # POST /subscriptions/validate-access

    author/
      list-subscribers.handler.ts         # GET /sites/{siteId}/subscribers
      get-subscriber.handler.ts           # GET /sites/{siteId}/subscribers/{subscriptionId}
      export-subscribers.handler.ts       # GET /sites/{siteId}/subscribers/export
      get-subscriber-stats.handler.ts     # GET /sites/{siteId}/subscribers/stats
      get-churn-summary.handler.ts        # GET /sites/{siteId}/subscribers/churn
      update-subscriber-note.handler.ts   # POST /sites/{siteId}/subscribers/{subscriptionId}/note

    gifts/
      purchase-gift.handler.ts            # POST /subscriptions/gift
      list-gifts-sent.handler.ts          # GET /subscriptions/gifts/sent
      list-gifts-received.handler.ts      # GET /subscriptions/gifts/received
      claim-gift.handler.ts               # POST /subscriptions/gifts/{claimCode}/claim
```

> Note: Some endpoints (like `validate-access`) may be more internal; they’re still documented for completeness.

### 3.2 Domain Layer

**Module:** `src/domain/subscriptions/`

```text
src/domain/subscriptions/
  entities/
    subscription-tier.entity.ts
    reader-subscription.entity.ts
    gift-subscription.entity.ts
    discount-code.entity.ts

  repositories/
    subscription-tier.repository.ts
    reader-subscription.repository.ts
    gift-subscription.repository.ts
    discount-code.repository.ts

  services/
    subscription-tier.service.ts        # CRUD on tiers, enforce tier limits
    reader-subscription.service.ts      # subscribe/change tier/cancel/pause
    subscription-billing.service.ts     # next period; interacts with payment module
    subscription-access.service.ts      # access checks for content gating
    gift-subscription.service.ts        # purchase/claim gifts
    subscriber-analytics.service.ts     # per-site subscriber stats
```

**Key responsibilities:**

- `subscription-tier.service.ts`:
  - Ensures per-site tier count doesn’t exceed `TierLimits.maxSubscriptionTiers`.
  - Handles default tier designation (`isDefault`).
  - Enforces `maxSubscribers` where set.

- `reader-subscription.service.ts`:
  - Creates new subscription record after payment success.
  - Handles status transitions:
    - PAST_DUE when recurring payment fails
    - CANCELLED on explicit cancel
    - EXPIRED after `currentPeriodEnd` when no renewal
    - PAUSED on pause/resume
  - Computes new period start/end.

- `subscription-billing.service.ts`:
  - Works with Payments module to:
    - Create gateway subscription (Stripe, Razorpay, etc.)
    - Update gateway subscription on tier change / billing cycle change.
    - Handle proration rules (if applicable).

- `subscription-access.service.ts`:
  - Utility for `validate-access` endpoint:
    - Given reader + chapter, decide if accessible:
      - FREE, REGISTERED, SUBSCRIBERS, SPECIFIC_TIER, EARLY_ACCESS, etc.

- `gift-subscription.service.ts`:
  - Creates `GiftSubscription` record, associates with Payment.
  - Marks as DELIVERED, CLAIMED, EXPIRED, REFUNDED.

### 3.3 Interaction with Payments

`reader-subscription.service` delegates to `payments.service` for charge creation. Rough flow:

- `POST /subscriptions`:
  - Validate tier availability and author/site status.
  - Calculate price (with `DiscountCode` if provided).
  - Initiate payment (via Payments API: create Payment + gateway checkout).
  - On payment success webhook:
    - Create `ReaderSubscription` with ACTIVE/TRIALING.
    - Link `Payment.subscriptionId`.

Recurring billing events are triggered from payment gateway webhooks and processed via Payment module, which calls `subscription-billing.service` to update `ReaderSubscription` and compute new periods.

---

## 4. Frontend Implementation (Next.js)

### 4.1 Reader – Subscription Management

Routes under `src/app/(reader-dashboard)/subscriptions/`:

```text
src/app/(reader-dashboard)/subscriptions/
  page.tsx                         # /subscriptions – list my subscriptions
  [subscriptionId]/
    page.tsx                       # /subscriptions/{id} – subscription detail

  _components/
    subscription-list.tsx
    subscription-card.tsx
    subscription-status-badge.tsx
    subscription-detail-header.tsx
    subscription-period-info.tsx
    subscription-actions.tsx      # cancel, pause, change tier
    subscription-invoices-list.tsx
```

Checkout flows are under `(checkout)` group (documented largely in Payments), but for subs:

```text
src/app/(checkout)/checkout/subscription/[tierId]/
  page.tsx                         # /checkout/subscription/{tierId}
  _components/
    checkout-summary.tsx
    billing-cycle-selector.tsx
    discount-code-input.tsx
    payment-methods.tsx
```

### 4.2 Author – Tiers & Subscribers

Routes under `src/app/(author)/tiers/` and `src/app/(author)/subscribers/`:

```text
src/app/(author)/tiers/
  page.tsx                         # /tiers – list tiers for current default site, or site selector
  create/
    page.tsx                       # /tiers/create
  [tierId]/
    edit/
      page.tsx                     # /tiers/{tierId}/edit

  _components/
    tier-list.tsx
    tier-card.tsx
    tier-form.tsx
    tier-benefits-editor.tsx
    tier-pricing-editor.tsx
    tier-highlight-toggle.tsx
    tier-status-toggle.tsx
```

```text
src/app/(author)/subscribers/
  page.tsx                         # /subscribers – list all subscribers across sites or per site
  [subscriptionId]/
    page.tsx                       # /subscribers/{subscriptionId} – subscriber detail

  _components/
    subscriber-table.tsx
    subscriber-filters.tsx
    subscriber-status-badge.tsx
    subscriber-ltv-badge.tsx
    subscriber-detail-panel.tsx
    subscriber-note-editor.tsx
    churn-risk-indicator.tsx       # uses Churn module
```

### 4.3 Gift Subscriptions (Reader)

Routes under `src/app/(checkout)/checkout/gift/[tierId]/` and `src/app/(reader-dashboard)/subscriptions/gifts/`:

```text
src/app/(checkout)/checkout/gift/[tierId]/
  page.tsx                         # /checkout/gift/{tierId}
  _components/
    gift-subscription-form.tsx
    recipient-info-form.tsx
    delivery-date-picker.tsx
    gift-message-input.tsx
```

```text
src/app/(reader-dashboard)/subscriptions/gifts/
  page.tsx                         # /subscriptions/gifts – overview
  sent/
    page.tsx                       # /subscriptions/gifts/sent
  received/
    page.tsx                       # /subscriptions/gifts/received

  _components/
    gift-list.tsx
    gift-card.tsx
    gift-status-badge.tsx
```

Gift claim route is in `(auth)` or `(reader)` group depending on UX; API handles claim by `claimCode`.

### 4.4 Components

```text
src/components/subscription/
  tier-card.tsx
  tier-comparison.tsx
  subscribe-button.tsx
  subscription-badge.tsx
  billing-cycle-toggle.tsx
  discount-badge.tsx
  trial-badge.tsx
  cancel-subscription-dialog.tsx
  pause-subscription-dialog.tsx
  gift-subscription-form.tsx
```

### 4.5 Hooks

```text
src/hooks/
  use-subscription-tiers.ts         # List tiers for a site
  use-create-tier.ts                # Create tier
  use-update-tier.ts                # Update tier
  use-reorder-tiers.ts              # Reorder tiers
  use-toggle-tier-status.ts         # Activate/deactivate

  use-my-subscriptions.ts           # GET /subscriptions
  use-subscription-detail.ts        # GET /subscriptions/{id}
  use-subscribe.ts                  # POST /subscriptions
  use-change-subscription-tier.ts
  use-change-billing-cycle.ts
  use-cancel-subscription.ts
  use-reactivate-subscription.ts
  use-pause-subscription.ts
  use-resume-subscription.ts

  use-site-subscribers.ts           # GET /sites/{siteId}/subscribers
  use-subscriber-detail.ts          # GET /sites/{siteId}/subscribers/{id}
  use-export-subscribers.ts
  use-subscriber-stats.ts

  use-gift-subscriptions.ts         # list sent/received
  use-purchase-gift.ts
  use-claim-gift.ts
```

### 4.6 API Client Endpoints (Frontend)

```text
src/lib/api/endpoints/subscriptions.ts

export const subscriptionTiersApi = {
  list: (siteId: string) =>
    api.get<AuthorSubscriptionTierDto[]>(`/sites/${siteId}/tiers`),
  create: (siteId: string, data: CreateTierDto) =>
    api.post<AuthorSubscriptionTierDto>(`/sites/${siteId}/tiers`, data),
  get: (siteId: string, tierId: string) =>
    api.get<AuthorSubscriptionTierDto>(`/sites/${siteId}/tiers/${tierId}`),
  update: (siteId: string, tierId: string, data: UpdateTierDto) =>
    api.put<AuthorSubscriptionTierDto>(`/sites/${siteId}/tiers/${tierId}`, data),
  remove: (siteId: string, tierId: string) =>
    api.delete<void>(`/sites/${siteId}/tiers/${tierId}`),
  reorder: (siteId: string, data: ReorderTiersDto) =>
    api.put<void>(`/sites/${siteId}/tiers/reorder`, data),
  highlight: (siteId: string, tierId: string) =>
    api.post<void>(`/sites/${siteId}/tiers/${tierId}/highlight`, {}),
  unhighlight: (siteId: string, tierId: string) =>
    api.post<void>(`/sites/${siteId}/tiers/${tierId}/unhighlight`, {}),
  activate: (siteId: string, tierId: string) =>
    api.post<void>(`/sites/${siteId}/tiers/${tierId}/activate`, {}),
  deactivate: (siteId: string, tierId: string) =>
    api.post<void>(`/sites/${siteId}/tiers/${tierId}/deactivate`, {}),
};

export const readerSubscriptionsApi = {
  list: () =>
    api.get<ReaderSubscriptionDto[]>('/subscriptions'),
  subscribe: (data: CreateSubscriptionDto) =>
    api.post<CheckoutSessionDto | ReaderSubscriptionDto>('/subscriptions', data),
  get: (id: string) =>
    api.get<ReaderSubscriptionDetailDto>(`/subscriptions/${id}`),
  changeTier: (id: string, data: ChangeTierDto) =>
    api.put<ReaderSubscriptionDetailDto>(`/subscriptions/${id}/tier`, data),
  changeBillingCycle: (id: string, data: ChangeBillingCycleDto) =>
    api.put<ReaderSubscriptionDetailDto>(`/subscriptions/${id}/billing-cycle`, data),
  cancel: (id: string, data?: CancelSubscriptionDto) =>
    api.post<void>(`/subscriptions/${id}/cancel`, data || {}),
  reactivate: (id: string) =>
    api.post<void>(`/subscriptions/${id}/reactivate`, {}),
  pause: (id: string, data?: PauseSubscriptionDto) =>
    api.post<void>(`/subscriptions/${id}/pause`, data || {}),
  resume: (id: string) =>
    api.post<void>(`/subscriptions/${id}/resume`, {}),
  invoices: (id: string) =>
    api.get<InvoiceSummaryDto[]>(`/subscriptions/${id}/invoices`),
  preview: (data: PreviewSubscriptionDto) =>
    api.get<SubscriptionQuoteDto>('/subscriptions/preview', data),
  validateAccess: (data: ValidateAccessDto) =>
    api.post<AccessResultDto>('/subscriptions/validate-access', data),
};

export const authorSubscribersApi = {
  list: (siteId: string, params?: SubscriberQueryParams) =>
    api.get<Paginated<SubscriberSummaryDto>>(`/sites/${siteId}/subscribers`, params),
  get: (siteId: string, subscriptionId: string) =>
    api.get<SubscriberDetailDto>(`/sites/${siteId}/subscribers/${subscriptionId}`),
  export: (siteId: string) =>
    api.get<Blob>(`/sites/${siteId}/subscribers/export`),
  stats: (siteId: string) =>
    api.get<SubscriberStatsDto>(`/sites/${siteId}/subscribers/stats`),
  churnSummary: (siteId: string) =>
    api.get<ChurnSummaryDto>(`/sites/${siteId}/subscribers/churn`),
  updateNote: (siteId: string, subscriptionId: string, data: UpdateSubscriberNoteDto) =>
    api.post<void>(`/sites/${siteId}/subscribers/${subscriptionId}/note`, data),
};

export const giftSubscriptionsApi = {
  purchase: (data: PurchaseGiftDto) =>
    api.post<CheckoutSessionDto | GiftSubscriptionDto>('/subscriptions/gift', data),
  listSent: () =>
    api.get<GiftSubscriptionDto[]>('/subscriptions/gifts/sent'),
  listReceived: () =>
    api.get<GiftSubscriptionDto[]>('/subscriptions/gifts/received'),
  claim: (claimCode: string) =>
    api.post<void>(`/subscriptions/gifts/${claimCode}/claim`, {}),
};
```

---

## 5. API Reference – Subscriptions (32 Endpoints)

Base URL: `https://api.ownverso.com/v1`

### 5.1 Author Subscription Tiers (10 endpoints)

1. **GET `/sites/{siteId}/tiers`**  
   List all subscription tiers for a site (author view).  
   - Auth: Author / Collaborator (MANAGER/EDITOR with permissions)
   - Query: optional `includeInactive`

2. **POST `/sites/{siteId}/tiers`**  
   Create a new tier.  
   - Body: `name`, `slug`, `monthlyPrice`, `annualPrice?`, `currencyCode`, `billingCycles`, `description?`, `benefits?`, `earlyAccessDays?`, `isFree?`, `isDefault?`, `maxSubscribers?`.

3. **GET `/sites/{siteId}/tiers/{tierId}`**  
   Get tier details.

4. **PUT `/sites/{siteId}/tiers/{tierId}`**  
   Update tier properties.

5. **DELETE `/sites/{siteId}/tiers/{tierId}`**  
   Archive tier (set `isActive = false`) – only if no active subscribers or properly handled.

6. **PUT `/sites/{siteId}/tiers/reorder`**  
   Update `displayOrder` for tiers.  
   - Body: `orders: { tierId: string; displayOrder: number }[]`.

7. **POST `/sites/{siteId}/tiers/{tierId}/highlight`**  
   Mark tier as highlighted (e.g. “Most Popular”).

8. **POST `/sites/{siteId}/tiers/{tierId}/unhighlight`**  
   Remove highlight from tier.

9. **POST `/sites/{siteId}/tiers/{tierId}/activate`**  
   Activate an inactive tier (`isActive = true`).

10. **POST `/sites/{siteId}/tiers/{tierId}/deactivate`**  
    Deactivate a tier (`isActive = false`).

### 5.2 Reader Subscriptions (12 endpoints)

11. **GET `/subscriptions`**  
    List all subscriptions for current reader.  
    - Auth: User

12. **POST `/subscriptions`**  
    Create a subscription to a tier (starts checkout).  
    - Auth: User  
    - Body:
      - `tierId`
      - `billingCycle`
      - `discountCode?`
      - `paymentMethodId?`
    - Response:
      - Either `CheckoutSessionDto` (for redirect to gateway) or immediate `ReaderSubscriptionDto` if using on-site card.

13. **GET `/subscriptions/{id}`**  
    Get subscription details for current reader.  
    - Includes status, tier info, next billing date, etc.

14. **PUT `/subscriptions/{id}/tier`**  
    Change tier (upgrade/downgrade).  
    - Auth: User  
    - Body: `newTierId`, optional `prorationBehavior`.

15. **PUT `/subscriptions/{id}/billing-cycle`**  
    Change billing cycle (monthly ↔ annual).  
    - Body: `billingCycle`.

16. **POST `/subscriptions/{id}/cancel`**  
    Cancel subscription (at period end).  
    - Body: `reason?`, `feedback?`.

17. **POST `/subscriptions/{id}/reactivate`**  
    Reactivate a cancelled subscription during grace period.

18. **POST `/subscriptions/{id}/pause`**  
    Pause subscription (if allowed by site/author).  
    - Body: optional `pauseDuration` / `pauseUntil`.

19. **POST `/subscriptions/{id}/resume`**  
    Resume a paused subscription.

20. **GET `/subscriptions/{id}/invoices`**  
    List invoices associated with this subscription.  
    - Auth: User

21. **GET `/subscriptions/preview`**  
    Preview subscription cost before creating.  
    - Query: `tierId`, `billingCycle`, `discountCode?`  
    - Response: `SubscriptionQuoteDto` (finalAmount, discount, tax, etc.).

22. **POST `/subscriptions/validate-access`**  
    Check if current user/subscription has access to a given resource (e.g., chapter).  
    - Body: `chapterId` or `tierId`, `readerId?` (from token)  
    - Used by content gating logic.

### 5.3 Author Subscriber Management (6 endpoints)

23. **GET `/sites/{siteId}/subscribers`**  
    List subscribers for the site.  
    - Auth: Author / MANAGER  
    - Query: `status?`, `tierId?`, `q?`, pagination.

24. **GET `/sites/{siteId}/subscribers/{subscriptionId}`**  
    Get detail for a specific subscription + reader info.

25. **GET `/sites/{siteId}/subscribers/export`**  
    Export subscriber list (e.g. CSV).  
    - Auth: Author / MANAGER

26. **GET `/sites/{siteId}/subscribers/stats`**  
    Subscriber metrics (active, churn, MRR, etc.).  
    - Auth: Author / MANAGER

27. **GET `/sites/{siteId}/subscribers/churn`**  
    High-level churn summary (by status) – detailed predictions in Churn module.  
    - Auth: Author / MANAGER

28. **POST `/sites/{siteId}/subscribers/{subscriptionId}/note`**  
    Set or update internal note about subscriber.  
    - Auth: Author / MANAGER  
    - Body: `note: string`.

### 5.4 Gift Subscriptions (4 endpoints)

29. **POST `/subscriptions/gift`**  
    Purchase gift subscription to a tier.  
    - Auth: User  
    - Body:
      - `tierId`
      - `months`
      - `recipientEmail`
      - `recipientName?`
      - `deliveryDate?`
      - `giftMessage?`
    - Response:
      - `CheckoutSessionDto` or `GiftSubscriptionDto`.

30. **GET `/subscriptions/gifts/sent`**  
    List gift subscriptions given by current user.  
    - Auth: User

31. **GET `/subscriptions/gifts/received`**  
    List gift subscriptions received (based on email / claimed user).  
    - Auth: User

32. **POST `/subscriptions/gifts/{claimCode}/claim`**  
    Claim gift subscription via code.  
    - Auth: User (can also support no-auth claim + forced registration)  
    - Behavior:
      - Links `GiftSubscription.recipientId` to current user.
      - Creates `ReaderSubscription` with PREPAID months.

---

## 6. Integration With Other Modules

- **Payments:**
  - All subscription creation / tier change / billing cycle change require coordination with Payment module and gateway webhooks.
  - ReaderSubscription `status` transitions (PAST_DUE, EXPIRED, CANCELLED) are often triggered from payment webhook handlers.

- **Churn Prevention:**
  - `ReaderSubscription` is linked to `ChurnPrediction` and `ChurnPreventionAction` (documented in Churn module).
  - Subscriber stats endpoints may show aggregated churn risk summaries.

- **Analytics:**
  - Subscription events (start, upgrade, cancel, renew) produce `AnalyticsEvent` entries and feed `AnalyticsAggregate`.

- **Author & Site Management:**
  - Tiers are per-site (`AuthorSubscriptionTier.siteId`); site deletion or suspension affects ability to subscribe.

- **Platform Tier Limits:**
  - `TierLimits` per `PlatformTier` restrict:
    - `maxSubscriptionTiers`
    - `maxSubscribers`
    - Maybe advanced features like `hasChurnPrediction`, `hasABTesting`.

---
