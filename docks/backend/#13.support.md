

---

# Support – Technical Documentation

## 1. Purpose & Scope

The **Support** module covers:

- **Support tickets**:
  - Users can submit tickets for issues (billing, technical, content, abuse, etc.).
  - Ticket lifecycle: OPEN → IN_PROGRESS → WAITING_ON_CUSTOMER/THIRD_PARTY → RESOLVED → CLOSED/REOPENED.
  - Priority levels and SLAs.

- **Ticket messages**:
  - Conversation thread between user and support staff.
  - AI-assisted responses (optional).

- **Support admin tools**:
  - Agent assignment, status changes, prioritization
  - Satisfaction ratings
  - Basic SLA tracking and breach detection.

Integration points:

- **Payments** (billing/payment issues)
- **Moderation** (abuse reports may be converted into support tickets or vice versa)
- **Communication** (email notifications on new replies)
- **Platform Administration** (support dashboards)

---

## 2. Prisma Schema (Models & Enums)

### 2.1 Enums

From the global schema; repeated here.

```prisma
/// Support ticket states
enum TicketStatus {
  OPEN
  ASSIGNED
  IN_PROGRESS
  WAITING_ON_CUSTOMER
  WAITING_ON_THIRD_PARTY
  PENDING_APPROVAL
  RESOLVED
  CLOSED
  REOPENED
}

/// Support ticket priority
enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
  URGENT
}

/// Support ticket categories
enum TicketCategory {
  ACCOUNT_ACCESS
  ACCOUNT_SECURITY
  BILLING
  PAYMENT_ISSUE
  REFUND_REQUEST
  TECHNICAL_BUG
  CONTENT_ISSUE
  COPYRIGHT_CLAIM
  FEATURE_REQUEST
  ABUSE_REPORT
  DATA_REQUEST
  OTHER
}
```

### 2.2 Models

#### 2.2.1 `SupportTicket`

```prisma
model SupportTicket {
  id     BigInt @id @default(autoincrement())
  userId BigInt

  ticketNumber String @unique
  subject      String @db.VarChar(200)

  category TicketCategory
  priority TicketPriority @default(MEDIUM)
  status   TicketStatus   @default(OPEN)

  assignedToId   String?
  assignedToName String?
  assignedAt     DateTime?

  tags String[] @default([])

  // SLA tracking
  slaDeadline      DateTime?
  slaBreach        Boolean   @default(false)
  firstResponseAt  DateTime?
  firstResponseSla Boolean?
  resolutionSla    Boolean?

  resolvedAt        DateTime?
  resolutionTimeMin Int?
  closedAt          DateTime?

  // Satisfaction
  satisfactionRating   Int?    @db.SmallInt // 1-5
  satisfactionFeedback String? @db.Text
  feedbackRequestedAt  DateTime?

  // Context
  userPlatformTier  PlatformTier?
  relatedEntityType String?
  relatedEntityId   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages TicketMessage[]

  @@index([userId])
  @@index([status, priority])
  @@index([ticketNumber])

  @@map("support_tickets")
}
```

#### 2.2.2 `TicketMessage`

```prisma
model TicketMessage {
  id       BigInt @id @default(autoincrement())
  ticketId BigInt
  userId   BigInt?

  isStaff   Boolean @default(false)
  isAI      Boolean @default(false)
  staffName String?
  staffId   BigInt?

  content     String  @db.Text
  contentHtml String? @db.Text

  attachments Json?
  isInternal  Boolean @default(false)

  createdAt DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([ticketId, createdAt])

  @@map("ticket_messages")
}
```

These models constitute the support domain’s core.

---

## 3. Backend Implementation

### 3.1 Route & Handler Structure

We group into:

- **User-facing support tickets**
- **Ticket messages**
- **Support/admin ticket management**

#### 3.1.1 User-Facing Tickets – `src/api/v1/support/tickets/`

```text
src/api/v1/support/tickets/
  index.ts
  support-tickets.controller.ts
  support-tickets.service.ts
  support-tickets.schema.ts
  support-tickets.test.ts

  handlers/
    list-my-tickets.handler.ts           # GET /support/tickets
    create-ticket.handler.ts             # POST /support/tickets
    get-ticket.handler.ts                # GET /support/tickets/{id}
    update-ticket.handler.ts             # PUT /support/tickets/{id}
    close-ticket.handler.ts              # POST /support/tickets/{id}/close
    reopen-ticket.handler.ts             # POST /support/tickets/{id}/reopen
```

#### 3.1.2 Ticket Messages – `src/api/v1/support/messages/`

```text
src/api/v1/support/messages/
  index.ts
  ticket-messages.controller.ts
  ticket-messages.service.ts
  ticket-messages.schema.ts
  ticket-messages.test.ts

  handlers/
    list-messages.handler.ts             # GET /support/tickets/{id}/messages
    add-message.handler.ts               # POST /support/tickets/{id}/messages
    add-attachment.handler.ts            # POST /support/tickets/{id}/messages/{messageId}/attachments (optional)
```

#### 3.1.3 Support/Admin – Tickets – `src/api/v1/admin/support/`

```text
src/api/v1/admin/support/
  index.ts
  admin-support.controller.ts
  admin-support.service.ts
  admin-support.schema.ts
  admin-support.test.ts

  handlers/
    list-all-tickets.handler.ts          # GET /admin/support/tickets
    get-ticket-detail.handler.ts         # GET /admin/support/tickets/{id}
    assign-ticket.handler.ts             # PUT /admin/support/tickets/{id}/assign
    change-priority.handler.ts           # PUT /admin/support/tickets/{id}/priority
    change-status.handler.ts             # PUT /admin/support/tickets/{id}/status
    add-staff-message.handler.ts         # POST /admin/support/tickets/{id}/messages
    get-support-stats.handler.ts         # GET /admin/support/stats
```

### 3.2 Domain Layer

**Module:** `src/domain/support/`

```text
src/domain/support/
  entities/
    support-ticket.entity.ts
    ticket-message.entity.ts

  repositories/
    support-ticket.repository.ts
    ticket-message.repository.ts

  services/
    support-ticket.service.ts
    ticket-message.service.ts
    support-sla.service.ts          # SLA computation & breach flags
    support-stats.service.ts        # Stats for admin dashboards
```

**Responsibilities:**

- `support-ticket.service.ts`:
  - User-level: create ticket, update subject, close/reopen.
  - Admin-level: assign, change status/priority, relate to entities (`relatedEntityType`/`relatedEntityId`).
  - SLA: sets `slaDeadline`, marks `slaBreach` if past.

- `ticket-message.service.ts`:
  - Creates messages from user or staff.
  - Handles `isInternal` messages (staff-only).
  - Optionally integrates with AI to generate drafts (`isAI = true`).

- `support-sla.service.ts`:
  - Calculates due times based on `TicketPriority`.
  - Tracks `firstResponseAt` and `resolutionTimeMin`.

- `support-stats.service.ts`:
  - Aggregates `status`, `priority`, SLA compliance, average time to resolution.

---

## 4. Frontend Implementation (Next.js)

### 4.1 User Support Pages

User UI for creating and managing own tickets under `src/app/(support)/tickets/`:

```text
src/app/(support)/tickets/
  page.tsx                              # /support/tickets – list my tickets
  create/
    page.tsx                            # /support/tickets/create
  [ticketId]/
    page.tsx                            # /support/tickets/{id} – ticket detail

  _components/
    ticket-list.tsx
    ticket-list-item.tsx
    ticket-status-badge.tsx
    ticket-priority-badge.tsx
    ticket-category-badge.tsx
    ticket-form.tsx                     # create/update ticket
    ticket-detail.tsx
    ticket-messages.tsx
    ticket-message-item.tsx
    ticket-reply-form.tsx
    ticket-sla-indicator.tsx
    ticket-satisfaction-form.tsx        # for resolving feedback
```

You might also offer a top-level path: `/help` or `/support` that links into these.

### 4.2 Support Agent/Admin UI

Support and admin tools under `src/app/(admin)/admin/support/`:

```text
src/app/(admin)/admin/support/
  page.tsx                              # /admin/support – overview dashboard
  tickets/
    page.tsx                            # /admin/support/tickets – list all tickets
    [ticketId]/
      page.tsx                          # /admin/support/tickets/{id}

  _components/
    support-dashboard-metrics.tsx
    ticket-table.tsx
    ticket-filters.tsx
    ticket-detail-header.tsx
    ticket-context-panel.tsx
    ticket-messages-thread.tsx
    staff-reply-form.tsx
    assign-agent-modal.tsx
    priority-selector.tsx
    status-selector.tsx
```

---

## 5. Hooks & Frontend API Clients

### 5.1 Hooks

```text
src/hooks/
  // User support
  use-my-support-tickets.ts           # list my tickets
  use-support-ticket-detail.ts        # get ticket detail
  use-create-ticket.ts                # create ticket
  use-update-ticket.ts                # update subject/category/priority (if allowed)
  use-close-ticket.ts                 # user closes
  use-reopen-ticket.ts                # user reopens

  use-ticket-messages.ts              # list messages
  use-add-ticket-message.ts           # add message
  use-add-ticket-attachment.ts        # optional

  // Admin/Support
  use-admin-support-tickets.ts        # list tickets (admin)
  use-admin-support-ticket-detail.ts
  use-assign-ticket.ts
  use-change-ticket-priority.ts
  use-change-ticket-status.ts
  use-add-staff-ticket-message.ts
  use-support-stats.ts                # admin dashboard metrics
```

### 5.2 Frontend API Endpoints

```text
src/lib/api/endpoints/support.ts

export const supportApi = {
  // User-facing tickets
  listMyTickets: (params?: SupportTicketQueryParams) =>
    api.get<Paginated<SupportTicketSummaryDto>>('/support/tickets', params),

  createTicket: (data: CreateSupportTicketDto) =>
    api.post<SupportTicketDetailDto>('/support/tickets', data),

  getTicket: (id: number | string) =>
    api.get<SupportTicketDetailDto>(`/support/tickets/${id}`),

  updateTicket: (id: number | string, data: UpdateSupportTicketDto) =>
    api.put<SupportTicketDetailDto>(`/support/tickets/${id}`, data),

  closeTicket: (id: number | string) =>
    api.post<void>(`/support/tickets/${id}/close`, {}),

  reopenTicket: (id: number | string) =>
    api.post<void>(`/support/tickets/${id}/reopen`, {}),

  // Messages
  listMessages: (ticketId: number | string) =>
    api.get<TicketMessageDto[]>(`/support/tickets/${ticketId}/messages`),

  addMessage: (ticketId: number | string, data: CreateTicketMessageDto) =>
    api.post<TicketMessageDto>(`/support/tickets/${ticketId}/messages`, data),

  addAttachment: (ticketId: number | string, messageId: number | string, formData: FormData) =>
    api.upload<TicketMessageDto>(
      `/support/tickets/${ticketId}/messages/${messageId}/attachments`,
      formData
    ),

  // Admin/Support
  adminListTickets: (params?: AdminSupportTicketQueryParams) =>
    api.get<Paginated<SupportTicketSummaryDto>>('/admin/support/tickets', params),

  adminGetTicket: (id: number | string) =>
    api.get<SupportTicketDetailDto>(`/admin/support/tickets/${id}`),

  adminAssignTicket: (id: number | string, data: AssignTicketDto) =>
    api.put<void>(`/admin/support/tickets/${id}/assign`, data),

  adminChangePriority: (id: number | string, data: ChangeTicketPriorityDto) =>
    api.put<void>(`/admin/support/tickets/${id}/priority`, data),

  adminChangeStatus: (id: number | string, data: ChangeTicketStatusDto) =>
    api.put<void>(`/admin/support/tickets/${id}/status`, data),

  adminAddMessage: (id: number | string, data: CreateStaffTicketMessageDto) =>
    api.post<TicketMessageDto>(`/admin/support/tickets/${id}/messages`, data),

  getStats: () =>
    api.get<SupportStatsDto>('/admin/support/stats'),
};
```

---

## 6. API Reference – Support (~20 Endpoints)

Base URL: `https://api.ownverso.com/v1`

### 6.1 User-Facing Tickets (6 endpoints)

1. **GET `/support/tickets`**  
   List support tickets created by current user.  
   - Filters: `status?`, `category?`, `priority?`, date range.
   - Response: Paginated `SupportTicketSummaryDto[]`.

2. **POST `/support/tickets`**  
   Create a new support ticket.  
   - Body:
     - `subject` (string)
     - `category` (`TicketCategory`)
     - `priority?` (`TicketPriority`)
     - `initialMessage` (string) – stored as first `TicketMessage`
     - `relatedEntityType?` / `relatedEntityId?` (e.g., `PAYMENT` + payment ID)
   - Response: `SupportTicketDetailDto`.

3. **GET `/support/tickets/{id}`**  
   Get detail of a ticket (only if `userId` = current user).  
   - Includes: ticket fields + messages.

4. **PUT `/support/tickets/{id}`**  
   Update certain user-editable fields (e.g., subject or category before it’s picked up).  
   - Body: partial update (e.g., `subject?`, `category?`, `priority?`).

5. **POST `/support/tickets/{id}/close`**  
   User closes ticket (e.g., if issue is resolved).  
   - Behavior: set `status = CLOSED`, `closedAt = now()`.  
   - Support may re-open if needed.

6. **POST `/support/tickets/{id}/reopen`**  
   Reopen ticket that’s RESOLVED/CLOSED (within some time window).  
   - Behavior: set `status = REOPENED`, `updatedAt = now()`.

### 6.2 Ticket Messages (2–3 endpoints)

7. **GET `/support/tickets/{id}/messages`**  
   List messages in ticket, ordered by `createdAt`.

8. **POST `/support/tickets/{id}/messages`**  
   Add new message to ticket (from user).  
   - Body: `content`, optional `attachments` metadata (actual upload often separate).

9. **POST `/support/tickets/{id}/messages/{messageId}/attachments`** (optional)  
   Upload file attachments for a message (multipart/form-data).  
   - May be omitted if attachments are simple JSON references to `MediaFile`.

### 6.3 Admin / Support – Ticket Management (9 endpoints)

10. **GET `/admin/support/tickets`**  
    List all support tickets (support staff view).  
    - Filters: `status`, `priority`, `category`, `assignedToId`, `userId`, date range.
    - Response: Paginated.

11. **GET `/admin/support/tickets/{id}`**  
    Get full ticket detail, including user info, linked entities, and messages.

12. **PUT `/admin/support/tickets/{id}/assign`**  
    Assign ticket to a support agent.  
    - Body:
      - `assignedToId` (string, e.g. support email or agent ID)
      - `assignedToName?`

13. **PUT `/admin/support/tickets/{id}/priority`**  
    Change ticket priority.  
    - Body: `priority: TicketPriority`.

14. **PUT `/admin/support/tickets/{id}/status`**  
    Change ticket status (OPEN, IN_PROGRESS, WAITING_ON_CUSTOMER, RESOLVED, CLOSED, etc.).  
    - Body: `status: TicketStatus`, `comment?` (logged in internal `TicketMessage` as staff note).

15. **POST `/admin/support/tickets/{id}/messages`**  
    Add staff message (reply to user).  
    - Body: `content`, optional `isInternal` (for notes not visible to user), `isAI?` if generated by AI assistant.

16. **GET `/admin/support/stats`**  
    Get high-level support metrics: open vs closed, average resolution time, SLA compliance.

17. **(Optional)** `POST /admin/support/tickets/{id}/request-feedback`  
    Trigger satisfaction survey email after resolution; or done automatically by job.

18. **(Optional)** `POST /admin/support/tickets/{id}/tag`  
    Add tags to ticket for classification.

### 6.4 Ticket Satisfaction (2 endpoints, user-side)

19. **POST `/support/tickets/{id}/satisfaction`**  
    Submit satisfaction rating & feedback for resolved ticket.  
    - Body:
      - `rating`: 1–5
      - `feedback?`: string

20. **GET `/support/tickets/{id}/satisfaction`**  
    (Optional) Get current satisfaction rating for ticket (user can view or edit within a window).

> Total is about 18–20 endpoints, consistent with the category.

---

## 7. Integration With Other Modules

- **Payments & Billing:**
  - Ticket category `BILLING` or `PAYMENT_ISSUE` often link to `Payment` or `PlatformInvoice` using `relatedEntityType`/`relatedEntityId`.
  - Refund requests may come both via “Payments” flows and Support tickets; support agents coordinate with finance.

- **Moderation:**
  - `ABUSE_REPORT` / `CONTENT_ISSUE` tickets may trigger moderation workflows; some abuse reports may originate from Support rather than direct “Report” API.

- **Communication:**
  - New ticket creation and new messages trigger notifications (`Notification`) and emails (via `EmailLog`), both for user and support staff.

- **Analytics & Admin:**
  - Support stats (ticket volumes, categories, SLA compliance, satisfaction ratings) feed into admin dashboards.

- **GDPR:**
  - Support tickets may contain personal data; inclusion in data export requests must be considered.

